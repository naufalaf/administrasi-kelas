<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistem Administrasi Kelas</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        body {
            box-sizing: border-box;
        }
        
        .fade-in {
            animation: fadeIn 0.5s ease-in;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #3498db;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 12px 20px;
            border-radius: 8px;
            color: white;
            font-weight: 500;
            z-index: 1000;
            animation: slideIn 0.3s ease-out;
        }
        .notification.success {
            background-color: #10b981;
        }
        .notification.error {
            background-color: #ef4444;
        }
        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
    </style>
</head>
<body class="bg-gradient-to-br from-blue-50 to-indigo-100 min-h-full">
    <!-- Login Page -->
    <div id="loginPage" class="min-h-full flex items-center justify-center py-12 px-4 sm:px-6 lg:px-8">
        <div class="max-w-md w-full space-y-8 bg-white p-8 rounded-xl shadow-lg fade-in">
            <div class="text-center">
                <img src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEit19uUj7ZanvTG4uc5p6Fc8fkoORl6bLxNN-hB-9wDcw-l5IPwmpX5Q5w6lcIfFE_Qat_o3AMrLZ1jOaBu2A5IAF1sUhJJSrQe6Vf8NdvLMqafGbdbl4xgttpRbCS7dEy6PbZrUKyeutqx34O4mQTQ3Z4UtSbaoPR79ywyjwrxXUMolyZ7oro8bsRQ/s158/LOGO%20MTS4.png" 
                     alt="Logo Sekolah" class="mx-auto h-20 w-auto mb-4">
                <h2 class="text-3xl font-bold text-gray-900 mb-2">Sistem Administrasi Kelas</h2>
                <p class="text-gray-600 mb-4">Silakan login untuk melanjutkan</p>
            </div>
            
            <form id="loginForm" class="mt-8 space-y-6">
                <div class="space-y-4">
                    <div>
                        <label for="username" class="block text-sm font-medium text-gray-700 mb-2">Username</label>
                        <input id="username" name="username" type="text" required 
                               class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                    </div>
                    <div>
                        <label for="password" class="block text-sm font-medium text-gray-700 mb-2">Password</label>
                        <div class="relative">
                            <input id="password" name="password" type="password" required 
                                   class="w-full px-3 py-2 pr-10 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                            <button type="button" id="togglePassword" 
                                    class="absolute inset-y-0 right-0 pr-3 flex items-center text-gray-400 hover:text-gray-600 focus:outline-none">
                                <svg id="eyeIcon" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" />
                                </svg>
                                <svg id="eyeOffIcon" class="h-5 w-5 hidden" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.875 18.825A10.05 10.05 0 0112 19c-4.478 0-8.268-2.943-9.543-7a9.97 9.97 0 011.563-3.029m5.858.908a3 3 0 114.243 4.243M9.878 9.878l4.242 4.242M9.878 9.878L3 3m6.878 6.878L21 21" />
                                </svg>
                            </button>
                        </div>
                    </div>
                    <div>
                        <label for="userType" class="block text-sm font-medium text-gray-700 mb-2">Login Sebagai</label>
                        <select id="userType" name="userType" required 
                                class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                            <option value="">Pilih Jenis Login</option>
                            <option value="guru">Guru</option>
                            <option value="walikelas">Wali Kelas</option>
                        </select>
                    </div>
                </div>
                
                <div id="loginError" class="hidden bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded"></div>
                
                <button type="submit" id="loginBtn" 
                        class="w-full flex justify-center py-2 px-4 border border-transparent rounded-lg shadow-sm text-sm font-medium text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition duration-200">
                    <span id="loginBtnText">Masuk</span>
                    <span id="loginSpinner" class="loading hidden ml-2"></span>
                </button>
            </form>
        </div>
    </div>

    <!-- Dashboard Guru -->
    <div id="dashboardGuru" class="hidden min-h-full">
        <nav class="bg-white shadow-sm border-b">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex justify-between h-16">
                    <div class="flex items-center">
                        <img src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEit19uUj7ZanvTG4uc5p6Fc8fkoORl6bLxNN-hB-9wDcw-l5IPwmpX5Q5w6lcIfFE_Qat_o3AMrLZ1jOaBu2A5IAF1sUhJJSrQe6Vf8NdvLMqafGbdbl4xgttpRbCS7dEy6PbZrUKyeutqx34O4mQTQ3Z4UtSbaoPR79ywyjwrxXUMolyZ7oro8bsRQ/s158/LOGO%20MTS4.png" 
                             alt="Logo" class="h-8 w-auto mr-3">
                        <h1 class="text-xl font-semibold text-gray-900">Dashboard Guru</h1>
                    </div>
                    <div class="flex items-center space-x-4">
                        <div class="flex items-center space-x-3">
                            <img id="profilePhoto" src="" alt="Foto Profil" class="h-10 w-10 rounded-full object-cover border-2 border-gray-300">
                            <div class="text-right">
                                <div id="welcomeMessage" class="text-gray-900 font-medium"></div>
                                <div id="mapelInfo" class="text-sm text-gray-600"></div>
                            </div>
                        </div>
                        <button onclick="logout()" class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-lg text-sm transition duration-200">
                            Logout
                        </button>
                    </div>
                </div>
            </div>
        </nav>

        <!-- Tab Navigation -->
        <div class="bg-white border-b">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <nav class="flex space-x-8">
                    <button onclick="showTab('dashboard')" id="tabDashboard" class="tab-button py-4 px-1 border-b-2 border-blue-500 text-blue-600 font-medium text-sm">
                        Dashboard
                    </button>
                    <button onclick="showTab('jurnal')" id="tabJurnal" class="tab-button py-4 px-1 border-b-2 border-transparent text-gray-500 hover:text-gray-700 font-medium text-sm">
                        Jurnal Pembelajaran
                    </button>
                    <button onclick="showTab('presensi')" id="tabPresensi" class="tab-button py-4 px-1 border-b-2 border-transparent text-gray-500 hover:text-gray-700 font-medium text-sm">
                        Daftar Kehadiran
                    </button>
                </nav>
            </div>
        </div>

        <div class="max-w-7xl mx-auto py-6 sm:px-6 lg:px-8">
            <div class="px-4 py-6 sm:px-0">
                
                <!-- Tab Dashboard -->
                <div id="contentDashboard" class="tab-content">
                    <!-- Filter Section -->
                    <div class="bg-white shadow rounded-lg mb-6">
                        <div class="px-4 py-5 sm:p-6">
                            <h3 class="text-lg leading-6 font-medium text-gray-900 mb-4">Filter Data</h3>
                            <div class="grid grid-cols-1 md:grid-cols-5 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Periode</label>
                                    <select id="filterPeriode" onchange="updateFilter()" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                                        <option value="today">Hari Ini</option>
                                        <option value="week">Minggu Ini</option>
                                        <option value="month">Bulan Ini</option>
                                        <option value="lastmonth">Bulan Lalu</option>
                                        <option value="custom">Custom</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Kelas</label>
                                    <select id="filterKelas" onchange="updateFilter()" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                                        <option value="">Semua Kelas</option>
                                    </select>
                                </div>
                                <div id="customDateFrom" class="hidden">
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Dari Tanggal</label>
                                    <input type="date" id="dateFrom" onchange="updateFilter()" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                                </div>
                                <div id="customDateTo" class="hidden">
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Sampai Tanggal</label>
                                    <input type="date" id="dateTo" onchange="updateFilter()" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                                </div>
                                <div class="flex items-end">
                                    <button onclick="resetFilter()" class="w-full bg-gray-500 hover:bg-gray-600 text-white font-medium py-2 px-4 rounded-lg transition duration-200">
                                        Reset Filter
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                        <div class="bg-white overflow-hidden shadow rounded-lg cursor-pointer hover:bg-gray-50 transition-colors" onclick="showJurnalList()">
                            <div class="p-5">
                                <div class="flex items-center">
                                    <div class="flex-shrink-0">
                                        <div class="text-3xl">üìö</div>
                                    </div>
                                    <div class="ml-5 w-0 flex-1">
                                        <dl>
                                            <dt id="jurnalLabel" class="text-sm font-medium text-gray-500 truncate">Total Jurnal Hari Ini</dt>
                                            <dd id="totalJurnal" class="text-lg font-medium text-gray-900">0</dd>
                                        </dl>
                                    </div>
                                    <div class="flex-shrink-0">
                                        <div class="text-gray-400">üëÜ</div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="bg-white overflow-hidden shadow rounded-lg">
                            <div class="p-5">
                                <div class="flex items-center">
                                    <div class="flex-shrink-0">
                                        <div class="text-3xl">‚è∞</div>
                                    </div>
                                    <div class="ml-5 w-0 flex-1">
                                        <dl>
                                            <dt id="durasiLabel" class="text-sm font-medium text-gray-500 truncate">Total Durasi Mengajar Hari Ini</dt>
                                            <dd id="totalDurasi" class="text-lg font-medium text-gray-900">0 JP</dd>
                                        </dl>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                        <div class="bg-white overflow-hidden shadow rounded-lg cursor-pointer hover:bg-gray-50 transition-colors" onclick="showGuruRekapKehadiran()">
                            <div class="p-5">
                                <div class="flex items-center">
                                    <div class="flex-shrink-0">
                                        <div class="text-3xl">üë•</div>
                                    </div>
                                    <div class="ml-5 w-0 flex-1">
                                        <dl>
                                            <dt id="presensiLabel" class="text-sm font-medium text-gray-500 truncate">Total Sesi Absensi Hari Ini</dt>
                                            <dd id="totalPresensi" class="text-lg font-medium text-gray-900">0</dd>
                                        </dl>
                                    </div>
                                    <div class="flex-shrink-0">
                                        <div class="text-gray-400">üëÜ</div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="bg-white overflow-hidden shadow rounded-lg">
                            <div class="p-5">
                                <div class="flex items-center">
                                    <div class="flex-shrink-0">
                                        <div class="text-3xl">üìä</div>
                                    </div>
                                    <div class="ml-5 w-0 flex-1">
                                        <dl>
                                            <dt id="kelasLabel" class="text-sm font-medium text-gray-500 truncate">Kelas Diajar Hari Ini</dt>
                                            <dd id="totalKelas" class="text-lg font-medium text-gray-900">0</dd>
                                        </dl>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="bg-white shadow rounded-lg">
                        <div class="px-4 py-5 sm:p-6">
                            <h3 class="text-lg leading-6 font-medium text-gray-900 mb-4">Aktivitas Terbaru</h3>
                            <div id="recentActivity" class="space-y-3">
                                <p class="text-gray-500 text-center py-4">Belum ada aktivitas hari ini</p>
                            </div>
                            <div id="viewMoreContainer" class="hidden mt-4 text-center">
                                <button onclick="toggleAllActivities()" id="viewMoreBtn" class="text-blue-600 hover:text-blue-800 font-medium text-sm transition duration-200">
                                    Lihat Selengkapnya
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Tab Jurnal -->
                <div id="contentJurnal" class="tab-content hidden">
                    <div class="bg-white overflow-hidden shadow rounded-lg">
                        <div class="px-4 py-5 sm:p-6">
                            <h3 class="text-lg leading-6 font-medium text-gray-900 mb-4">Jurnal Pembelajaran</h3>
                            <form id="jurnalForm" class="space-y-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Kelas</label>
                                    <select id="kelasJurnal" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                                        <option value="">Pilih Kelas</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Materi</label>
                                    <textarea id="materi" required rows="3" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Masukkan materi pembelajaran..."></textarea>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Catatan</label>
                                    <textarea id="catatan" rows="2" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Catatan tambahan (opsional)..."></textarea>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Durasi Pembelajaran</label>
                                    <select id="jamPelajaran" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                                        <option value="">Pilih Durasi</option>
                                        <option value="1">1 Jam Pelajaran</option>
                                        <option value="2">2 Jam Pelajaran</option>
                                        <option value="3">3 Jam Pelajaran</option>
                                        <option value="4">4 Jam Pelajaran</option>
                                    </select>
                                </div>
                                <button type="submit" id="simpanJurnalBtn" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-medium py-2 px-4 rounded-lg transition duration-200 flex items-center justify-center">
                                    <span id="simpanJurnalText">Simpan Jurnal</span>
                                    <div id="simpanJurnalSpinner" class="loading ml-2 hidden"></div>
                                </button>
                            </form>
                        </div>
                    </div>
                </div>

                <!-- Tab Presensi -->
                <div id="contentPresensi" class="tab-content hidden">
                    <div class="bg-white overflow-hidden shadow rounded-lg">
                        <div class="px-4 py-5 sm:p-6">
                            <h3 class="text-lg leading-6 font-medium text-gray-900 mb-4">Daftar Kehadiran Siswa</h3>
                            <div class="space-y-4">
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Kelas</label>
                                        <select id="kelasAbsen" onchange="loadSiswa()" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                                            <option value="">Pilih Kelas</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Durasi Pembelajaran</label>
                                        <select id="jamAbsen" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                                            <option value="">Pilih Durasi</option>
                                            <option value="1">1 Jam Pelajaran</option>
                                            <option value="2">2 Jam Pelajaran</option>
                                            <option value="3">3 Jam Pelajaran</option>
                                            <option value="4">4 Jam Pelajaran</option>
                                        </select>
                                    </div>
                                </div>
                                
                                <div id="daftarSiswa" class="hidden">
                                    <div class="flex justify-between items-center mb-4">
                                        <h4 class="font-medium text-gray-900">Daftar Siswa</h4>
                                        <div class="flex space-x-2">
                                            <button onclick="bulkAction('Hadir')" class="px-3 py-1 bg-green-600 hover:bg-green-700 text-white text-sm rounded-lg transition duration-200">
                                                ‚úì Semua Hadir
                                            </button>
                                            <button onclick="resetAllStatus()" class="px-3 py-1 bg-gray-500 hover:bg-gray-600 text-white text-sm rounded-lg transition duration-200">
                                                üîÑ Reset
                                            </button>
                                        </div>
                                    </div>
                                    
                                    <div id="siswaList" class="space-y-3"></div>
                                    <button id="simpanAbsensiBtn" onclick="simpanAbsensi()" class="w-full mt-4 bg-green-600 hover:bg-green-700 text-white font-medium py-2 px-4 rounded-lg transition duration-200 flex items-center justify-center">
                                        <span id="simpanAbsensiText">Simpan Absensi</span>
                                        <div id="simpanAbsensiSpinner" class="loading ml-2 hidden"></div>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Dashboard Wali Kelas -->
    <div id="dashboardWaliKelas" class="hidden min-h-full">
        <nav class="bg-white shadow-sm border-b">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex justify-between h-16">
                    <div class="flex items-center">
                        <img src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEit19uUj7ZanvTG4uc5p6Fc8fkoORl6bLxNN-hB-9wDcw-l5IPwmpX5Q5w6lcIfFE_Qat_o3AMrLZ1jOaBu2A5IAF1sUhJJSrQe6Vf8NdvLMqafGbdbl4xgttpRbCS7dEy6PbZrUKyeutqx34O4mQTQ3Z4UtSbaoPR79ywyjwrxXUMolyZ7oro8bsRQ/s158/LOGO%20MTS4.png" 
                             alt="Logo" class="h-8 w-auto mr-3">
                        <h1 class="text-xl font-semibold text-gray-900">Dashboard Wali Kelas</h1>
                    </div>
                    <div class="flex items-center space-x-4">
                        <div class="flex items-center space-x-3">
                            <img id="profilePhotoWali" src="" alt="Foto Profil" class="h-10 w-10 rounded-full object-cover border-2 border-gray-300">
                            <div class="text-right">
                                <div id="welcomeMessageWali" class="text-gray-900 font-medium"></div>
                                <div id="kelasInfo" class="text-sm text-gray-600"></div>
                            </div>
                        </div>
                        <button onclick="logout()" class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-lg text-sm transition duration-200">
                            Logout
                        </button>
                    </div>
                </div>
            </div>
        </nav>

        <!-- Tab Navigation Wali Kelas -->
        <div class="bg-white border-b">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <nav class="flex space-x-8">
                    <button onclick="showWaliTab('overview')" id="tabOverview" class="tab-button py-4 px-1 border-b-2 border-blue-500 text-blue-600 font-medium text-sm">
                        Overview Kelas
                    </button>
                    <button onclick="showWaliTab('rekap')" id="tabRekap" class="tab-button py-4 px-1 border-b-2 border-transparent text-gray-500 hover:text-gray-700 font-medium text-sm">
                        Rekap Kehadiran
                    </button>
                    <button onclick="showWaliTab('export')" id="tabExport" class="tab-button py-4 px-1 border-b-2 border-transparent text-gray-500 hover:text-gray-700 font-medium text-sm">
                        Export Data
                    </button>
                </nav>
            </div>
        </div>

        <div class="max-w-7xl mx-auto py-6 sm:px-6 lg:px-8">
            <div class="px-4 py-6 sm:px-0">
                
                <!-- Tab Overview -->
                <div id="contentOverview" class="tab-content">
                    <!-- Filter Section -->
                    <div class="bg-white shadow rounded-lg mb-6">
                        <div class="px-4 py-5 sm:p-6">
                            <h3 class="text-lg leading-6 font-medium text-gray-900 mb-4">Filter Data</h3>
                            <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Periode</label>
                                    <select id="filterPeriodeWali" onchange="updateWaliFilter()" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                                        <option value="today">Hari Ini</option>
                                        <option value="week">Minggu Ini</option>
                                        <option value="month">Bulan Ini</option>
                                        <option value="lastmonth">Bulan Lalu</option>
                                        <option value="custom">Custom</option>
                                    </select>
                                </div>
                                <div id="customDateFromWali" class="hidden">
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Dari Tanggal</label>
                                    <input type="date" id="dateFromWali" onchange="updateWaliFilter()" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                                </div>
                                <div id="customDateToWali" class="hidden">
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Sampai Tanggal</label>
                                    <input type="date" id="dateToWali" onchange="updateWaliFilter()" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                                </div>
                                <div class="flex items-end">
                                    <button onclick="resetWaliFilter()" class="w-full bg-gray-500 hover:bg-gray-600 text-white font-medium py-2 px-4 rounded-lg transition duration-200">
                                        Reset Filter
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-6">
                        <div class="bg-white overflow-hidden shadow rounded-lg">
                            <div class="p-5">
                                <div class="flex items-center">
                                    <div class="flex-shrink-0">
                                        <div class="text-3xl">üë•</div>
                                    </div>
                                    <div class="ml-5 w-0 flex-1">
                                        <dl>
                                            <dt class="text-sm font-medium text-gray-500 truncate">Total Siswa</dt>
                                            <dd id="totalSiswaWali" class="text-lg font-medium text-gray-900">0</dd>
                                        </dl>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="bg-white overflow-hidden shadow rounded-lg">
                            <div class="p-5">
                                <div class="flex items-center">
                                    <div class="flex-shrink-0">
                                        <div class="text-3xl">‚úÖ</div>
                                    </div>
                                    <div class="ml-5 w-0 flex-1">
                                        <dl>
                                            <dt id="hadirLabelWali" class="text-sm font-medium text-gray-500 truncate">Rata-rata Kehadiran Hari Ini</dt>
                                            <dd id="rataHadirWali" class="text-lg font-medium text-green-600">0%</dd>
                                        </dl>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="bg-white overflow-hidden shadow rounded-lg">
                            <div class="p-5">
                                <div class="flex items-center">
                                    <div class="flex-shrink-0">
                                        <div class="text-3xl">üìö</div>
                                    </div>
                                    <div class="ml-5 w-0 flex-1">
                                        <dl>
                                            <dt id="jurnalLabelWali" class="text-sm font-medium text-gray-500 truncate">Total Jurnal Hari Ini</dt>
                                            <dd id="totalJurnalWali" class="text-lg font-medium text-gray-900">0</dd>
                                        </dl>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="bg-white overflow-hidden shadow rounded-lg cursor-pointer hover:bg-gray-50 transition-colors" onclick="showSiswaBermasalah()">
                            <div class="p-5">
                                <div class="flex items-center">
                                    <div class="flex-shrink-0">
                                        <div class="text-3xl">‚ö†Ô∏è</div>
                                    </div>
                                    <div class="ml-5 w-0 flex-1">
                                        <dl>
                                            <dt id="masalahLabelWali" class="text-sm font-medium text-gray-500 truncate">Siswa Bermasalah Hari Ini</dt>
                                            <dd id="siswaBermasalahWali" class="text-lg font-medium text-red-600">0</dd>
                                        </dl>
                                    </div>
                                    <div class="flex-shrink-0">
                                        <div class="text-gray-400">üëÜ</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="bg-white shadow rounded-lg">
                        <div class="px-4 py-5 sm:p-6">
                            <h3 class="text-lg leading-6 font-medium text-gray-900 mb-4">Aktivitas Pembelajaran Terbaru</h3>
                            <div id="recentActivityWali" class="space-y-3">
                                <p class="text-gray-500 text-center py-4">Belum ada aktivitas hari ini</p>
                            </div>
                            <div id="viewMoreContainerWali" class="hidden mt-4 text-center">
                                <button onclick="toggleAllActivitiesWali()" id="viewMoreBtnWali" class="text-blue-600 hover:text-blue-800 font-medium text-sm transition duration-200">
                                    Lihat Selengkapnya
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Tab Rekap -->
                <div id="contentRekap" class="tab-content hidden">
                    <div class="bg-white shadow rounded-lg">
                        <div class="px-4 py-5 sm:p-6">
                            <div class="flex justify-between items-center mb-4">
                                <h3 class="text-lg leading-6 font-medium text-gray-900">Rekap Kehadiran Siswa</h3>
                                <div class="flex items-center space-x-3">
                                    <button onclick="downloadWaliRekapExcel()" id="downloadWaliBtn" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg text-sm transition duration-200 flex items-center">
                                        <span id="downloadWaliBtnText">üìä Download Excel</span>
                                        <div id="downloadWaliSpinner" class="loading ml-2 hidden"></div>
                                    </button>
                                    <div class="text-sm text-gray-600">
                                        Filter mengikuti periode dari Overview
                                    </div>
                                </div>
                            </div>
                            
                            <div class="overflow-x-auto">
                                <div id="rekapKehadiranContainer" class="min-w-full">
                                    <div class="text-center py-8">
                                        <div class="loading mx-auto mb-4"></div>
                                        <p class="text-gray-500">Memuat data kehadiran...</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Tab Export -->
                <div id="contentExport" class="tab-content hidden">
                    <div class="bg-white shadow rounded-lg">
                        <div class="px-4 py-5 sm:p-6">
                            <h3 class="text-lg leading-6 font-medium text-gray-900 mb-4">Export Data</h3>
                            <div class="space-y-4">
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Jenis Data</label>
                                        <select id="exportType" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                                            <option value="kehadiran">Rekap Kehadiran</option>
                                            <option value="jurnal">Jurnal Pembelajaran</option>
                                            <option value="absensi">Data Absensi Detail</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Periode Export</label>
                                        <select id="exportPeriode" onchange="toggleExportCustomDate()" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                                            <option value="week">Minggu Ini</option>
                                            <option value="month">Bulan Ini</option>
                                            <option value="lastmonth">Bulan Lalu</option>
                                            <option value="custom">Custom</option>
                                        </select>
                                    </div>
                                </div>
                                
                                <div id="exportCustomDate" class="hidden grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Dari Tanggal</label>
                                        <input type="date" id="exportDateFrom" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Sampai Tanggal</label>
                                        <input type="date" id="exportDateTo" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                                    </div>
                                </div>
                                
                                <button onclick="exportData()" id="exportBtn" class="w-full bg-green-600 hover:bg-green-700 text-white font-medium py-2 px-4 rounded-lg transition duration-200 flex items-center justify-center">
                                    <span id="exportBtnText">üìä Export ke Excel</span>
                                    <div id="exportSpinner" class="loading ml-2 hidden"></div>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Jurnal List -->
    <div id="modalJurnalList" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50">
        <div class="relative top-10 mx-auto p-5 border w-11/12 md:w-4/5 lg:w-3/4 shadow-lg rounded-md bg-white">
            <div class="mt-3">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-lg font-medium text-gray-900">Daftar Jurnal Pembelajaran</h3>
                    <button onclick="closeModalJurnalList()" class="text-gray-400 hover:text-gray-600 focus:outline-none">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                </div>
                <div id="daftarJurnalList" class="space-y-3 max-h-96 overflow-y-auto">
                    <!-- Content will be populated by JavaScript -->
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Activity Detail -->
    <div id="modalActivityDetail" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50">
        <div class="relative top-10 mx-auto p-5 border w-11/12 md:w-4/5 lg:w-3/4 shadow-lg rounded-md bg-white">
            <div class="mt-3">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-lg font-medium text-gray-900">Detail Aktivitas Pembelajaran</h3>
                    <button onclick="closeModalActivityDetail()" class="text-gray-400 hover:text-gray-600 focus:outline-none">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                </div>
                <div id="activityDetailContent" class="max-h-96 overflow-y-auto">
                    <!-- Content will be populated by JavaScript -->
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Siswa Bermasalah -->
    <div id="modalSiswaBermasalah" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50">
        <div class="relative top-20 mx-auto p-5 border w-11/12 md:w-3/4 lg:w-1/2 shadow-lg rounded-md bg-white">
            <div class="mt-3">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-lg font-medium text-gray-900">Detail Siswa Bermasalah</h3>
                    <button onclick="closeModalSiswaBermasalah()" class="text-gray-400 hover:text-gray-600 focus:outline-none">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                </div>
                <div id="daftarSiswaBermasalah" class="space-y-3 max-h-96 overflow-y-auto">
                    <!-- Content will be populated by JavaScript -->
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Rekap Kehadiran Guru -->
    <div id="modalRekapGuru" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50">
        <div class="relative top-5 mx-auto p-5 border w-11/12 md:w-11/12 lg:w-11/12 shadow-lg rounded-md bg-white">
            <div class="mt-3">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-lg font-medium text-gray-900">Rekap Kehadiran Siswa - Pembelajaran Saya</h3>
                    <div class="flex items-center space-x-3">
                        <button onclick="downloadGuruRekapExcel()" id="downloadGuruBtn" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg text-sm transition duration-200 flex items-center">
                            <span id="downloadGuruBtnText">üìä Download Excel</span>
                            <div id="downloadGuruSpinner" class="loading ml-2 hidden"></div>
                        </button>
                        <button onclick="closeModalRekapGuru()" class="text-gray-400 hover:text-gray-600 focus:outline-none">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                            </svg>
                        </button>
                    </div>
                </div>
                <div id="rekapGuruContainer" class="overflow-x-auto max-h-96 overflow-y-auto">
                    <!-- Content will be populated by JavaScript -->
                </div>
            </div>
        </div>
    </div>

    <script>
        let currentUser = null;
        let userData = [];
        let classData = [];
        let jurnalDataGlobal = [];
        let absensiDataGlobal = [];
        let showingAllActivities = false;
        let showingAllActivitiesWali = false;

        // Data akan dimuat dari Google Sheets

        // Load user data and class data on page load
        window.onload = async function() {
            try {
                // Show loading state
                const loginBtn = document.getElementById('loginBtn');
                const loginBtnText = document.getElementById('loginBtnText');
                const loginSpinner = document.getElementById('loginSpinner');
                
                loginBtn.disabled = true;
                loginBtnText.textContent = 'Memuat data...';
                loginSpinner.classList.remove('hidden');
                
                // Load all data
                await loadUserData();
                await loadClassData();
                await loadJurnalData();
                await loadAbsensiData();
                
                // Reset login button
                loginBtn.disabled = false;
                loginBtnText.textContent = 'Masuk';
                loginSpinner.classList.add('hidden');
                
                console.log('Semua data berhasil dimuat');
                
            } catch (error) {
                console.error('Error loading data:', error);
                showNotification('Gagal memuat data. Silakan refresh halaman.', 'error');
            }
            
            // Add password toggle event listener
            document.getElementById('togglePassword').addEventListener('click', function() {
                togglePasswordVisibility();
            });
        };

        async function loadUserData() {
            try {
                console.log('Mencoba memuat data user dari Google Sheets...');
                
                const url = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vRZw29qfDE0eX9LT1HRLwtSP_MuFJMx900bjb55WUcSzre0sjcx-HpI7GpwAqTy6D5Neb9slRbkboNx/pub?gid=0&single=true&output=csv';
                
                const response = await fetch(url);
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const csvText = await response.text();
                
                if (!csvText || csvText.includes('<!DOCTYPE html>')) {
                    throw new Error('Invalid CSV response');
                }
                
                userData = parseCSV(csvText);
                console.log('Data user berhasil dimuat dari Google Sheets:', userData.length, 'records');
                
            } catch (error) {
                console.error('Gagal memuat data user dari Google Sheets:', error.message);
                userData = [];
                showNotification('Gagal memuat data login. Silakan refresh halaman.', 'error');
            }
        }

        async function loadClassData() {
            try {
                console.log('Mencoba memuat data kelas dari Google Sheets...');
                
                const url = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vRyCpgTY6rAY1jfRZSD0y_2Lem7m9YSvuU710VC7yz2eAGz3eXbymWjW1elNhWmAHNrbL8VypeFzDV5/pub?gid=0&single=true&output=csv';
                
                const response = await fetch(url);
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const csvText = await response.text();
                
                if (!csvText || csvText.includes('<!DOCTYPE html>')) {
                    throw new Error('Invalid CSV response');
                }
                
                classData = parseCSV(csvText);
                console.log('Data kelas berhasil dimuat dari Google Sheets:', classData.length, 'records');
                populateKelasOptions();
                
            } catch (error) {
                console.error('Gagal memuat data kelas dari Google Sheets:', error.message);
                classData = [];
                showNotification('Gagal memuat data kelas. Silakan refresh halaman.', 'error');
            }
        }

        async function loadJurnalData() {
            try {
                console.log('Mencoba memuat data jurnal dari Google Sheets...');
                
                const url = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vT-qW4AiW4D_Xv5Relg-JP9SI9ZsSWlGcDz76ZHRFyvdMC9ynKWJ6-s-XLx-KpWWzaBs53saQuslyBr/pub?gid=636350518&single=true&output=csv';
                
                let sheetsJurnalData = [];
                
                try {
                    const response = await fetch(url);
                    
                    if (response.ok) {
                        const csvText = await response.text();
                        if (csvText && !csvText.includes('<!DOCTYPE html>')) {
                            sheetsJurnalData = parseCSV(csvText);
                            console.log('Data jurnal berhasil dimuat dari Google Sheets:', sheetsJurnalData.length, 'records');
                        }
                    }
                } catch (e) {
                    console.warn('Gagal memuat data jurnal dari Google Sheets:', e.message);
                }
                
                // Combine with localStorage data
                const localJurnalData = getLocalStorageData('jurnal');
                jurnalDataGlobal = [...sheetsJurnalData, ...localJurnalData];
                console.log('Total data jurnal (Sheets + localStorage):', jurnalDataGlobal.length, 'records');
                
            } catch (error) {
                console.warn('Error loading jurnal data:', error.message);
                jurnalDataGlobal = getLocalStorageData('jurnal');
                console.log('Menggunakan data jurnal dari localStorage:', jurnalDataGlobal.length, 'records');
            }
        }

        async function loadAbsensiData() {
            try {
                console.log('Mencoba memuat data absensi dari Google Sheets...');
                
                const url = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vT-qW4AiW4D_Xv5Relg-JP9SI9ZsSWlGcDz76ZHRFyvdMC9ynKWJ6-s-XLx-KpWWzaBs53saQuslyBr/pub?gid=1687404390&single=true&output=csv';
                
                let sheetsAbsensiData = [];
                
                try {
                    const response = await fetch(url);
                    
                    if (response.ok) {
                        const csvText = await response.text();
                        if (csvText && !csvText.includes('<!DOCTYPE html>')) {
                            sheetsAbsensiData = parseCSV(csvText);
                            console.log('Data absensi berhasil dimuat dari Google Sheets:', sheetsAbsensiData.length, 'records');
                        }
                    }
                } catch (e) {
                    console.warn('Gagal memuat data absensi dari Google Sheets:', e.message);
                }
                
                // Combine with localStorage data
                const localAbsensiData = getLocalStorageData('absensi');
                absensiDataGlobal = [...sheetsAbsensiData, ...localAbsensiData];
                console.log('Total data absensi (Sheets + localStorage):', absensiDataGlobal.length, 'records');
                
            } catch (error) {
                console.warn('Error loading absensi data:', error.message);
                absensiDataGlobal = getLocalStorageData('absensi');
                console.log('Menggunakan data absensi dari localStorage:', absensiDataGlobal.length, 'records');
            }
        }

        function getAllJurnalData() {
            return jurnalDataGlobal;
        }

        function getAllAbsensiData() {
            return absensiDataGlobal;
        }

        function parseCSV(csvText) {
            const lines = csvText.trim().split('\n');
            if (lines.length === 0) return [];
            
            // Parse headers - handle quoted values
            const headers = parseCSVLine(lines[0]);
            console.log('CSV Headers:', headers);
            
            const data = [];
            
            for (let i = 1; i < lines.length; i++) {
                if (lines[i].trim() === '') continue; // Skip empty lines
                
                const values = parseCSVLine(lines[i]);
                const row = {};
                
                headers.forEach((header, index) => {
                    row[header] = values[index] || '';
                });
                
                // Only add non-empty rows
                if (Object.values(row).some(value => value.trim() !== '')) {
                    data.push(row);
                }
            }
            
            console.log('Parsed CSV rows:', data.length);
            return data;
        }
        
        function parseCSVLine(line) {
            const result = [];
            let current = '';
            let inQuotes = false;
            
            for (let i = 0; i < line.length; i++) {
                const char = line[i];
                
                if (char === '"') {
                    inQuotes = !inQuotes;
                } else if (char === ',' && !inQuotes) {
                    result.push(current.trim());
                    current = '';
                } else {
                    current += char;
                }
            }
            
            result.push(current.trim());
            return result;
        }

        function populateKelasOptions() {
            const kelasSet = new Set();
            classData.forEach(row => {
                if (row.Kelas) {
                    kelasSet.add(row.Kelas);
                }
            });
            
            const kelasOptions = Array.from(kelasSet).sort();
            const kelasJurnal = document.getElementById('kelasJurnal');
            const kelasAbsen = document.getElementById('kelasAbsen');
            const filterKelas = document.getElementById('filterKelas');
            
            kelasOptions.forEach(kelas => {
                kelasJurnal.appendChild(new Option(kelas, kelas));
                kelasAbsen.appendChild(new Option(kelas, kelas));
                filterKelas.appendChild(new Option(kelas, kelas));
            });
        }

        document.getElementById('loginForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const username = document.getElementById('username').value.trim();
            const password = document.getElementById('password').value.trim();
            const userType = document.getElementById('userType').value;
            
            const loginBtn = document.getElementById('loginBtn');
            const loginBtnText = document.getElementById('loginBtnText');
            const loginSpinner = document.getElementById('loginSpinner');
            const loginError = document.getElementById('loginError');
            
            // Show loading state
            loginBtn.disabled = true;
            loginBtnText.textContent = 'Memproses...';
            loginSpinner.classList.remove('hidden');
            loginError.classList.add('hidden');
            
            console.log('Login attempt:', { username, userType });
            console.log('Available users:', userData);
            
            // Validate inputs
            if (!username || !password || !userType) {
                loginError.textContent = 'Semua field harus diisi';
                loginError.classList.remove('hidden');
                loginBtn.disabled = false;
                loginBtnText.textContent = 'Masuk';
                loginSpinner.classList.add('hidden');
                return;
            }
            
            // Find user in data
            let user = null;
            for (let i = 0; i < userData.length; i++) {
                const u = userData[i];
                const userUsername = (u.Username || '').toString().trim();
                const userPassword = (u.Password || '').toString().trim();
                
                console.log('Checking user:', userUsername, 'vs', username);
                
                if (userUsername.toLowerCase() === username.toLowerCase() && userPassword === password) {
                    user = u;
                    break;
                }
            }
            
            console.log('Found user:', user);
            
            if (!user) {
                loginError.textContent = 'Username atau password salah';
                loginError.classList.remove('hidden');
                loginBtn.disabled = false;
                loginBtnText.textContent = 'Masuk';
                loginSpinner.classList.add('hidden');
                return;
            }
            
            // Check if user type matches
            if (userType === 'walikelas') {
                const waliKelas = user['Wali Kelas'] || '';
                if (!waliKelas || waliKelas.trim() === '') {
                    loginError.textContent = 'User ini bukan wali kelas';
                    loginError.classList.remove('hidden');
                    loginBtn.disabled = false;
                    loginBtnText.textContent = 'Masuk';
                    loginSpinner.classList.add('hidden');
                    return;
                }
            }
            
            // Login successful
            currentUser = user;
            console.log('Login successful for:', currentUser['Nama Guru']);
            
            // Refresh data after login
            await loadJurnalData();
            await loadAbsensiData();
            
            // Hide login page
            document.getElementById('loginPage').classList.add('hidden');
            
            if (userType === 'guru') {
                // Show guru dashboard
                document.getElementById('dashboardGuru').classList.remove('hidden');
                document.getElementById('welcomeMessage').textContent = user['Nama Guru'] || 'Guru';
                document.getElementById('mapelInfo').textContent = `Guru ${user.Mapel || 'Mata Pelajaran'}`;
                
                const photoUrl = user.Foto || `https://via.placeholder.com/40x40/4F46E5/FFFFFF?text=${(user['Nama Guru'] || 'G').charAt(0)}`;
                document.getElementById('profilePhoto').src = photoUrl;
                
                showTab('dashboard');
                updateDashboardStats();
                
            } else if (userType === 'walikelas') {
                // Show wali kelas dashboard
                document.getElementById('dashboardWaliKelas').classList.remove('hidden');
                document.getElementById('welcomeMessageWali').textContent = user['Nama Guru'] || 'Wali Kelas';
                
                const waliKelas = user['Wali Kelas'] || '';
                document.getElementById('kelasInfo').textContent = `Wali Kelas ${waliKelas}`;
                
                const photoUrl = user.Foto || `https://via.placeholder.com/40x40/4F46E5/FFFFFF?text=${(user['Nama Guru'] || 'W').charAt(0)}`;
                document.getElementById('profilePhotoWali').src = photoUrl;
                
                showWaliTab('overview');
                updateWaliDashboard();
                // Initial load of rekap kehadiran
                setTimeout(() => {
                    updateRekapKehadiran();
                }, 500);
            }
            
            // Reset form and loading state
            document.getElementById('loginForm').reset();
            loginBtn.disabled = false;
            loginBtnText.textContent = 'Masuk';
            loginSpinner.classList.add('hidden');
            
            showNotification('Login berhasil!', 'success');
        });

        document.getElementById('jurnalForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            // Show loading state
            const btn = document.getElementById('simpanJurnalBtn');
            const btnText = document.getElementById('simpanJurnalText');
            const spinner = document.getElementById('simpanJurnalSpinner');
            
            btn.disabled = true;
            btnText.textContent = 'Menyimpan...';
            spinner.classList.remove('hidden');
            
            const formData = {
                timestamp: new Date().toLocaleString('id-ID'),
                namaGuru: currentUser['Nama Guru'],
                kelas: document.getElementById('kelasJurnal').value,
                mataPelajaran: currentUser.Mapel,
                materi: document.getElementById('materi').value,
                catatan: document.getElementById('catatan').value,
                jamPelajaran: document.getElementById('jamPelajaran').value
            };
            
            try {
                await submitToGoogleSheets('jurnal', formData);
                showNotification('Jurnal berhasil disimpan!', 'success');
                updateDashboardStats();
                document.getElementById('jurnalForm').reset();
            } catch (error) {
                console.error('Error saving jurnal:', error);
                showNotification('Gagal menyimpan jurnal', 'error');
            } finally {
                // Reset loading state
                btn.disabled = false;
                btnText.textContent = 'Simpan Jurnal';
                spinner.classList.add('hidden');
            }
        });

        function loadSiswa() {
            const kelas = document.getElementById('kelasAbsen').value;
            if (!kelas) {
                document.getElementById('daftarSiswa').classList.add('hidden');
                return;
            }
            
            const siswaList = document.getElementById('siswaList');
            const siswaKelas = classData.filter(row => row.Kelas === kelas);
            
            siswaList.innerHTML = '';
            
            siswaKelas.forEach((siswa, index) => {
                const siswaDiv = document.createElement('div');
                siswaDiv.className = 'p-4 bg-gray-50 rounded-lg border';
                siswaDiv.innerHTML = `
                    <div class="mb-3">
                        <span class="font-medium text-gray-900 text-lg">${siswa['Nama Siswa']}</span>
                    </div>
                    <div class="grid grid-cols-2 md:grid-cols-5 gap-2">
                        <label class="flex items-center p-2 bg-green-100 rounded-lg cursor-pointer hover:bg-green-200 transition-colors">
                            <input type="radio" name="status_${index}" value="Hadir" class="siswa-status mr-2" data-nama="${siswa['Nama Siswa']}">
                            <span class="text-sm font-medium text-green-800">‚úì Hadir</span>
                        </label>
                        <label class="flex items-center p-2 bg-yellow-100 rounded-lg cursor-pointer hover:bg-yellow-200 transition-colors">
                            <input type="radio" name="status_${index}" value="Sakit" class="siswa-status mr-2" data-nama="${siswa['Nama Siswa']}">
                            <span class="text-sm font-medium text-yellow-800">ü§í Sakit</span>
                        </label>
                        <label class="flex items-center p-2 bg-blue-100 rounded-lg cursor-pointer hover:bg-blue-200 transition-colors">
                            <input type="radio" name="status_${index}" value="Ijin" class="siswa-status mr-2" data-nama="${siswa['Nama Siswa']}">
                            <span class="text-sm font-medium text-blue-800">üìù Ijin</span>
                        </label>
                        <label class="flex items-center p-2 bg-red-100 rounded-lg cursor-pointer hover:bg-red-200 transition-colors">
                            <input type="radio" name="status_${index}" value="Alpha" class="siswa-status mr-2" data-nama="${siswa['Nama Siswa']}">
                            <span class="text-sm font-medium text-red-800">‚ùå Alpha</span>
                        </label>
                        <label class="flex items-center p-2 bg-purple-100 rounded-lg cursor-pointer hover:bg-purple-200 transition-colors">
                            <input type="radio" name="status_${index}" value="Bolos" class="siswa-status mr-2" data-nama="${siswa['Nama Siswa']}">
                            <span class="text-sm font-medium text-purple-800">üö´ Bolos</span>
                        </label>
                    </div>
                `;
                siswaList.appendChild(siswaDiv);
            });
            
            document.getElementById('daftarSiswa').classList.remove('hidden');
        }

        async function simpanAbsensi() {
            const kelas = document.getElementById('kelasAbsen').value;
            const jamPelajaran = document.getElementById('jamAbsen').value;
            
            if (!kelas || !jamPelajaran) {
                showNotification('Pilih kelas dan jam pelajaran terlebih dahulu', 'error');
                return;
            }
            
            const statusElements = document.querySelectorAll('.siswa-status:checked');
            const absensiData = [];
            
            statusElements.forEach(element => {
                const nama = element.getAttribute('data-nama');
                const status = element.value;
                
                absensiData.push({
                    timestamp: new Date().toLocaleString('id-ID'),
                    namaGuru: currentUser['Nama Guru'],
                    kelas: kelas,
                    namaSiswa: nama,
                    keterangan: status,
                    jamPelajaran: jamPelajaran
                });
            });
            
            if (absensiData.length === 0) {
                showNotification('Pilih status kehadiran untuk minimal satu siswa', 'error');
                return;
            }
            
            // Show loading state
            const btn = document.getElementById('simpanAbsensiBtn');
            const btnText = document.getElementById('simpanAbsensiText');
            const spinner = document.getElementById('simpanAbsensiSpinner');
            
            btn.disabled = true;
            btnText.textContent = `Menyimpan ${absensiData.length} data...`;
            spinner.classList.remove('hidden');
            
            try {
                // Submit data with optimized approach
                await submitToGoogleSheetsOptimized('absensi', absensiData);
                
                showNotification(`Absensi berhasil disimpan untuk ${absensiData.length} siswa!`, 'success');
                updateDashboardStats();
                document.getElementById('kelasAbsen').value = '';
                document.getElementById('jamAbsen').value = '';
                document.getElementById('daftarSiswa').classList.add('hidden');
            } catch (error) {
                console.error('Error saving absensi:', error);
                showNotification(`Gagal menyimpan absensi: ${error.message}`, 'error');
            } finally {
                // Reset loading state
                btn.disabled = false;
                btnText.textContent = 'Simpan Absensi';
                spinner.classList.add('hidden');
            }
        }

        function getLocalStorageData(type) {
            // Get all localStorage data for this type across all dates
            const allData = [];
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                if (key && key.startsWith(`${type}Data_`)) {
                    try {
                        const data = JSON.parse(localStorage.getItem(key) || '[]');
                        if (Array.isArray(data)) {
                            allData.push(...data);
                        } else {
                            allData.push(data);
                        }
                    } catch (e) {
                        console.error('Error parsing localStorage data:', key, e);
                    }
                }
            }
            return allData;
        }

        async function submitToGoogleSheets(type, data) {
            const appScriptUrl = 'https://script.google.com/macros/s/AKfycbwrcc2G4yipG9ZRQgSRuLXrDjLX2a1pMHBQq8aPIGqcK7TVltBWHwO-8wIrO8eQJ4pfng/exec';
            
            try {
                // Prepare data for Google Apps Script - handle both single and bulk data
                let payload;
                
                if (Array.isArray(data)) {
                    // For bulk data (absensi), send each item separately to match Apps Script structure
                    payload = {
                        type: type,
                        data: data[0] // Send first item structure for Apps Script to understand
                    };
                    
                    // Send each item individually for bulk data
                    for (const item of data) {
                        const itemPayload = {
                            type: type,
                            data: item
                        };
                        
                        console.log('Mengirim item ke Google Apps Script:', itemPayload);
                        
                        await fetch(appScriptUrl, {
                            method: 'POST',
                            mode: 'no-cors',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify(itemPayload)
                        });
                        
                        // Small delay between requests to avoid overwhelming the server
                        await new Promise(resolve => setTimeout(resolve, 100));
                    }
                } else {
                    // For single data (jurnal)
                    payload = {
                        type: type,
                        data: data
                    };
                    
                    console.log('Mengirim data ke Google Apps Script:', payload);
                    
                    await fetch(appScriptUrl, {
                        method: 'POST',
                        mode: 'no-cors',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(payload)
                    });
                }
                
                console.log('Data berhasil dikirim ke Google Apps Script');
                
                // Also store in localStorage as backup
                const today = new Date().toLocaleDateString('id-ID');
                const existingData = getLocalStorageData(type);
                
                if (Array.isArray(data)) {
                    existingData.push(...data);
                } else {
                    existingData.push(data);
                }
                
                localStorage.setItem(`${type}Data_${today}`, JSON.stringify(existingData));
                
                // Update global data arrays
                if (type === 'jurnal') {
                    if (Array.isArray(data)) {
                        jurnalDataGlobal.push(...data);
                    } else {
                        jurnalDataGlobal.push(data);
                    }
                } else if (type === 'absensi') {
                    if (Array.isArray(data)) {
                        absensiDataGlobal.push(...data);
                    } else {
                        absensiDataGlobal.push(data);
                    }
                }
                
                console.log(`Data ${type} berhasil disimpan. Total ${type}:`, 
                    type === 'jurnal' ? jurnalDataGlobal.length : absensiDataGlobal.length);
                
            } catch (error) {
                console.error('Error submitting to Google Apps Script:', error);
                
                // Fallback to localStorage only
                const today = new Date().toLocaleDateString('id-ID');
                const existingData = getLocalStorageData(type);
                
                if (Array.isArray(data)) {
                    existingData.push(...data);
                } else {
                    existingData.push(data);
                }
                
                localStorage.setItem(`${type}Data_${today}`, JSON.stringify(existingData));
                
                // Update global data arrays
                if (type === 'jurnal') {
                    if (Array.isArray(data)) {
                        jurnalDataGlobal.push(...data);
                    } else {
                        jurnalDataGlobal.push(data);
                    }
                } else if (type === 'absensi') {
                    if (Array.isArray(data)) {
                        absensiDataGlobal.push(...data);
                    } else {
                        absensiDataGlobal.push(data);
                    }
                }
                
                console.log(`Data ${type} disimpan di localStorage sebagai fallback. Total ${type}:`, 
                    type === 'jurnal' ? jurnalDataGlobal.length : absensiDataGlobal.length);
                
                // Don't throw error, let the UI show success since data is saved locally
            }
        }

        async function submitToGoogleSheetsOptimized(type, data) {
            try {
                // Store in localStorage immediately for instant feedback
                const today = new Date().toLocaleDateString('id-ID');
                const existingData = getLocalStorageData(type);
                
                if (Array.isArray(data)) {
                    existingData.push(...data);
                } else {
                    existingData.push(data);
                }
                
                localStorage.setItem(`${type}Data_${today}`, JSON.stringify(existingData));
                
                // Update global data arrays immediately
                if (type === 'jurnal') {
                    if (Array.isArray(data)) {
                        jurnalDataGlobal.push(...data);
                    } else {
                        jurnalDataGlobal.push(data);
                    }
                } else if (type === 'absensi') {
                    if (Array.isArray(data)) {
                        absensiDataGlobal.push(...data);
                    } else {
                        absensiDataGlobal.push(data);
                    }
                }
                
                console.log(`Data ${type} berhasil disimpan lokal. Total ${type}:`, 
                    type === 'jurnal' ? jurnalDataGlobal.length : absensiDataGlobal.length);
                
                // Send to Google Sheets in background (fire and forget)
                const appScriptUrl = 'https://script.google.com/macros/s/AKfycbwrcc2G4yipG9ZRQgSRuLXrDjLX2a1pMHBQq8aPIGqcK7TVltBWHwO-8wIrO8eQJ4pfng/exec';
                
                if (Array.isArray(data)) {
                    // Send bulk data as single request
                    const payload = {
                        type: type,
                        bulkData: data
                    };
                    
                    fetch(appScriptUrl, {
                        method: 'POST',
                        mode: 'no-cors',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(payload)
                    }).catch(error => {
                        console.warn('Background sync to Google Sheets failed:', error);
                    });
                } else {
                    const payload = {
                        type: type,
                        data: data
                    };
                    
                    fetch(appScriptUrl, {
                        method: 'POST',
                        mode: 'no-cors',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(payload)
                    }).catch(error => {
                        console.warn('Background sync to Google Sheets failed:', error);
                    });
                }
                
            } catch (error) {
                console.error('Error in optimized submit:', error);
                throw error;
            }
        }

        function showTab(tabName) {
            // Hide all tab contents
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.add('hidden');
            });
            
            // Remove active class from all tabs
            document.querySelectorAll('.tab-button').forEach(button => {
                button.classList.remove('border-blue-500', 'text-blue-600');
                button.classList.add('border-transparent', 'text-gray-500');
            });
            
            // Show selected tab content
            document.getElementById(`content${tabName.charAt(0).toUpperCase() + tabName.slice(1)}`).classList.remove('hidden');
            
            // Add active class to selected tab
            const activeTab = document.getElementById(`tab${tabName.charAt(0).toUpperCase() + tabName.slice(1)}`);
            activeTab.classList.remove('border-transparent', 'text-gray-500');
            activeTab.classList.add('border-blue-500', 'text-blue-600');
        }

        function showWaliTab(tabName) {
            // Hide all tab contents
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.add('hidden');
            });
            
            // Remove active class from all tabs
            document.querySelectorAll('.tab-button').forEach(button => {
                button.classList.remove('border-blue-500', 'text-blue-600');
                button.classList.add('border-transparent', 'text-gray-500');
            });
            
            // Show selected tab content
            document.getElementById(`content${tabName.charAt(0).toUpperCase() + tabName.slice(1)}`).classList.remove('hidden');
            
            // Add active class to selected tab
            const activeTab = document.getElementById(`tab${tabName.charAt(0).toUpperCase() + tabName.slice(1)}`);
            activeTab.classList.remove('border-transparent', 'text-gray-500');
            activeTab.classList.add('border-blue-500', 'text-blue-600');
            
            // Update rekap kehadiran when switching to rekap tab
            if (tabName === 'rekap') {
                setTimeout(() => {
                    updateRekapKehadiran();
                }, 100);
            }
        }

        function toggleAllActivities() {
            showingAllActivities = !showingAllActivities;
            updateDashboardStats();
        }

        function toggleAllActivitiesWali() {
            showingAllActivitiesWali = !showingAllActivitiesWali;
            updateWaliDashboard();
        }

        function updateDashboardStats() {
            const filterPeriode = document.getElementById('filterPeriode').value;
            const filterKelas = document.getElementById('filterKelas').value;
            const dateFrom = document.getElementById('dateFrom').value;
            const dateTo = document.getElementById('dateTo').value;
            
            let periodLabel = '';
            let dateRange = [];
            
            // Determine date range based on filter
            if (filterPeriode === 'today') {
                const today = new Date();
                dateRange = [today.toLocaleDateString('id-ID')];
                periodLabel = 'Hari Ini';
            } else if (filterPeriode === 'week') {
                const today = new Date();
                const startOfWeek = new Date(today.setDate(today.getDate() - today.getDay()));
                dateRange = [];
                for (let i = 0; i < 7; i++) {
                    const date = new Date(startOfWeek);
                    date.setDate(startOfWeek.getDate() + i);
                    dateRange.push(date.toLocaleDateString('id-ID'));
                }
                periodLabel = 'Minggu Ini';
            } else if (filterPeriode === 'month') {
                const today = new Date();
                const year = today.getFullYear();
                const month = today.getMonth();
                const daysInMonth = new Date(year, month + 1, 0).getDate();
                dateRange = [];
                for (let i = 1; i <= daysInMonth; i++) {
                    const date = new Date(year, month, i);
                    dateRange.push(date.toLocaleDateString('id-ID'));
                }
                periodLabel = 'Bulan Ini';
            } else if (filterPeriode === 'lastmonth') {
                const today = new Date();
                const year = today.getFullYear();
                const month = today.getMonth() - 1;
                const daysInMonth = new Date(year, month + 1, 0).getDate();
                dateRange = [];
                for (let i = 1; i <= daysInMonth; i++) {
                    const date = new Date(year, month, i);
                    dateRange.push(date.toLocaleDateString('id-ID'));
                }
                periodLabel = 'Bulan Lalu';
            } else if (filterPeriode === 'custom' && dateFrom && dateTo) {
                const start = new Date(dateFrom);
                const end = new Date(dateTo);
                dateRange = [];
                for (let d = new Date(start); d <= end; d.setDate(d.getDate() + 1)) {
                    dateRange.push(new Date(d).toLocaleDateString('id-ID'));
                }
                periodLabel = 'Custom';
            }
            
            console.log('Filter periode:', filterPeriode, 'Date range:', dateRange);
            console.log('Current user:', currentUser['Nama Guru']);
            
            // Load data from global arrays
            const jurnalData = getAllJurnalData();
            const absensiData = getAllAbsensiData();
            
            console.log('Data loaded - Jurnal:', jurnalData.length, 'Absensi:', absensiData.length);
            
            // Filter data by current user, date range, and class
            const filteredJurnal = jurnalData.filter(item => {
                // Check if guru name matches
                const guruName = item['Nama Guru'] || item['namaGuru'] || item['Guru'] || item.namaGuru;
                
                if (!guruName) {
                    return false;
                }
                
                // Normalize names for comparison
                const normalizedGuruName = guruName.toString().trim().toLowerCase().replace(/[^a-z\s]/g, '');
                const normalizedCurrentUser = currentUser['Nama Guru'].toString().trim().toLowerCase().replace(/[^a-z\s]/g, '');
                
                if (normalizedGuruName !== normalizedCurrentUser) {
                    return false;
                }
                
                // Check class filter
                if (filterKelas) {
                    const itemKelas = item.Kelas || item.kelas || '';
                    if (itemKelas !== filterKelas) {
                        return false;
                    }
                }
                
                // Check timestamp
                const timestamp = item.Timestamp || item.timestamp || item['Tanggal'] || item.tanggal;
                if (!timestamp) {
                    return false;
                }
                
                const parsedTime = parseTimestamp(timestamp);
                return parsedTime && (dateRange.length === 0 || dateRange.includes(parsedTime.dateString));
            });
            
            const filteredAbsensi = absensiData.filter(item => {
                // Check if guru name matches
                const guruName = item['Nama Guru'] || item['namaGuru'] || item['Guru'] || item.namaGuru;
                
                if (!guruName) {
                    return false;
                }
                
                // Normalize names for comparison
                const normalizedGuruName = guruName.toString().trim().toLowerCase().replace(/[^a-z\s]/g, '');
                const normalizedCurrentUser = currentUser['Nama Guru'].toString().trim().toLowerCase().replace(/[^a-z\s]/g, '');
                
                if (normalizedGuruName !== normalizedCurrentUser) {
                    return false;
                }
                
                // Check class filter
                if (filterKelas) {
                    const itemKelas = item.Kelas || item.kelas || '';
                    if (itemKelas !== filterKelas) {
                        return false;
                    }
                }
                
                // Check timestamp
                const timestamp = item.Timestamp || item.timestamp || item['Tanggal'] || item.tanggal;
                if (!timestamp) {
                    return false;
                }
                
                const parsedTime = parseTimestamp(timestamp);
                return parsedTime && (dateRange.length === 0 || dateRange.includes(parsedTime.dateString));
            });
            
            console.log('Filtered data - Jurnal:', filteredJurnal.length, 'Absensi:', filteredAbsensi.length);
            console.log('Sample filtered jurnal:', filteredJurnal.slice(0, 2));
            console.log('Sample filtered absensi:', filteredAbsensi.slice(0, 2));
            
            // Calculate stats from JURNAL data only
            const totalJurnal = filteredJurnal.length;
            const totalDurasi = filteredJurnal.reduce((sum, item) => {
                const jamPelajaran = item['Jam Pelajaran'] || item['jamPelajaran'] || item['JP'] || item.jamPelajaran || '0';
                return sum + parseInt(jamPelajaran.toString());
            }, 0);
            
            // Get unique classes from JURNAL data only
            const kelasFromJurnal = new Set();
            filteredJurnal.forEach(item => {
                const kelas = item.Kelas || item.kelas;
                if (kelas) {
                    kelasFromJurnal.add(kelas);
                }
            });
            
            // Group absensi by session (kelas + tanggal + jam) for counting sessions
            const absensiSessions = {};
            filteredAbsensi.forEach(item => {
                const kelas = item.Kelas || item.kelas || '';
                const jamPelajaran = item['Jam Pelajaran'] || item.jamPelajaran || '';
                const timestamp = item.Timestamp || item.timestamp || item['Tanggal'] || item.tanggal;
                
                let tanggal;
                try {
                    const timestampStr = timestamp.toString();
                    if (timestampStr.includes('/')) {
                        const parts = timestampStr.split(' ')[0].split('/');
                        if (parts.length === 3) {
                            const day = parseInt(parts[0]);
                            const month = parseInt(parts[1]);
                            const year = parseInt(parts[2]);
                            
                            if (day <= 31 && month <= 12) {
                                tanggal = new Date(year, month - 1, day).toLocaleDateString('id-ID');
                            } else {
                                tanggal = new Date(year, day - 1, month).toLocaleDateString('id-ID');
                            }
                        }
                    } else {
                        tanggal = new Date(timestampStr).toLocaleDateString('id-ID');
                    }
                } catch (e) {
                    tanggal = timestampStr;
                }
                
                const sessionKey = `${kelas}_${tanggal}_${jamPelajaran}`;
                if (!absensiSessions[sessionKey]) {
                    absensiSessions[sessionKey] = {
                        kelas: kelas,
                        tanggal: tanggal,
                        jamPelajaran: jamPelajaran,
                        siswa: []
                    };
                }
                absensiSessions[sessionKey].siswa.push(item);
            });
            
            const totalPresensi = Object.keys(absensiSessions).length;
            
            // Update labels
            document.getElementById('jurnalLabel').textContent = `Total Jurnal ${periodLabel}`;
            document.getElementById('durasiLabel').textContent = `Total Durasi Mengajar ${periodLabel}`;
            document.getElementById('presensiLabel').textContent = `Total Sesi Absensi ${periodLabel}`;
            document.getElementById('kelasLabel').textContent = `Kelas Diajar ${periodLabel}`;
            
            // Update values
            document.getElementById('totalJurnal').textContent = totalJurnal;
            document.getElementById('totalDurasi').textContent = `${totalDurasi} JP`;
            document.getElementById('totalPresensi').textContent = totalPresensi;
            document.getElementById('totalKelas').textContent = kelasFromJurnal.size;
            
            // Update recent activity - combine jurnal and absensi data
            const activityContainer = document.getElementById('recentActivity');
            const combinedActivities = {};
            
            // Process jurnal data first
            filteredJurnal.forEach(item => {
                const kelas = item.Kelas || item.kelas || '';
                const materi = item.Materi || item.materi || '';
                const timestamp = item.Timestamp || item.timestamp || item['Tanggal'] || item.tanggal;
                const namaGuru = item['Nama Guru'] || item.namaGuru || item['Guru'] || item.namaGuru;
                
                if (!timestamp || !kelas || !materi || !namaGuru) {
                    return;
                }
                
                // Normalize guru name for comparison
                const normalizedGuruName = namaGuru.toString().trim().toLowerCase().replace(/[^a-z\s]/g, '');
                const normalizedCurrentUser = currentUser['Nama Guru'].toString().trim().toLowerCase().replace(/[^a-z\s]/g, '');
                
                if (normalizedGuruName !== normalizedCurrentUser) {
                    return;
                }
                
                try {
                    let dateKey;
                    const timestampStr = timestamp.toString();
                    
                    if (timestampStr.includes('/')) {
                        const parts = timestampStr.split(' ')[0].split('/');
                        if (parts.length === 3) {
                            const day = parts[0].length === 1 ? '0' + parts[0] : parts[0];
                            const month = parts[1].length === 1 ? '0' + parts[1] : parts[1];
                            const year = parts[2];
                            dateKey = `${day}/${month}/${year}`;
                        }
                    }
                    
                    if (dateKey) {
                        const activityKey = `${dateKey}_${kelas}_${normalizedCurrentUser}`;
                        if (!combinedActivities[activityKey]) {
                            combinedActivities[activityKey] = {
                                date: dateKey,
                                kelas: kelas,
                                namaGuru: namaGuru,
                                jurnal: null,
                                absensi: null,
                                timestamp: timestampStr,
                                fullTimestamp: new Date(timestampStr)
                            };
                        }
                        combinedActivities[activityKey].jurnal = {
                            materi: materi,
                            jamPelajaran: item['Jam Pelajaran'] || item.jamPelajaran || '1'
                        };
                    }
                } catch (e) {
                    console.error('Error parsing jurnal timestamp:', timestamp, e);
                }
            });
            
            // Process absensi data and match with jurnal
            filteredAbsensi.forEach(item => {
                const kelas = item.Kelas || item.kelas || '';
                const timestamp = item.Timestamp || item.timestamp || item['Tanggal'] || item.tanggal;
                const namaGuru = item['Nama Guru'] || item.namaGuru || item['Guru'] || item.namaGuru;
                const namaSiswa = item['Nama Siswa'] || item.namaSiswa || item['Siswa'] || item.siswa;
                const status = item.Keterangan || item.keterangan || item.Status || item.status;
                
                if (!timestamp || !kelas || !namaGuru || !namaSiswa || !status) {
                    return;
                }
                
                // Normalize guru name for comparison
                const normalizedGuruName = namaGuru.toString().trim().toLowerCase().replace(/[^a-z\s]/g, '');
                const normalizedCurrentUser = currentUser['Nama Guru'].toString().trim().toLowerCase().replace(/[^a-z\s]/g, '');
                
                if (normalizedGuruName !== normalizedCurrentUser) {
                    return;
                }
                
                try {
                    let dateKey;
                    const timestampStr = timestamp.toString();
                    
                    if (timestampStr.includes('/')) {
                        const parts = timestampStr.split(' ')[0].split('/');
                        if (parts.length === 3) {
                            const day = parts[0].length === 1 ? '0' + parts[0] : parts[0];
                            const month = parts[1].length === 1 ? '0' + parts[1] : parts[1];
                            const year = parts[2];
                            dateKey = `${day}/${month}/${year}`;
                        }
                    }
                    
                    if (dateKey) {
                        const activityKey = `${dateKey}_${kelas}_${normalizedCurrentUser}`;
                        
                        // Initialize activity if not exists (for cases where absensi exists without jurnal)
                        if (!combinedActivities[activityKey]) {
                            combinedActivities[activityKey] = {
                                date: dateKey,
                                kelas: kelas,
                                namaGuru: namaGuru,
                                jurnal: null,
                                absensi: null,
                                timestamp: timestampStr,
                                fullTimestamp: new Date(timestampStr)
                            };
                        }
                        
                        // Initialize absensi data structure
                        if (!combinedActivities[activityKey].absensi) {
                            combinedActivities[activityKey].absensi = {
                                totalSiswa: 0,
                                hadir: 0,
                                sakit: 0,
                                ijin: 0,
                                alpha: 0,
                                bolos: 0,
                                siswaList: []
                            };
                        }
                        
                        const absensiData = combinedActivities[activityKey].absensi;
                        absensiData.totalSiswa++;
                        absensiData.siswaList.push({
                            nama: namaSiswa,
                            status: status
                        });
                        
                        // Count by status
                        const statusLower = status.toLowerCase();
                        if (statusLower === 'hadir') absensiData.hadir++;
                        else if (statusLower === 'sakit') absensiData.sakit++;
                        else if (statusLower === 'ijin') absensiData.ijin++;
                        else if (statusLower === 'alpha') absensiData.alpha++;
                        else if (statusLower === 'bolos') absensiData.bolos++;
                    }
                } catch (e) {
                    console.error('Error parsing absensi timestamp:', timestamp, e);
                }
            });
            
            // Only include activities that have either jurnal or absensi data
            const activities = Object.values(combinedActivities).filter(activity => {
                return (activity.jurnal && activity.jurnal.materi && activity.jurnal.materi.trim() !== '') || 
                       (activity.absensi && activity.absensi.totalSiswa > 0);
            });
            
            console.log('Final activities count:', activities.length);
            
            // Store activities for modal access
            currentActivities = activities;
            
            if (activities.length === 0) {
                activityContainer.innerHTML = `<p class="text-gray-500 text-center py-4">Belum ada aktivitas untuk periode ${periodLabel.toLowerCase()}</p>`;
                document.getElementById('viewMoreContainer').classList.add('hidden');
            } else {
                // Sort by date (newest first)
                activities.sort((a, b) => {
                    try {
                        const dateA = a.date.split('/');
                        const dateB = b.date.split('/');
                        const timestampA = new Date(dateA[2], dateA[1] - 1, dateA[0]);
                        const timestampB = new Date(dateB[2], dateB[1] - 1, dateB[0]);
                        return timestampB - timestampA;
                    } catch (e) {
                        return 0;
                    }
                });
                
                // Show activities based on toggle state
                let displayActivities;
                if (showingAllActivities) {
                    displayActivities = activities;
                    document.getElementById('viewMoreBtn').textContent = 'Sembunyikan';
                } else {
                    displayActivities = activities.slice(0, 5);
                    document.getElementById('viewMoreBtn').textContent = 'Lihat Selengkapnya';
                }
                
                // Show/hide view more button
                if (activities.length > 5) {
                    document.getElementById('viewMoreContainer').classList.remove('hidden');
                } else {
                    document.getElementById('viewMoreContainer').classList.add('hidden');
                }
                
                activityContainer.innerHTML = displayActivities.map((activity, index) => {
                    // Extract time from timestamp if available
                    let timeStr = '';
                    try {
                        if (activity.timestamp && activity.timestamp.includes(' ')) {
                            const timePart = activity.timestamp.split(' ')[1];
                            if (timePart) {
                                timeStr = ` ‚Ä¢ ${timePart}`;
                            }
                        }
                    } catch (e) {
                        // Ignore time extraction errors
                    }
                    
                    let content = `
                        <div class="flex items-start p-4 bg-gray-50 rounded-lg border cursor-pointer hover:bg-gray-100 transition-colors" onclick="showActivityDetail(${index})">
                            <div class="text-2xl mr-3">üìÖ</div>
                            <div class="flex-1">
                                <div class="flex items-center justify-between mb-3">
                                    <h4 class="text-sm font-semibold text-gray-900">${activity.kelas} - ${activity.date}${timeStr}</h4>
                                    <div class="flex items-center space-x-3">
                                        ${activity.absensi ? `
                                            <div class="text-right">
                                                <div class="text-xs font-medium text-green-600">${activity.absensi.hadir}/${activity.absensi.totalSiswa} Hadir</div>
                                                <div class="text-xs text-gray-500">${Math.round((activity.absensi.hadir / activity.absensi.totalSiswa) * 100)}% Kehadiran</div>
                                            </div>
                                        ` : ''}
                                        <div class="text-gray-400">üëÜ</div>
                                    </div>
                                </div>`;
                    
                    if (activity.jurnal) {
                        content += `
                            <div class="mb-3">
                                <div class="flex items-center text-xs text-blue-600 mb-1">
                                    <span class="mr-1">üìö</span>
                                    <span class="font-medium">Materi Pembelajaran (${activity.jurnal.jamPelajaran} JP)</span>
                                </div>
                                <p class="text-xs text-gray-700 ml-4 bg-blue-50 p-2 rounded border-l-2 border-blue-200">${activity.jurnal.materi}</p>
                            </div>`;
                    }
                    
                    if (activity.absensi) {
                        content += `
                            <div class="mb-2">
                                <div class="flex items-center text-xs text-green-600 mb-2">
                                    <span class="mr-1">üë•</span>
                                    <span class="font-medium">Kehadiran Siswa</span>
                                </div>
                                <div class="ml-4 grid grid-cols-2 md:grid-cols-5 gap-2 text-xs">`;
                        
                        if (activity.absensi.hadir > 0) {
                            content += `<span class="px-2 py-1 bg-green-100 text-green-800 rounded-full text-center">‚úì Hadir: ${activity.absensi.hadir}</span>`;
                        }
                        if (activity.absensi.sakit > 0) {
                            content += `<span class="px-2 py-1 bg-yellow-100 text-yellow-800 rounded-full text-center">ü§í Sakit: ${activity.absensi.sakit}</span>`;
                        }
                        if (activity.absensi.ijin > 0) {
                            content += `<span class="px-2 py-1 bg-blue-100 text-blue-800 rounded-full text-center">üìù Ijin: ${activity.absensi.ijin}</span>`;
                        }
                        if (activity.absensi.alpha > 0) {
                            content += `<span class="px-2 py-1 bg-red-100 text-red-800 rounded-full text-center">‚ùå Alpha: ${activity.absensi.alpha}</span>`;
                        }
                        if (activity.absensi.bolos > 0) {
                            content += `<span class="px-2 py-1 bg-purple-100 text-purple-800 rounded-full text-center">üö´ Bolos: ${activity.absensi.bolos}</span>`;
                        }
                        
                        content += `
                                </div>
                            </div>`;
                        
                        // Show detailed student list if not too many
                        if (activity.absensi.siswaList.length <= 10) {
                            content += `
                                <div class="ml-4 mt-2">
                                    <div class="text-xs text-gray-600 mb-1">Detail Siswa:</div>
                                    <div class="flex flex-wrap gap-1">`;
                            
                            activity.absensi.siswaList.forEach(siswa => {
                                const statusColor = siswa.status.toLowerCase() === 'hadir' ? 'bg-green-100 text-green-700' :
                                                   siswa.status.toLowerCase() === 'sakit' ? 'bg-yellow-100 text-yellow-700' :
                                                   siswa.status.toLowerCase() === 'ijin' ? 'bg-blue-100 text-blue-700' :
                                                   siswa.status.toLowerCase() === 'alpha' ? 'bg-red-100 text-red-700' :
                                                   'bg-purple-100 text-purple-700';
                                
                                content += `<span class="text-xs px-2 py-1 ${statusColor} rounded-full">${siswa.nama}</span>`;
                            });
                            
                            content += `
                                    </div>
                                </div>`;
                        } else {
                            content += `
                                <div class="ml-4 mt-2 text-xs text-gray-500">
                                    ${activity.absensi.totalSiswa} siswa total - Klik "Lihat Selengkapnya" untuk detail lengkap
                                </div>`;
                        }
                    }
                    
                    content += `
                            </div>
                        </div>`;
                    
                    return content;
                }).join('');
            }
        }

        function updateWaliDashboard() {
            const filterPeriode = document.getElementById('filterPeriodeWali').value;
            const dateFrom = document.getElementById('dateFromWali').value;
            const dateTo = document.getElementById('dateToWali').value;
            
            let periodLabel = '';
            let dateRange = [];
            
            // Determine date range based on filter
            if (filterPeriode === 'today') {
                const today = new Date();
                dateRange = [today.toLocaleDateString('id-ID')];
                periodLabel = 'Hari Ini';
            } else if (filterPeriode === 'week') {
                const today = new Date();
                const startOfWeek = new Date(today.setDate(today.getDate() - today.getDay()));
                dateRange = [];
                for (let i = 0; i < 7; i++) {
                    const date = new Date(startOfWeek);
                    date.setDate(startOfWeek.getDate() + i);
                    dateRange.push(date.toLocaleDateString('id-ID'));
                }
                periodLabel = 'Minggu Ini';
            } else if (filterPeriode === 'month') {
                const today = new Date();
                const year = today.getFullYear();
                const month = today.getMonth();
                const daysInMonth = new Date(year, month + 1, 0).getDate();
                dateRange = [];
                for (let i = 1; i <= daysInMonth; i++) {
                    const date = new Date(year, month, i);
                    dateRange.push(date.toLocaleDateString('id-ID'));
                }
                periodLabel = 'Bulan Ini';
            } else if (filterPeriode === 'lastmonth') {
                const today = new Date();
                const year = today.getFullYear();
                const month = today.getMonth() - 1;
                const daysInMonth = new Date(year, month + 1, 0).getDate();
                dateRange = [];
                for (let i = 1; i <= daysInMonth; i++) {
                    const date = new Date(year, month, i);
                    dateRange.push(date.toLocaleDateString('id-ID'));
                }
                periodLabel = 'Bulan Lalu';
            } else if (filterPeriode === 'custom' && dateFrom && dateTo) {
                const start = new Date(dateFrom);
                const end = new Date(dateTo);
                dateRange = [];
                for (let d = new Date(start); d <= end; d.setDate(d.getDate() + 1)) {
                    dateRange.push(new Date(d).toLocaleDateString('id-ID'));
                }
                periodLabel = 'Custom';
            }
            
            const kelasWali = currentUser['Wali Kelas'];
            
            // Get students in this class
            const siswaKelas = classData.filter(row => row.Kelas === kelasWali);
            const totalSiswa = siswaKelas.length;
            
            // Load data from global arrays
            const jurnalData = getAllJurnalData();
            const absensiData = getAllAbsensiData();
            
            // Filter data by class and date range
            const filteredJurnal = jurnalData.filter(item => {
                const kelas = item.Kelas || item.kelas || '';
                if (kelas !== kelasWali) return false;
                
                const timestamp = item.Timestamp || item.timestamp || item['Tanggal'] || item.tanggal;
                if (!timestamp) return false;
                
                const parsedTime = parseTimestamp(timestamp);
                return parsedTime && (dateRange.length === 0 || dateRange.includes(parsedTime.dateString));
            });
            
            const filteredAbsensi = absensiData.filter(item => {
                const kelas = item.Kelas || item.kelas || '';
                if (kelas !== kelasWali) return false;
                
                const timestamp = item.Timestamp || item.timestamp || item['Tanggal'] || item.tanggal;
                if (!timestamp) return false;
                
                const parsedTime = parseTimestamp(timestamp);
                return parsedTime && (dateRange.length === 0 || dateRange.includes(parsedTime.dateString));
            });
            
            // Calculate attendance rate
            const hadirCount = filteredAbsensi.filter(item => {
                const status = item.Keterangan || item.keterangan || item.Status || item.status;
                return status && status.toLowerCase() === 'hadir';
            }).length;
            
            const totalAbsensi = filteredAbsensi.length;
            const rataKehadiran = totalAbsensi > 0 ? Math.round((hadirCount / totalAbsensi) * 100) : 0;
            
            // Count problematic students (Alpha + Bolos)
            const siswaBermasalah = filteredAbsensi.filter(item => {
                const status = item.Keterangan || item.keterangan || item.Status || item.status;
                return status && (status.toLowerCase() === 'alpha' || status.toLowerCase() === 'bolos');
            }).length;
            
            // Update labels
            document.getElementById('hadirLabelWali').textContent = `Rata-rata Kehadiran ${periodLabel}`;
            document.getElementById('jurnalLabelWali').textContent = `Total Jurnal ${periodLabel}`;
            document.getElementById('masalahLabelWali').textContent = `Siswa Bermasalah ${periodLabel}`;
            
            // Update values
            document.getElementById('totalSiswaWali').textContent = totalSiswa;
            document.getElementById('rataHadirWali').textContent = `${rataKehadiran}%`;
            document.getElementById('totalJurnalWali').textContent = filteredJurnal.length;
            document.getElementById('siswaBermasalahWali').textContent = siswaBermasalah;
            
            // Update recent activity for wali kelas
            const activityContainer = document.getElementById('recentActivityWali');
            
            if (filteredJurnal.length === 0) {
                activityContainer.innerHTML = `<p class="text-gray-500 text-center py-4">Belum ada aktivitas pembelajaran untuk periode ${periodLabel.toLowerCase()}</p>`;
                document.getElementById('viewMoreContainerWali').classList.add('hidden');
            } else {
                // Sort by timestamp (newest first)
                const sortedJurnal = filteredJurnal.sort((a, b) => {
                    const timestampA = a.Timestamp || a.timestamp || a['Tanggal'] || a.tanggal;
                    const timestampB = b.Timestamp || b.timestamp || b['Tanggal'] || b.tanggal;
                    return new Date(timestampB) - new Date(timestampA);
                });
                
                // Show activities based on toggle state
                let displayActivities;
                if (showingAllActivitiesWali) {
                    displayActivities = sortedJurnal;
                    document.getElementById('viewMoreBtnWali').textContent = 'Sembunyikan';
                } else {
                    displayActivities = sortedJurnal.slice(0, 5);
                    document.getElementById('viewMoreBtnWali').textContent = 'Lihat Selengkapnya';
                }
                
                // Show/hide view more button
                if (sortedJurnal.length > 5) {
                    document.getElementById('viewMoreContainerWali').classList.remove('hidden');
                } else {
                    document.getElementById('viewMoreContainerWali').classList.add('hidden');
                }
                
                activityContainer.innerHTML = displayActivities.map(activity => {
                    const timestamp = activity.Timestamp || activity.timestamp || activity['Tanggal'] || activity.tanggal;
                    const materi = activity.Materi || activity.materi || '';
                    const namaGuru = activity['Nama Guru'] || activity.namaGuru || activity['Guru'] || activity.namaGuru;
                    const jamPelajaran = activity['Jam Pelajaran'] || activity.jamPelajaran || '1';
                    const mapel = activity['Mata Pelajaran'] || activity.mataPelajaran || activity.Mapel || activity.mapel || '';
                    
                    return `
                        <div class="flex items-start p-4 bg-gray-50 rounded-lg border">
                            <div class="text-2xl mr-3">üìö</div>
                            <div class="flex-1">
                                <div class="flex items-center justify-between mb-2">
                                    <h4 class="text-sm font-semibold text-gray-900">${mapel} - ${namaGuru}</h4>
                                    <span class="text-xs text-gray-500">${timestamp}</span>
                                </div>
                                <div class="mb-2">
                                    <div class="flex items-center text-xs text-blue-600 mb-1">
                                        <span class="mr-1">üìñ</span>
                                        <span class="font-medium">Materi (${jamPelajaran} JP)</span>
                                    </div>
                                    <p class="text-xs text-gray-700 ml-4 bg-blue-50 p-2 rounded border-l-2 border-blue-200">${materi}</p>
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');
            }
        }

        let currentDetailLevel = 1; // 1: daily, 2: pembelajaran, 3: individual
        let currentExpandedDate = null;
        let currentExpandedSubject = null;

        function updateRekapKehadiran() {
            // Use the same filter as overview
            const filterPeriode = document.getElementById('filterPeriodeWali').value;
            const dateFrom = document.getElementById('dateFromWali').value;
            const dateTo = document.getElementById('dateToWali').value;
            
            let dateRange = [];
            
            // Determine date range based on filter (same as overview)
            if (filterPeriode === 'today') {
                const today = new Date();
                dateRange = [today.toLocaleDateString('id-ID')];
            } else if (filterPeriode === 'week') {
                const today = new Date();
                const startOfWeek = new Date(today.setDate(today.getDate() - today.getDay()));
                dateRange = [];
                for (let i = 0; i < 7; i++) {
                    const date = new Date(startOfWeek);
                    date.setDate(startOfWeek.getDate() + i);
                    dateRange.push(date.toLocaleDateString('id-ID'));
                }
            } else if (filterPeriode === 'month') {
                const today = new Date();
                const year = today.getFullYear();
                const month = today.getMonth();
                const daysInMonth = new Date(year, month + 1, 0).getDate();
                dateRange = [];
                for (let i = 1; i <= daysInMonth; i++) {
                    const date = new Date(year, month, i);
                    dateRange.push(date.toLocaleDateString('id-ID'));
                }
            } else if (filterPeriode === 'lastmonth') {
                const today = new Date();
                const year = today.getFullYear();
                const month = today.getMonth() - 1;
                const daysInMonth = new Date(year, month + 1, 0).getDate();
                dateRange = [];
                for (let i = 1; i <= daysInMonth; i++) {
                    const date = new Date(year, month, i);
                    dateRange.push(date.toLocaleDateString('id-ID'));
                }
            } else if (filterPeriode === 'custom' && dateFrom && dateTo) {
                const start = new Date(dateFrom);
                const end = new Date(dateTo);
                dateRange = [];
                for (let d = new Date(start); d <= end; d.setDate(d.getDate() + 1)) {
                    dateRange.push(new Date(d).toLocaleDateString('id-ID'));
                }
            }
            
            const kelasWali = currentUser['Wali Kelas'];
            
            // Get students in this class
            const siswaKelas = classData.filter(row => row.Kelas === kelasWali);
            
            // Load both absensi and jurnal data
            const absensiData = getAllAbsensiData();
            const jurnalData = getAllJurnalData();
            
            // Filter data by class and date range
            const filteredAbsensi = absensiData.filter(item => {
                const kelas = item.Kelas || item.kelas || '';
                if (kelas !== kelasWali) return false;
                
                const timestamp = item.Timestamp || item.timestamp || item['Tanggal'] || item.tanggal;
                if (!timestamp) return false;
                
                const parsedTime = parseTimestamp(timestamp);
                return parsedTime && (dateRange.length === 0 || dateRange.includes(parsedTime.dateString));
            });
            
            const filteredJurnal = jurnalData.filter(item => {
                const kelas = item.Kelas || item.kelas || '';
                if (kelas !== kelasWali) return false;
                
                const timestamp = item.Timestamp || item.timestamp || item['Tanggal'] || item.tanggal;
                if (!timestamp) return false;
                
                const parsedTime = parseTimestamp(timestamp);
                return parsedTime && (dateRange.length === 0 || dateRange.includes(parsedTime.dateString));
            });
            
            // Reset detail level when filter changes
            currentDetailLevel = 1;
            currentExpandedDate = null;
            currentExpandedSubject = null;
            
            generateRekapTable(siswaKelas, filteredAbsensi, filteredJurnal, dateRange);
        }

        function generateRekapTable(siswaKelas, absensiData, jurnalData, dateRange) {
            const container = document.getElementById('rekapKehadiranContainer');
            
            if (siswaKelas.length === 0) {
                container.innerHTML = '<div class="text-center py-8 text-gray-500">Tidak ada data siswa</div>';
                return;
            }
            
            // Sort dates chronologically
            const sortedDates = dateRange.sort((a, b) => {
                const dateA = parseIndonesianDate(a);
                const dateB = parseIndonesianDate(b);
                return dateA - dateB;
            });
            
            // Build combined learning and attendance data structure
            const learningMatrix = {};
            
            // Initialize structure
            sortedDates.forEach(date => {
                learningMatrix[date] = {
                    pembelajaran: {},
                    siswaAttendance: {}
                };
                
                siswaKelas.forEach(siswa => {
                    const namaSiswa = siswa['Nama Siswa'];
                    learningMatrix[date].siswaAttendance[namaSiswa] = {
                        totalJP: 0,
                        hadirJP: 0,
                        finalStatus: 'Tidak Ada Data',
                        statusColor: 'text-gray-400',
                        subjectDetails: {}
                    };
                });
            });
            
            // Process jurnal data to get pembelajaran info
            jurnalData.forEach(record => {
                const timestamp = record.Timestamp || record.timestamp || record['Tanggal'] || record.tanggal;
                const namaGuru = record['Nama Guru'] || record.namaGuru || 'Guru';
                const mapel = record['Mata Pelajaran'] || record.mataPelajaran || record.Mapel || record.mapel || namaGuru;
                const materi = record.Materi || record.materi || '';
                const jamPelajaran = parseInt(record['Jam Pelajaran'] || record.jamPelajaran || '1');
                
                if (!timestamp || !namaGuru) return;
                
                const parsedTime = parseTimestamp(timestamp);
                if (!parsedTime) return;
                
                const dateKey = parsedTime.dateString;
                
                if (learningMatrix[dateKey]) {
                    const subjectKey = `${namaGuru}_${mapel}`;
                    learningMatrix[dateKey].pembelajaran[subjectKey] = {
                        namaGuru: namaGuru,
                        mapel: mapel,
                        materi: materi,
                        jamPelajaran: jamPelajaran,
                        timestamp: timestamp,
                        siswaList: {}
                    };
                    
                    // Initialize siswa list for this subject
                    siswaKelas.forEach(siswa => {
                        const namaSiswa = siswa['Nama Siswa'];
                        learningMatrix[dateKey].pembelajaran[subjectKey].siswaList[namaSiswa] = {
                            status: 'Tidak Ada Data',
                            statusColor: 'text-gray-400'
                        };
                    });
                }
            });
            
            // Process attendance data
            absensiData.forEach(record => {
                const nama = record['Nama Siswa'] || record.namaSiswa || record['Siswa'] || record.siswa;
                const timestamp = record.Timestamp || record.timestamp || record['Tanggal'] || record.tanggal;
                const status = record.Keterangan || record.keterangan || record.Status || record.status;
                const jamPelajaran = parseInt(record['Jam Pelajaran'] || record.jamPelajaran || '1');
                const namaGuru = record['Nama Guru'] || record.namaGuru || 'Guru';
                
                if (!nama || !timestamp || !status || !namaGuru) return;
                
                const parsedTime = parseTimestamp(timestamp);
                if (!parsedTime) return;
                
                const dateKey = parsedTime.dateString;
                
                if (learningMatrix[dateKey] && learningMatrix[dateKey].siswaAttendance[nama]) {
                    const siswaData = learningMatrix[dateKey].siswaAttendance[nama];
                    
                    // Add to daily totals
                    siswaData.totalJP += jamPelajaran;
                    if (status.toLowerCase() === 'hadir') {
                        siswaData.hadirJP += jamPelajaran;
                    }
                    
                    // Find matching pembelajaran
                    const matchingSubjects = Object.keys(learningMatrix[dateKey].pembelajaran).filter(subjectKey => {
                        const subject = learningMatrix[dateKey].pembelajaran[subjectKey];
                        return subject.namaGuru === namaGuru;
                    });
                    
                    matchingSubjects.forEach(subjectKey => {
                        const subject = learningMatrix[dateKey].pembelajaran[subjectKey];
                        if (subject.siswaList[nama]) {
                            const statusColor = status.toLowerCase() === 'hadir' ? 'text-green-600 bg-green-50' :
                                               status.toLowerCase() === 'alpha' ? 'text-red-600 bg-red-50' :
                                               status.toLowerCase() === 'bolos' ? 'text-purple-600 bg-purple-50' :
                                               status.toLowerCase() === 'sakit' ? 'text-yellow-600 bg-yellow-50' :
                                               'text-blue-600 bg-blue-50';
                            
                            subject.siswaList[nama] = {
                                status: status,
                                statusColor: statusColor,
                                jp: jamPelajaran,
                                timestamp: timestamp
                            };
                        }
                    });
                    
                    // Store subject details for student
                    if (!siswaData.subjectDetails[namaGuru]) {
                        siswaData.subjectDetails[namaGuru] = [];
                    }
                    siswaData.subjectDetails[namaGuru].push({
                        status: status,
                        jp: jamPelajaran,
                        timestamp: timestamp
                    });
                }
            });
            
            // Calculate final status for each student per day and overall stats
            const attendanceMatrix = {};
            
            siswaKelas.forEach(siswa => {
                const namaSiswa = siswa['Nama Siswa'];
                attendanceMatrix[namaSiswa] = {
                    kelas: siswa.Kelas,
                    dailyAttendance: {},
                    totalStats: { hadir: 0, sakit: 0, ijin: 0, alpha: 0, bolos: 0 }
                };
                
                sortedDates.forEach(date => {
                    const siswaData = learningMatrix[date].siswaAttendance[namaSiswa];
                    
                    if (siswaData.totalJP === 0) {
                        attendanceMatrix[namaSiswa].dailyAttendance[date] = {
                            finalStatus: 'Tidak Ada Data',
                            statusColor: 'text-gray-400',
                            totalJP: 0,
                            hadirJP: 0,
                            hasLearning: Object.keys(learningMatrix[date].pembelajaran).length > 0
                        };
                        return;
                    }
                    
                    const hadirPercentage = (siswaData.hadirJP / siswaData.totalJP) * 100;
                    
                    // Calculate JP for each status
                    const statusJP = { hadir: 0, alpha: 0, bolos: 0, sakit: 0, ijin: 0 };
                    Object.values(siswaData.subjectDetails).forEach(subjectRecords => {
                        subjectRecords.forEach(record => {
                            const status = record.status.toLowerCase();
                            statusJP[status] = (statusJP[status] || 0) + record.jp;
                        });
                    });
                    
                    // Always count bolos JP separately regardless of final status
                    if (statusJP.bolos > 0) {
                        attendanceMatrix[namaSiswa].totalStats.bolos += statusJP.bolos;
                    }
                    
                    // Special handling for hadir + bolos combination
                    const hasHadirAndBolos = statusJP.hadir > 0 && statusJP.bolos > 0;
                    
                    // Determine final status based on majority JP
                    if (hadirPercentage >= 55) {
                        // Student is considered present for the day
                        attendanceMatrix[namaSiswa].dailyAttendance[date] = {
                            finalStatus: 'Hadir',
                            statusColor: 'text-green-600 bg-green-50',
                            totalJP: siswaData.totalJP,
                            hadirJP: siswaData.hadirJP,
                            bolosJP: statusJP.bolos, // Track bolos JP even when final status is Hadir
                            hasLearning: Object.keys(learningMatrix[date].pembelajaran).length > 0
                        };
                        attendanceMatrix[namaSiswa].totalStats.hadir++;
                    } else {
                        // For combinations with hadir + bolos where hadir < 55%
                        if (hasHadirAndBolos) {
                            // Still count as hadir day but track bolos separately
                            attendanceMatrix[namaSiswa].dailyAttendance[date] = {
                                finalStatus: 'Hadir',
                                statusColor: 'text-green-600 bg-green-50',
                                totalJP: siswaData.totalJP,
                                hadirJP: siswaData.hadirJP,
                                bolosJP: statusJP.bolos,
                                hasLearning: Object.keys(learningMatrix[date].pembelajaran).length > 0,
                                isPartialAttendance: true // Flag to indicate partial attendance
                            };
                            attendanceMatrix[namaSiswa].totalStats.hadir++;
                        } else {
                            // Determine majority status from non-hadir statuses
                            const nonHadirStatusJP = {};
                            Object.entries(statusJP).forEach(([status, jp]) => {
                                if (status !== 'hadir' && jp > 0) {
                                    nonHadirStatusJP[status] = jp;
                                }
                            });
                            
                            if (Object.keys(nonHadirStatusJP).length === 0) {
                                // All hadir but less than 55% - shouldn't happen but handle it
                                attendanceMatrix[namaSiswa].dailyAttendance[date] = {
                                    finalStatus: 'Hadir',
                                    statusColor: 'text-green-600 bg-green-50',
                                    totalJP: siswaData.totalJP,
                                    hadirJP: siswaData.hadirJP,
                                    bolosJP: statusJP.bolos,
                                    hasLearning: Object.keys(learningMatrix[date].pembelajaran).length > 0
                                };
                                attendanceMatrix[namaSiswa].totalStats.hadir++;
                            } else {
                                const majorityStatus = Object.keys(nonHadirStatusJP).reduce((a, b) => 
                                    nonHadirStatusJP[a] > nonHadirStatusJP[b] ? a : b);
                                
                                let finalStatus, statusColor;
                                if (majorityStatus === 'alpha') {
                                    finalStatus = 'Alpha';
                                    statusColor = 'text-red-600 bg-red-50';
                                    attendanceMatrix[namaSiswa].totalStats.alpha++;
                                } else if (majorityStatus === 'bolos') {
                                    finalStatus = 'Bolos';
                                    statusColor = 'text-purple-600 bg-purple-50';
                                    // Don't add to bolos count here as it's already added above
                                } else if (majorityStatus === 'sakit') {
                                    finalStatus = 'Sakit';
                                    statusColor = 'text-yellow-600 bg-yellow-50';
                                    attendanceMatrix[namaSiswa].totalStats.sakit++;
                                } else if (majorityStatus === 'ijin') {
                                    finalStatus = 'Ijin';
                                    statusColor = 'text-blue-600 bg-blue-50';
                                    attendanceMatrix[namaSiswa].totalStats.ijin++;
                                }
                                
                                attendanceMatrix[namaSiswa].dailyAttendance[date] = {
                                    finalStatus: finalStatus,
                                    statusColor: statusColor,
                                    totalJP: siswaData.totalJP,
                                    hadirJP: siswaData.hadirJP,
                                    bolosJP: statusJP.bolos,
                                    hasLearning: Object.keys(learningMatrix[date].pembelajaran).length > 0
                                };
                            }
                        }
                    }
                });
            });
            
            // Generate navigation breadcrumb
            let breadcrumbHTML = `
                <div class="mb-4 flex items-center space-x-2 text-sm text-gray-600">
                    <span class="font-medium">Navigasi:</span>
                    <button onclick="resetToDaily()" class="text-blue-600 hover:text-blue-800 ${currentDetailLevel === 1 ? 'font-semibold' : ''}">
                        üìä Rekap Harian
                    </button>
            `;
            
            if (currentDetailLevel >= 2 && currentExpandedDate) {
                breadcrumbHTML += `
                    <span>‚Üí</span>
                    <button onclick="resetToDaily()" class="text-blue-600 hover:text-blue-800">
                        üìÖ ${formatShortDate(currentExpandedDate)} - Pembelajaran & Kehadiran
                    </button>
                `;
            }
            
            if (currentDetailLevel >= 3 && currentExpandedSubject) {
                breadcrumbHTML += `
                    <span>‚Üí</span>
                    <span class="font-semibold text-gray-900">
                        üë• ${currentExpandedSubject} - Detail Individual
                    </span>
                `;
            }
            
            breadcrumbHTML += `</div>`;
            
            // Generate table HTML based on current detail level
            let tableHTML = '';
            
            if (currentDetailLevel === 1) {
                // Level 1: Daily summary
                tableHTML = generateDailySummaryTable(attendanceMatrix, sortedDates);
            } else if (currentDetailLevel === 2) {
                // Level 2: Learning and attendance details for specific date
                tableHTML = generateLearningDetailTable(learningMatrix, currentExpandedDate, siswaKelas);
            } else if (currentDetailLevel === 3) {
                // Level 3: Individual attendance details for specific subject
                tableHTML = generateIndividualDetailTable(learningMatrix, currentExpandedDate, currentExpandedSubject, siswaKelas);
            }
            
            container.innerHTML = breadcrumbHTML + tableHTML;
        }
        
        function generateDailySummaryTable(attendanceMatrix, sortedDates) {
            let tableHTML = `
                <table class="min-w-full divide-y divide-gray-200 border border-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider border-r border-gray-200 sticky left-0 bg-gray-50 z-10">Nama Siswa</th>
                            <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider border-r border-gray-200 sticky left-32 bg-gray-50 z-10">Kelas</th>
            `;
            
            // Date headers
            sortedDates.forEach(date => {
                const shortDate = formatShortDate(date);
                tableHTML += `
                    <th class="px-2 py-2 text-center text-xs font-medium text-gray-500 uppercase tracking-wider border-r border-gray-200 cursor-pointer hover:bg-gray-100 transition-colors min-w-16" 
                        onclick="showWaliDateDetail('${date}')" title="Klik untuk detail mata pelajaran & kehadiran">
                        ${shortDate}
                        <div class="text-xs text-blue-600 mt-1">üëÜ Detail</div>
                    </th>
                `;
            });
            
            // Summary headers
            tableHTML += `
                    <th class="px-3 py-2 text-center text-xs font-medium text-green-600 uppercase tracking-wider border-r border-gray-200 bg-green-50">Hadir</th>
                    <th class="px-3 py-2 text-center text-xs font-medium text-yellow-600 uppercase tracking-wider border-r border-gray-200 bg-yellow-50">Sakit</th>
                    <th class="px-3 py-2 text-center text-xs font-medium text-blue-600 uppercase tracking-wider border-r border-gray-200 bg-blue-50">Ijin</th>
                    <th class="px-3 py-2 text-center text-xs font-medium text-red-600 uppercase tracking-wider border-r border-gray-200 bg-red-50">Alpha</th>
                    <th class="px-3 py-2 text-center text-xs font-medium text-purple-600 uppercase tracking-wider border-r border-gray-200 bg-purple-50">Bolos (JP)</th>
                    <th class="px-3 py-2 text-center text-xs font-medium text-gray-700 uppercase tracking-wider bg-gray-100">Kehadiran %</th>
                </tr>
            </thead><tbody class="bg-white divide-y divide-gray-200">`;
            
            // Student rows
            Object.keys(attendanceMatrix).forEach(nama => {
                const studentData = attendanceMatrix[nama];
                const totalDays = studentData.totalStats.hadir + studentData.totalStats.sakit + 
                                 studentData.totalStats.ijin + studentData.totalStats.alpha + 
                                 Math.ceil(studentData.totalStats.bolos / 8);
                const attendancePercentage = totalDays > 0 ? Math.round((studentData.totalStats.hadir / totalDays) * 100) : 0;
                const percentageColor = attendancePercentage >= 80 ? 'text-green-600' : 
                                       attendancePercentage >= 60 ? 'text-yellow-600' : 'text-red-600';
                
                tableHTML += `
                    <tr class="hover:bg-gray-50">
                        <td class="px-3 py-2 whitespace-nowrap text-sm font-medium text-gray-900 border-r border-gray-200 sticky left-0 bg-white z-10">${nama}</td>
                        <td class="px-3 py-2 whitespace-nowrap text-sm text-gray-600 border-r border-gray-200 sticky left-32 bg-white z-10">${studentData.kelas}</td>
                `;
                
                // Daily attendance cells
                sortedDates.forEach(date => {
                    const dayData = studentData.dailyAttendance[date];
                    const cellClass = dayData.statusColor;
                    const hasData = dayData.totalJP > 0 || dayData.hasLearning;
                    const jpInfo = dayData.totalJP > 0 ? `${dayData.hadirJP}/${dayData.totalJP} JP` : '';
                    const bolosInfo = dayData.bolosJP > 0 ? `Bolos: ${dayData.bolosJP} JP` : '';
                    const isPartialAttendance = dayData.isPartialAttendance;
                    
                    // Add visual indicator for partial attendance (hadir + bolos with <55% hadir)
                    const partialIndicator = isPartialAttendance ? '‚ö†Ô∏è' : '';
                    const partialTooltip = isPartialAttendance ? ' (Kehadiran Parsial - Ada Bolos)' : '';
                    
                    tableHTML += `
                        <td class="px-2 py-2 text-center text-xs border-r border-gray-200 ${cellClass} ${hasData ? 'cursor-pointer hover:opacity-80' : ''}" 
                            ${hasData ? `onclick="showWaliDateDetail('${date}')" title="Klik untuk detail mata pelajaran & kehadiran${jpInfo ? ' - ' + jpInfo : ''}${bolosInfo ? ' - ' + bolosInfo : ''}${partialTooltip}"` : ''}>
                            <div class="font-medium">${dayData.finalStatus} ${partialIndicator}</div>
                            ${jpInfo ? `<div class="text-xs opacity-75">${jpInfo}</div>` : ''}
                            ${bolosInfo ? `<div class="text-xs text-purple-600 opacity-75">${bolosInfo}</div>` : ''}
                            ${hasData ? `<div class="text-xs text-blue-600 mt-1">üëÜ</div>` : ''}
                        </td>
                    `;
                });
                
                // Summary cells
                tableHTML += `
                        <td class="px-3 py-2 text-center text-sm text-green-600 border-r border-gray-200 bg-green-50">${studentData.totalStats.hadir}</td>
                        <td class="px-3 py-2 text-center text-sm text-yellow-600 border-r border-gray-200 bg-yellow-50">${studentData.totalStats.sakit}</td>
                        <td class="px-3 py-2 text-center text-sm text-blue-600 border-r border-gray-200 bg-blue-50">${studentData.totalStats.ijin}</td>
                        <td class="px-3 py-2 text-center text-sm text-red-600 border-r border-gray-200 bg-red-50">${studentData.totalStats.alpha}</td>
                        <td class="px-3 py-2 text-center text-sm text-purple-600 border-r border-gray-200 bg-purple-50">${studentData.totalStats.bolos}</td>
                        <td class="px-3 py-2 text-center text-sm font-medium ${percentageColor} bg-gray-100">${attendancePercentage}%</td>
                    </tr>
                `;
            });
            
            tableHTML += `</tbody></table>`;
            
            // Add legend
            tableHTML += `
                <div class="mt-4 flex flex-wrap gap-4 text-xs">
                    <div class="flex items-center"><div class="w-3 h-3 bg-green-100 border border-green-200 rounded mr-1"></div> Hadir (‚â•55% JP atau ada kombinasi hadir+bolos)</div>
                    <div class="flex items-center"><div class="w-3 h-3 bg-yellow-100 border border-yellow-200 rounded mr-1"></div> Sakit</div>
                    <div class="flex items-center"><div class="w-3 h-3 bg-blue-100 border border-blue-200 rounded mr-1"></div> Ijin</div>
                    <div class="flex items-center"><div class="w-3 h-3 bg-red-100 border border-red-200 rounded mr-1"></div> Alpha</div>
                    <div class="flex items-center"><div class="w-3 h-3 bg-purple-100 border border-purple-200 rounded mr-1"></div> Bolos</div>
                    <div class="flex items-center"><div class="w-3 h-3 bg-gray-100 border border-gray-200 rounded mr-1"></div> Tidak Ada Data</div>
                    <div class="flex items-center text-orange-600"><span class="mr-1">‚ö†Ô∏è</span> Kehadiran Parsial (Hadir + Bolos dengan kehadiran <55%)</div>
                    <div class="flex items-center text-blue-600"><span class="mr-1">üëÜ</span> Klik untuk detail pembelajaran</div>
                </div>
            `;
            
            return tableHTML;
        }

        function generateLearningDetailTable(learningMatrix, date, siswaKelas) {
            if (!learningMatrix[date]) {
                return `<div class="text-center py-8 text-gray-500">Tidak ada data pembelajaran untuk tanggal ${formatShortDate(date)}</div>`;
            }
            
            const dayData = learningMatrix[date];
            const subjects = Object.keys(dayData.pembelajaran);
            
            if (subjects.length === 0) {
                return `<div class="text-center py-8 text-gray-500">Tidak ada pembelajaran untuk tanggal ${formatShortDate(date)}</div>`;
            }
            
            let tableHTML = `
                <div class="bg-blue-50 p-4 rounded-lg mb-4">
                    <h3 class="text-lg font-semibold text-blue-900 mb-2">üìÖ Pembelajaran & Kehadiran - ${formatShortDate(date)}</h3>
                    <p class="text-blue-700 text-sm">Klik mata pelajaran untuk melihat detail kehadiran individual siswa</p>
                </div>
                
                <div class="grid gap-4">
            `;
            
            subjects.forEach(subjectKey => {
                const subject = dayData.pembelajaran[subjectKey];
                const totalSiswa = siswaKelas.length;
                const hadirCount = Object.values(subject.siswaList).filter(s => s.status && s.status.toLowerCase() === 'hadir').length;
                const attendanceRate = totalSiswa > 0 ? Math.round((hadirCount / totalSiswa) * 100) : 0;
                
                tableHTML += `
                    <div class="bg-white border border-gray-200 rounded-lg overflow-hidden">
                        <div class="bg-gray-50 px-4 py-3 border-b border-gray-200 cursor-pointer hover:bg-gray-100 transition-colors" 
                             onclick="showIndividualDetail('${date}', '${subjectKey}')">
                            <div class="flex items-center justify-between">
                                <div>
                                    <h4 class="font-semibold text-gray-900">${subject.mapel}</h4>
                                    <p class="text-sm text-gray-600">Guru: ${subject.namaGuru} ‚Ä¢ ${subject.jamPelajaran} JP ‚Ä¢ ${subject.timestamp}</p>
                                </div>
                                <div class="text-right">
                                    <div class="text-lg font-bold ${attendanceRate >= 80 ? 'text-green-600' : attendanceRate >= 60 ? 'text-yellow-600' : 'text-red-600'}">
                                        ${attendanceRate}%
                                    </div>
                                    <div class="text-xs text-gray-500">${hadirCount}/${totalSiswa} hadir</div>
                                    <div class="text-xs text-blue-600 mt-1">üëÜ Detail Individual</div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="p-4">
                            <div class="mb-3">
                                <h5 class="text-sm font-medium text-gray-700 mb-2">üìñ Materi Pembelajaran:</h5>
                                <p class="text-sm text-gray-600 bg-blue-50 p-3 rounded border-l-4 border-blue-200">${subject.materi}</p>
                            </div>
                            
                            <div class="grid grid-cols-2 md:grid-cols-5 gap-2 text-xs">
                `;
                
                // Count status
                const statusCounts = { hadir: 0, sakit: 0, ijin: 0, alpha: 0, bolos: 0, 'tidak ada data': 0 };
                Object.values(subject.siswaList).forEach(siswa => {
                    const status = siswa.status ? siswa.status.toLowerCase() : 'tidak ada data';
                    statusCounts[status] = (statusCounts[status] || 0) + 1;
                });
                
                Object.entries(statusCounts).forEach(([status, count]) => {
                    if (count > 0) {
                        const statusColor = status === 'hadir' ? 'bg-green-100 text-green-800' :
                                           status === 'alpha' ? 'bg-red-100 text-red-800' :
                                           status === 'bolos' ? 'bg-purple-100 text-purple-800' :
                                           status === 'sakit' ? 'bg-yellow-100 text-yellow-800' :
                                           status === 'ijin' ? 'bg-blue-100 text-blue-800' :
                                           'bg-gray-100 text-gray-800';
                        
                        tableHTML += `
                            <div class="px-2 py-1 ${statusColor} rounded text-center font-medium">
                                ${status.charAt(0).toUpperCase() + status.slice(1)}: ${count}
                            </div>
                        `;
                    }
                });
                
                tableHTML += `
                            </div>
                        </div>
                    </div>
                `;
            });
            
            tableHTML += `</div>`;
            
            return tableHTML;
        }

        function generateIndividualDetailTable(learningMatrix, date, subjectKey, siswaKelas) {
            if (!learningMatrix[date] || !learningMatrix[date].pembelajaran[subjectKey]) {
                return `<div class="text-center py-8 text-gray-500">Data tidak ditemukan</div>`;
            }
            
            const subject = learningMatrix[date].pembelajaran[subjectKey];
            
            let tableHTML = `
                <div class="bg-green-50 p-4 rounded-lg mb-4">
                    <h3 class="text-lg font-semibold text-green-900 mb-2">üë• Detail Kehadiran Individual</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm">
                        <div>
                            <p><span class="font-medium">üìÖ Tanggal:</span> ${formatShortDate(date)}</p>
                            <p><span class="font-medium">üìö Mata Pelajaran:</span> ${subject.mapel}</p>
                            <p><span class="font-medium">üë®‚Äçüè´ Guru:</span> ${subject.namaGuru}</p>
                        </div>
                        <div>
                            <p><span class="font-medium">‚è∞ Waktu:</span> ${subject.timestamp}</p>
                            <p><span class="font-medium">üïê Durasi:</span> ${subject.jamPelajaran} JP</p>
                        </div>
                    </div>
                    <div class="mt-3">
                        <p class="font-medium text-green-800 mb-2">üìñ Materi Pembelajaran:</p>
                        <p class="text-green-700 bg-white p-3 rounded border-l-4 border-green-300">${subject.materi}</p>
                    </div>
                </div>
                
                <div class="bg-white border border-gray-200 rounded-lg overflow-hidden">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">No</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Nama Siswa</th>
                                <th class="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Status Kehadiran</th>
                                <th class="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Jam Pelajaran</th>
                                <th class="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Waktu Absen</th>
                            </tr>
                        </thead>
                        <tbody class="bg-white divide-y divide-gray-200">
            `;
            
            siswaKelas.forEach((siswa, index) => {
                const namaSiswa = siswa['Nama Siswa'];
                const siswaData = subject.siswaList[namaSiswa] || { status: 'Tidak Ada Data', statusColor: 'text-gray-400' };
                
                const statusBadge = siswaData.status === 'Tidak Ada Data' ? 
                    `<span class="px-2 py-1 text-xs font-medium bg-gray-100 text-gray-600 rounded-full">Tidak Ada Data</span>` :
                    siswaData.status.toLowerCase() === 'hadir' ?
                    `<span class="px-2 py-1 text-xs font-medium bg-green-100 text-green-800 rounded-full">‚úì ${siswaData.status}</span>` :
                    siswaData.status.toLowerCase() === 'alpha' ?
                    `<span class="px-2 py-1 text-xs font-medium bg-red-100 text-red-800 rounded-full">‚ùå ${siswaData.status}</span>` :
                    siswaData.status.toLowerCase() === 'bolos' ?
                    `<span class="px-2 py-1 text-xs font-medium bg-purple-100 text-purple-800 rounded-full">üö´ ${siswaData.status}</span>` :
                    siswaData.status.toLowerCase() === 'sakit' ?
                    `<span class="px-2 py-1 text-xs font-medium bg-yellow-100 text-yellow-800 rounded-full">ü§í ${siswaData.status}</span>` :
                    `<span class="px-2 py-1 text-xs font-medium bg-blue-100 text-blue-800 rounded-full">üìù ${siswaData.status}</span>`;
                
                const rowClass = siswaData.status === 'Tidak Ada Data' ? 'bg-gray-50' :
                                siswaData.status.toLowerCase() === 'hadir' ? 'bg-green-50' :
                                siswaData.status.toLowerCase() === 'alpha' ? 'bg-red-50' :
                                siswaData.status.toLowerCase() === 'bolos' ? 'bg-purple-50' :
                                siswaData.status.toLowerCase() === 'sakit' ? 'bg-yellow-50' :
                                'bg-blue-50';
                
                tableHTML += `
                    <tr class="${rowClass} hover:opacity-80 transition-opacity">
                        <td class="px-4 py-3 text-sm text-gray-900">${index + 1}</td>
                        <td class="px-4 py-3 text-sm font-medium text-gray-900">${namaSiswa}</td>
                        <td class="px-4 py-3 text-center">${statusBadge}</td>
                        <td class="px-4 py-3 text-center text-sm text-gray-600">${siswaData.jp || subject.jamPelajaran} JP</td>
                        <td class="px-4 py-3 text-center text-sm text-gray-600">${siswaData.timestamp || '-'}</td>
                    </tr>
                `;
            });
            
            tableHTML += `
                        </tbody>
                    </table>
                </div>
            `;
            
            // Add summary statistics
            const totalSiswa = siswaKelas.length;
            const statusCounts = { hadir: 0, sakit: 0, ijin: 0, alpha: 0, bolos: 0, 'tidak ada data': 0 };
            
            Object.values(subject.siswaList).forEach(siswa => {
                const status = siswa.status ? siswa.status.toLowerCase() : 'tidak ada data';
                statusCounts[status] = (statusCounts[status] || 0) + 1;
            });
            
            // Count students without data
            statusCounts['tidak ada data'] = totalSiswa - Object.values(subject.siswaList).length;
            
            tableHTML += `
                <div class="mt-4 bg-gray-50 p-4 rounded-lg">
                    <h4 class="font-medium text-gray-900 mb-3">üìä Ringkasan Kehadiran</h4>
                    <div class="grid grid-cols-2 md:grid-cols-6 gap-3 text-sm">
            `;
            
            Object.entries(statusCounts).forEach(([status, count]) => {
                if (count > 0) {
                    const percentage = Math.round((count / totalSiswa) * 100);
                    const statusColor = status === 'hadir' ? 'bg-green-100 text-green-800 border-green-200' :
                                       status === 'alpha' ? 'bg-red-100 text-red-800 border-red-200' :
                                       status === 'bolos' ? 'bg-purple-100 text-purple-800 border-purple-200' :
                                       status === 'sakit' ? 'bg-yellow-100 text-yellow-800 border-yellow-200' :
                                       status === 'ijin' ? 'bg-blue-100 text-blue-800 border-blue-200' :
                                       'bg-gray-100 text-gray-800 border-gray-200';
                    
                    tableHTML += `
                        <div class="p-3 ${statusColor} border rounded-lg text-center">
                            <div class="font-semibold">${count}</div>
                            <div class="text-xs">${status.charAt(0).toUpperCase() + status.slice(1)}</div>
                            <div class="text-xs opacity-75">${percentage}%</div>
                        </div>
                    `;
                }
            });
            
            tableHTML += `
                    </div>
                </div>
            `;
            
            return tableHTML;
        }

        function resetToDaily() {
            currentDetailLevel = 1;
            currentExpandedDate = null;
            currentExpandedSubject = null;
            updateRekapKehadiran();
        }

        function showLearningDetail(date) {
            currentDetailLevel = 2;
            currentExpandedDate = date;
            currentExpandedSubject = null;
            updateRekapKehadiran();
        }

        function showIndividualDetail(date, subjectKey) {
            currentDetailLevel = 3;
            currentExpandedDate = date;
            currentExpandedSubject = subjectKey;
            updateRekapKehadiran();
        }

        // Legacy functions for backward compatibility
        function toggleDateDetail(date) {
            showLearningDetail(date);
        }

        function toggleSubjectDetail(date, subject) {
            showIndividualDetail(date, subject);
        }

        function formatShortDate(dateStr) {
            try {
                const parts = dateStr.split('/');
                if (parts.length === 3) {
                    return `${parts[0]}/${parts[1]}`;
                }
                return dateStr;
            } catch (e) {
                return dateStr;
            }
        }

        function parseIndonesianDate(dateStr) {
            try {
                const parts = dateStr.split('/');
                if (parts.length === 3) {
                    const day = parseInt(parts[0]);
                    const month = parseInt(parts[1]);
                    const year = parseInt(parts[2]);
                    return new Date(year, month - 1, day);
                }
                return new Date(dateStr);
            } catch (e) {
                return new Date();
            }
        }
        
        function updateFilter() {
            const filterPeriode = document.getElementById('filterPeriode').value;
            const customDateFrom = document.getElementById('customDateFrom');
            const customDateTo = document.getElementById('customDateTo');
            
            if (filterPeriode === 'custom') {
                customDateFrom.classList.remove('hidden');
                customDateTo.classList.remove('hidden');
                
                // Set default dates if not set
                if (!document.getElementById('dateFrom').value) {
                    const today = new Date();
                    document.getElementById('dateFrom').value = today.toISOString().split('T')[0];
                }
                if (!document.getElementById('dateTo').value) {
                    const today = new Date();
                    document.getElementById('dateTo').value = today.toISOString().split('T')[0];
                }
            } else {
                customDateFrom.classList.add('hidden');
                customDateTo.classList.add('hidden');
            }
            
            // Show loading state when filter changes
            showDashboardLoading();
            
            // Update stats with small delay to show loading
            setTimeout(() => {
                updateDashboardStats();
            }, 300);
        }

        function updateWaliFilter() {
            const filterPeriode = document.getElementById('filterPeriodeWali').value;
            const customDateFrom = document.getElementById('customDateFromWali');
            const customDateTo = document.getElementById('customDateToWali');
            
            if (filterPeriode === 'custom') {
                customDateFrom.classList.remove('hidden');
                customDateTo.classList.remove('hidden');
                
                // Set default dates if not set
                if (!document.getElementById('dateFromWali').value) {
                    const today = new Date();
                    document.getElementById('dateFromWali').value = today.toISOString().split('T')[0];
                }
                if (!document.getElementById('dateToWali').value) {
                    const today = new Date();
                    document.getElementById('dateToWali').value = today.toISOString().split('T')[0];
                }
            } else {
                customDateFrom.classList.add('hidden');
                customDateTo.classList.add('hidden');
            }
            
            // Update wali dashboard and rekap kehadiran
            setTimeout(() => {
                updateWaliDashboard();
                updateRekapKehadiran();
            }, 300);
        }
        
        function resetFilter() {
            document.getElementById('filterPeriode').value = 'today';
            document.getElementById('filterKelas').value = '';
            document.getElementById('dateFrom').value = '';
            document.getElementById('dateTo').value = '';
            document.getElementById('customDateFrom').classList.add('hidden');
            document.getElementById('customDateTo').classList.add('hidden');
            
            // Show loading state when resetting filter
            showDashboardLoading();
            
            // Update stats with small delay to show loading
            setTimeout(() => {
                updateDashboardStats();
            }, 300);
        }

        function resetWaliFilter() {
            document.getElementById('filterPeriodeWali').value = 'today';
            document.getElementById('dateFromWali').value = '';
            document.getElementById('dateToWali').value = '';
            document.getElementById('customDateFromWali').classList.add('hidden');
            document.getElementById('customDateToWali').classList.add('hidden');
            
            // Update wali dashboard and rekap kehadiran
            setTimeout(() => {
                updateWaliDashboard();
                updateRekapKehadiran();
            }, 300);
        }

        function togglePasswordVisibility() {
            const passwordInput = document.getElementById('password');
            const eyeIcon = document.getElementById('eyeIcon');
            const eyeOffIcon = document.getElementById('eyeOffIcon');
            
            if (passwordInput.type === 'password') {
                passwordInput.type = 'text';
                eyeIcon.classList.add('hidden');
                eyeOffIcon.classList.remove('hidden');
            } else {
                passwordInput.type = 'password';
                eyeIcon.classList.remove('hidden');
                eyeOffIcon.classList.add('hidden');
            }
        }

        function showDashboardLoading() {
            // Show loading state for dashboard stats
            document.getElementById('totalJurnal').innerHTML = '<div class="loading"></div>';
            document.getElementById('totalDurasi').innerHTML = '<div class="loading"></div>';
            document.getElementById('totalPresensi').innerHTML = '<div class="loading"></div>';
            document.getElementById('totalKelas').innerHTML = '<div class="loading"></div>';
            document.getElementById('recentActivity').innerHTML = '<div class="text-center py-4"><div class="loading mx-auto"></div><p class="mt-2 text-gray-500">Memuat aktivitas...</p></div>';
        }

        function showNotification(message, type = 'success') {
            // Remove existing notifications
            const existingNotifications = document.querySelectorAll('.notification');
            existingNotifications.forEach(notification => notification.remove());
            
            // Create new notification
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.textContent = message;
            
            document.body.appendChild(notification);
            
            // Auto remove after 3 seconds
            setTimeout(() => {
                if (notification.parentNode) {
                    notification.parentNode.removeChild(notification);
                }
            }, 3000);
        }

        function logout() {
            currentUser = null;
            document.getElementById('loginPage').classList.remove('hidden');
            document.getElementById('dashboardGuru').classList.add('hidden');
            document.getElementById('dashboardWaliKelas').classList.add('hidden');
            
            // Reset form
            document.getElementById('loginForm').reset();
            document.getElementById('loginError').classList.add('hidden');
            
            showNotification('Anda telah logout', 'success');
        }

        function bulkAction(status) {
            const statusInputs = document.querySelectorAll('.siswa-status');
            statusInputs.forEach(input => {
                if (input.value === status) {
                    input.checked = true;
                }
            });
        }

        function resetAllStatus() {
            const statusInputs = document.querySelectorAll('.siswa-status');
            statusInputs.forEach(input => {
                input.checked = false;
            });
        }

        function toggleExportCustomDate() {
            const exportPeriode = document.getElementById('exportPeriode').value;
            const customDateDiv = document.getElementById('exportCustomDate');
            
            if (exportPeriode === 'custom') {
                customDateDiv.classList.remove('hidden');
                
                // Set default dates if not set
                if (!document.getElementById('exportDateFrom').value) {
                    const today = new Date();
                    document.getElementById('exportDateFrom').value = today.toISOString().split('T')[0];
                }
                if (!document.getElementById('exportDateTo').value) {
                    const today = new Date();
                    document.getElementById('exportDateTo').value = today.toISOString().split('T')[0];
                }
            } else {
                customDateDiv.classList.add('hidden');
            }
        }

        function exportData() {
            const exportType = document.getElementById('exportType').value;
            const exportPeriode = document.getElementById('exportPeriode').value;
            const dateFrom = document.getElementById('exportDateFrom').value;
            const dateTo = document.getElementById('exportDateTo').value;
            
            // Show loading state
            const btn = document.getElementById('exportBtn');
            const btnText = document.getElementById('exportBtnText');
            const spinner = document.getElementById('exportSpinner');
            
            btn.disabled = true;
            btnText.textContent = 'Mengexport...';
            spinner.classList.remove('hidden');
            
            console.log('üîÑ Starting Export Data function...');
            
            let dateRange = [];
            
            // Determine date range based on filter
            if (exportPeriode === 'week') {
                const today = new Date();
                const startOfWeek = new Date(today.setDate(today.getDate() - today.getDay()));
                dateRange = [];
                for (let i = 0; i < 7; i++) {
                    const date = new Date(startOfWeek);
                    date.setDate(startOfWeek.getDate() + i);
                    dateRange.push(date.toLocaleDateString('id-ID'));
                }
            } else if (exportPeriode === 'month') {
                const today = new Date();
                const year = today.getFullYear();
                const month = today.getMonth();
                const daysInMonth = new Date(year, month + 1, 0).getDate();
                dateRange = [];
                for (let i = 1; i <= daysInMonth; i++) {
                    const date = new Date(year, month, i);
                    dateRange.push(date.toLocaleDateString('id-ID'));
                }
            } else if (exportPeriode === 'lastmonth') {
                const today = new Date();
                const year = today.getFullYear();
                const month = today.getMonth() - 1;
                const daysInMonth = new Date(year, month + 1, 0).getDate();
                dateRange = [];
                for (let i = 1; i <= daysInMonth; i++) {
                    const date = new Date(year, month, i);
                    dateRange.push(date.toLocaleDateString('id-ID'));
                }
            } else if (exportPeriode === 'custom' && dateFrom && dateTo) {
                const start = new Date(dateFrom);
                const end = new Date(dateTo);
                dateRange = [];
                for (let d = new Date(start); d <= end; d.setDate(d.getDate() + 1)) {
                    dateRange.push(new Date(d).toLocaleDateString('id-ID'));
                }
            }
            
            const kelasWali = currentUser['Wali Kelas'];
            
            console.log('üìä Export parameters:', {
                type: exportType,
                period: exportPeriode,
                class: kelasWali,
                dateRange: dateRange.length
            });
            
            try {
                let exportData = [];
                let filename = '';
                
                if (exportType === 'kehadiran') {
                    // Export rekap kehadiran
                    const siswaKelas = classData.filter(row => row.Kelas === kelasWali);
                    const absensiData = getAllAbsensiData();
                    
                    const filteredAbsensi = absensiData.filter(item => {
                        const kelas = item.Kelas || item.kelas || '';
                        if (kelas !== kelasWali) return false;
                        
                        const timestamp = item.Timestamp || item.timestamp || item['Tanggal'] || item.tanggal;
                        if (!timestamp) return false;
                        
                        const parsedTime = parseTimestamp(timestamp);
                        return parsedTime && (dateRange.length === 0 || dateRange.includes(parsedTime.dateString));
                    });
                    
                    exportData = siswaKelas.map(siswa => {
                        const namaSiswa = siswa['Nama Siswa'];
                        const siswaAbsensi = filteredAbsensi.filter(item => {
                            const nama = item['Nama Siswa'] || item.namaSiswa || item['Siswa'] || item.siswa;
                            return nama === namaSiswa;
                        });
                        
                        const stats = { hadir: 0, sakit: 0, ijin: 0, alpha: 0, bolos: 0 };
                        const attendanceByDate = {};
                        
                        siswaAbsensi.forEach(record => {
                            const timestamp = record.Timestamp || record.timestamp || record['Tanggal'] || record.tanggal;
                            const status = record.Keterangan || record.keterangan || record.Status || record.status;
                            const jamPelajaran = parseInt(record['Jam Pelajaran'] || record.jamPelajaran || '1');
                            
                            if (!timestamp || !status) return;
                            
                            const parsedTime = parseTimestamp(timestamp);
                            if (!parsedTime) return;
                            
                            const dateKey = parsedTime.dateString;
                            
                            if (status.toLowerCase() === 'bolos') {
                                stats.bolos += jamPelajaran;
                                return;
                            }
                            
                            if (!attendanceByDate[dateKey]) {
                                attendanceByDate[dateKey] = {};
                            }
                            attendanceByDate[dateKey][status] = true;
                        });
                        
                        Object.values(attendanceByDate).forEach(dayStatuses => {
                            Object.keys(dayStatuses).forEach(status => {
                                if (stats.hasOwnProperty(status.toLowerCase()) && status.toLowerCase() !== 'bolos') {
                                    stats[status.toLowerCase()]++;
                                }
                            });
                        });
                        
                        const totalDays = stats.hadir + stats.sakit + stats.ijin + stats.alpha + (stats.bolos > 0 ? Math.ceil(stats.bolos / 8) : 0);
                        const persentaseKehadiran = totalDays > 0 ? Math.round((stats.hadir / totalDays) * 100) : 0;
                        
                        return {
                            'Nama Siswa': namaSiswa,
                            'Hadir (Hari)': stats.hadir,
                            'Sakit (Hari)': stats.sakit,
                            'Ijin (Hari)': stats.ijin,
                            'Alpha (Hari)': stats.alpha,
                            'Bolos (JP)': stats.bolos,
                            'Persentase Kehadiran': persentaseKehadiran + '%'
                        };
                    });
                    
                    filename = `Rekap_Kehadiran_${kelasWali}_${exportPeriode}.xlsx`;
                    
                } else if (exportType === 'jurnal') {
                    // Export jurnal pembelajaran
                    const jurnalData = getAllJurnalData();
                    
                    exportData = jurnalData.filter(item => {
                        const kelas = item.Kelas || item.kelas || '';
                        if (kelas !== kelasWali) return false;
                        
                        const timestamp = item.Timestamp || item.timestamp || item['Tanggal'] || item.tanggal;
                        if (!timestamp) return false;
                        
                        const parsedTime = parseTimestamp(timestamp);
                        return parsedTime && (dateRange.length === 0 || dateRange.includes(parsedTime.dateString));
                    }).map(item => ({
                        'Tanggal': item.Timestamp || item.timestamp || item['Tanggal'] || item.tanggal,
                        'Kelas': item.Kelas || item.kelas,
                        'Mata Pelajaran': item['Mata Pelajaran'] || item.mataPelajaran || item.Mapel || item.mapel,
                        'Nama Guru': item['Nama Guru'] || item.namaGuru,
                        'Materi': item.Materi || item.materi,
                        'Catatan': item.Catatan || item.catatan || '',
                        'Jam Pelajaran': item['Jam Pelajaran'] || item.jamPelajaran
                    }));
                    
                    filename = `Jurnal_Pembelajaran_${kelasWali}_${exportPeriode}.xlsx`;
                    
                } else if (exportType === 'absensi') {
                    // Export data absensi detail
                    const absensiData = getAllAbsensiData();
                    
                    exportData = absensiData.filter(item => {
                        const kelas = item.Kelas || item.kelas || '';
                        if (kelas !== kelasWali) return false;
                        
                        const timestamp = item.Timestamp || item.timestamp || item['Tanggal'] || item.tanggal;
                        if (!timestamp) return false;
                        
                        const parsedTime = parseTimestamp(timestamp);
                        return parsedTime && (dateRange.length === 0 || dateRange.includes(parsedTime.dateString));
                    }).map(item => ({
                        'Tanggal': item.Timestamp || item.timestamp || item['Tanggal'] || item.tanggal,
                        'Kelas': item.Kelas || item.kelas,
                        'Nama Siswa': item['Nama Siswa'] || item.namaSiswa,
                        'Keterangan': item.Keterangan || item.keterangan,
                        'Nama Guru': item['Nama Guru'] || item.namaGuru,
                        'Jam Pelajaran': item['Jam Pelajaran'] || item.jamPelajaran
                    }));
                    
                    filename = `Data_Absensi_${kelasWali}_${exportPeriode}.xlsx`;
                }
                
                console.log('üìã Export data prepared:', exportData.length, 'records');
                console.log('üìÅ Filename:', filename);
                
                if (exportData.length === 0) {
                    showNotification('Tidak ada data untuk diekspor', 'error');
                    return;
                }
                
                // Try primary method: Create workbook and download
                try {
                    console.log('üîÑ Attempting primary download method...');
                    
                    // Create workbook and worksheet
                    const wb = XLSX.utils.book_new();
                    const ws = XLSX.utils.json_to_sheet(exportData);
                    
                    // Add worksheet to workbook
                    XLSX.utils.book_append_sheet(wb, ws, 'Data');
                    
                    // Create blob and download
                    const wbout = XLSX.write(wb, { bookType: 'xlsx', type: 'array' });
                    const blob = new Blob([wbout], { type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' });
                    
                    // Create download link
                    const url = URL.createObjectURL(blob);
                    const link = document.createElement('a');
                    link.href = url;
                    link.download = filename;
                    link.style.display = 'none';
                    
                    // Add to DOM, click, and remove
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    
                    // Clean up URL
                    setTimeout(() => URL.revokeObjectURL(url), 1000);
                    
                    console.log('‚úÖ Primary download method successful');
                    showNotification(`Data berhasil diekspor! (${exportData.length} records)`, 'success');
                    
                } catch (primaryError) {
                    console.warn('‚ö†Ô∏è Primary download method failed:', primaryError);
                    
                    // Fallback method: Use XLSX.writeFile
                    try {
                        console.log('üîÑ Attempting fallback download method...');
                        
                        const wb = XLSX.utils.book_new();
                        const ws = XLSX.utils.json_to_sheet(exportData);
                        XLSX.utils.book_append_sheet(wb, ws, 'Data');
                        XLSX.writeFile(wb, filename);
                        
                        console.log('‚úÖ Fallback download method successful');
                        showNotification(`Data berhasil diekspor! (${exportData.length} records)`, 'success');
                        
                    } catch (fallbackError) {
                        console.error('‚ùå Fallback download method failed:', fallbackError);
                        
                        // Final fallback: Show manual download option
                        const csvData = exportData.map(row => {
                            return Object.values(row).map(cell => {
                                // Escape commas and quotes in CSV
                                if (typeof cell === 'string' && (cell.includes(',') || cell.includes('"'))) {
                                    return `"${cell.replace(/"/g, '""')}"`;
                                }
                                return cell;
                            }).join(',');
                        });
                        
                        // Add header row
                        const headers = Object.keys(exportData[0]).join(',');
                        const fullCsvData = [headers, ...csvData].join('\n');
                        
                        const csvBlob = new Blob([fullCsvData], { type: 'text/csv;charset=utf-8;' });
                        const csvUrl = URL.createObjectURL(csvBlob);
                        
                        const newWindow = window.open('', '_blank');
                        if (newWindow) {
                            newWindow.document.write(`
                                <html>
                                <head><title>Download Data</title></head>
                                <body style="font-family: Arial, sans-serif; padding: 20px;">
                                    <h2>üìä Export Data ${exportType.charAt(0).toUpperCase() + exportType.slice(1)}</h2>
                                    <p>Klik link di bawah untuk mendownload data:</p>
                                    <p><a href="${csvUrl}" download="${filename.replace('.xlsx', '.csv')}" style="background: #4F46E5; color: white; padding: 10px 20px; text-decoration: none; border-radius: 5px;">üì• Download CSV</a></p>
                                    <p><small>Data berisi ${exportData.length} records untuk periode ${exportPeriode}</small></p>
                                </body>
                                </html>
                            `);
                        }
                        
                        showNotification('Download otomatis gagal. Silakan gunakan link manual yang terbuka.', 'error');
                    }
                }
                
            } catch (error) {
                console.error('‚ùå Critical error in export function:', error);
                showNotification('Gagal mengekspor data: ' + error.message, 'error');
            } finally {
                // Reset loading state
                btn.disabled = false;
                btnText.textContent = 'üìä Export ke Excel';
                spinner.classList.add('hidden');
            }
        }

        function parseTimestamp(timestamp) {
            if (!timestamp) return null;
            
            try {
                const timestampStr = timestamp.toString().trim();
                
                // Handle Indonesian date format (DD/MM/YYYY or DD/MM/YYYY HH:MM:SS)
                if (timestampStr.includes('/')) {
                    const parts = timestampStr.split(' ')[0].split('/');
                    if (parts.length === 3) {
                        const day = parseInt(parts[0]);
                        const month = parseInt(parts[1]);
                        const year = parseInt(parts[2]);
                        
                        // Validate date parts
                        if (day >= 1 && day <= 31 && month >= 1 && month <= 12 && year >= 2020) {
                            const date = new Date(year, month - 1, day);
                            return {
                                date: date,
                                dateString: date.toLocaleDateString('id-ID')
                            };
                        }
                    }
                }
                
                // Handle ISO date format
                const date = new Date(timestampStr);
                if (!isNaN(date.getTime())) {
                    return {
                        date: date,
                        dateString: date.toLocaleDateString('id-ID')
                    };
                }
                
                return null;
            } catch (e) {
                console.error('Error parsing timestamp:', timestamp, e);
                return null;
            }
        }

        function showSiswaBermasalah() {
            const filterPeriode = document.getElementById('filterPeriodeWali').value;
            const dateFrom = document.getElementById('dateFromWali').value;
            const dateTo = document.getElementById('dateToWali').value;
            
            let dateRange = [];
            let periodLabel = '';
            
            // Determine date range based on filter (same as overview)
            if (filterPeriode === 'today') {
                const today = new Date();
                dateRange = [today.toLocaleDateString('id-ID')];
                periodLabel = 'Hari Ini';
            } else if (filterPeriode === 'week') {
                const today = new Date();
                const startOfWeek = new Date(today.setDate(today.getDate() - today.getDay()));
                dateRange = [];
                for (let i = 0; i < 7; i++) {
                    const date = new Date(startOfWeek);
                    date.setDate(startOfWeek.getDate() + i);
                    dateRange.push(date.toLocaleDateString('id-ID'));
                }
                periodLabel = 'Minggu Ini';
            } else if (filterPeriode === 'month') {
                const today = new Date();
                const year = today.getFullYear();
                const month = today.getMonth();
                const daysInMonth = new Date(year, month + 1, 0).getDate();
                dateRange = [];
                for (let i = 1; i <= daysInMonth; i++) {
                    const date = new Date(year, month, i);
                    dateRange.push(date.toLocaleDateString('id-ID'));
                }
                periodLabel = 'Bulan Ini';
            } else if (filterPeriode === 'lastmonth') {
                const today = new Date();
                const year = today.getFullYear();
                const month = today.getMonth() - 1;
                const daysInMonth = new Date(year, month + 1, 0).getDate();
                dateRange = [];
                for (let i = 1; i <= daysInMonth; i++) {
                    const date = new Date(year, month, i);
                    dateRange.push(date.toLocaleDateString('id-ID'));
                }
                periodLabel = 'Bulan Lalu';
            } else if (filterPeriode === 'custom' && dateFrom && dateTo) {
                const start = new Date(dateFrom);
                const end = new Date(dateTo);
                dateRange = [];
                for (let d = new Date(start); d <= end; d.setDate(d.getDate() + 1)) {
                    dateRange.push(new Date(d).toLocaleDateString('id-ID'));
                }
                periodLabel = 'Custom';
            }
            
            const kelasWali = currentUser['Wali Kelas'];
            
            // Get all students in this class
            const siswaKelas = classData.filter(row => row.Kelas === kelasWali);
            
            // Load absensi data from global arrays
            const absensiData = getAllAbsensiData();
            
            // Filter absensi data by class and date range
            const filteredAbsensi = absensiData.filter(item => {
                const kelas = item.Kelas || item.kelas || '';
                if (kelas !== kelasWali) return false;
                
                const timestamp = item.Timestamp || item.timestamp || item['Tanggal'] || item.tanggal;
                if (!timestamp) return false;
                
                const parsedTime = parseTimestamp(timestamp);
                return parsedTime && (dateRange.length === 0 || dateRange.includes(parsedTime.dateString));
            });
            
            // Calculate problematic students based on attendance percentage
            const siswaBermasalah = [];
            
            siswaKelas.forEach(siswa => {
                const namaSiswa = siswa['Nama Siswa'];
                const siswaAbsensi = filteredAbsensi.filter(item => {
                    const nama = item['Nama Siswa'] || item.namaSiswa || item['Siswa'] || item.siswa;
                    return nama === namaSiswa;
                });
                
                if (siswaAbsensi.length === 0) return; // Skip if no attendance data
                
                // Calculate total JP and hadir JP
                let totalJP = 0;
                let hadirJP = 0;
                let alphaCount = 0;
                let bolosJP = 0;
                let sakitCount = 0;
                let ijinCount = 0;
                
                const attendanceByDate = {};
                
                siswaAbsensi.forEach(record => {
                    const timestamp = record.Timestamp || record.timestamp || record['Tanggal'] || record.tanggal;
                    const status = record.Keterangan || record.keterangan || record.Status || record.status;
                    const jamPelajaran = parseInt(record['Jam Pelajaran'] || record.jamPelajaran || '1');
                    
                    if (!timestamp || !status) return;
                    
                    const parsedTime = parseTimestamp(timestamp);
                    if (!parsedTime) return;
                    
                    const dateKey = parsedTime.dateString;
                    
                    if (!attendanceByDate[dateKey]) {
                        attendanceByDate[dateKey] = {
                            totalJP: 0,
                            hadirJP: 0,
                            statuses: []
                        };
                    }
                    
                    attendanceByDate[dateKey].totalJP += jamPelajaran;
                    attendanceByDate[dateKey].statuses.push({
                        status: status.toLowerCase(),
                        jp: jamPelajaran
                    });
                    
                    if (status.toLowerCase() === 'hadir') {
                        attendanceByDate[dateKey].hadirJP += jamPelajaran;
                    }
                });
                
                // Calculate daily attendance and overall stats
                Object.values(attendanceByDate).forEach(dayData => {
                    totalJP += dayData.totalJP;
                    hadirJP += dayData.hadirJP;
                    
                    const hadirPercentage = dayData.totalJP > 0 ? (dayData.hadirJP / dayData.totalJP) * 100 : 0;
                    
                    if (hadirPercentage >= 55) {
                        // Count as hadir day - already counted in hadirJP
                    } else {
                        // Determine majority status for the day
                        const statusCounts = {};
                        dayData.statuses.forEach(s => {
                            if (s.status !== 'hadir') {
                                statusCounts[s.status] = (statusCounts[s.status] || 0) + s.jp;
                            }
                        });
                        
                        const majorityStatus = Object.keys(statusCounts).reduce((a, b) => 
                            statusCounts[a] > statusCounts[b] ? a : b, Object.keys(statusCounts)[0]);
                        
                        if (majorityStatus === 'alpha') alphaCount++;
                        else if (majorityStatus === 'bolos') bolosJP += statusCounts[majorityStatus];
                        else if (majorityStatus === 'sakit') sakitCount++;
                        else if (majorityStatus === 'ijin') ijinCount++;
                    }
                });
                
                const attendancePercentage = totalJP > 0 ? (hadirJP / totalJP) * 100 : 0;
                
                // Consider problematic if attendance < 80% or has significant alpha/bolos
                if (attendancePercentage < 80 || alphaCount > 0 || bolosJP > 0) {
                    siswaBermasalah.push({
                        nama: namaSiswa,
                        attendancePercentage: Math.round(attendancePercentage),
                        totalJP: totalJP,
                        hadirJP: hadirJP,
                        alphaCount: alphaCount,
                        bolosJP: bolosJP,
                        sakitCount: sakitCount,
                        ijinCount: ijinCount,
                        details: siswaAbsensi.slice(0, 5) // Show recent 5 records
                    });
                }
            });
            
            // Sort by attendance percentage (lowest first)
            siswaBermasalah.sort((a, b) => a.attendancePercentage - b.attendancePercentage);
            
            // Update modal title
            document.querySelector('#modalSiswaBermasalah h3').textContent = `Siswa Bermasalah - ${periodLabel}`;
            
            // Populate modal content
            const container = document.getElementById('daftarSiswaBermasalah');
            
            if (siswaBermasalah.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-8">
                        <div class="text-6xl mb-4">üéâ</div>
                        <h4 class="text-lg font-medium text-gray-900 mb-2">Tidak Ada Siswa Bermasalah</h4>
                        <p class="text-gray-600">Semua siswa memiliki kehadiran yang baik untuk periode ${periodLabel.toLowerCase()}!</p>
                    </div>
                `;
            } else {
                container.innerHTML = siswaBermasalah.map(siswa => {
                    const severityClass = siswa.attendancePercentage < 50 ? 'border-red-500 bg-red-50' : 
                                         siswa.attendancePercentage < 70 ? 'border-orange-500 bg-orange-50' : 
                                         'border-yellow-500 bg-yellow-50';
                    
                    const attendanceColor = siswa.attendancePercentage < 50 ? 'text-red-600' :
                                           siswa.attendancePercentage < 70 ? 'text-orange-600' :
                                           'text-yellow-600';
                    
                    return `
                        <div class="border-2 ${severityClass} rounded-lg p-4">
                            <div class="flex items-center justify-between mb-3">
                                <h4 class="font-semibold text-gray-900">${siswa.nama}</h4>
                                <div class="text-right">
                                    <div class="text-lg font-bold ${attendanceColor}">${siswa.attendancePercentage}%</div>
                                    <div class="text-xs text-gray-600">${siswa.hadirJP}/${siswa.totalJP} JP</div>
                                </div>
                            </div>
                            
                            <div class="grid grid-cols-2 md:grid-cols-4 gap-2 mb-3">
                                ${siswa.alphaCount > 0 ? `<span class="px-2 py-1 bg-red-100 text-red-800 text-xs rounded-full text-center">Alpha: ${siswa.alphaCount}</span>` : ''}
                                ${siswa.bolosJP > 0 ? `<span class="px-2 py-1 bg-purple-100 text-purple-800 text-xs rounded-full text-center">Bolos: ${siswa.bolosJP} JP</span>` : ''}
                                ${siswa.sakitCount > 0 ? `<span class="px-2 py-1 bg-yellow-100 text-yellow-800 text-xs rounded-full text-center">Sakit: ${siswa.sakitCount}</span>` : ''}
                                ${siswa.ijinCount > 0 ? `<span class="px-2 py-1 bg-blue-100 text-blue-800 text-xs rounded-full text-center">Ijin: ${siswa.ijinCount}</span>` : ''}
                            </div>
                            
                            <div class="space-y-1">
                                <div class="text-xs font-medium text-gray-700 mb-1">Riwayat Terbaru:</div>
                                ${siswa.details.map(detail => {
                                    const status = detail.Keterangan || detail.keterangan || detail.Status || detail.status;
                                    const timestamp = detail.Timestamp || detail.timestamp || detail['Tanggal'] || detail.tanggal;
                                    const jp = detail['Jam Pelajaran'] || detail.jamPelajaran || '1';
                                    const statusColor = status.toLowerCase() === 'hadir' ? 'text-green-600' :
                                                       status.toLowerCase() === 'alpha' ? 'text-red-600' :
                                                       status.toLowerCase() === 'bolos' ? 'text-purple-600' :
                                                       status.toLowerCase() === 'sakit' ? 'text-yellow-600' :
                                                       'text-blue-600';
                                    
                                    return `
                                        <div class="text-xs text-gray-600 flex justify-between items-center bg-white p-2 rounded border">
                                            <span>${timestamp}</span>
                                            <span class="font-medium ${statusColor}">${status} (${jp} JP)</span>
                                        </div>
                                    `;
                                }).join('')}
                            </div>
                        </div>
                    `;
                }).join('');
            }
            
            // Show modal
            document.getElementById('modalSiswaBermasalah').classList.remove('hidden');
        }

        function closeModalSiswaBermasalah() {
            document.getElementById('modalSiswaBermasalah').classList.add('hidden');
        }

        function showGuruRekapKehadiran() {
            const filterPeriode = document.getElementById('filterPeriode').value;
            const filterKelas = document.getElementById('filterKelas').value;
            const dateFrom = document.getElementById('dateFrom').value;
            const dateTo = document.getElementById('dateTo').value;
            
            let periodLabel = '';
            let dateRange = [];
            
            // Determine date range based on filter (same logic as updateDashboardStats)
            if (filterPeriode === 'today') {
                const today = new Date();
                dateRange = [today.toLocaleDateString('id-ID')];
                periodLabel = 'Hari Ini';
            } else if (filterPeriode === 'week') {
                const today = new Date();
                const startOfWeek = new Date(today.setDate(today.getDate() - today.getDay()));
                dateRange = [];
                for (let i = 0; i < 7; i++) {
                    const date = new Date(startOfWeek);
                    date.setDate(startOfWeek.getDate() + i);
                    dateRange.push(date.toLocaleDateString('id-ID'));
                }
                periodLabel = 'Minggu Ini';
            } else if (filterPeriode === 'month') {
                const today = new Date();
                const year = today.getFullYear();
                const month = today.getMonth();
                const daysInMonth = new Date(year, month + 1, 0).getDate();
                dateRange = [];
                for (let i = 1; i <= daysInMonth; i++) {
                    const date = new Date(year, month, i);
                    dateRange.push(date.toLocaleDateString('id-ID'));
                }
                periodLabel = 'Bulan Ini';
            } else if (filterPeriode === 'lastmonth') {
                const today = new Date();
                const year = today.getFullYear();
                const month = today.getMonth() - 1;
                const daysInMonth = new Date(year, month + 1, 0).getDate();
                dateRange = [];
                for (let i = 1; i <= daysInMonth; i++) {
                    const date = new Date(year, month, i);
                    dateRange.push(date.toLocaleDateString('id-ID'));
                }
                periodLabel = 'Bulan Lalu';
            } else if (filterPeriode === 'custom' && dateFrom && dateTo) {
                const start = new Date(dateFrom);
                const end = new Date(dateTo);
                dateRange = [];
                for (let d = new Date(start); d <= end; d.setDate(d.getDate() + 1)) {
                    dateRange.push(new Date(d).toLocaleDateString('id-ID'));
                }
                periodLabel = 'Custom';
            }
            
            // Load data from global arrays
            const jurnalData = getAllJurnalData();
            const absensiData = getAllAbsensiData();
            
            // Filter data by current user, date range, and class
            const filteredJurnal = jurnalData.filter(item => {
                // Check if guru name matches
                const guruName = item['Nama Guru'] || item['namaGuru'] || item['Guru'] || item.namaGuru;
                
                if (!guruName) {
                    return false;
                }
                
                // Normalize names for comparison
                const normalizedGuruName = guruName.toString().trim().toLowerCase().replace(/[^a-z\s]/g, '');
                const normalizedCurrentUser = currentUser['Nama Guru'].toString().trim().toLowerCase().replace(/[^a-z\s]/g, '');
                
                if (normalizedGuruName !== normalizedCurrentUser) {
                    return false;
                }
                
                // Check class filter
                if (filterKelas) {
                    const itemKelas = item.Kelas || item.kelas || '';
                    if (itemKelas !== filterKelas) {
                        return false;
                    }
                }
                
                // Check timestamp
                const timestamp = item.Timestamp || item.timestamp || item['Tanggal'] || item.tanggal;
                if (!timestamp) {
                    return false;
                }
                
                const parsedTime = parseTimestamp(timestamp);
                return parsedTime && (dateRange.length === 0 || dateRange.includes(parsedTime.dateString));
            });
            
            const filteredAbsensi = absensiData.filter(item => {
                // Check if guru name matches
                const guruName = item['Nama Guru'] || item['namaGuru'] || item['Guru'] || item.namaGuru;
                
                if (!guruName) {
                    return false;
                }
                
                // Normalize names for comparison
                const normalizedGuruName = guruName.toString().trim().toLowerCase().replace(/[^a-z\s]/g, '');
                const normalizedCurrentUser = currentUser['Nama Guru'].toString().trim().toLowerCase().replace(/[^a-z\s]/g, '');
                
                if (normalizedGuruName !== normalizedCurrentUser) {
                    return false;
                }
                
                // Check class filter
                if (filterKelas) {
                    const itemKelas = item.Kelas || item.kelas || '';
                    if (itemKelas !== filterKelas) {
                        return false;
                    }
                }
                
                // Check timestamp
                const timestamp = item.Timestamp || item.timestamp || item['Tanggal'] || item.tanggal;
                if (!timestamp) {
                    return false;
                }
                
                const parsedTime = parseTimestamp(timestamp);
                return parsedTime && (dateRange.length === 0 || dateRange.includes(parsedTime.dateString));
            });
            
            // Get all unique classes from filtered data
            const kelasSet = new Set();
            filteredJurnal.forEach(item => {
                const kelas = item.Kelas || item.kelas;
                if (kelas) kelasSet.add(kelas);
            });
            filteredAbsensi.forEach(item => {
                const kelas = item.Kelas || item.kelas;
                if (kelas) kelasSet.add(kelas);
            });
            
            const kelasList = Array.from(kelasSet).sort();
            
            // Get all unique students from filtered classes
            const allSiswa = [];
            kelasList.forEach(kelas => {
                const siswaKelas = classData.filter(row => row.Kelas === kelas);
                siswaKelas.forEach(siswa => {
                    allSiswa.push({
                        nama: siswa['Nama Siswa'],
                        kelas: siswa.Kelas
                    });
                });
            });
            
            // Sort dates chronologically
            const sortedDates = dateRange.sort((a, b) => {
                const dateA = parseIndonesianDate(a);
                const dateB = parseIndonesianDate(b);
                return dateA - dateB;
            });
            
            // Build attendance matrix for guru's classes
            const attendanceMatrix = {};
            
            allSiswa.forEach(siswa => {
                attendanceMatrix[siswa.nama] = {
                    kelas: siswa.kelas,
                    dailyAttendance: {},
                    totalStats: { hadir: 0, sakit: 0, ijin: 0, alpha: 0, bolos: 0 }
                };
                
                sortedDates.forEach(date => {
                    attendanceMatrix[siswa.nama].dailyAttendance[date] = {
                        finalStatus: 'Tidak Ada Data',
                        statusColor: 'text-gray-400',
                        totalJP: 0,
                        hadirJP: 0,
                        hasLearning: false
                    };
                });
            });
            
            // Process attendance data for each student
            filteredAbsensi.forEach(record => {
                const nama = record['Nama Siswa'] || record.namaSiswa || record['Siswa'] || record.siswa;
                const timestamp = record.Timestamp || record.timestamp || record['Tanggal'] || record.tanggal;
                const status = record.Keterangan || record.keterangan || record.Status || record.status;
                const jamPelajaran = parseInt(record['Jam Pelajaran'] || record.jamPelajaran || '1');
                
                if (!nama || !timestamp || !status) return;
                
                const parsedTime = parseTimestamp(timestamp);
                if (!parsedTime) return;
                
                const dateKey = parsedTime.dateString;
                
                if (attendanceMatrix[nama] && attendanceMatrix[nama].dailyAttendance[dateKey]) {
                    const dayData = attendanceMatrix[nama].dailyAttendance[dateKey];
                    dayData.hasLearning = true;
                    dayData.totalJP += jamPelajaran;
                    
                    if (status.toLowerCase() === 'hadir') {
                        dayData.hadirJP += jamPelajaran;
                    }
                }
            });
            
            // Calculate final status for each student per day
            allSiswa.forEach(siswa => {
                const studentData = attendanceMatrix[siswa.nama];
                
                sortedDates.forEach(date => {
                    const dayData = studentData.dailyAttendance[date];
                    
                    if (dayData.totalJP === 0) {
                        // Check if there was learning on this date for this class
                        const hasLearningForClass = filteredJurnal.some(item => {
                            const kelas = item.Kelas || item.kelas;
                            const timestamp = item.Timestamp || item.timestamp || item['Tanggal'] || item.tanggal;
                            const parsedTime = parseTimestamp(timestamp);
                            return kelas === siswa.kelas && parsedTime && parsedTime.dateString === date;
                        });
                        
                        dayData.hasLearning = hasLearningForClass;
                        return;
                    }
                    
                    const hadirPercentage = (dayData.hadirJP / dayData.totalJP) * 100;
                    
                    // Calculate JP for each status
                    const statusJP = { hadir: 0, alpha: 0, bolos: 0, sakit: 0, ijin: 0 };
                    
                    filteredAbsensi.forEach(record => {
                        const recordNama = record['Nama Siswa'] || record.namaSiswa || record['Siswa'] || record.siswa;
                        const recordTimestamp = record.Timestamp || record.timestamp || record['Tanggal'] || record.tanggal;
                        const recordStatus = record.Keterangan || record.keterangan || record.Status || record.status;
                        const recordJP = parseInt(record['Jam Pelajaran'] || record.jamPelajaran || '1');
                        
                        if (recordNama === siswa.nama) {
                            const recordParsedTime = parseTimestamp(recordTimestamp);
                            if (recordParsedTime && recordParsedTime.dateString === date) {
                                const status = recordStatus.toLowerCase();
                                statusJP[status] = (statusJP[status] || 0) + recordJP;
                            }
                        }
                    });
                    
                    // Always count bolos JP separately
                    if (statusJP.bolos > 0) {
                        studentData.totalStats.bolos += statusJP.bolos;
                    }
                    
                    // Special handling for hadir + bolos combination
                    const hasHadirAndBolos = statusJP.hadir > 0 && statusJP.bolos > 0;
                    
                    // Determine final status
                    if (hadirPercentage >= 55) {
                        dayData.finalStatus = 'Hadir';
                        dayData.statusColor = 'text-green-600 bg-green-50';
                        dayData.bolosJP = statusJP.bolos;
                        studentData.totalStats.hadir++;
                    } else {
                        if (hasHadirAndBolos) {
                            dayData.finalStatus = 'Hadir';
                            dayData.statusColor = 'text-green-600 bg-green-50';
                            dayData.bolosJP = statusJP.bolos;
                            dayData.isPartialAttendance = true;
                            studentData.totalStats.hadir++;
                        } else {
                            // Determine majority status from non-hadir statuses
                            const nonHadirStatusJP = {};
                            Object.entries(statusJP).forEach(([status, jp]) => {
                                if (status !== 'hadir' && jp > 0) {
                                    nonHadirStatusJP[status] = jp;
                                }
                            });
                            
                            if (Object.keys(nonHadirStatusJP).length > 0) {
                                const majorityStatus = Object.keys(nonHadirStatusJP).reduce((a, b) => 
                                    nonHadirStatusJP[a] > nonHadirStatusJP[b] ? a : b);
                                
                                if (majorityStatus === 'alpha') {
                                    dayData.finalStatus = 'Alpha';
                                    dayData.statusColor = 'text-red-600 bg-red-50';
                                    studentData.totalStats.alpha++;
                                } else if (majorityStatus === 'bolos') {
                                    dayData.finalStatus = 'Bolos';
                                    dayData.statusColor = 'text-purple-600 bg-purple-50';
                                } else if (majorityStatus === 'sakit') {
                                    dayData.finalStatus = 'Sakit';
                                    dayData.statusColor = 'text-yellow-600 bg-yellow-50';
                                    studentData.totalStats.sakit++;
                                } else if (majorityStatus === 'ijin') {
                                    dayData.finalStatus = 'Ijin';
                                    dayData.statusColor = 'text-blue-600 bg-blue-50';
                                    studentData.totalStats.ijin++;
                                }
                                
                                dayData.bolosJP = statusJP.bolos;
                            }
                        }
                    }
                });
            });
            
            // Generate table HTML
            let tableHTML = generateGuruRekapTable(attendanceMatrix, sortedDates, periodLabel, filterKelas);
            
            // Update modal title
            document.querySelector('#modalRekapGuru h3').textContent = `Rekap Kehadiran Siswa - ${periodLabel}${filterKelas ? ` (${filterKelas})` : ''}`;
            
            // Populate modal content
            document.getElementById('rekapGuruContainer').innerHTML = tableHTML;
            
            // Store data for Excel export
            window.guruRekapData = {
                attendanceMatrix: attendanceMatrix,
                sortedDates: sortedDates,
                periodLabel: periodLabel,
                filterKelas: filterKelas,
                guruName: currentUser['Nama Guru'],
                mapel: currentUser.Mapel
            };
            
            // Show modal
            document.getElementById('modalRekapGuru').classList.remove('hidden');
        }

        function generateGuruRekapTable(attendanceMatrix, sortedDates, periodLabel, filterKelas) {
            let tableHTML = `
                <div class="bg-blue-50 p-4 rounded-lg mb-4">
                    <h3 class="text-lg font-semibold text-blue-900 mb-2">üìä Rekap Kehadiran Siswa - Pembelajaran ${currentUser.Mapel}</h3>
                    <p class="text-blue-700 text-sm">Menampilkan kehadiran siswa untuk mata pelajaran yang Anda ajarkan pada periode ${periodLabel.toLowerCase()}${filterKelas ? ` di kelas ${filterKelas}` : ''}.</p>
                </div>
                
                <table class="min-w-full divide-y divide-gray-200 border border-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider border-r border-gray-200 sticky left-0 bg-gray-50 z-10">Nama Siswa</th>
                            <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider border-r border-gray-200 sticky left-32 bg-gray-50 z-10">Kelas</th>
            `;
            
            // Date headers
            sortedDates.forEach(date => {
                const shortDate = formatShortDate(date);
                tableHTML += `
                    <th class="px-2 py-2 text-center text-xs font-medium text-gray-500 uppercase tracking-wider border-r border-gray-200 min-w-16">
                        ${shortDate}
                    </th>
                `;
            });
            
            // Summary headers
            tableHTML += `
                    <th class="px-3 py-2 text-center text-xs font-medium text-green-600 uppercase tracking-wider border-r border-gray-200 bg-green-50">Hadir</th>
                    <th class="px-3 py-2 text-center text-xs font-medium text-yellow-600 uppercase tracking-wider border-r border-gray-200 bg-yellow-50">Sakit</th>
                    <th class="px-3 py-2 text-center text-xs font-medium text-blue-600 uppercase tracking-wider border-r border-gray-200 bg-blue-50">Ijin</th>
                    <th class="px-3 py-2 text-center text-xs font-medium text-red-600 uppercase tracking-wider border-r border-gray-200 bg-red-50">Alpha</th>
                    <th class="px-3 py-2 text-center text-xs font-medium text-purple-600 uppercase tracking-wider border-r border-gray-200 bg-purple-50">Bolos (JP)</th>
                    <th class="px-3 py-2 text-center text-xs font-medium text-gray-700 uppercase tracking-wider bg-gray-100">Kehadiran %</th>
                </tr>
            </thead><tbody class="bg-white divide-y divide-gray-200">`;
            
            // Student rows
            Object.keys(attendanceMatrix).forEach(nama => {
                const studentData = attendanceMatrix[nama];
                const totalDays = studentData.totalStats.hadir + studentData.totalStats.sakit + 
                                 studentData.totalStats.ijin + studentData.totalStats.alpha + 
                                 Math.ceil(studentData.totalStats.bolos / 8);
                const attendancePercentage = totalDays > 0 ? Math.round((studentData.totalStats.hadir / totalDays) * 100) : 0;
                const percentageColor = attendancePercentage >= 80 ? 'text-green-600' : 
                                       attendancePercentage >= 60 ? 'text-yellow-600' : 'text-red-600';
                
                tableHTML += `
                    <tr class="hover:bg-gray-50">
                        <td class="px-3 py-2 whitespace-nowrap text-sm font-medium text-gray-900 border-r border-gray-200 sticky left-0 bg-white z-10">${nama}</td>
                        <td class="px-3 py-2 whitespace-nowrap text-sm text-gray-600 border-r border-gray-200 sticky left-32 bg-white z-10">${studentData.kelas}</td>
                `;
                
                // Daily attendance cells
                sortedDates.forEach(date => {
                    const dayData = studentData.dailyAttendance[date];
                    const cellClass = dayData.statusColor;
                    const hasData = dayData.totalJP > 0 || dayData.hasLearning;
                    const jpInfo = dayData.totalJP > 0 ? `${dayData.hadirJP}/${dayData.totalJP} JP` : '';
                    const bolosInfo = dayData.bolosJP > 0 ? `Bolos: ${dayData.bolosJP} JP` : '';
                    const isPartialAttendance = dayData.isPartialAttendance;
                    
                    const partialIndicator = isPartialAttendance ? '‚ö†Ô∏è' : '';
                    const partialTooltip = isPartialAttendance ? ' (Kehadiran Parsial - Ada Bolos)' : '';
                    
                    tableHTML += `
                        <td class="px-2 py-2 text-center text-xs border-r border-gray-200 ${cellClass}" 
                            ${hasData ? `title="${jpInfo ? jpInfo : ''}${bolosInfo ? ' - ' + bolosInfo : ''}${partialTooltip}"` : ''}>
                            <div class="font-medium">${dayData.finalStatus} ${partialIndicator}</div>
                            ${jpInfo ? `<div class="text-xs opacity-75">${jpInfo}</div>` : ''}
                            ${bolosInfo ? `<div class="text-xs text-purple-600 opacity-75">${bolosInfo}</div>` : ''}
                        </td>
                    `;
                });
                
                // Summary cells
                tableHTML += `
                        <td class="px-3 py-2 text-center text-sm text-green-600 border-r border-gray-200 bg-green-50">${studentData.totalStats.hadir}</td>
                        <td class="px-3 py-2 text-center text-sm text-yellow-600 border-r border-gray-200 bg-yellow-50">${studentData.totalStats.sakit}</td>
                        <td class="px-3 py-2 text-center text-sm text-blue-600 border-r border-gray-200 bg-blue-50">${studentData.totalStats.ijin}</td>
                        <td class="px-3 py-2 text-center text-sm text-red-600 border-r border-gray-200 bg-red-50">${studentData.totalStats.alpha}</td>
                        <td class="px-3 py-2 text-center text-sm text-purple-600 border-r border-gray-200 bg-purple-50">${studentData.totalStats.bolos}</td>
                        <td class="px-3 py-2 text-center text-sm font-medium ${percentageColor} bg-gray-100">${attendancePercentage}%</td>
                    </tr>
                `;
            });
            
            tableHTML += `</tbody></table>`;
            
            // Add legend
            tableHTML += `
                <div class="mt-4 flex flex-wrap gap-4 text-xs">
                    <div class="flex items-center"><div class="w-3 h-3 bg-green-100 border border-green-200 rounded mr-1"></div> Hadir (‚â•55% JP atau ada kombinasi hadir+bolos)</div>
                    <div class="flex items-center"><div class="w-3 h-3 bg-yellow-100 border border-yellow-200 rounded mr-1"></div> Sakit</div>
                    <div class="flex items-center"><div class="w-3 h-3 bg-blue-100 border border-blue-200 rounded mr-1"></div> Ijin</div>
                    <div class="flex items-center"><div class="w-3 h-3 bg-red-100 border border-red-200 rounded mr-1"></div> Alpha</div>
                    <div class="flex items-center"><div class="w-3 h-3 bg-purple-100 border border-purple-200 rounded mr-1"></div> Bolos</div>
                    <div class="flex items-center"><div class="w-3 h-3 bg-gray-100 border border-gray-200 rounded mr-1"></div> Tidak Ada Data</div>
                    <div class="flex items-center text-orange-600"><span class="mr-1">‚ö†Ô∏è</span> Kehadiran Parsial (Hadir + Bolos dengan kehadiran <55%)</div>
                </div>
            `;
            
            return tableHTML;
        }

        function closeModalRekapGuru() {
            document.getElementById('modalRekapGuru').classList.add('hidden');
        }

        function downloadGuruRekapExcel() {
            if (!window.guruRekapData) {
                showNotification('Data tidak tersedia untuk export', 'error');
                return;
            }
            
            const btn = document.getElementById('downloadGuruBtn');
            const btnText = document.getElementById('downloadGuruBtnText');
            const spinner = document.getElementById('downloadGuruSpinner');
            
            btn.disabled = true;
            btnText.textContent = 'Mengexport...';
            spinner.classList.remove('hidden');
            
            console.log('üîÑ Starting Guru Rekap Excel export...');
            
            try {
                const { attendanceMatrix, sortedDates, periodLabel, filterKelas, guruName, mapel } = window.guruRekapData;
                
                console.log('üìä Data to export:', {
                    students: Object.keys(attendanceMatrix).length,
                    dates: sortedDates.length,
                    period: periodLabel,
                    teacher: guruName,
                    subject: mapel
                });
                
                // Prepare data for Excel
                const exportData = [];
                
                // Add header row
                const headerRow = ['Nama Siswa', 'Kelas'];
                sortedDates.forEach(date => {
                    headerRow.push(formatShortDate(date));
                });
                headerRow.push('Total Hadir', 'Total Sakit', 'Total Ijin', 'Total Alpha', 'Total Bolos (JP)', 'Persentase Kehadiran');
                exportData.push(headerRow);
                
                // Add student data rows
                Object.keys(attendanceMatrix).forEach(nama => {
                    const studentData = attendanceMatrix[nama];
                    const totalDays = studentData.totalStats.hadir + studentData.totalStats.sakit + 
                                     studentData.totalStats.ijin + studentData.totalStats.alpha + 
                                     Math.ceil(studentData.totalStats.bolos / 8);
                    const attendancePercentage = totalDays > 0 ? Math.round((studentData.totalStats.hadir / totalDays) * 100) : 0;
                    
                    const row = [nama, studentData.kelas];
                    
                    // Add daily attendance
                    sortedDates.forEach(date => {
                        const dayData = studentData.dailyAttendance[date];
                        let cellValue = dayData.finalStatus;
                        
                        if (dayData.totalJP > 0) {
                            cellValue += ` (${dayData.hadirJP}/${dayData.totalJP} JP)`;
                        }
                        if (dayData.bolosJP > 0) {
                            cellValue += ` - Bolos: ${dayData.bolosJP} JP`;
                        }
                        if (dayData.isPartialAttendance) {
                            cellValue += ' ‚ö†Ô∏è';
                        }
                        
                        row.push(cellValue);
                    });
                    
                    // Add summary statistics
                    row.push(
                        studentData.totalStats.hadir,
                        studentData.totalStats.sakit,
                        studentData.totalStats.ijin,
                        studentData.totalStats.alpha,
                        studentData.totalStats.bolos,
                        attendancePercentage + '%'
                    );
                    
                    exportData.push(row);
                });
                
                console.log('üìã Export data prepared:', exportData.length, 'rows');
                
                // Generate filename
                const filename = `Rekap_Kehadiran_${mapel.replace(/\s+/g, '_')}_${guruName.replace(/\s+/g, '_')}_${periodLabel}${filterKelas ? `_${filterKelas}` : ''}.xlsx`;
                console.log('üìÅ Filename:', filename);
                
                // Try primary method: Create workbook and download
                try {
                    console.log('üîÑ Attempting primary download method...');
                    
                    // Create workbook
                    const wb = XLSX.utils.book_new();
                    const ws = XLSX.utils.aoa_to_sheet(exportData);
                    
                    // Set column widths
                    const colWidths = [
                        { wch: 25 }, // Nama Siswa
                        { wch: 10 }, // Kelas
                    ];
                    
                    // Date columns
                    sortedDates.forEach(() => {
                        colWidths.push({ wch: 12 });
                    });
                    
                    // Summary columns
                    colWidths.push(
                        { wch: 10 }, // Hadir
                        { wch: 10 }, // Sakit
                        { wch: 10 }, // Ijin
                        { wch: 10 }, // Alpha
                        { wch: 15 }, // Bolos JP
                        { wch: 15 }  // Persentase
                    );
                    
                    ws['!cols'] = colWidths;
                    
                    // Add worksheet to workbook
                    XLSX.utils.book_append_sheet(wb, ws, 'Rekap Kehadiran');
                    
                    // Create blob and download
                    const wbout = XLSX.write(wb, { bookType: 'xlsx', type: 'array' });
                    const blob = new Blob([wbout], { type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' });
                    
                    // Create download link
                    const url = URL.createObjectURL(blob);
                    const link = document.createElement('a');
                    link.href = url;
                    link.download = filename;
                    link.style.display = 'none';
                    
                    // Add to DOM, click, and remove
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    
                    // Clean up URL
                    setTimeout(() => URL.revokeObjectURL(url), 1000);
                    
                    console.log('‚úÖ Primary download method successful');
                    showNotification(`Data berhasil diekspor! (${Object.keys(attendanceMatrix).length} siswa)`, 'success');
                    
                } catch (primaryError) {
                    console.warn('‚ö†Ô∏è Primary download method failed:', primaryError);
                    
                    // Fallback method: Use XLSX.writeFile
                    try {
                        console.log('üîÑ Attempting fallback download method...');
                        
                        const wb = XLSX.utils.book_new();
                        const ws = XLSX.utils.aoa_to_sheet(exportData);
                        XLSX.utils.book_append_sheet(wb, ws, 'Rekap Kehadiran');
                        XLSX.writeFile(wb, filename);
                        
                        console.log('‚úÖ Fallback download method successful');
                        showNotification(`Data berhasil diekspor! (${Object.keys(attendanceMatrix).length} siswa)`, 'success');
                        
                    } catch (fallbackError) {
                        console.error('‚ùå Fallback download method failed:', fallbackError);
                        
                        // Final fallback: Show manual download option
                        const csvData = exportData.map(row => row.join(',')).join('\n');
                        const csvBlob = new Blob([csvData], { type: 'text/csv;charset=utf-8;' });
                        const csvUrl = URL.createObjectURL(csvBlob);
                        
                        const newWindow = window.open('', '_blank');
                        if (newWindow) {
                            newWindow.document.write(`
                                <html>
                                <head><title>Download Data</title></head>
                                <body style="font-family: Arial, sans-serif; padding: 20px;">
                                    <h2>üìä Export Data Rekap Kehadiran</h2>
                                    <p>Klik link di bawah untuk mendownload data:</p>
                                    <p><a href="${csvUrl}" download="${filename.replace('.xlsx', '.csv')}" style="background: #4F46E5; color: white; padding: 10px 20px; text-decoration: none; border-radius: 5px;">üì• Download CSV</a></p>
                                    <p><small>Data berisi ${Object.keys(attendanceMatrix).length} siswa untuk periode ${periodLabel}</small></p>
                                </body>
                                </html>
                            `);
                        }
                        
                        showNotification('Download otomatis gagal. Silakan gunakan link manual yang terbuka.', 'error');
                    }
                }
                
            } catch (error) {
                console.error('‚ùå Critical error in export function:', error);
                showNotification('Gagal mengekspor data: ' + error.message, 'error');
            } finally {
                btn.disabled = false;
                btnText.textContent = 'üìä Download Excel';
                spinner.classList.add('hidden');
            }
        }

        function downloadWaliRekapExcel() {
            const filterPeriode = document.getElementById('filterPeriodeWali').value;
            const dateFrom = document.getElementById('dateFromWali').value;
            const dateTo = document.getElementById('dateToWali').value;
            
            let periodLabel = '';
            let dateRange = [];
            
            // Determine date range based on filter (same as updateRekapKehadiran)
            if (filterPeriode === 'today') {
                const today = new Date();
                dateRange = [today.toLocaleDateString('id-ID')];
                periodLabel = 'Hari_Ini';
            } else if (filterPeriode === 'week') {
                const today = new Date();
                const startOfWeek = new Date(today.setDate(today.getDate() - today.getDay()));
                dateRange = [];
                for (let i = 0; i < 7; i++) {
                    const date = new Date(startOfWeek);
                    date.setDate(startOfWeek.getDate() + i);
                    dateRange.push(date.toLocaleDateString('id-ID'));
                }
                periodLabel = 'Minggu_Ini';
            } else if (filterPeriode === 'month') {
                const today = new Date();
                const year = today.getFullYear();
                const month = today.getMonth();
                const daysInMonth = new Date(year, month + 1, 0).getDate();
                dateRange = [];
                for (let i = 1; i <= daysInMonth; i++) {
                    const date = new Date(year, month, i);
                    dateRange.push(date.toLocaleDateString('id-ID'));
                }
                periodLabel = 'Bulan_Ini';
            } else if (filterPeriode === 'lastmonth') {
                const today = new Date();
                const year = today.getFullYear();
                const month = today.getMonth() - 1;
                const daysInMonth = new Date(year, month + 1, 0).getDate();
                dateRange = [];
                for (let i = 1; i <= daysInMonth; i++) {
                    const date = new Date(year, month, i);
                    dateRange.push(date.toLocaleDateString('id-ID'));
                }
                periodLabel = 'Bulan_Lalu';
            } else if (filterPeriode === 'custom' && dateFrom && dateTo) {
                const start = new Date(dateFrom);
                const end = new Date(dateTo);
                dateRange = [];
                for (let d = new Date(start); d <= end; d.setDate(d.getDate() + 1)) {
                    dateRange.push(new Date(d).toLocaleDateString('id-ID'));
                }
                periodLabel = 'Custom';
            }
            
            const btn = document.getElementById('downloadWaliBtn');
            const btnText = document.getElementById('downloadWaliBtnText');
            const spinner = document.getElementById('downloadWaliSpinner');
            
            btn.disabled = true;
            btnText.textContent = 'Mengexport...';
            spinner.classList.remove('hidden');
            
            console.log('üîÑ Starting Wali Kelas Rekap Excel export...');
            
            try {
                const kelasWali = currentUser['Wali Kelas'];
                
                console.log('üìä Export parameters:', {
                    class: kelasWali,
                    period: periodLabel,
                    dateRange: dateRange.length,
                    filter: filterPeriode
                });
                
                // Get students in this class
                const siswaKelas = classData.filter(row => row.Kelas === kelasWali);
                
                // Load both absensi and jurnal data
                const absensiData = getAllAbsensiData();
                const jurnalData = getAllJurnalData();
                
                // Filter data by class and date range
                const filteredAbsensi = absensiData.filter(item => {
                    const kelas = item.Kelas || item.kelas || '';
                    if (kelas !== kelasWali) return false;
                    
                    const timestamp = item.Timestamp || item.timestamp || item['Tanggal'] || item.tanggal;
                    if (!timestamp) return false;
                    
                    const parsedTime = parseTimestamp(timestamp);
                    return parsedTime && (dateRange.length === 0 || dateRange.includes(parsedTime.dateString));
                });
                
                console.log('üìã Filtered data:', {
                    students: siswaKelas.length,
                    attendanceRecords: filteredAbsensi.length
                });
                
                // Sort dates chronologically
                const sortedDates = dateRange.sort((a, b) => {
                    const dateA = parseIndonesianDate(a);
                    const dateB = parseIndonesianDate(b);
                    return dateA - dateB;
                });
                
                // Build attendance matrix (reuse logic from updateRekapKehadiran)
                const attendanceMatrix = {};
                
                siswaKelas.forEach(siswa => {
                    const namaSiswa = siswa['Nama Siswa'];
                    attendanceMatrix[namaSiswa] = {
                        kelas: siswa.Kelas,
                        dailyAttendance: {},
                        totalStats: { hadir: 0, sakit: 0, ijin: 0, alpha: 0, bolos: 0 }
                    };
                    
                    sortedDates.forEach(date => {
                        attendanceMatrix[namaSiswa].dailyAttendance[date] = {
                            finalStatus: 'Tidak Ada Data',
                            statusColor: 'text-gray-400',
                            totalJP: 0,
                            hadirJP: 0,
                            hasLearning: false
                        };
                    });
                });
                
                // Process attendance data (same logic as updateRekapKehadiran)
                filteredAbsensi.forEach(record => {
                    const nama = record['Nama Siswa'] || record.namaSiswa || record['Siswa'] || record.siswa;
                    const timestamp = record.Timestamp || record.timestamp || record['Tanggal'] || record.tanggal;
                    const status = record.Keterangan || record.keterangan || record.Status || record.status;
                    const jamPelajaran = parseInt(record['Jam Pelajaran'] || record.jamPelajaran || '1');
                    
                    if (!nama || !timestamp || !status) return;
                    
                    const parsedTime = parseTimestamp(timestamp);
                    if (!parsedTime) return;
                    
                    const dateKey = parsedTime.dateString;
                    
                    if (attendanceMatrix[nama] && attendanceMatrix[nama].dailyAttendance[dateKey]) {
                        const dayData = attendanceMatrix[nama].dailyAttendance[dateKey];
                        dayData.hasLearning = true;
                        dayData.totalJP += jamPelajaran;
                        
                        if (status.toLowerCase() === 'hadir') {
                            dayData.hadirJP += jamPelajaran;
                        }
                    }
                });
                
                // Calculate final status for each student per day (same logic as updateRekapKehadiran)
                siswaKelas.forEach(siswa => {
                    const namaSiswa = siswa['Nama Siswa'];
                    const studentData = attendanceMatrix[namaSiswa];
                    
                    sortedDates.forEach(date => {
                        const dayData = studentData.dailyAttendance[date];
                        
                        if (dayData.totalJP === 0) {
                            return;
                        }
                        
                        const hadirPercentage = (dayData.hadirJP / dayData.totalJP) * 100;
                        
                        // Calculate JP for each status
                        const statusJP = { hadir: 0, alpha: 0, bolos: 0, sakit: 0, ijin: 0 };
                        
                        filteredAbsensi.forEach(record => {
                            const recordNama = record['Nama Siswa'] || record.namaSiswa || record['Siswa'] || record.siswa;
                            const recordTimestamp = record.Timestamp || record.timestamp || record['Tanggal'] || record.tanggal;
                            const recordStatus = record.Keterangan || record.keterangan || record.Status || record.status;
                            const recordJP = parseInt(record['Jam Pelajaran'] || record.jamPelajaran || '1');
                            
                            if (recordNama === namaSiswa) {
                                const recordParsedTime = parseTimestamp(recordTimestamp);
                                if (recordParsedTime && recordParsedTime.dateString === date) {
                                    const status = recordStatus.toLowerCase();
                                    statusJP[status] = (statusJP[status] || 0) + recordJP;
                                }
                            }
                        });
                        
                        // Always count bolos JP separately
                        if (statusJP.bolos > 0) {
                            studentData.totalStats.bolos += statusJP.bolos;
                        }
                        
                        // Special handling for hadir + bolos combination
                        const hasHadirAndBolos = statusJP.hadir > 0 && statusJP.bolos > 0;
                        
                        // Determine final status
                        if (hadirPercentage >= 55) {
                            dayData.finalStatus = 'Hadir';
                            dayData.bolosJP = statusJP.bolos;
                            studentData.totalStats.hadir++;
                        } else {
                            if (hasHadirAndBolos) {
                                dayData.finalStatus = 'Hadir';
                                dayData.bolosJP = statusJP.bolos;
                                dayData.isPartialAttendance = true;
                                studentData.totalStats.hadir++;
                            } else {
                                // Determine majority status from non-hadir statuses
                                const nonHadirStatusJP = {};
                                Object.entries(statusJP).forEach(([status, jp]) => {
                                    if (status !== 'hadir' && jp > 0) {
                                        nonHadirStatusJP[status] = jp;
                                    }
                                });
                                
                                if (Object.keys(nonHadirStatusJP).length > 0) {
                                    const majorityStatus = Object.keys(nonHadirStatusJP).reduce((a, b) => 
                                        nonHadirStatusJP[a] > nonHadirStatusJP[b] ? a : b);
                                    
                                    if (majorityStatus === 'alpha') {
                                        dayData.finalStatus = 'Alpha';
                                        studentData.totalStats.alpha++;
                                    } else if (majorityStatus === 'bolos') {
                                        dayData.finalStatus = 'Bolos';
                                    } else if (majorityStatus === 'sakit') {
                                        dayData.finalStatus = 'Sakit';
                                        studentData.totalStats.sakit++;
                                    } else if (majorityStatus === 'ijin') {
                                        dayData.finalStatus = 'Ijin';
                                        studentData.totalStats.ijin++;
                                    }
                                    
                                    dayData.bolosJP = statusJP.bolos;
                                }
                            }
                        }
                    });
                });
                
                // Prepare data for Excel
                const exportData = [];
                
                // Add header row
                const headerRow = ['Nama Siswa', 'Kelas'];
                sortedDates.forEach(date => {
                    headerRow.push(formatShortDate(date));
                });
                headerRow.push('Total Hadir', 'Total Sakit', 'Total Ijin', 'Total Alpha', 'Total Bolos (JP)', 'Persentase Kehadiran');
                exportData.push(headerRow);
                
                // Add student data rows
                Object.keys(attendanceMatrix).forEach(nama => {
                    const studentData = attendanceMatrix[nama];
                    const totalDays = studentData.totalStats.hadir + studentData.totalStats.sakit + 
                                     studentData.totalStats.ijin + studentData.totalStats.alpha + 
                                     Math.ceil(studentData.totalStats.bolos / 8);
                    const attendancePercentage = totalDays > 0 ? Math.round((studentData.totalStats.hadir / totalDays) * 100) : 0;
                    
                    const row = [nama, studentData.kelas];
                    
                    // Add daily attendance
                    sortedDates.forEach(date => {
                        const dayData = studentData.dailyAttendance[date];
                        let cellValue = dayData.finalStatus;
                        
                        if (dayData.totalJP > 0) {
                            cellValue += ` (${dayData.hadirJP}/${dayData.totalJP} JP)`;
                        }
                        if (dayData.bolosJP > 0) {
                            cellValue += ` - Bolos: ${dayData.bolosJP} JP`;
                        }
                        if (dayData.isPartialAttendance) {
                            cellValue += ' ‚ö†Ô∏è';
                        }
                        
                        row.push(cellValue);
                    });
                    
                    // Add summary statistics
                    row.push(
                        studentData.totalStats.hadir,
                        studentData.totalStats.sakit,
                        studentData.totalStats.ijin,
                        studentData.totalStats.alpha,
                        studentData.totalStats.bolos,
                        attendancePercentage + '%'
                    );
                    
                    exportData.push(row);
                });
                
                console.log('üìã Export data prepared:', exportData.length, 'rows');
                
                // Generate filename
                const filename = `Rekap_Kehadiran_${kelasWali}_${periodLabel}.xlsx`;
                console.log('üìÅ Filename:', filename);
                
                // Try primary method: Create workbook and download
                try {
                    console.log('üîÑ Attempting primary download method...');
                    
                    // Create workbook
                    const wb = XLSX.utils.book_new();
                    const ws = XLSX.utils.aoa_to_sheet(exportData);
                    
                    // Set column widths
                    const colWidths = [
                        { wch: 25 }, // Nama Siswa
                        { wch: 10 }, // Kelas
                    ];
                    
                    // Date columns
                    sortedDates.forEach(() => {
                        colWidths.push({ wch: 12 });
                    });
                    
                    // Summary columns
                    colWidths.push(
                        { wch: 10 }, // Hadir
                        { wch: 10 }, // Sakit
                        { wch: 10 }, // Ijin
                        { wch: 10 }, // Alpha
                        { wch: 15 }, // Bolos JP
                        { wch: 15 }  // Persentase
                    );
                    
                    ws['!cols'] = colWidths;
                    
                    // Add worksheet to workbook
                    XLSX.utils.book_append_sheet(wb, ws, 'Rekap Kehadiran');
                    
                    // Create blob and download
                    const wbout = XLSX.write(wb, { bookType: 'xlsx', type: 'array' });
                    const blob = new Blob([wbout], { type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' });
                    
                    // Create download link
                    const url = URL.createObjectURL(blob);
                    const link = document.createElement('a');
                    link.href = url;
                    link.download = filename;
                    link.style.display = 'none';
                    
                    // Add to DOM, click, and remove
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    
                    // Clean up URL
                    setTimeout(() => URL.revokeObjectURL(url), 1000);
                    
                    console.log('‚úÖ Primary download method successful');
                    showNotification(`Data berhasil diekspor! (${siswaKelas.length} siswa)`, 'success');
                    
                } catch (primaryError) {
                    console.warn('‚ö†Ô∏è Primary download method failed:', primaryError);
                    
                    // Fallback method: Use XLSX.writeFile
                    try {
                        console.log('üîÑ Attempting fallback download method...');
                        
                        const wb = XLSX.utils.book_new();
                        const ws = XLSX.utils.aoa_to_sheet(exportData);
                        XLSX.utils.book_append_sheet(wb, ws, 'Rekap Kehadiran');
                        XLSX.writeFile(wb, filename);
                        
                        console.log('‚úÖ Fallback download method successful');
                        showNotification(`Data berhasil diekspor! (${siswaKelas.length} siswa)`, 'success');
                        
                    } catch (fallbackError) {
                        console.error('‚ùå Fallback download method failed:', fallbackError);
                        
                        // Final fallback: Show manual download option
                        const csvData = exportData.map(row => row.join(',')).join('\n');
                        const csvBlob = new Blob([csvData], { type: 'text/csv;charset=utf-8;' });
                        const csvUrl = URL.createObjectURL(csvBlob);
                        
                        const newWindow = window.open('', '_blank');
                        if (newWindow) {
                            newWindow.document.write(`
                                <html>
                                <head><title>Download Data</title></head>
                                <body style="font-family: Arial, sans-serif; padding: 20px;">
                                    <h2>üìä Export Data Rekap Kehadiran</h2>
                                    <p>Klik link di bawah untuk mendownload data:</p>
                                    <p><a href="${csvUrl}" download="${filename.replace('.xlsx', '.csv')}" style="background: #4F46E5; color: white; padding: 10px 20px; text-decoration: none; border-radius: 5px;">üì• Download CSV</a></p>
                                    <p><small>Data berisi ${siswaKelas.length} siswa untuk periode ${periodLabel}</small></p>
                                </body>
                                </html>
                            `);
                        }
                        
                        showNotification('Download otomatis gagal. Silakan gunakan link manual yang terbuka.', 'error');
                    }
                }
                
            } catch (error) {
                console.error('‚ùå Critical error in wali export function:', error);
                showNotification('Gagal mengekspor data: ' + error.message, 'error');
            } finally {
                btn.disabled = false;
                btnText.textContent = 'üìä Download Excel';
                spinner.classList.add('hidden');
            }
        }

        function showJurnalList() {
            const filterPeriode = document.getElementById('filterPeriode').value;
            const filterKelas = document.getElementById('filterKelas').value;
            const dateFrom = document.getElementById('dateFrom').value;
            const dateTo = document.getElementById('dateTo').value;
            
            let periodLabel = '';
            let dateRange = [];
            
            // Determine date range based on filter (same logic as updateDashboardStats)
            if (filterPeriode === 'today') {
                const today = new Date();
                dateRange = [today.toLocaleDateString('id-ID')];
                periodLabel = 'Hari Ini';
            } else if (filterPeriode === 'week') {
                const today = new Date();
                const startOfWeek = new Date(today.setDate(today.getDate() - today.getDay()));
                dateRange = [];
                for (let i = 0; i < 7; i++) {
                    const date = new Date(startOfWeek);
                    date.setDate(startOfWeek.getDate() + i);
                    dateRange.push(date.toLocaleDateString('id-ID'));
                }
                periodLabel = 'Minggu Ini';
            } else if (filterPeriode === 'month') {
                const today = new Date();
                const year = today.getFullYear();
                const month = today.getMonth();
                const daysInMonth = new Date(year, month + 1, 0).getDate();
                dateRange = [];
                for (let i = 1; i <= daysInMonth; i++) {
                    const date = new Date(year, month, i);
                    dateRange.push(date.toLocaleDateString('id-ID'));
                }
                periodLabel = 'Bulan Ini';
            } else if (filterPeriode === 'lastmonth') {
                const today = new Date();
                const year = today.getFullYear();
                const month = today.getMonth() - 1;
                const daysInMonth = new Date(year, month + 1, 0).getDate();
                dateRange = [];
                for (let i = 1; i <= daysInMonth; i++) {
                    const date = new Date(year, month, i);
                    dateRange.push(date.toLocaleDateString('id-ID'));
                }
                periodLabel = 'Bulan Lalu';
            } else if (filterPeriode === 'custom' && dateFrom && dateTo) {
                const start = new Date(dateFrom);
                const end = new Date(dateTo);
                dateRange = [];
                for (let d = new Date(start); d <= end; d.setDate(d.getDate() + 1)) {
                    dateRange.push(new Date(d).toLocaleDateString('id-ID'));
                }
                periodLabel = 'Custom';
            }
            
            // Load and filter jurnal data
            const jurnalData = getAllJurnalData();
            
            const filteredJurnal = jurnalData.filter(item => {
                // Check if guru name matches
                const guruName = item['Nama Guru'] || item['namaGuru'] || item['Guru'] || item.namaGuru;
                
                if (!guruName) {
                    return false;
                }
                
                // Normalize names for comparison
                const normalizedGuruName = guruName.toString().trim().toLowerCase().replace(/[^a-z\s]/g, '');
                const normalizedCurrentUser = currentUser['Nama Guru'].toString().trim().toLowerCase().replace(/[^a-z\s]/g, '');
                
                if (normalizedGuruName !== normalizedCurrentUser) {
                    return false;
                }
                
                // Check class filter
                if (filterKelas) {
                    const itemKelas = item.Kelas || item.kelas || '';
                    if (itemKelas !== filterKelas) {
                        return false;
                    }
                }
                
                // Check timestamp
                const timestamp = item.Timestamp || item.timestamp || item['Tanggal'] || item.tanggal;
                if (!timestamp) {
                    return false;
                }
                
                const parsedTime = parseTimestamp(timestamp);
                return parsedTime && (dateRange.length === 0 || dateRange.includes(parsedTime.dateString));
            });
            
            // Sort by timestamp (newest first)
            filteredJurnal.sort((a, b) => {
                const timestampA = a.Timestamp || a.timestamp || a['Tanggal'] || a.tanggal;
                const timestampB = b.Timestamp || b.timestamp || b['Tanggal'] || b.tanggal;
                return new Date(timestampB) - new Date(timestampA);
            });
            
            // Update modal title
            document.querySelector('#modalJurnalList h3').textContent = `Daftar Jurnal Pembelajaran - ${periodLabel}${filterKelas ? ` (${filterKelas})` : ''}`;
            
            // Populate modal content
            const container = document.getElementById('daftarJurnalList');
            
            if (filteredJurnal.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-8">
                        <div class="text-6xl mb-4">üìö</div>
                        <h4 class="text-lg font-medium text-gray-900 mb-2">Tidak Ada Jurnal</h4>
                        <p class="text-gray-600">Belum ada jurnal pembelajaran untuk periode ${periodLabel.toLowerCase()}${filterKelas ? ` di kelas ${filterKelas}` : ''}.</p>
                    </div>
                `;
            } else {
                container.innerHTML = filteredJurnal.map((jurnal, index) => {
                    const timestamp = jurnal.Timestamp || jurnal.timestamp || jurnal['Tanggal'] || jurnal.tanggal;
                    const kelas = jurnal.Kelas || jurnal.kelas || '';
                    const materi = jurnal.Materi || jurnal.materi || '';
                    const catatan = jurnal.Catatan || jurnal.catatan || '';
                    const jamPelajaran = jurnal['Jam Pelajaran'] || jurnal.jamPelajaran || '1';
                    const mapel = jurnal['Mata Pelajaran'] || jurnal.mataPelajaran || jurnal.Mapel || jurnal.mapel || currentUser.Mapel || '';
                    
                    return `
                        <div class="bg-white border border-gray-200 rounded-lg p-4 hover:bg-gray-50 transition-colors">
                            <div class="flex items-center justify-between mb-3">
                                <div class="flex items-center space-x-3">
                                    <div class="text-2xl">üìö</div>
                                    <div>
                                        <h4 class="font-semibold text-gray-900">${kelas} - ${mapel}</h4>
                                        <p class="text-sm text-gray-600">${timestamp} ‚Ä¢ ${jamPelajaran} JP</p>
                                    </div>
                                </div>
                                <div class="text-right">
                                    <span class="px-2 py-1 bg-blue-100 text-blue-800 text-xs font-medium rounded-full">
                                        Jurnal #${index + 1}
                                    </span>
                                </div>
                            </div>
                            
                            <div class="space-y-3">
                                <div>
                                    <h5 class="text-sm font-medium text-gray-700 mb-2">üìñ Materi Pembelajaran:</h5>
                                    <p class="text-sm text-gray-600 bg-blue-50 p-3 rounded border-l-4 border-blue-200">${materi}</p>
                                </div>
                                
                                ${catatan ? `
                                    <div>
                                        <h5 class="text-sm font-medium text-gray-700 mb-2">üìù Catatan:</h5>
                                        <p class="text-sm text-gray-600 bg-yellow-50 p-3 rounded border-l-4 border-yellow-200">${catatan}</p>
                                    </div>
                                ` : ''}
                            </div>
                        </div>
                    `;
                }).join('');
            }
            
            // Show modal
            document.getElementById('modalJurnalList').classList.remove('hidden');
        }

        function closeModalJurnalList() {
            document.getElementById('modalJurnalList').classList.add('hidden');
        }

        let currentActivities = []; // Store current activities for modal access

        function showActivityDetail(activityIndex) {
            if (!currentActivities[activityIndex]) return;
            
            const activity = currentActivities[activityIndex];
            
            // Update modal title
            document.querySelector('#modalActivityDetail h3').textContent = `Detail Aktivitas - ${activity.kelas} (${activity.date})`;
            
            // Build detailed content
            let content = `
                <div class="bg-blue-50 p-4 rounded-lg mb-4">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm">
                        <div>
                            <p><span class="font-medium">üìÖ Tanggal:</span> ${activity.date}</p>
                            <p><span class="font-medium">üè´ Kelas:</span> ${activity.kelas}</p>
                            <p><span class="font-medium">üë®‚Äçüè´ Guru:</span> ${activity.namaGuru}</p>
                        </div>
                        <div>
                            <p><span class="font-medium">‚è∞ Waktu:</span> ${activity.timestamp}</p>
                            ${activity.jurnal ? `<p><span class="font-medium">üïê Durasi:</span> ${activity.jurnal.jamPelajaran} JP</p>` : ''}
                        </div>
                    </div>
                </div>
            `;
            
            // Add jurnal section if exists
            if (activity.jurnal) {
                content += `
                    <div class="bg-white border border-gray-200 rounded-lg mb-4">
                        <div class="bg-blue-50 px-4 py-3 border-b border-gray-200">
                            <h4 class="font-semibold text-blue-900 flex items-center">
                                <span class="mr-2">üìö</span>
                                Jurnal Pembelajaran (${activity.jurnal.jamPelajaran} JP)
                            </h4>
                        </div>
                        <div class="p-4">
                            <div class="mb-3">
                                <h5 class="text-sm font-medium text-gray-700 mb-2">üìñ Materi Pembelajaran:</h5>
                                <p class="text-sm text-gray-600 bg-blue-50 p-3 rounded border-l-4 border-blue-200">${activity.jurnal.materi}</p>
                            </div>
                        </div>
                    </div>
                `;
            }
            
            // Add absensi section if exists
            if (activity.absensi) {
                content += `
                    <div class="bg-white border border-gray-200 rounded-lg">
                        <div class="bg-green-50 px-4 py-3 border-b border-gray-200">
                            <div class="flex items-center justify-between">
                                <h4 class="font-semibold text-green-900 flex items-center">
                                    <span class="mr-2">üë•</span>
                                    Data Kehadiran Siswa
                                </h4>
                                <div class="text-right">
                                    <div class="text-lg font-bold text-green-600">${Math.round((activity.absensi.hadir / activity.absensi.totalSiswa) * 100)}%</div>
                                    <div class="text-xs text-green-700">${activity.absensi.hadir}/${activity.absensi.totalSiswa} hadir</div>
                                </div>
                            </div>
                        </div>
                        <div class="p-4">
                            <div class="grid grid-cols-2 md:grid-cols-5 gap-2 text-xs mb-4">
                `;
                
                // Status summary
                if (activity.absensi.hadir > 0) {
                    content += `<span class="px-2 py-1 bg-green-100 text-green-800 rounded-full text-center font-medium">‚úì Hadir: ${activity.absensi.hadir}</span>`;
                }
                if (activity.absensi.sakit > 0) {
                    content += `<span class="px-2 py-1 bg-yellow-100 text-yellow-800 rounded-full text-center font-medium">ü§í Sakit: ${activity.absensi.sakit}</span>`;
                }
                if (activity.absensi.ijin > 0) {
                    content += `<span class="px-2 py-1 bg-blue-100 text-blue-800 rounded-full text-center font-medium">üìù Ijin: ${activity.absensi.ijin}</span>`;
                }
                if (activity.absensi.alpha > 0) {
                    content += `<span class="px-2 py-1 bg-red-100 text-red-800 rounded-full text-center font-medium">‚ùå Alpha: ${activity.absensi.alpha}</span>`;
                }
                if (activity.absensi.bolos > 0) {
                    content += `<span class="px-2 py-1 bg-purple-100 text-purple-800 rounded-full text-center font-medium">üö´ Bolos: ${activity.absensi.bolos}</span>`;
                }
                
                content += `
                            </div>
                            
                            <div>
                                <h5 class="text-sm font-medium text-gray-700 mb-3">üìã Daftar Siswa:</h5>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-2">
                `;
                
                // Individual student list
                activity.absensi.siswaList.forEach(siswa => {
                    const statusColor = siswa.status.toLowerCase() === 'hadir' ? 'bg-green-100 text-green-700 border-green-200' :
                                       siswa.status.toLowerCase() === 'sakit' ? 'bg-yellow-100 text-yellow-700 border-yellow-200' :
                                       siswa.status.toLowerCase() === 'ijin' ? 'bg-blue-100 text-blue-700 border-blue-200' :
                                       siswa.status.toLowerCase() === 'alpha' ? 'bg-red-100 text-red-700 border-red-200' :
                                       'bg-purple-100 text-purple-700 border-purple-200';
                    
                    const statusIcon = siswa.status.toLowerCase() === 'hadir' ? '‚úì' :
                                      siswa.status.toLowerCase() === 'sakit' ? 'ü§í' :
                                      siswa.status.toLowerCase() === 'ijin' ? 'üìù' :
                                      siswa.status.toLowerCase() === 'alpha' ? '‚ùå' : 'üö´';
                    
                    content += `
                        <div class="flex items-center justify-between p-2 ${statusColor} border rounded text-sm">
                            <span class="font-medium">${siswa.nama}</span>
                            <span class="text-xs">${statusIcon} ${siswa.status}</span>
                        </div>
                    `;
                });
                
                content += `
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }
            
            // If no jurnal or absensi data
            if (!activity.jurnal && !activity.absensi) {
                content += `
                    <div class="text-center py-8">
                        <div class="text-6xl mb-4">üìã</div>
                        <h4 class="text-lg font-medium text-gray-900 mb-2">Data Tidak Lengkap</h4>
                        <p class="text-gray-600">Aktivitas ini tidak memiliki data jurnal atau kehadiran yang lengkap.</p>
                    </div>
                `;
            }
            
            // Populate modal content
            document.getElementById('activityDetailContent').innerHTML = content;
            
            // Show modal
            document.getElementById('modalActivityDetail').classList.remove('hidden');
        }

        function closeModalActivityDetail() {
            document.getElementById('modalActivityDetail').classList.add('hidden');
        }

        // Wali Kelas specific functions for date detail
        function showWaliDateDetail(date) {
            const kelasWali = currentUser['Wali Kelas'];
            
            // Load both jurnal and absensi data
            const jurnalData = getAllJurnalData();
            const absensiData = getAllAbsensiData();
            
            // Filter data by class and date
            const filteredJurnal = jurnalData.filter(item => {
                const kelas = item.Kelas || item.kelas || '';
                if (kelas !== kelasWali) return false;
                
                const timestamp = item.Timestamp || item.timestamp || item['Tanggal'] || item.tanggal;
                if (!timestamp) return false;
                
                const parsedTime = parseTimestamp(timestamp);
                return parsedTime && parsedTime.dateString === date;
            });
            
            const filteredAbsensi = absensiData.filter(item => {
                const kelas = item.Kelas || item.kelas || '';
                if (kelas !== kelasWali) return false;
                
                const timestamp = item.Timestamp || item.timestamp || item['Tanggal'] || item.tanggal;
                if (!timestamp) return false;
                
                const parsedTime = parseTimestamp(timestamp);
                return parsedTime && parsedTime.dateString === date;
            });
            
            // Get students in this class
            const siswaKelas = classData.filter(row => row.Kelas === kelasWali);
            
            // Build combined learning and attendance data structure
            const subjectData = {};
            
            // Process jurnal data first
            filteredJurnal.forEach(item => {
                const namaGuru = item['Nama Guru'] || item.namaGuru || 'Guru';
                const mapel = item['Mata Pelajaran'] || item.mataPelajaran || item.Mapel || item.mapel || namaGuru;
                const materi = item.Materi || item.materi || '';
                const jamPelajaran = parseInt(item['Jam Pelajaran'] || item.jamPelajaran || '1');
                const timestamp = item.Timestamp || item.timestamp || item['Tanggal'] || item.tanggal;
                
                const subjectKey = `${namaGuru}_${mapel}`;
                subjectData[subjectKey] = {
                    namaGuru: namaGuru,
                    mapel: mapel,
                    materi: materi,
                    jamPelajaran: jamPelajaran,
                    timestamp: timestamp,
                    siswaList: {}
                };
                
                // Initialize siswa list for this subject
                siswaKelas.forEach(siswa => {
                    const namaSiswa = siswa['Nama Siswa'];
                    subjectData[subjectKey].siswaList[namaSiswa] = {
                        status: 'Tidak Ada Data',
                        statusColor: 'text-gray-400'
                    };
                });
            });
            
            // Process attendance data
            filteredAbsensi.forEach(record => {
                const nama = record['Nama Siswa'] || record.namaSiswa || record['Siswa'] || record.siswa;
                const status = record.Keterangan || record.keterangan || record.Status || record.status;
                const jamPelajaran = parseInt(record['Jam Pelajaran'] || record.jamPelajaran || '1');
                const namaGuru = record['Nama Guru'] || record.namaGuru || 'Guru';
                const timestamp = record.Timestamp || record.timestamp || record['Tanggal'] || record.tanggal;
                
                if (!nama || !status || !namaGuru) return;
                
                // Find matching subject
                const matchingSubjects = Object.keys(subjectData).filter(subjectKey => {
                    const subject = subjectData[subjectKey];
                    return subject.namaGuru === namaGuru;
                });
                
                matchingSubjects.forEach(subjectKey => {
                    const subject = subjectData[subjectKey];
                    if (subject.siswaList[nama]) {
                        const statusColor = status.toLowerCase() === 'hadir' ? 'text-green-600 bg-green-50' :
                                           status.toLowerCase() === 'alpha' ? 'text-red-600 bg-red-50' :
                                           status.toLowerCase() === 'bolos' ? 'text-purple-600 bg-purple-50' :
                                           status.toLowerCase() === 'sakit' ? 'text-yellow-600 bg-yellow-50' :
                                           'text-blue-600 bg-blue-50';
                        
                        subject.siswaList[nama] = {
                            status: status,
                            statusColor: statusColor,
                            jp: jamPelajaran,
                            timestamp: timestamp
                        };
                    }
                });
            });
            
            // Update modal title
            document.querySelector('#modalActivityDetail h3').textContent = `Detail Pembelajaran - ${formatShortDate(date)} (${kelasWali})`;
            
            // Build content
            let content = `
                <div class="bg-blue-50 p-4 rounded-lg mb-4">
                    <h3 class="text-lg font-semibold text-blue-900 mb-2">üìÖ Mata Pelajaran & Kehadiran - ${formatShortDate(date)}</h3>
                    <p class="text-blue-700 text-sm">Klik mata pelajaran untuk melihat detail kehadiran individual siswa</p>
                </div>
            `;
            
            const subjects = Object.keys(subjectData);
            
            if (subjects.length === 0) {
                content += `
                    <div class="text-center py-8">
                        <div class="text-6xl mb-4">üìö</div>
                        <h4 class="text-lg font-medium text-gray-900 mb-2">Tidak Ada Pembelajaran</h4>
                        <p class="text-gray-600">Tidak ada mata pelajaran yang diajarkan pada tanggal ${formatShortDate(date)}.</p>
                    </div>
                `;
            } else {
                content += `<div class="grid gap-4">`;
                
                subjects.forEach(subjectKey => {
                    const subject = subjectData[subjectKey];
                    const totalSiswa = siswaKelas.length;
                    const hadirCount = Object.values(subject.siswaList).filter(s => s.status && s.status.toLowerCase() === 'hadir').length;
                    const attendanceRate = totalSiswa > 0 ? Math.round((hadirCount / totalSiswa) * 100) : 0;
                    
                    content += `
                        <div class="bg-white border border-gray-200 rounded-lg overflow-hidden">
                            <div class="bg-gray-50 px-4 py-3 border-b border-gray-200 cursor-pointer hover:bg-gray-100 transition-colors" 
                                 onclick="showWaliSubjectDetail('${date}', '${subjectKey}')">
                                <div class="flex items-center justify-between">
                                    <div>
                                        <h4 class="font-semibold text-gray-900">${subject.mapel}</h4>
                                        <p class="text-sm text-gray-600">Guru: ${subject.namaGuru} ‚Ä¢ ${subject.jamPelajaran} JP ‚Ä¢ ${subject.timestamp}</p>
                                    </div>
                                    <div class="text-right">
                                        <div class="text-lg font-bold ${attendanceRate >= 80 ? 'text-green-600' : attendanceRate >= 60 ? 'text-yellow-600' : 'text-red-600'}">
                                            ${attendanceRate}%
                                        </div>
                                        <div class="text-xs text-gray-500">${hadirCount}/${totalSiswa} hadir</div>
                                        <div class="text-xs text-blue-600 mt-1">üëÜ Detail Individual</div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="p-4">
                                <div class="mb-3">
                                    <h5 class="text-sm font-medium text-gray-700 mb-2">üìñ Materi Pembelajaran:</h5>
                                    <p class="text-sm text-gray-600 bg-blue-50 p-3 rounded border-l-4 border-blue-200">${subject.materi}</p>
                                </div>
                                
                                <div class="grid grid-cols-2 md:grid-cols-5 gap-2 text-xs">
                    `;
                    
                    // Count status
                    const statusCounts = { hadir: 0, sakit: 0, ijin: 0, alpha: 0, bolos: 0, 'tidak ada data': 0 };
                    Object.values(subject.siswaList).forEach(siswa => {
                        const status = siswa.status ? siswa.status.toLowerCase() : 'tidak ada data';
                        statusCounts[status] = (statusCounts[status] || 0) + 1;
                    });
                    
                    Object.entries(statusCounts).forEach(([status, count]) => {
                        if (count > 0) {
                            const statusColor = status === 'hadir' ? 'bg-green-100 text-green-800' :
                                               status === 'alpha' ? 'bg-red-100 text-red-800' :
                                               status === 'bolos' ? 'bg-purple-100 text-purple-800' :
                                               status === 'sakit' ? 'bg-yellow-100 text-yellow-800' :
                                               status === 'ijin' ? 'bg-blue-100 text-blue-800' :
                                               'bg-gray-100 text-gray-800';
                            
                            content += `
                                <div class="px-2 py-1 ${statusColor} rounded text-center font-medium">
                                    ${status.charAt(0).toUpperCase() + status.slice(1)}: ${count}
                                </div>
                            `;
                        }
                    });
                    
                    content += `
                                </div>
                            </div>
                        </div>
                    `;
                });
                
                content += `</div>`;
            }
            
            // Populate modal content
            document.getElementById('activityDetailContent').innerHTML = content;
            
            // Show modal
            document.getElementById('modalActivityDetail').classList.remove('hidden');
        }

        function showWaliSubjectDetail(date, subjectKey) {
            const kelasWali = currentUser['Wali Kelas'];
            
            // Load both jurnal and absensi data
            const jurnalData = getAllJurnalData();
            const absensiData = getAllAbsensiData();
            
            // Filter data by class and date
            const filteredJurnal = jurnalData.filter(item => {
                const kelas = item.Kelas || item.kelas || '';
                if (kelas !== kelasWali) return false;
                
                const timestamp = item.Timestamp || item.timestamp || item['Tanggal'] || item.tanggal;
                if (!timestamp) return false;
                
                const parsedTime = parseTimestamp(timestamp);
                return parsedTime && parsedTime.dateString === date;
            });
            
            const filteredAbsensi = absensiData.filter(item => {
                const kelas = item.Kelas || item.kelas || '';
                if (kelas !== kelasWali) return false;
                
                const timestamp = item.Timestamp || item.timestamp || item['Tanggal'] || item.tanggal;
                if (!timestamp) return false;
                
                const parsedTime = parseTimestamp(timestamp);
                return parsedTime && parsedTime.dateString === date;
            });
            
            // Get students in this class
            const siswaKelas = classData.filter(row => row.Kelas === kelasWali);
            
            // Find the specific subject
            let subject = null;
            filteredJurnal.forEach(item => {
                const namaGuru = item['Nama Guru'] || item.namaGuru || 'Guru';
                const mapel = item['Mata Pelajaran'] || item.mataPelajaran || item.Mapel || item.mapel || namaGuru;
                const currentSubjectKey = `${namaGuru}_${mapel}`;
                
                if (currentSubjectKey === subjectKey) {
                    subject = {
                        namaGuru: namaGuru,
                        mapel: mapel,
                        materi: item.Materi || item.materi || '',
                        jamPelajaran: parseInt(item['Jam Pelajaran'] || item.jamPelajaran || '1'),
                        timestamp: item.Timestamp || item.timestamp || item['Tanggal'] || item.tanggal,
                        siswaList: {}
                    };
                    
                    // Initialize siswa list
                    siswaKelas.forEach(siswa => {
                        const namaSiswa = siswa['Nama Siswa'];
                        subject.siswaList[namaSiswa] = {
                            status: 'Tidak Ada Data',
                            statusColor: 'text-gray-400'
                        };
                    });
                }
            });
            
            if (!subject) return;
            
            // Process attendance data for this subject
            filteredAbsensi.forEach(record => {
                const nama = record['Nama Siswa'] || record.namaSiswa || record['Siswa'] || record.siswa;
                const status = record.Keterangan || record.keterangan || record.Status || record.status;
                const jamPelajaran = parseInt(record['Jam Pelajaran'] || record.jamPelajaran || '1');
                const namaGuru = record['Nama Guru'] || record.namaGuru || 'Guru';
                const timestamp = record.Timestamp || record.timestamp || record['Tanggal'] || record.tanggal;
                
                if (!nama || !status || !namaGuru) return;
                
                // Check if this attendance record matches our subject
                if (namaGuru === subject.namaGuru && subject.siswaList[nama]) {
                    const statusColor = status.toLowerCase() === 'hadir' ? 'text-green-600 bg-green-50' :
                                       status.toLowerCase() === 'alpha' ? 'text-red-600 bg-red-50' :
                                       status.toLowerCase() === 'bolos' ? 'text-purple-600 bg-purple-50' :
                                       status.toLowerCase() === 'sakit' ? 'text-yellow-600 bg-yellow-50' :
                                       'text-blue-600 bg-blue-50';
                    
                    subject.siswaList[nama] = {
                        status: status,
                        statusColor: statusColor,
                        jp: jamPelajaran,
                        timestamp: timestamp
                    };
                }
            });
            
            // Update modal title
            document.querySelector('#modalActivityDetail h3').textContent = `Detail Presensi - ${subject.mapel} (${formatShortDate(date)})`;
            
            // Build detailed content
            let content = `
                <div class="bg-green-50 p-4 rounded-lg mb-4">
                    <h3 class="text-lg font-semibold text-green-900 mb-2">üë• Detail Kehadiran Individual</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm">
                        <div>
                            <p><span class="font-medium">üìÖ Tanggal:</span> ${formatShortDate(date)}</p>
                            <p><span class="font-medium">üè´ Kelas:</span> ${kelasWali}</p>
                            <p><span class="font-medium">üìö Mata Pelajaran:</span> ${subject.mapel}</p>
                        </div>
                        <div>
                            <p><span class="font-medium">üë®‚Äçüè´ Guru:</span> ${subject.namaGuru}</p>
                            <p><span class="font-medium">‚è∞ Waktu:</span> ${subject.timestamp}</p>
                            <p><span class="font-medium">üïê Durasi:</span> ${subject.jamPelajaran} JP</p>
                        </div>
                    </div>
                    <div class="mt-3">
                        <p class="font-medium text-green-800 mb-2">üìñ Materi Pembelajaran:</p>
                        <p class="text-green-700 bg-white p-3 rounded border-l-4 border-green-300">${subject.materi}</p>
                    </div>
                </div>
                
                <div class="bg-white border border-gray-200 rounded-lg overflow-hidden">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">No</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Nama Siswa</th>
                                <th class="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Status Kehadiran</th>
                                <th class="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Jam Pelajaran</th>
                                <th class="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Waktu Absen</th>
                            </tr>
                        </thead>
                        <tbody class="bg-white divide-y divide-gray-200">
            `;
            
            siswaKelas.forEach((siswa, index) => {
                const namaSiswa = siswa['Nama Siswa'];
                const siswaData = subject.siswaList[namaSiswa] || { status: 'Tidak Ada Data', statusColor: 'text-gray-400' };
                
                const statusBadge = siswaData.status === 'Tidak Ada Data' ? 
                    `<span class="px-2 py-1 text-xs font-medium bg-gray-100 text-gray-600 rounded-full">Tidak Ada Data</span>` :
                    siswaData.status.toLowerCase() === 'hadir' ?
                    `<span class="px-2 py-1 text-xs font-medium bg-green-100 text-green-800 rounded-full">‚úì ${siswaData.status}</span>` :
                    siswaData.status.toLowerCase() === 'alpha' ?
                    `<span class="px-2 py-1 text-xs font-medium bg-red-100 text-red-800 rounded-full">‚ùå ${siswaData.status}</span>` :
                    siswaData.status.toLowerCase() === 'bolos' ?
                    `<span class="px-2 py-1 text-xs font-medium bg-purple-100 text-purple-800 rounded-full">üö´ ${siswaData.status}</span>` :
                    siswaData.status.toLowerCase() === 'sakit' ?
                    `<span class="px-2 py-1 text-xs font-medium bg-yellow-100 text-yellow-800 rounded-full">ü§í ${siswaData.status}</span>` :
                    `<span class="px-2 py-1 text-xs font-medium bg-blue-100 text-blue-800 rounded-full">üìù ${siswaData.status}</span>`;
                
                const rowClass = siswaData.status === 'Tidak Ada Data' ? 'bg-gray-50' :
                                siswaData.status.toLowerCase() === 'hadir' ? 'bg-green-50' :
                                siswaData.status.toLowerCase() === 'alpha' ? 'bg-red-50' :
                                siswaData.status.toLowerCase() === 'bolos' ? 'bg-purple-50' :
                                siswaData.status.toLowerCase() === 'sakit' ? 'bg-yellow-50' :
                                'bg-blue-50';
                
                content += `
                    <tr class="${rowClass} hover:opacity-80 transition-opacity">
                        <td class="px-4 py-3 text-sm text-gray-900">${index + 1}</td>
                        <td class="px-4 py-3 text-sm font-medium text-gray-900">${namaSiswa}</td>
                        <td class="px-4 py-3 text-center">${statusBadge}</td>
                        <td class="px-4 py-3 text-center text-sm text-gray-600">${siswaData.jp || subject.jamPelajaran} JP</td>
                        <td class="px-4 py-3 text-center text-sm text-gray-600">${siswaData.timestamp || '-'}</td>
                    </tr>
                `;
            });
            
            content += `
                        </tbody>
                    </table>
                </div>
            `;
            
            // Add summary statistics
            const totalSiswa = siswaKelas.length;
            const statusCounts = { hadir: 0, sakit: 0, ijin: 0, alpha: 0, bolos: 0, 'tidak ada data': 0 };
            
            Object.values(subject.siswaList).forEach(siswa => {
                const status = siswa.status ? siswa.status.toLowerCase() : 'tidak ada data';
                statusCounts[status] = (statusCounts[status] || 0) + 1;
            });
            
            content += `
                <div class="mt-4 bg-gray-50 p-4 rounded-lg">
                    <h4 class="font-medium text-gray-900 mb-3">üìä Ringkasan Kehadiran</h4>
                    <div class="grid grid-cols-2 md:grid-cols-6 gap-3 text-sm">
            `;
            
            Object.entries(statusCounts).forEach(([status, count]) => {
                if (count > 0) {
                    const percentage = Math.round((count / totalSiswa) * 100);
                    const statusColor = status === 'hadir' ? 'bg-green-100 text-green-800 border-green-200' :
                                       status === 'alpha' ? 'bg-red-100 text-red-800 border-red-200' :
                                       status === 'bolos' ? 'bg-purple-100 text-purple-800 border-purple-200' :
                                       status === 'sakit' ? 'bg-yellow-100 text-yellow-800 border-yellow-200' :
                                       status === 'ijin' ? 'bg-blue-100 text-blue-800 border-blue-200' :
                                       'bg-gray-100 text-gray-800 border-gray-200';
                    
                    content += `
                        <div class="p-3 ${statusColor} border rounded-lg text-center">
                            <div class="font-semibold">${count}</div>
                            <div class="text-xs">${status.charAt(0).toUpperCase() + status.slice(1)}</div>
                            <div class="text-xs opacity-75">${percentage}%</div>
                        </div>
                    `;
                }
            });
            
            content += `
                    </div>
                </div>
            `;
            
            // Populate modal content
            document.getElementById('activityDetailContent').innerHTML = content;
            
            // Show modal (already open, just update content)
        }
    </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'98d5799653e67550',t:'MTc2MDI2MDM0MC4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
