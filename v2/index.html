<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistem Administrasi Kelas</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        body {
            box-sizing: border-box;
        }
        .fade-in {
            animation: fadeIn 0.5s ease-in;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #3498db;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 12px 20px;
            border-radius: 8px;
            color: white;
            font-weight: 500;
            z-index: 1000;
            animation: slideIn 0.3s ease-out;
        }
        .notification.success {
            background-color: #10b981;
        }
        .notification.error {
            background-color: #ef4444;
        }
        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
    </style>
</head>
<body class="bg-gradient-to-br from-blue-50 to-indigo-100 min-h-full">
    <!-- Login Page -->
    <div id="loginPage" class="min-h-full flex items-center justify-center py-12 px-4 sm:px-6 lg:px-8">
        <div class="max-w-md w-full space-y-8 bg-white p-8 rounded-xl shadow-lg fade-in">
            <div class="text-center">
                <img src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEit19uUj7ZanvTG4uc5p6Fc8fkoORl6bLxNN-hB-9wDcw-l5IPwmpX5Q5w6lcIfFE_Qat_o3AMrLZ1jOaBu2A5IAF1sUhJJSrQe6Vf8NdvLMqafGbdbl4xgttpRbCS7dEy6PbZrUKyeutqx34O4mQTQ3Z4UtSbaoPR79ywyjwrxXUMolyZ7oro8bsRQ/s158/LOGO%20MTS4.png" 
                     alt="Logo Sekolah" class="mx-auto h-20 w-auto mb-4">
                <h2 class="text-3xl font-bold text-gray-900 mb-2">Sistem Administrasi Kelas</h2>
                <p class="text-gray-600 mb-4">Silakan login untuk melanjutkan</p>
            </div>
            
            <form id="loginForm" class="mt-8 space-y-6">
                <div class="space-y-4">
                    <div>
                        <label for="username" class="block text-sm font-medium text-gray-700 mb-2">Username</label>
                        <input id="username" name="username" type="text" required 
                               class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                    </div>
                    <div>
                        <label for="password" class="block text-sm font-medium text-gray-700 mb-2">Password</label>
                        <div class="relative">
                            <input id="password" name="password" type="password" required 
                                   class="w-full px-3 py-2 pr-10 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                            <button type="button" id="togglePassword" onclick="togglePasswordVisibility()" 
                                    class="absolute inset-y-0 right-0 pr-3 flex items-center text-gray-400 hover:text-gray-600 focus:outline-none">
                                <svg id="eyeIcon" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" />
                                </svg>
                                <svg id="eyeOffIcon" class="h-5 w-5 hidden" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.875 18.825A10.05 10.05 0 0112 19c-4.478 0-8.268-2.943-9.543-7a9.97 9.97 0 011.563-3.029m5.858.908a3 3 0 114.243 4.243M9.878 9.878l4.242 4.242M9.878 9.878L3 3m6.878 6.878L21 21" />
                                </svg>
                            </button>
                        </div>
                    </div>
                    <div>
                        <label for="userType" class="block text-sm font-medium text-gray-700 mb-2">Login Sebagai</label>
                        <select id="userType" name="userType" required 
                                class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                            <option value="">Pilih Jenis Login</option>
                            <option value="guru">Guru</option>
                            <option value="walikelas">Wali Kelas</option>
                        </select>
                    </div>
                </div>
                
                <div id="loginError" class="hidden bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded"></div>
                
                <button type="submit" id="loginBtn" 
                        class="w-full flex justify-center py-2 px-4 border border-transparent rounded-lg shadow-sm text-sm font-medium text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition duration-200">
                    <span id="loginBtnText">Masuk</span>
                    <span id="loginSpinner" class="loading hidden ml-2"></span>
                </button>
            </form>
        </div>
    </div>

    <!-- Dashboard Guru -->
    <div id="dashboardGuru" class="hidden min-h-full">
        <nav class="bg-white shadow-sm border-b">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex justify-between h-16">
                    <div class="flex items-center">
                        <img src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEit19uUj7ZanvTG4uc5p6Fc8fkoORl6bLxNN-hB-9wDcw-l5IPwmpX5Q5w6lcIfFE_Qat_o3AMrLZ1jOaBu2A5IAF1sUhJJSrQe6Vf8NdvLMqafGbdbl4xgttpRbCS7dEy6PbZrUKyeutqx34O4mQTQ3Z4UtSbaoPR79ywyjwrxXUMolyZ7oro8bsRQ/s158/LOGO%20MTS4.png" 
                             alt="Logo" class="h-8 w-auto mr-3">
                        <h1 class="text-xl font-semibold text-gray-900">Dashboard Guru</h1>
                    </div>
                    <div class="flex items-center space-x-4">
                        <div class="flex items-center space-x-3">
                            <img id="profilePhoto" src="" alt="Foto Profil" class="h-10 w-10 rounded-full object-cover border-2 border-gray-300">
                            <div class="text-right">
                                <div id="welcomeMessage" class="text-gray-900 font-medium"></div>
                                <div id="mapelInfo" class="text-sm text-gray-600"></div>
                            </div>
                        </div>
                        <button onclick="logout()" class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-lg text-sm transition duration-200">
                            Logout
                        </button>
                    </div>
                </div>
            </div>
        </nav>

        <!-- Tab Navigation -->
        <div class="bg-white border-b">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <nav class="flex space-x-8">
                    <button onclick="showTab('dashboard')" id="tabDashboard" class="tab-button py-4 px-1 border-b-2 border-blue-500 text-blue-600 font-medium text-sm">
                        Dashboard
                    </button>
                    <button onclick="showTab('jurnal')" id="tabJurnal" class="tab-button py-4 px-1 border-b-2 border-transparent text-gray-500 hover:text-gray-700 font-medium text-sm">
                        Jurnal Pembelajaran
                    </button>
                    <button onclick="showTab('presensi')" id="tabPresensi" class="tab-button py-4 px-1 border-b-2 border-transparent text-gray-500 hover:text-gray-700 font-medium text-sm">
                        Daftar Kehadiran
                    </button>
                </nav>
            </div>
        </div>

        <div class="max-w-7xl mx-auto py-6 sm:px-6 lg:px-8">
            <div class="px-4 py-6 sm:px-0">
                
                <!-- Tab Dashboard -->
                <div id="contentDashboard" class="tab-content">
                    <!-- Filter Section -->
                    <div class="bg-white shadow rounded-lg mb-6">
                        <div class="px-4 py-5 sm:p-6">
                            <h3 class="text-lg leading-6 font-medium text-gray-900 mb-4">Filter Data</h3>
                            <div class="grid grid-cols-1 md:grid-cols-5 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Periode</label>
                                    <select id="filterPeriode" onchange="updateFilter()" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                                        <option value="today">Hari Ini</option>
                                        <option value="week">Minggu Ini</option>
                                        <option value="month">Bulan Ini</option>
                                        <option value="lastmonth">Bulan Lalu</option>
                                        <option value="custom">Custom</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Kelas</label>
                                    <select id="filterKelas" onchange="updateFilter()" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                                        <option value="">Semua Kelas</option>
                                    </select>
                                </div>
                                <div id="customDateFrom" class="hidden">
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Dari Tanggal</label>
                                    <input type="date" id="dateFrom" onchange="updateFilter()" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                                </div>
                                <div id="customDateTo" class="hidden">
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Sampai Tanggal</label>
                                    <input type="date" id="dateTo" onchange="updateFilter()" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                                </div>
                                <div class="flex items-end">
                                    <button onclick="resetFilter()" class="w-full bg-gray-500 hover:bg-gray-600 text-white font-medium py-2 px-4 rounded-lg transition duration-200">
                                        Reset Filter
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                        <div onclick="showDetailJurnal()" class="bg-white overflow-hidden shadow rounded-lg cursor-pointer hover:shadow-lg transition-shadow duration-200">
                            <div class="p-5">
                                <div class="flex items-center">
                                    <div class="flex-shrink-0">
                                        <div class="text-3xl">üìö</div>
                                    </div>
                                    <div class="ml-5 w-0 flex-1">
                                        <dl>
                                            <dt id="jurnalLabel" class="text-sm font-medium text-gray-500 truncate">Total Jurnal Hari Ini</dt>
                                            <dd id="totalJurnal" class="text-lg font-medium text-gray-900">0</dd>
                                        </dl>
                                    </div>
                                    <div class="text-gray-400">
                                        <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                                            <path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd"></path>
                                        </svg>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="bg-white overflow-hidden shadow rounded-lg">
                            <div class="p-5">
                                <div class="flex items-center">
                                    <div class="flex-shrink-0">
                                        <div class="text-3xl">‚è∞</div>
                                    </div>
                                    <div class="ml-5 w-0 flex-1">
                                        <dl>
                                            <dt id="durasiLabel" class="text-sm font-medium text-gray-500 truncate">Total Durasi Mengajar Hari Ini</dt>
                                            <dd id="totalDurasi" class="text-lg font-medium text-gray-900">0 JP</dd>
                                        </dl>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                        <div onclick="showDetailPresensi()" class="bg-white overflow-hidden shadow rounded-lg cursor-pointer hover:shadow-lg transition-shadow duration-200">
                            <div class="p-5">
                                <div class="flex items-center">
                                    <div class="flex-shrink-0">
                                        <div class="text-3xl">üë•</div>
                                    </div>
                                    <div class="ml-5 w-0 flex-1">
                                        <dl>
                                            <dt id="presensiLabel" class="text-sm font-medium text-gray-500 truncate">Total Presensi Hari Ini</dt>
                                            <dd id="totalPresensi" class="text-lg font-medium text-gray-900">0</dd>
                                        </dl>
                                    </div>
                                    <div class="text-gray-400">
                                        <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                                            <path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd"></path>
                                        </svg>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="bg-white overflow-hidden shadow rounded-lg">
                            <div class="p-5">
                                <div class="flex items-center">
                                    <div class="flex-shrink-0">
                                        <div class="text-3xl">üìä</div>
                                    </div>
                                    <div class="ml-5 w-0 flex-1">
                                        <dl>
                                            <dt id="kelasLabel" class="text-sm font-medium text-gray-500 truncate">Kelas Diajar Hari Ini</dt>
                                            <dd id="totalKelas" class="text-lg font-medium text-gray-900">0</dd>
                                        </dl>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="bg-white shadow rounded-lg">
                        <div class="px-4 py-5 sm:p-6">
                            <h3 class="text-lg leading-6 font-medium text-gray-900 mb-4">Aktivitas Terbaru</h3>
                            <div id="recentActivity" class="space-y-3">
                                <p class="text-gray-500 text-center py-4">Belum ada aktivitas hari ini</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Tab Jurnal -->
                <div id="contentJurnal" class="tab-content hidden">
                    <div class="bg-white overflow-hidden shadow rounded-lg">
                        <div class="px-4 py-5 sm:p-6">
                            <h3 class="text-lg leading-6 font-medium text-gray-900 mb-4">Jurnal Pembelajaran</h3>
                            <form id="jurnalForm" class="space-y-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Kelas</label>
                                    <select id="kelasJurnal" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                                        <option value="">Pilih Kelas</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Materi</label>
                                    <textarea id="materi" required rows="3" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Masukkan materi pembelajaran..."></textarea>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Catatan</label>
                                    <textarea id="catatan" rows="2" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Catatan tambahan (opsional)..."></textarea>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Durasi Pembelajaran</label>
                                    <select id="jamPelajaran" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                                        <option value="">Pilih Durasi</option>
                                        <option value="1">1 Jam Pelajaran</option>
                                        <option value="2">2 Jam Pelajaran</option>
                                        <option value="3">3 Jam Pelajaran</option>
                                        <option value="4">4 Jam Pelajaran</option>
                                    </select>
                                </div>
                                <button type="submit" id="simpanJurnalBtn" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-medium py-2 px-4 rounded-lg transition duration-200 flex items-center justify-center">
                                    <span id="simpanJurnalText">Simpan Jurnal</span>
                                    <div id="simpanJurnalSpinner" class="loading ml-2 hidden"></div>
                                </button>
                            </form>
                        </div>
                    </div>
                </div>

                <!-- Tab Presensi -->
                <div id="contentPresensi" class="tab-content hidden">
                    <div class="bg-white overflow-hidden shadow rounded-lg">
                        <div class="px-4 py-5 sm:p-6">
                            <h3 class="text-lg leading-6 font-medium text-gray-900 mb-4">Daftar Kehadiran Siswa</h3>
                            <div class="space-y-4">
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Kelas</label>
                                        <select id="kelasAbsen" onchange="loadSiswa()" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                                            <option value="">Pilih Kelas</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Durasi Pembelajaran</label>
                                        <select id="jamAbsen" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                                            <option value="">Pilih Durasi</option>
                                            <option value="1">1 Jam Pelajaran</option>
                                            <option value="2">2 Jam Pelajaran</option>
                                            <option value="3">3 Jam Pelajaran</option>
                                            <option value="4">4 Jam Pelajaran</option>
                                        </select>
                                    </div>
                                </div>
                                
                                <div id="daftarSiswa" class="hidden">
                                    <div class="flex justify-between items-center mb-4">
                                        <h4 class="font-medium text-gray-900">Daftar Siswa</h4>
                                        <div class="flex space-x-2">
                                            <button onclick="bulkAction('Hadir')" class="px-3 py-1 bg-green-500 hover:bg-green-600 text-white text-sm rounded-lg transition duration-200">
                                                ‚úì Semua Hadir
                                            </button>
                                            <button onclick="resetAllStatus()" class="px-3 py-1 bg-gray-500 hover:bg-gray-600 text-white text-sm rounded-lg transition duration-200">
                                                üîÑ Reset
                                            </button>
                                        </div>
                                    </div>
                                    
                                    <div id="siswaList" class="space-y-3"></div>
                                    <button id="simpanAbsensiBtn" onclick="simpanAbsensi()" class="w-full mt-4 bg-green-600 hover:bg-green-700 text-white font-medium py-2 px-4 rounded-lg transition duration-200 flex items-center justify-center">
                                        <span id="simpanAbsensiText">Simpan Absensi</span>
                                        <div id="simpanAbsensiSpinner" class="loading ml-2 hidden"></div>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Detail Jurnal -->
                <div id="contentDetailJurnal" class="tab-content hidden">
                    <div class="bg-white overflow-hidden shadow rounded-lg">
                        <div class="px-4 py-5 sm:p-6">
                            <div class="flex items-center justify-between mb-4">
                                <h3 class="text-lg leading-6 font-medium text-gray-900">Detail Jurnal Pembelajaran</h3>
                                <div class="flex space-x-2">
                                    <button onclick="exportJurnalToExcel()" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg text-sm transition duration-200 flex items-center">
                                        <svg class="w-4 h-4 mr-2" fill="currentColor" viewBox="0 0 20 20">
                                            <path d="M3 17a1 1 0 011-1h12a1 1 0 011 1v2a1 1 0 01-1 1H4a1 1 0 01-1-1v-2zM3 5a1 1 0 011-1h12a1 1 0 011 1v8a1 1 0 01-1 1H4a1 1 0 01-1-1V5zM11 4a1 1 0 10-2 0v4a1 1 0 102 0V4z"/>
                                        </svg>
                                        Export Excel
                                    </button>
                                    <button onclick="backToDashboard()" class="bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded-lg text-sm transition duration-200">
                                        ‚Üê Kembali
                                    </button>
                                </div>
                            </div>
                            <div id="detailJurnalContent" class="space-y-4">
                                <!-- Content will be loaded here -->
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Detail Presensi -->
                <div id="contentDetailPresensi" class="tab-content hidden">
                    <div class="bg-white overflow-hidden shadow rounded-lg">
                        <div class="px-4 py-5 sm:p-6">
                            <div class="flex items-center justify-between mb-4">
                                <h3 class="text-lg leading-6 font-medium text-gray-900">Detail Presensi Siswa</h3>
                                <div class="flex space-x-2">
                                    <button onclick="exportPresensiToExcel()" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg text-sm transition duration-200 flex items-center">
                                        <svg class="w-4 h-4 mr-2" fill="currentColor" viewBox="0 0 20 20">
                                            <path d="M3 17a1 1 0 011-1h12a1 1 0 011 1v2a1 1 0 01-1 1H4a1 1 0 01-1-1v-2zM3 5a1 1 0 011-1h12a1 1 0 011 1v8a1 1 0 01-1 1H4a1 1 0 01-1-1V5zM11 4a1 1 0 10-2 0v4a1 1 0 102 0V4z"/>
                                        </svg>
                                        Export Excel
                                    </button>
                                    <button onclick="backToDashboard()" class="bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded-lg text-sm transition duration-200">
                                        ‚Üê Kembali
                                    </button>
                                </div>
                            </div>
                            <div id="detailPresensiContent" class="space-y-4">
                                <!-- Content will be loaded here -->
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Detail Presensi Per Siswa -->
                <div id="contentDetailPresensiSiswa" class="tab-content hidden">
                    <div class="bg-white overflow-hidden shadow rounded-lg">
                        <div class="px-4 py-5 sm:p-6">
                            <div class="flex items-center justify-between mb-4">
                                <h3 id="detailPresensiSiswaTitle" class="text-lg leading-6 font-medium text-gray-900">Detail Presensi Siswa</h3>
                                <button onclick="showDetailPresensi()" class="bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded-lg text-sm transition duration-200">
                                    ‚Üê Kembali
                                </button>
                            </div>
                            <div id="detailPresensiSiswaContent" class="space-y-4">
                                <!-- Content will be loaded here -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Dashboard Wali Kelas -->
    <div id="dashboardWaliKelas" class="hidden min-h-full">
        <nav class="bg-white shadow-sm border-b">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex justify-between h-16">
                    <div class="flex items-center">
                        <img src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEit19uUj7ZanvTG4uc5p6Fc8fkoORl6bLxNN-hB-9wDcw-l5IPwmpX5Q5w6lcIfFE_Qat_o3AMrLZ1jOaBu2A5IAF1sUhJJSrQe6Vf8NdvLMqafGbdbl4xgttpRbCS7dEy6PbZrUKyeutqx34O4mQTQ3Z4UtSbaoPR79ywyjwrxXUMolyZ7oro8bsRQ/s158/LOGO%20MTS4.png" 
                             alt="Logo" class="h-8 w-auto mr-3">
                        <div>
                            <h1 id="dashboardWaliTitle" class="text-xl font-semibold text-gray-900">Dashboard Wali Kelas</h1>
                            <p id="dashboardWaliSubtitle" class="text-sm text-gray-600"></p>
                        </div>
                    </div>
                    <div class="flex items-center space-x-4">
                        <div class="flex items-center space-x-3">
                            <img id="profilePhotoWali" src="" alt="Foto Profil" class="h-10 w-10 rounded-full object-cover border-2 border-gray-300">
                            <div class="text-right">
                                <div id="welcomeMessageWali" class="text-gray-900 font-medium"></div>
                                <div id="roleInfoWali" class="text-sm text-gray-600"></div>
                            </div>
                        </div>
                        <button onclick="logout()" class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-lg text-sm transition duration-200">
                            Logout
                        </button>
                    </div>
                </div>
            </div>
        </nav>

        <!-- Tab Navigation -->
        <div class="bg-white border-b">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <nav class="flex space-x-8">
                    <button onclick="showWaliTab('overview')" id="tabWaliOverview" class="wali-tab-button py-4 px-1 border-b-2 border-blue-500 text-blue-600 font-medium text-sm">
                        Overview
                    </button>
                    <button onclick="showWaliTab('kehadiran')" id="tabWaliKehadiran" class="wali-tab-button py-4 px-1 border-b-2 border-transparent text-gray-500 hover:text-gray-700 font-medium text-sm">
                        Rekap Kehadiran
                    </button>
                    <button onclick="showWaliTab('pembelajaran')" id="tabWaliPembelajaran" class="wali-tab-button py-4 px-1 border-b-2 border-transparent text-gray-500 hover:text-gray-700 font-medium text-sm">
                        Rekap Pembelajaran
                    </button>
                    <button onclick="showWaliTab('siswaBermasalah')" id="tabWaliSiswaBermasalah" class="wali-tab-button py-4 px-1 border-b-2 border-transparent text-gray-500 hover:text-gray-700 font-medium text-sm">
                        Siswa Bermasalah
                    </button>
                </nav>
            </div>
        </div>

        <div class="max-w-7xl mx-auto py-6 sm:px-6 lg:px-8">
            <div class="px-4 py-6 sm:px-0">
                
                <!-- Tab Overview -->
                <div id="contentWaliOverview" class="wali-tab-content">
                    <!-- Filter Section for Operator -->
                    <div id="operatorFilter" class="bg-white shadow rounded-lg mb-6 hidden">
                        <div class="px-4 py-5 sm:p-6">
                            <h3 class="text-lg leading-6 font-medium text-gray-900 mb-4">Filter Kelas</h3>
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Pilih Kelas</label>
                                    <select id="filterKelasWali" onchange="updateWaliFilter()" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                                        <option value="">Semua Kelas</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Periode</label>
                                    <select id="filterPeriodeWali" onchange="updateWaliFilter()" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                                        <option value="week">Minggu Ini</option>
                                        <option value="month">Bulan Ini</option>
                                        <option value="semester1">Semester 1 (Jul-Des)</option>
                                        <option value="semester2">Semester 2 (Jan-Jun)</option>
                                        <option value="tahun">Tahun Ajaran</option>
                                        <option value="custom">Custom</option>
                                    </select>
                                </div>
                                <div class="flex items-end">
                                    <button onclick="resetWaliFilter()" class="w-full bg-gray-500 hover:bg-gray-600 text-white font-medium py-2 px-4 rounded-lg transition duration-200">
                                        Reset Filter
                                    </button>
                                </div>
                            </div>
                            <div id="customDateWali" class="hidden mt-4 grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Dari Tanggal</label>
                                    <input type="date" id="dateFromWali" onchange="updateWaliFilter()" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Sampai Tanggal</label>
                                    <input type="date" id="dateToWali" onchange="updateWaliFilter()" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Statistics Cards -->
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-6">
                        <div class="bg-white overflow-hidden shadow rounded-lg">
                            <div class="p-5">
                                <div class="flex items-center">
                                    <div class="flex-shrink-0">
                                        <div class="text-3xl">üë•</div>
                                    </div>
                                    <div class="ml-5 w-0 flex-1">
                                        <dl>
                                            <dt class="text-sm font-medium text-gray-500 truncate">Total Siswa</dt>
                                            <dd id="totalSiswaWali" class="text-lg font-medium text-gray-900">0</dd>
                                        </dl>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="bg-white overflow-hidden shadow rounded-lg">
                            <div class="p-5">
                                <div class="flex items-center">
                                    <div class="flex-shrink-0">
                                        <div class="text-3xl">üìö</div>
                                    </div>
                                    <div class="ml-5 w-0 flex-1">
                                        <dl>
                                            <dt id="totalPembelajaranLabel" class="text-sm font-medium text-gray-500 truncate">Total Pembelajaran</dt>
                                            <dd id="totalPembelajaranWali" class="text-lg font-medium text-gray-900">0</dd>
                                        </dl>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="bg-white overflow-hidden shadow rounded-lg">
                            <div class="p-5">
                                <div class="flex items-center">
                                    <div class="flex-shrink-0">
                                        <div class="text-3xl">‚úÖ</div>
                                    </div>
                                    <div class="ml-5 w-0 flex-1">
                                        <dl>
                                            <dt id="persentaseKehadiranLabel" class="text-sm font-medium text-gray-500 truncate">Rata-rata Kehadiran</dt>
                                            <dd id="persentaseKehadiranWali" class="text-lg font-medium text-gray-900">0%</dd>
                                        </dl>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div onclick="showSiswaBermasalah()" class="bg-white overflow-hidden shadow rounded-lg cursor-pointer hover:shadow-lg transition-shadow duration-200">
                            <div class="p-5">
                                <div class="flex items-center">
                                    <div class="flex-shrink-0">
                                        <div class="text-3xl">üò∞</div>
                                    </div>
                                    <div class="ml-5 w-0 flex-1">
                                        <dl>
                                            <dt id="siswaBermasalahLabel" class="text-sm font-medium text-gray-500 truncate">Siswa Bermasalah</dt>
                                            <dd id="totalSiswaBermasalah" class="text-lg font-medium text-gray-900">0</dd>
                                        </dl>
                                    </div>
                                    <div class="text-gray-400">
                                        <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                                            <path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd"></path>
                                        </svg>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Quick Summary -->
                    <div class="bg-white shadow rounded-lg">
                        <div class="px-4 py-5 sm:p-6">
                            <h3 class="text-lg leading-6 font-medium text-gray-900 mb-4">Ringkasan Kehadiran</h3>
                            <div id="ringkasanKehadiran" class="space-y-4">
                                <p class="text-gray-500 text-center py-4">Memuat data...</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Tab Kehadiran -->
                <div id="contentWaliKehadiran" class="wali-tab-content hidden">
                    <div class="bg-white shadow rounded-lg">
                        <div class="px-4 py-5 sm:p-6">
                            <div class="flex items-center justify-between mb-4">
                                <h3 class="text-lg leading-6 font-medium text-gray-900">Rekap Kehadiran Siswa</h3>
                                <div class="flex space-x-2">
                                    Periode sesuai filter
                                    <button onclick="exportKehadiranToExcel()" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg text-sm transition duration-200 flex items-center">
                                        <svg class="w-4 h-4 mr-2" fill="currentColor" viewBox="0 0 20 20">
                                            <path d="M3 17a1 1 0 011-1h12a1 1 0 011 1v2a1 1 0 01-1 1H4a1 1 0 01-1-1v-2zM3 5a1 1 0 011-1h12a1 1 0 011 1v8a1 1 0 01-1 1H4a1 1 0 01-1-1V5zM11 4a1 1 0 10-2 0v4a1 1 0 102 0V4z"/>
                                        </svg>
                                        Export Excel
                                    </button>
                                </div>
                            </div>
                            <div id="rekapKehadiranContent" class="space-y-4">
                                <p class="text-gray-500 text-center py-4">Memuat data kehadiran...</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Tab Pembelajaran -->
                <div id="contentWaliPembelajaran" class="wali-tab-content hidden">
                    <div class="bg-white shadow rounded-lg">
                        <div class="px-4 py-5 sm:p-6">
                            <div class="flex items-center justify-between mb-4">
                                <h3 class="text-lg leading-6 font-medium text-gray-900">Rekap Pembelajaran</h3>
                                <div class="flex space-x-2">
                                    periode sesuai filter
                                    <button onclick="exportPembelajaranToExcel()" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg text-sm transition duration-200 flex items-center">
                                        <svg class="w-4 h-4 mr-2" fill="currentColor" viewBox="0 0 20 20">
                                            <path d="M3 17a1 1 0 011-1h12a1 1 0 011 1v2a1 1 0 01-1 1H4a1 1 0 01-1-1v-2zM3 5a1 1 0 011-1h12a1 1 0 011 1v8a1 1 0 01-1 1H4a1 1 0 01-1-1V5zM11 4a1 1 0 10-2 0v4a1 1 0 102 0V4z"/>
                                        </svg>
                                        Export Excel
                                    </button>
                                </div>
                            </div>
                            <div id="rekapPembelajaranContent" class="space-y-4">
                                <p class="text-gray-500 text-center py-4">Memuat data pembelajaran...</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Tab Siswa Bermasalah -->
                <div id="contentWaliSiswaBermasalah" class="wali-tab-content hidden">
                    <div class="bg-white shadow rounded-lg">
                        <div class="px-4 py-5 sm:p-6">
                            <div class="flex items-center justify-between mb-4">
                                <h3 class="text-lg leading-6 font-medium text-gray-900">Daftar Siswa Bermasalah</h3>
                                <button onclick="showWaliTab('overview')" class="bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded-lg text-sm transition duration-200">
                                    ‚Üê Kembali ke Overview
                                </button>
                            </div>
                            <div id="siswaBermasalahContent" class="space-y-4">
                                <p class="text-gray-500 text-center py-4">Memuat data siswa bermasalah...</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let currentUser = null;
        let userData = [];
        let classData = [];

        // Global function for closing download modals
        window.closeDownloadModal = function(button) {
            const modal = button.closest('div[style*="position: fixed"]');
            if (modal && modal.parentNode) {
                modal.parentNode.removeChild(modal);
            }
        };

        // Fallback data untuk testing
        const fallbackUserData = [
            {
                'Username': 'guru1',
                'Password': '123',
                'Nama Guru': 'Ahmad Fauzi',
                'Mapel': 'Matematika',
                'Foto': 'https://via.placeholder.com/40x40/4F46E5/FFFFFF?text=AF',
                'Wali Kelas': ''
            },
            {
                'Username': 'guru2',
                'Password': '123',
                'Nama Guru': 'Siti Nurhaliza',
                'Mapel': 'Bahasa Indonesia',
                'Foto': 'https://via.placeholder.com/40x40/10B981/FFFFFF?text=SN',
                'Wali Kelas': '7A'
            },
            {
                'Username': 'wali1',
                'Password': '123',
                'Nama Guru': 'Budi Santoso',
                'Mapel': 'IPA',
                'Foto': 'https://via.placeholder.com/40x40/F59E0B/FFFFFF?text=BS',
                'Wali Kelas': '8B'
            }
        ];

        const fallbackClassData = [
            { 'Kelas': '7A', 'Nama Siswa': 'Andi Pratama' },
            { 'Kelas': '7A', 'Nama Siswa': 'Budi Setiawan' },
            { 'Kelas': '7A', 'Nama Siswa': 'Citra Dewi' },
            { 'Kelas': '7A', 'Nama Siswa': 'Dina Sari' },
            { 'Kelas': '7A', 'Nama Siswa': 'Eko Prasetyo' },
            { 'Kelas': '7B', 'Nama Siswa': 'Fajar Nugroho' },
            { 'Kelas': '7B', 'Nama Siswa': 'Gita Permata' },
            { 'Kelas': '7B', 'Nama Siswa': 'Hadi Wijaya' },
            { 'Kelas': '7B', 'Nama Siswa': 'Indah Lestari' },
            { 'Kelas': '7B', 'Nama Siswa': 'Joko Susilo' },
            { 'Kelas': '8A', 'Nama Siswa': 'Karina Putri' },
            { 'Kelas': '8A', 'Nama Siswa': 'Lukman Hakim' },
            { 'Kelas': '8A', 'Nama Siswa': 'Maya Sari' },
            { 'Kelas': '8A', 'Nama Siswa': 'Nanda Pratama' },
            { 'Kelas': '8A', 'Nama Siswa': 'Omar Bakri' },
            { 'Kelas': '8B', 'Nama Siswa': 'Putri Ayu' },
            { 'Kelas': '8B', 'Nama Siswa': 'Qori Rahman' },
            { 'Kelas': '8B', 'Nama Siswa': 'Rina Wati' },
            { 'Kelas': '8B', 'Nama Siswa': 'Sandi Kurnia' },
            { 'Kelas': '8B', 'Nama Siswa': 'Tari Melati' }
        ];

        // Load user data and class data on page load
        window.onload = function() {
            loadUserData();
            loadClassData();
        };

        async function loadUserData() {
            try {
                console.log('Mencoba memuat data user dari Google Sheets...');
                const response = await fetch('https://docs.google.com/spreadsheets/d/e/2PACX-1vRZw29qfDE0eX9LT1HRLwtSP_MuFJMx900bjb55WUcSzre0sjcx-HpI7GpwAqTy6D5Neb9slRbkboNx/pub?gid=0&single=true&output=csv', {
                    method: 'GET',
                    mode: 'cors'
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const csvText = await response.text();
                userData = parseCSV(csvText);
                console.log('Data user berhasil dimuat dari Google Sheets:', userData.length, 'records');
            } catch (error) {
                console.warn('Gagal memuat data user dari Google Sheets, menggunakan data fallback:', error.message);
                userData = fallbackUserData;
                console.log('Menggunakan data fallback user:', userData.length, 'records');
            }
        }

        async function loadClassData() {
            try {
                console.log('Mencoba memuat data kelas dari Google Sheets...');
                const response = await fetch('https://docs.google.com/spreadsheets/d/e/2PACX-1vRyCpgTY6rAY1jfRZSD0y_2Lem7m9YSvuU710VC7yz2eAGz3eXbymWjW1elNhWmAHNrbL8VypeFzDV5/pub?gid=0&single=true&output=csv', {
                    method: 'GET',
                    mode: 'cors'
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const csvText = await response.text();
                classData = parseCSV(csvText);
                console.log('Data kelas berhasil dimuat dari Google Sheets:', classData.length, 'records');
                populateKelasOptions();
            } catch (error) {
                console.warn('Gagal memuat data kelas dari Google Sheets, menggunakan data fallback:', error.message);
                classData = fallbackClassData;
                console.log('Menggunakan data fallback kelas:', classData.length, 'records');
                populateKelasOptions();
            }
        }

        async function loadDashboardDataFromSpreadsheet() {
            console.log('Memuat data dashboard dari Google Sheets...');
            
            try {
                // Load jurnal data from sheet 1
                const jurnalResponse = await fetch('https://docs.google.com/spreadsheets/d/e/2PACX-1vT-qW4AiW4D_Xv5Relg-JP9SI9ZsSWlGcDz76ZHRFyvdMC9ynKWJ6-s-XLx-KpWWzaBs53saQuslyBr/pub?gid=636350518&single=true&output=csv');
                if (!jurnalResponse.ok) {
                    throw new Error(`HTTP error! status: ${jurnalResponse.status}`);
                }
                const jurnalCsv = await jurnalResponse.text();
                const jurnalData = parseCSV(jurnalCsv);
                console.log('Data jurnal berhasil dimuat:', jurnalData.length, 'records');
                
                // Load absensi data from sheet 2
                const absensiResponse = await fetch('https://docs.google.com/spreadsheets/d/e/2PACX-1vT-qW4AiW4D_Xv5Relg-JP9SI9ZsSWlGcDz76ZHRFyvdMC9ynKWJ6-s-XLx-KpWWzaBs53saQuslyBr/pub?gid=1687404390&single=true&output=csv');
                if (!absensiResponse.ok) {
                    throw new Error(`HTTP error! status: ${absensiResponse.status}`);
                }
                const absensiCsv = await absensiResponse.text();
                const absensiData = parseCSV(absensiCsv);
                console.log('Data absensi berhasil dimuat:', absensiData.length, 'records');
                
                return { jurnalData, absensiData };
                
            } catch (error) {
                console.error('Error loading data from Google Sheets:', error);
                throw error;
            }
        }

        function parseCSV(csvText) {
            const lines = csvText.trim().split('\n');
            if (lines.length === 0) return [];
            
            // Parse headers - handle quoted values
            const headers = parseCSVLine(lines[0]);
            console.log('CSV Headers:', headers);
            
            const data = [];
            
            for (let i = 1; i < lines.length; i++) {
                if (lines[i].trim() === '') continue; // Skip empty lines
                
                const values = parseCSVLine(lines[i]);
                const row = {};
                
                headers.forEach((header, index) => {
                    row[header] = values[index] || '';
                });
                
                // Only add non-empty rows
                if (Object.values(row).some(value => value.trim() !== '')) {
                    data.push(row);
                }
            }
            
            console.log('Parsed CSV rows:', data.length);
            return data;
        }
        
        function parseCSVLine(line) {
            const result = [];
            let current = '';
            let inQuotes = false;
            
            for (let i = 0; i < line.length; i++) {
                const char = line[i];
                
                if (char === '"') {
                    inQuotes = !inQuotes;
                } else if (char === ',' && !inQuotes) {
                    result.push(current.trim());
                    current = '';
                } else {
                    current += char;
                }
            }
            
            result.push(current.trim());
            return result;
        }

        function populateKelasOptions() {
            const kelasSet = new Set();
            classData.forEach(row => {
                if (row.Kelas) {
                    kelasSet.add(row.Kelas);
                }
            });
            
            const kelasOptions = Array.from(kelasSet).sort();
            const kelasJurnal = document.getElementById('kelasJurnal');
            const kelasAbsen = document.getElementById('kelasAbsen');
            const filterKelas = document.getElementById('filterKelas');
            
            kelasOptions.forEach(kelas => {
                const option1 = new Option(kelas, kelas);
                const option2 = new Option(kelas, kelas);
                const option3 = new Option(kelas, kelas);
                kelasJurnal.appendChild(option1);
                kelasAbsen.appendChild(option2);
                filterKelas.appendChild(option3);
            });
        }

        document.getElementById('loginForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            const userType = document.getElementById('userType').value;
            
            const loginBtn = document.getElementById('loginBtn');
            const loginBtnText = document.getElementById('loginBtnText');
            const loginSpinner = document.getElementById('loginSpinner');
            const loginError = document.getElementById('loginError');
            
            // Show loading state
            loginBtn.disabled = true;
            loginBtnText.textContent = 'Memproses...';
            loginSpinner.classList.remove('hidden');
            loginError.classList.add('hidden');
            
            try {
                // Find user in data
                const user = userData.find(u => u.Username === username && u.Password === password);
                
                if (!user) {
                    throw new Error('Username atau password salah');
                }
                
                if (userType === 'walikelas' && !user['Wali Kelas']) {
                    throw new Error('Anda bukan wali kelas');
                }
                
                currentUser = user;
                
                // Show appropriate dashboard
                document.getElementById('loginPage').classList.add('hidden');
                
                if (userType === 'guru') {
                    document.getElementById('dashboardGuru').classList.remove('hidden');
                    document.getElementById('welcomeMessage').textContent = `${user['Nama Guru']}`;
                    document.getElementById('mapelInfo').textContent = `Guru ${user.Mapel}`;
                    document.getElementById('profilePhoto').src = user.Foto || 'https://via.placeholder.com/40x40/4F46E5/FFFFFF?text=' + user['Nama Guru'].charAt(0);
                    showTab('dashboard');
                    
                    // Show loading state immediately after login
                    showDashboardLoading();
                    
                    // Load dashboard data immediately after login
                    console.log('Loading dashboard data after login...');
                    setTimeout(() => {
                        updateDashboardStats();
                    }, 500);
                } else {
                    document.getElementById('dashboardWaliKelas').classList.remove('hidden');
                    setupWaliKelasInterface(user);
                    showWaliTab('overview');
                    
                    // Load dashboard data for wali kelas
                    setTimeout(() => {
                        updateWaliDashboardStats();
                    }, 500);
                }
                
            } catch (error) {
                loginError.textContent = error.message;
                loginError.classList.remove('hidden');
            } finally {
                // Reset loading state
                loginBtn.disabled = false;
                loginBtnText.textContent = 'Masuk';
                loginSpinner.classList.add('hidden');
            }
        });

        document.getElementById('jurnalForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            // Show loading state
            const btn = document.getElementById('simpanJurnalBtn');
            const btnText = document.getElementById('simpanJurnalText');
            const spinner = document.getElementById('simpanJurnalSpinner');
            
            btn.disabled = true;
            btnText.textContent = 'Menyimpan...';
            spinner.classList.remove('hidden');
            
            const formData = {
                timestamp: new Date().toLocaleString('id-ID'),
                kelas: document.getElementById('kelasJurnal').value,
                mataPelajaran: currentUser.Mapel,
                materi: document.getElementById('materi').value,
                catatan: document.getElementById('catatan').value,
                jamPelajaran: document.getElementById('jamPelajaran').value,
                namaGuru: currentUser['Nama Guru']
            };
            
            try {
                await submitToGoogleSheets('jurnal', formData);
                addActivity('jurnal', formData);
                updateDashboardStats();
                document.getElementById('jurnalForm').reset();
            } catch (error) {
                console.error('Error saving jurnal:', error);
            } finally {
                // Reset loading state
                btn.disabled = false;
                btnText.textContent = 'Simpan Jurnal';
                spinner.classList.add('hidden');
            }
        });

        function loadSiswa() {
            const kelas = document.getElementById('kelasAbsen').value;
            if (!kelas) {
                document.getElementById('daftarSiswa').classList.add('hidden');
                return;
            }
            
            const siswaList = document.getElementById('siswaList');
            const siswaKelas = classData.filter(row => row.Kelas === kelas);
            
            siswaList.innerHTML = '';
            
            siswaKelas.forEach((siswa, index) => {
                const siswaDiv = document.createElement('div');
                siswaDiv.className = 'p-4 bg-gray-50 rounded-lg border';
                siswaDiv.innerHTML = `
                    <div class="mb-3">
                        <span class="font-medium text-gray-900 text-lg">${siswa['Nama Siswa']}</span>
                    </div>
                    <div class="grid grid-cols-2 md:grid-cols-5 gap-2">
                        <label class="flex items-center p-2 bg-green-100 rounded-lg cursor-pointer hover:bg-green-200 transition-colors">
                            <input type="radio" name="status_${index}" value="Hadir" class="siswa-status mr-2" data-nama="${siswa['Nama Siswa']}">
                            <span class="text-sm font-medium text-green-800">‚úì Hadir</span>
                        </label>
                        <label class="flex items-center p-2 bg-yellow-100 rounded-lg cursor-pointer hover:bg-yellow-200 transition-colors">
                            <input type="radio" name="status_${index}" value="Sakit" class="siswa-status mr-2" data-nama="${siswa['Nama Siswa']}">
                            <span class="text-sm font-medium text-yellow-800">ü§í Sakit</span>
                        </label>
                        <label class="flex items-center p-2 bg-blue-100 rounded-lg cursor-pointer hover:bg-blue-200 transition-colors">
                            <input type="radio" name="status_${index}" value="Ijin" class="siswa-status mr-2" data-nama="${siswa['Nama Siswa']}">
                            <span class="text-sm font-medium text-blue-800">üìù Ijin</span>
                        </label>
                        <label class="flex items-center p-2 bg-red-100 rounded-lg cursor-pointer hover:bg-red-200 transition-colors">
                            <input type="radio" name="status_${index}" value="Alpha" class="siswa-status mr-2" data-nama="${siswa['Nama Siswa']}">
                            <span class="text-sm font-medium text-red-800">‚ùå Alpha</span>
                        </label>
                        <label class="flex items-center p-2 bg-purple-100 rounded-lg cursor-pointer hover:bg-purple-200 transition-colors">
                            <input type="radio" name="status_${index}" value="Bolos" class="siswa-status mr-2" data-nama="${siswa['Nama Siswa']}">
                            <span class="text-sm font-medium text-purple-800">üö´ Bolos</span>
                        </label>
                    </div>
                `;
                siswaList.appendChild(siswaDiv);
            });
            
            document.getElementById('daftarSiswa').classList.remove('hidden');
        }

        async function simpanAbsensi() {
            const kelas = document.getElementById('kelasAbsen').value;
            const jamPelajaran = document.getElementById('jamAbsen').value;
            
            if (!kelas || !jamPelajaran) {
                showNotification('Pilih kelas dan jam pelajaran terlebih dahulu', 'error');
                return;
            }
            
            const statusElements = document.querySelectorAll('.siswa-status:checked');
            const absensiData = [];
            
            statusElements.forEach(element => {
                const nama = element.getAttribute('data-nama');
                const status = element.value;
                
                absensiData.push({
                    timestamp: new Date().toLocaleString('id-ID'),
                    kelas: kelas,
                    namaSiswa: nama,
                    keterangan: status,
                    namaGuru: currentUser['Nama Guru'],
                    jamPelajaran: jamPelajaran
                });
            });
            
            if (absensiData.length === 0) {
                showNotification('Pilih status kehadiran untuk minimal satu siswa', 'error');
                return;
            }
            
            // Show loading state
            const btn = document.getElementById('simpanAbsensiBtn');
            const btnText = document.getElementById('simpanAbsensiText');
            const spinner = document.getElementById('simpanAbsensiSpinner');
            
            btn.disabled = true;
            btnText.textContent = `Menyimpan ${absensiData.length} data...`;
            spinner.classList.remove('hidden');
            
            try {
                // Submit all data as bulk in one request
                await submitBulkToGoogleSheets('absensi', absensiData);
                
                showNotification(`Absensi berhasil disimpan untuk ${absensiData.length} siswa!`, 'success');
                addActivity('presensi', { kelas: kelas, count: absensiData.length });
                updateDashboardStats();
                document.getElementById('kelasAbsen').value = '';
                document.getElementById('jamAbsen').value = '';
                document.getElementById('daftarSiswa').classList.add('hidden');
            } catch (error) {
                console.error('Error saving absensi:', error);
                showNotification('Gagal menyimpan absensi: ' + error.message, 'error');
            } finally {
                // Reset loading state
                btn.disabled = false;
                btnText.textContent = 'Simpan Absensi';
                spinner.classList.add('hidden');
            }
        }

        function getLocalStorageData(type) {
            // Get all localStorage data for this type across all dates
            const allData = [];
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                if (key && key.startsWith(`${type}Data_`)) {
                    try {
                        const data = JSON.parse(localStorage.getItem(key) || '[]');
                        allData.push(...data);
                    } catch (e) {
                        console.error('Error parsing localStorage data:', key, e);
                    }
                }
            }
            return allData;
        }

        function saveToLocalStorage(type, data) {
            const today = new Date().toLocaleDateString('id-ID');
            const existingData = getLocalStorageData(type);
            
            if (Array.isArray(data)) {
                existingData.push(...data);
            } else {
                existingData.push(data);
            }
            
            localStorage.setItem(`${type}Data_${today}`, JSON.stringify(existingData));
        }

        async function submitToGoogleSheets(type, data) {
            // Simpan ke localStorage sebagai primary storage
            saveToLocalStorage(type, data);
            
            // Coba kirim ke Google Sheets dengan retry mechanism
            try {
                const payload = {
                    type: type,
                    data: data
                };
                
                const response = await fetch('https://script.google.com/macros/s/AKfycbwrcc2G4yipG9ZRQgSRuLXrDjLX2a1pMHBQq8aPIGqcK7TVltBWHwO-8wIrO8eQJ4pfng/exec', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(payload),
                    mode: 'no-cors'
                });
                
                console.log('Data sent to Google Sheets successfully');
                showNotification('Data berhasil disimpan ke sistem!', 'success');
                
            } catch (error) {
                console.error('Error sending to Google Sheets:', error);
                showNotification('Data disimpan lokal (sync ke server gagal)', 'success');
            }
            
            return { success: true };
        }

        async function submitBulkToGoogleSheets(type, dataArray) {
            // Simpan ke localStorage sebagai primary storage
            saveToLocalStorage(type, dataArray);
            
            // Coba kirim ke Google Sheets dengan retry mechanism
            try {
                const payload = {
                    type: type,
                    bulkData: dataArray
                };
                
                const response = await fetch('https://script.google.com/macros/s/AKfycbwrcc2G4yipG9ZRQgSRuLXrDjLX2a1pMHBQq8aPIGqcK7TVltBWHwO-8wIrO8eQJ4pfng/exec', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(payload),
                    mode: 'no-cors'
                });
                
                console.log('Bulk data sent to Google Sheets successfully');
                
            } catch (error) {
                console.error('Error sending bulk data to Google Sheets:', error);
            }
            
            return { success: true };
        }

        function showTab(tabName) {
            // Hide all tab contents
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.add('hidden');
            });
            
            // Remove active class from all tabs
            document.querySelectorAll('.tab-button').forEach(button => {
                button.classList.remove('border-blue-500', 'text-blue-600');
                button.classList.add('border-transparent', 'text-gray-500');
            });
            
            // Show selected tab content
            document.getElementById('content' + tabName.charAt(0).toUpperCase() + tabName.slice(1)).classList.remove('hidden');
            
            // Add active class to selected tab
            const activeTab = document.getElementById('tab' + tabName.charAt(0).toUpperCase() + tabName.slice(1));
            activeTab.classList.remove('border-transparent', 'text-gray-500');
            activeTab.classList.add('border-blue-500', 'text-blue-600');
        }

        async function updateDashboardStats() {
            const filterPeriode = document.getElementById('filterPeriode').value;
            const filterKelas = document.getElementById('filterKelas').value;
            const dateFrom = document.getElementById('dateFrom').value;
            const dateTo = document.getElementById('dateTo').value;
            
            let periodLabel = '';
            let dateRange = [];
            
            // Determine date range based on filter
            if (filterPeriode === 'today') {
                const today = new Date();
                dateRange = [today.toLocaleDateString('id-ID')];
                periodLabel = 'Hari Ini';
            } else if (filterPeriode === 'week') {
                const today = new Date();
                const startOfWeek = new Date(today.setDate(today.getDate() - today.getDay()));
                dateRange = [];
                for (let i = 0; i < 7; i++) {
                    const date = new Date(startOfWeek);
                    date.setDate(startOfWeek.getDate() + i);
                    dateRange.push(date.toLocaleDateString('id-ID'));
                }
                periodLabel = 'Minggu Ini';
            } else if (filterPeriode === 'month') {
                const today = new Date();
                const year = today.getFullYear();
                const month = today.getMonth();
                const daysInMonth = new Date(year, month + 1, 0).getDate();
                dateRange = [];
                for (let i = 1; i <= daysInMonth; i++) {
                    const date = new Date(year, month, i);
                    dateRange.push(date.toLocaleDateString('id-ID'));
                }
                periodLabel = 'Bulan Ini';
            } else if (filterPeriode === 'lastmonth') {
                const today = new Date();
                const year = today.getMonth() === 0 ? today.getFullYear() - 1 : today.getFullYear();
                const month = today.getMonth() === 0 ? 11 : today.getMonth() - 1;
                const daysInMonth = new Date(year, month + 1, 0).getDate();
                dateRange = [];
                for (let i = 1; i <= daysInMonth; i++) {
                    const date = new Date(year, month, i);
                    dateRange.push(date.toLocaleDateString('id-ID'));
                }
                periodLabel = 'Bulan Lalu';
            } else if (filterPeriode === 'custom' && dateFrom && dateTo) {
                const start = new Date(dateFrom);
                const end = new Date(dateTo);
                dateRange = [];
                for (let d = new Date(start); d <= end; d.setDate(d.getDate() + 1)) {
                    dateRange.push(new Date(d).toLocaleDateString('id-ID'));
                }
                periodLabel = 'Custom';
            }
            
            console.log('Filter periode:', filterPeriode, 'Date range:', dateRange);
            console.log('Current user:', currentUser['Nama Guru']);
            
            // Load data from Google Sheets and localStorage
            let jurnalData = [];
            let absensiData = [];
            
            try {
                // Try to load from Google Sheets first
                const spreadsheetData = await loadDashboardDataFromSpreadsheet();
                jurnalData = spreadsheetData.jurnalData || [];
                absensiData = spreadsheetData.absensiData || [];
                console.log('Data loaded from Google Sheets - Jurnal:', jurnalData.length, 'Absensi:', absensiData.length);
            } catch (error) {
                console.warn('Failed to load from Google Sheets, using localStorage:', error);
            }
            
            // Also load from localStorage for recent data
            const localJurnalData = getLocalStorageData('jurnal');
            const localAbsensiData = getLocalStorageData('absensi');
            
            // Combine data (remove duplicates if any)
            jurnalData = [...jurnalData, ...localJurnalData];
            absensiData = [...absensiData, ...localAbsensiData];
            
            console.log('Combined data - Jurnal:', jurnalData.length, 'Absensi:', absensiData.length);
            
            // Debug: Log sample data to check column names
            if (jurnalData.length > 0) {
                console.log('Sample jurnal data:', jurnalData[0]);
            }
            if (absensiData.length > 0) {
                console.log('Sample absensi data:', absensiData[0]);
            }
            
            // Filter data by current user, date range, and class
            const filteredJurnal = jurnalData.filter(item => {
                // Check if guru name matches (handle different column names from spreadsheet)
                const guruName = item['Nama Guru'] || item['namaGuru'] || item['Guru'] || item.namaGuru;
                
                if (!guruName) {
                    return false;
                }
                
                // Normalize names for comparison (trim whitespace, case insensitive, remove extra characters)
                const normalizedGuruName = guruName.toString().trim().toLowerCase().replace(/[^a-z\s]/g, '');
                const normalizedCurrentUser = currentUser['Nama Guru'].toString().trim().toLowerCase().replace(/[^a-z\s]/g, '');
                
                console.log('Comparing guru names:', normalizedGuruName, 'vs', normalizedCurrentUser);
                
                if (normalizedGuruName !== normalizedCurrentUser) {
                    return false;
                }
                
                // Check class filter
                if (filterKelas) {
                    const itemKelas = item.Kelas || item.kelas || '';
                    if (itemKelas !== filterKelas) {
                        return false;
                    }
                }
                
                // Check timestamp (handle different column names)
                const timestamp = item.Timestamp || item.timestamp || item['Tanggal'] || item.tanggal;
                if (!timestamp) {
                    return false;
                }
                
                const parsedTime = parseTimestamp(timestamp);
                return parsedTime && (dateRange.length === 0 || dateRange.includes(parsedTime.dateString));
            });
            
            const filteredAbsensi = absensiData.filter(item => {
                // Check if guru name matches (handle different column names from spreadsheet)
                const guruName = item['Nama Guru'] || item['namaGuru'] || item['Guru'] || item.namaGuru;
                
                if (!guruName) {
                    return false;
                }
                
                // Normalize names for comparison (trim whitespace, case insensitive, remove extra characters)
                const normalizedGuruName = guruName.toString().trim().toLowerCase().replace(/[^a-z\s]/g, '');
                const normalizedCurrentUser = currentUser['Nama Guru'].toString().trim().toLowerCase().replace(/[^a-z\s]/g, '');
                
                if (normalizedGuruName !== normalizedCurrentUser) {
                    return false;
                }
                
                // Check class filter
                if (filterKelas) {
                    const itemKelas = item.Kelas || item.kelas || '';
                    if (itemKelas !== filterKelas) {
                        return false;
                    }
                }
                
                // Check timestamp (handle different column names)
                const timestamp = item.Timestamp || item.timestamp || item['Tanggal'] || item.tanggal;
                if (!timestamp) {
                    return false;
                }
                
                const parsedTime = parseTimestamp(timestamp);
                return parsedTime && (dateRange.length === 0 || dateRange.includes(parsedTime.dateString));
            });
            
            console.log('Filtered data - Jurnal:', filteredJurnal.length, 'Absensi:', filteredAbsensi.length);
            
            // Calculate stats from JURNAL data only
            const totalJurnal = filteredJurnal.length;
            const totalDurasi = filteredJurnal.reduce((sum, item) => {
                const jamPelajaran = item['Jam Pelajaran'] || item['jamPelajaran'] || item['JP'] || item.jamPelajaran || '0';
                return sum + parseInt(jamPelajaran.toString());
            }, 0);
            
            // Get unique classes from JURNAL data only
            const kelasFromJurnal = new Set(
                filteredJurnal.map(item => item.Kelas || item.kelas).filter(Boolean)
            );
            
            // Group absensi by session (kelas + tanggal + jam) for counting sessions
            const absensiSessions = {};
            filteredAbsensi.forEach(item => {
                const kelas = item.Kelas || item.kelas || '';
                const jamPelajaran = item['Jam Pelajaran'] || item.jamPelajaran || '';
                const timestamp = item.Timestamp || item.timestamp || item['Tanggal'] || item.tanggal;
                
                let tanggal;
                try {
                    const timestampStr = timestamp.toString();
                    if (timestampStr.includes('/')) {
                        const parts = timestampStr.split(' ')[0].split('/');
                        if (parts.length === 3) {
                            const day = parseInt(parts[0]);
                            const month = parseInt(parts[1]);
                            const year = parseInt(parts[2]);
                            
                            if (day <= 31 && month <= 12) {
                                tanggal = new Date(year, month - 1, day).toLocaleDateString('id-ID');
                            } else {
                                tanggal = new Date(year, day - 1, month).toLocaleDateString('id-ID');
                            }
                        }
                    } else if (timestampStr.includes('-')) {
                        const parts = timestampStr.split(' ')[0].split('-');
                        if (parts.length === 3) {
                            if (parts[0].length === 4) {
                                tanggal = new Date(parts[0], parts[1] - 1, parts[2]).toLocaleDateString('id-ID');
                            } else {
                                tanggal = new Date(parts[2], parts[1] - 1, parts[0]).toLocaleDateString('id-ID');
                            }
                        }
                    } else {
                        tanggal = new Date(timestampStr).toLocaleDateString('id-ID');
                    }
                } catch (e) {
                    tanggal = timestampStr;
                }
                
                const sessionKey = `${kelas}_${tanggal}_${jamPelajaran}`;
                if (!absensiSessions[sessionKey]) {
                    absensiSessions[sessionKey] = {
                        kelas: kelas,
                        tanggal: tanggal,
                        jamPelajaran: jamPelajaran,
                        siswa: []
                    };
                }
                absensiSessions[sessionKey].siswa.push(item);
            });
            
            const totalPresensi = Object.keys(absensiSessions).length;
            
            // Update labels
            document.getElementById('jurnalLabel').textContent = `Total Jurnal ${periodLabel}`;
            document.getElementById('durasiLabel').textContent = `Total Durasi Mengajar ${periodLabel}`;
            document.getElementById('presensiLabel').textContent = `Total Sesi Absensi ${periodLabel}`;
            document.getElementById('kelasLabel').textContent = `Kelas Diajar ${periodLabel}`;
            
            // Update values
            document.getElementById('totalJurnal').textContent = totalJurnal;
            document.getElementById('totalDurasi').textContent = totalDurasi + ' JP';
            document.getElementById('totalPresensi').textContent = totalPresensi;
            document.getElementById('totalKelas').textContent = kelasFromJurnal.size;
            
            // Update recent activity - combine jurnal and absensi by date, guru, and class
            const activityContainer = document.getElementById('recentActivity');
            const combinedActivities = {};
            
            console.log('Processing activities - Jurnal:', filteredJurnal.length, 'Absensi sessions:', Object.keys(absensiSessions).length);
            
            // Process jurnal data first
            filteredJurnal.forEach(item => {
                const kelas = item.Kelas || item.kelas || '';
                const materi = item.Materi || item.materi || '';
                const timestamp = item.Timestamp || item.timestamp || item['Tanggal'] || item.tanggal;
                const namaGuru = item['Nama Guru'] || item.namaGuru || item['Guru'] || item.namaGuru;
                
                if (!timestamp || !kelas || !materi || !namaGuru) {
                    console.log('Skipping jurnal - missing data:', { timestamp, kelas, materi, namaGuru });
                    return;
                }
                
                // Normalize guru name for comparison
                const normalizedGuruName = namaGuru.toString().trim().toLowerCase().replace(/[^a-z\s]/g, '');
                const normalizedCurrentUser = currentUser['Nama Guru'].toString().trim().toLowerCase().replace(/[^a-z\s]/g, '');
                
                if (normalizedGuruName !== normalizedCurrentUser) {
                    return;
                }
                
                try {
                    let dateKey;
                    const timestampStr = timestamp.toString();
                    
                    if (timestampStr.includes('/')) {
                        const parts = timestampStr.split(' ')[0].split('/');
                        if (parts.length === 3) {
                            // DD/MM/YYYY format
                            const day = parts[0].padStart(2, '0');
                            const month = parts[1].padStart(2, '0');
                            const year = parts[2];
                            dateKey = `${day}/${month}/${year}`;
                        }
                    } else if (timestampStr.includes('-')) {
                        const parts = timestampStr.split(' ')[0].split('-');
                        if (parts.length === 3) {
                            if (parts[0].length === 4) {
                                // YYYY-MM-DD format
                                const day = parts[2].padStart(2, '0');
                                const month = parts[1].padStart(2, '0');
                                const year = parts[0];
                                dateKey = `${day}/${month}/${year}`;
                            } else {
                                // DD-MM-YYYY format
                                const day = parts[0].padStart(2, '0');
                                const month = parts[1].padStart(2, '0');
                                const year = parts[2];
                                dateKey = `${day}/${month}/${year}`;
                            }
                        }
                    }
                    
                    if (dateKey) {
                        const activityKey = `${dateKey}_${kelas}_${normalizedCurrentUser}`;
                        if (!combinedActivities[activityKey]) {
                            combinedActivities[activityKey] = {
                                date: dateKey,
                                kelas: kelas,
                                namaGuru: namaGuru,
                                jurnal: null,
                                absensi: null,
                                timestamp: timestampStr
                            };
                        }
                        combinedActivities[activityKey].jurnal = {
                            materi: materi,
                            jamPelajaran: item['Jam Pelajaran'] || item.jamPelajaran || '1'
                        };
                        
                        console.log('Added jurnal activity:', activityKey, combinedActivities[activityKey].jurnal);
                    }
                } catch (e) {
                    console.error('Error parsing jurnal timestamp:', timestamp, e);
                }
            });
            
            // Process absensi data - match with existing jurnal activities
            Object.values(absensiSessions).forEach(session => {
                if (!session.kelas || !session.siswa.length) return;
                
                try {
                    const firstStudent = session.siswa[0];
                    const timestamp = firstStudent.Timestamp || firstStudent.timestamp || firstStudent['Tanggal'] || firstStudent.tanggal;
                    const namaGuru = firstStudent['Nama Guru'] || firstStudent.namaGuru || firstStudent['Guru'] || firstStudent.namaGuru;
                    
                    if (!timestamp || !namaGuru) return;
                    
                    // Normalize guru name for comparison
                    const normalizedGuruName = namaGuru.toString().trim().toLowerCase().replace(/[^a-z\s]/g, '');
                    const normalizedCurrentUser = currentUser['Nama Guru'].toString().trim().toLowerCase().replace(/[^a-z\s]/g, '');
                    
                    if (normalizedGuruName !== normalizedCurrentUser) {
                        return;
                    }
                    
                    let dateKey;
                    const timestampStr = timestamp.toString();
                    
                    if (timestampStr.includes('/')) {
                        const parts = timestampStr.split(' ')[0].split('/');
                        if (parts.length === 3) {
                            const day = parts[0].padStart(2, '0');
                            const month = parts[1].padStart(2, '0');
                            const year = parts[2];
                            dateKey = `${day}/${month}/${year}`;
                        }
                    } else if (timestampStr.includes('-')) {
                        const parts = timestampStr.split(' ')[0].split('-');
                        if (parts.length === 3) {
                            if (parts[0].length === 4) {
                                const day = parts[2].padStart(2, '0');
                                const month = parts[1].padStart(2, '0');
                                const year = parts[0];
                                dateKey = `${day}/${month}/${year}`;
                            } else {
                                const day = parts[0].padStart(2, '0');
                                const month = parts[1].padStart(2, '0');
                                const year = parts[2];
                                dateKey = `${day}/${month}/${year}`;
                            }
                        }
                    }
                    
                    if (dateKey) {
                        const activityKey = `${dateKey}_${session.kelas}_${normalizedCurrentUser}`;
                        
                        // Only add absensi if there's already a jurnal for this date, class, and guru
                        if (combinedActivities[activityKey] && combinedActivities[activityKey].jurnal) {
                            // Count attendance status
                            const statusCount = {
                                hadir: 0,
                                sakit: 0,
                                ijin: 0,
                                alpha: 0,
                                bolos: 0
                            };
                            
                            session.siswa.forEach(siswa => {
                                const status = (siswa.Keterangan || siswa.keterangan || '').toLowerCase();
                                if (status === 'hadir') statusCount.hadir++;
                                else if (status === 'sakit') statusCount.sakit++;
                                else if (status === 'ijin') statusCount.ijin++;
                                else if (status === 'alpha') statusCount.alpha++;
                                else if (status === 'bolos') {     // Misal kolom jam pelajaran pada data absensi disebut 'jamPelajaran' atau 'Jam Pelajaran'     
                                    const jp = Number(siswa.jamPelajaran || siswa['Jam Pelajaran'] || 1);}     
                                    statusCount.bolos += jp;
                            });
                            
                            combinedActivities[activityKey].absensi = {
                                total: session.siswa.length,
                                statusCount: statusCount
                            };
                            
                            console.log('Added absensi to activity:', activityKey, combinedActivities[activityKey].absensi);
                        }
                    }
                } catch (e) {
                    console.error('Error parsing absensi session timestamp:', e);
                }
            });
            
            // Only include activities that have jurnal with materi (pembelajaran yang benar-benar terjadi)
            const activities = Object.values(combinedActivities).filter(activity => {
                return activity.jurnal && activity.jurnal.materi && activity.jurnal.materi.trim() !== '';
            });
            
            console.log('Final activities count:', activities.length);
            
            if (activities.length === 0) {
                activityContainer.innerHTML = `<p class="text-gray-500 text-center py-4">Belum ada aktivitas untuk periode ${periodLabel.toLowerCase()}</p>`;
            } else {
                // Sort by date (newest first)
                activities.sort((a, b) => {
                    try {
                        const dateA = a.date.split('/');
                        const dateB = b.date.split('/');
                        const timestampA = new Date(dateA[2], dateA[1] - 1, dateA[0]);
                        const timestampB = new Date(dateB[2], dateB[1] - 1, dateB[0]);
                        return timestampB - timestampA;
                    } catch (e) {
                        return 0;
                    }
                });
                
                activityContainer.innerHTML = activities.slice(0, 5).map(activity => {
                    let content = `
                        <div class="flex items-start p-4 bg-gray-50 rounded-lg border">
                            <div class="text-2xl mr-3">üìÖ</div>
                            <div class="flex-1">
                                <div class="flex items-center justify-between mb-2">
                                    <h4 class="text-sm font-semibold text-gray-900">${activity.kelas} - ${activity.date}</h4>
                                </div>
                    `;
                    
                    if (activity.jurnal) {
                        content += `
                            <div class="mb-2">
                                <div class="flex items-center text-xs text-blue-600 mb-1">
                                    <span class="mr-1">üìö</span>
                                    <span class="font-medium">Materi (${activity.jurnal.jamPelajaran} JP)</span>
                                </div>
                                <p class="text-xs text-gray-700 ml-4 bg-blue-50 p-2 rounded border-l-2 border-blue-200">${activity.jurnal.materi}</p>
                            </div>
                        `;
                    }
                    
                    if (activity.absensi) {
                        const status = activity.absensi.statusCount;
                        content += `
                            <div>
                                <div class="flex items-center text-xs text-green-600 mb-1">
                                    <span class="mr-1">üë•</span>
                                    <span class="font-medium">Kehadiran (${activity.absensi.total} siswa)</span>
                                </div>
                                <div class="flex flex-wrap gap-1 ml-4 text-xs">
                                    ${status.hadir > 0 ? `<span class="bg-green-100 text-green-800 px-2 py-1 rounded">‚úì ${status.hadir}</span>` : ''}
                                    ${status.sakit > 0 ? `<span class="bg-yellow-100 text-yellow-800 px-2 py-1 rounded">ü§í ${status.sakit}</span>` : ''}
                                    ${status.ijin > 0 ? `<span class="bg-blue-100 text-blue-800 px-2 py-1 rounded">üìù ${status.ijin}</span>` : ''}
                                    ${status.alpha > 0 ? `<span class="bg-red-100 text-red-800 px-2 py-1 rounded">‚ùå ${status.alpha}</span>` : ''}
                                    ${status.bolos > 0 ? `<span class="bg-purple-100 text-purple-800 px-2 py-1 rounded">üö´ ${status.bolos}</span>` : ''}
                                </div>
                            </div>
                        `;
                    }
                    
                    if (!activity.jurnal && !activity.absensi) {
                        content += `<p class="text-xs text-gray-500">Data tidak lengkap</p>`;
                    }
                    
                    content += `
                            </div>
                        </div>
                    `;
                    
                    return content;
                }).join('');
            }
        }
        
        function updateFilter() {
            const filterPeriode = document.getElementById('filterPeriode').value;
            const customDateFrom = document.getElementById('customDateFrom');
            const customDateTo = document.getElementById('customDateTo');
            
            if (filterPeriode === 'custom') {
                customDateFrom.classList.remove('hidden');
                customDateTo.classList.remove('hidden');
                
                // Set default dates if not set
                if (!document.getElementById('dateFrom').value) {
                    const today = new Date();
                    document.getElementById('dateFrom').value = today.toISOString().split('T')[0];
                }
                if (!document.getElementById('dateTo').value) {
                    const today = new Date();
                    document.getElementById('dateTo').value = today.toISOString().split('T')[0];
                }
            } else {
                customDateFrom.classList.add('hidden');
                customDateTo.classList.add('hidden');
            }
            
            // Show loading state when filter changes
            showDashboardLoading();
            
            // Update stats with small delay to show loading
            setTimeout(() => {
                updateDashboardStats();
            }, 300);
        }
        
        function resetFilter() {
            document.getElementById('filterPeriode').value = 'today';
            document.getElementById('filterKelas').value = '';
            document.getElementById('dateFrom').value = '';
            document.getElementById('dateTo').value = '';
            document.getElementById('customDateFrom').classList.add('hidden');
            document.getElementById('customDateTo').classList.add('hidden');
            
            // Show loading state when resetting filter
            showDashboardLoading();
            
            // Update stats with small delay to show loading
            setTimeout(() => {
                updateDashboardStats();
            }, 300);
        }

        function togglePasswordVisibility() {
            const passwordInput = document.getElementById('password');
            const eyeIcon = document.getElementById('eyeIcon');
            const eyeOffIcon = document.getElementById('eyeOffIcon');
            
            if (passwordInput.type === 'password') {
                passwordInput.type = 'text';
                eyeIcon.classList.add('hidden');
                eyeOffIcon.classList.remove('hidden');
            } else {
                passwordInput.type = 'password';
                eyeIcon.classList.remove('hidden');
                eyeOffIcon.classList.add('hidden');
            }
        }

        function showDashboardLoading() {
            // Show loading state for dashboard stats
            document.getElementById('totalJurnal').innerHTML = '<div class="loading"></div>';
            document.getElementById('totalDurasi').innerHTML = '<div class="loading"></div>';
            document.getElementById('totalPresensi').innerHTML = '<div class="loading"></div>';
            document.getElementById('totalKelas').innerHTML = '<div class="loading"></div>';
            document.getElementById('recentActivity').innerHTML = '<div class="text-center py-4"><div class="loading mx-auto"></div><p class="mt-2 text-gray-500">Memuat aktivitas...</p></div>';
        }

        function showNotification(message, type = 'success') {
            // Remove existing notifications
            const existingNotifications = document.querySelectorAll('.notification');
            existingNotifications.forEach(notification => notification.remove());
            
            // Create new notification
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.textContent = message;
            
            document.body.appendChild(notification);
            
            // Auto remove after 3 seconds
            setTimeout(() => {
                if (notification.parentNode) {
                    notification.parentNode.removeChild(notification);
                }
            }, 3000);
        }

        function logout() {
            currentUser = null;
            document.getElementById('loginPage').classList.remove('hidden');
            document.getElementById('dashboardGuru').classList.add('hidden');
            document.getElementById('dashboardWaliKelas').classList.add('hidden');
            
            // Reset form
            document.getElementById('loginForm').reset();
            document.getElementById('loginError').classList.add('hidden');
            
            showNotification('Anda telah logout', 'success');
        }

        function bulkAction(status) {
            const statusInputs = document.querySelectorAll('.siswa-status');
            statusInputs.forEach(input => {
                if (input.value === status) {
                    input.checked = true;
                }
            });
        }

        function resetAllStatus() {
            const statusInputs = document.querySelectorAll('.siswa-status');
            statusInputs.forEach(input => {
                input.checked = false;
            });
        }

        function parseTimestamp(timestamp) {
            if (!timestamp) return null;
            
            try {
                const timestampStr = timestamp.toString();
                let date;
                
                if (timestampStr.includes('/')) {
                    // DD/MM/YYYY format
                    const parts = timestampStr.split(' ')[0].split('/');
                    if (parts.length === 3) {
                        const day = parseInt(parts[0]);
                        const month = parseInt(parts[1]);
                        const year = parseInt(parts[2]);
                        
                        if (day <= 31 && month <= 12) {
                            date = new Date(year, month - 1, day);
                        }
                    }
                } else if (timestampStr.includes('-')) {
                    // YYYY-MM-DD or DD-MM-YYYY format
                    const parts = timestampStr.split(' ')[0].split('-');
                    if (parts.length === 3) {
                        if (parts[0].length === 4) {
                            // YYYY-MM-DD
                            date = new Date(parts[0], parts[1] - 1, parts[2]);
                        } else {
                            // DD-MM-YYYY
                            date = new Date(parts[2], parts[1] - 1, parts[0]);
                        }
                    }
                } else {
                    date = new Date(timestampStr);
                }
                
                if (date && !isNaN(date.getTime())) {
                    return {
                        date: date,
                        dateString: date.toLocaleDateString('id-ID')
                    };
                }
            } catch (e) {
                console.error('Error parsing timestamp:', timestamp, e);
            }
            
            return null;
        }

        function getDateRange(filterPeriode, dateFrom, dateTo) {
            let dateRange = [];
            
            if (filterPeriode === 'today') {
                const today = new Date();
                dateRange = [today.toLocaleDateString('id-ID')];
            } else if (filterPeriode === 'week') {
                const today = new Date();
                const startOfWeek = new Date(today.setDate(today.getDate() - today.getDay()));
                for (let i = 0; i < 7; i++) {
                    const date = new Date(startOfWeek);
                    date.setDate(startOfWeek.getDate() + i);
                    dateRange.push(date.toLocaleDateString('id-ID'));
                }
            } else if (filterPeriode === 'month') {
                const today = new Date();
                const year = today.getFullYear();
                const month = today.getMonth();
                const daysInMonth = new Date(year, month + 1, 0).getDate();
                for (let i = 1; i <= daysInMonth; i++) {
                    const date = new Date(year, month, i);
                    dateRange.push(date.toLocaleDateString('id-ID'));
                }
            } else if (filterPeriode === 'lastmonth') {
                const today = new Date();
                const year = today.getMonth() === 0 ? today.getFullYear() - 1 : today.getFullYear();
                const month = today.getMonth() === 0 ? 11 : today.getMonth() - 1;
                const daysInMonth = new Date(year, month + 1, 0).getDate();
                for (let i = 1; i <= daysInMonth; i++) {
                    const date = new Date(year, month, i);
                    dateRange.push(date.toLocaleDateString('id-ID'));
                }
            } else if (filterPeriode === 'custom' && dateFrom && dateTo) {
                const start = new Date(dateFrom);
                const end = new Date(dateTo);
                for (let d = new Date(start); d <= end; d.setDate(d.getDate() + 1)) {
                    dateRange.push(new Date(d).toLocaleDateString('id-ID'));
                }
            }
            
            return dateRange;
        }

        async function exportJurnalToExcel() {
            console.log('üöÄ Starting jurnal export process...');
            
            try {
                // Get current filter settings
                const filterPeriode = document.getElementById('filterPeriode').value;
                const filterKelas = document.getElementById('filterKelas').value;
                const dateFrom = document.getElementById('dateFrom').value;
                const dateTo = document.getElementById('dateTo').value;
                
                let dateRange = getDateRange(filterPeriode, dateFrom, dateTo);
                console.log('üìÖ Filter settings - Periode:', filterPeriode, 'Kelas:', filterKelas, 'Date range:', dateRange.length);
                
                // Load data
                console.log('üìä Loading jurnal data...');
                let jurnalData = getLocalStorageData('jurnal');
                console.log('üíæ LocalStorage data count:', jurnalData.length);
                
                try {
                    const spreadsheetData = await loadDashboardDataFromSpreadsheet();
                    if (spreadsheetData.jurnalData) {
                        jurnalData = [...jurnalData, ...spreadsheetData.jurnalData];
                        console.log('‚òÅÔ∏è Combined with Google Sheets data, total:', jurnalData.length);
                    }
                } catch (error) {
                    console.warn('‚ö†Ô∏è Using localStorage data only for export:', error.message);
                }
                
                // Apply ALL filters (user, date range, class)
                const filteredData = jurnalData.filter(item => {
                    // Filter by current user
                    const guruName = item['Nama Guru'] || item.namaGuru || '';
                    const normalizedGuruName = guruName.toString().trim().toLowerCase().replace(/[^a-z\s]/g, '');
                    const normalizedCurrentUser = currentUser['Nama Guru'].toString().trim().toLowerCase().replace(/[^a-z\s]/g, '');
                    
                    if (normalizedGuruName !== normalizedCurrentUser) return false;
                    
                    // Filter by class if specified
                    if (filterKelas) {
                        const itemKelas = item.kelas || item.Kelas || '';
                        if (itemKelas !== filterKelas) return false;
                    }
                    
                    // Filter by date range if specified
                    if (dateRange.length > 0) {
                        const timestamp = item.timestamp || item.Timestamp || item['Tanggal'] || item.tanggal;
                        if (!timestamp) return false;
                        
                        const parsedTime = parseTimestamp(timestamp);
                        if (!parsedTime || !dateRange.includes(parsedTime.dateString)) return false;
                    }
                    
                    return true;
                });
                
                console.log('üîç Filtered data after applying all filters:', filteredData.length);
                
                if (filteredData.length === 0) {
                    showNotification('Tidak ada data jurnal untuk diekspor', 'error');
                    return;
                }
                
                // Prepare data for Excel
                const excelData = filteredData.map(item => ({
                    'Tanggal': item.timestamp || item.Timestamp || '',
                    'Kelas': item.kelas || item.Kelas || '',
                    'Mata Pelajaran': item.mataPelajaran || item['Mata Pelajaran'] || '',
                    'Materi': item.materi || item.Materi || '',
                    'Jam Pelajaran': item.jamPelajaran || item['Jam Pelajaran'] || '',
                    'Catatan': item.catatan || item.Catatan || '',
                    'Guru': item.namaGuru || item['Nama Guru'] || ''
                }));
                
                console.log('üìã Excel data prepared, rows:', excelData.length);
                
                // Generate filename with filter info
                const today = new Date().toLocaleDateString('id-ID').replace(/\//g, '-');
                let filterInfo = '';
                if (filterKelas) filterInfo += `_${filterKelas}`;
                if (filterPeriode !== 'today') filterInfo += `_${filterPeriode}`;
                
                const filename = `Jurnal_${currentUser['Nama Guru'].replace(/\s+/g, '_')}${filterInfo}_${today}.xlsx`;
                console.log('üìÅ Generated filename:', filename);
                
                // Create Excel workbook using SheetJS
                console.log('üìù Creating Excel workbook...');
                
                // Create a new workbook
                const wb = XLSX.utils.book_new();
                
                // Convert data to worksheet
                const ws = XLSX.utils.json_to_sheet(excelData);
                
                // Set column widths for better readability
                const colWidths = [
                    { wch: 15 }, // Tanggal
                    { wch: 10 }, // Kelas
                    { wch: 20 }, // Mata Pelajaran
                    { wch: 50 }, // Materi
                    { wch: 12 }, // Jam Pelajaran
                    { wch: 30 }, // Catatan
                    { wch: 20 }  // Guru
                ];
                ws['!cols'] = colWidths;
                
                // Add worksheet to workbook
                XLSX.utils.book_append_sheet(wb, ws, 'Jurnal Pembelajaran');
                
                // Generate Excel file as array buffer
                const excelBuffer = XLSX.write(wb, { bookType: 'xlsx', type: 'array' });
                
                // Create blob and data URL
                const blob = new Blob([excelBuffer], { type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' });
                const dataUrl = URL.createObjectURL(blob);
                
                console.log('‚úÖ Excel file created successfully');
                
                // Show enhanced download modal with XLSX option
                const downloadModal = document.createElement('div');
                downloadModal.innerHTML = `
                    <div style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
                                background: rgba(0,0,0,0.7); z-index: 10000; display: flex; 
                                align-items: center; justify-content: center; backdrop-filter: blur(2px);">
                        <div style="background: white; padding: 30px; border-radius: 16px; 
                                    box-shadow: 0 25px 50px rgba(0,0,0,0.4); max-width: 600px; width: 90%;
                                    max-height: 90vh; overflow-y: auto;">
                            
                            <!-- Header -->
                            <div style="text-align: center; margin-bottom: 25px;">
                                <div style="font-size: 64px; margin-bottom: 15px;">üìä</div>
                                <h2 style="margin: 0 0 10px 0; color: #1F2937; font-size: 24px; font-weight: 700;">
                                    Export Data Jurnal
                                </h2>
                                <p style="margin: 0; color: #6B7280; font-size: 16px;">
                                    Data siap untuk didownload dalam format Excel (.xlsx)
                                </p>
                            </div>
                            
                            <!-- File Info -->
                            <div style="background: linear-gradient(135deg, #EBF8FF 0%, #F0F9FF 100%); 
                                        padding: 20px; border-radius: 12px; margin-bottom: 25px; 
                                        border: 1px solid #BFDBFE;">
                                <div style="display: flex; align-items: center; margin-bottom: 15px;">
                                    <div style="font-size: 24px; margin-right: 10px;">üìã</div>
                                    <div style="font-weight: 600; color: #1E40AF; font-size: 18px;">Detail File & Filter</div>
                                </div>
                                
                                <!-- Filter Info -->
                                <div style="background: #F8FAFC; padding: 12px; border-radius: 8px; margin-bottom: 15px; border: 1px solid #E2E8F0;">
                                    <div style="color: #475569; font-weight: 500; margin-bottom: 8px; font-size: 14px;">üîç Filter yang Diterapkan:</div>
                                    <div style="display: flex; flex-wrap: gap: 8px; font-size: 12px;">
                                        <span style="background: #3B82F6; color: white; padding: 4px 8px; border-radius: 4px;">
                                            üìÖ ${filterPeriode === 'today' ? 'Hari Ini' : 
                                                filterPeriode === 'week' ? 'Minggu Ini' : 
                                                filterPeriode === 'month' ? 'Bulan Ini' : 
                                                filterPeriode === 'lastmonth' ? 'Bulan Lalu' : 'Custom'}
                                        </span>
                                        ${filterKelas ? `<span style="background: #10B981; color: white; padding: 4px 8px; border-radius: 4px;">üè´ Kelas ${filterKelas}</span>` : ''}
                                        ${dateRange.length > 0 ? `<span style="background: #F59E0B; color: white; padding: 4px 8px; border-radius: 4px;">üìä ${dateRange.length} hari</span>` : ''}
                                    </div>
                                </div>
                                
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; font-size: 14px;">
                                    <div style="background: white; padding: 12px; border-radius: 8px; border: 1px solid #E5E7EB;">
                                        <div style="color: #6B7280; margin-bottom: 4px;">üìÅ Nama File:</div>
                                        <div style="color: #374151; font-weight: 500; word-break: break-all;">${filename}</div>
                                    </div>
                                    <div style="background: white; padding: 12px; border-radius: 8px; border: 1px solid #E5E7EB;">
                                        <div style="color: #6B7280; margin-bottom: 4px;">üìä Jumlah Data:</div>
                                        <div style="color: #374151; font-weight: 500;">${filteredData.length} records</div>
                                    </div>
                                    <div style="background: white; padding: 12px; border-radius: 8px; border: 1px solid #E5E7EB;">
                                        <div style="color: #6B7280; margin-bottom: 4px;">üìè Ukuran File:</div>
                                        <div style="color: #374151; font-weight: 500;">${Math.round(blob.size / 1024)} KB</div>
                                    </div>
                                    <div style="background: white; padding: 12px; border-radius: 8px; border: 1px solid #E5E7EB;">
                                        <div style="color: #6B7280; margin-bottom: 4px;">üìÖ Format:</div>
                                        <div style="color: #374151; font-weight: 500;">Excel (.xlsx)</div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Download Options -->
                            <div style="margin-bottom: 25px;">
                                <h3 style="margin: 0 0 15px 0; color: #374151; font-size: 18px; font-weight: 600;">
                                    Download File Excel:
                                </h3>
                                
                                <!-- Primary Download Button -->
                                <div style="margin-bottom: 15px;">
                                    <a href="${dataUrl}" download="${filename}" 
                                       style="display: block; background: linear-gradient(135deg, #059669 0%, #047857 100%); 
                                              color: white; padding: 18px 24px; text-decoration: none; 
                                              border-radius: 12px; font-weight: 600; font-size: 16px;
                                              text-align: center; transition: all 0.3s ease;
                                              box-shadow: 0 4px 12px rgba(5, 150, 105, 0.3);"
                                       onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 8px 20px rgba(5, 150, 105, 0.4)'"
                                       onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 12px rgba(5, 150, 105, 0.3)'">
                                        <div style="display: flex; align-items: center; justify-content: center;">
                                            <span style="font-size: 20px; margin-right: 8px;">üì•</span>
                                            Download File Excel (.xlsx)
                                        </div>
                                        <div style="font-size: 12px; opacity: 0.9; margin-top: 4px;">
                                            Klik untuk download file Excel asli
                                        </div>
                                    </a>
                                </div>
                            </div>
                            
                            <!-- Instructions -->
                            <div style="background: #ECFDF5; border: 1px solid #10B981; border-radius: 12px; 
                                        padding: 20px; margin-bottom: 20px;">
                                <div style="display: flex; align-items: flex-start;">
                                    <div style="font-size: 24px; margin-right: 12px; margin-top: 2px;">üí°</div>
                                    <div>
                                        <div style="font-weight: 600; color: #047857; margin-bottom: 8px; font-size: 16px;">
                                            Keunggulan Format Excel (.xlsx):
                                        </div>
                                        <div style="color: #047857; font-size: 14px; line-height: 1.5;">
                                            <div style="margin-bottom: 6px;">
                                                <strong>‚úÖ Format Asli Excel:</strong> Langsung terbuka dengan sempurna di Microsoft Excel
                                            </div>
                                            <div style="margin-bottom: 6px;">
                                                <strong>üìä Kolom Terformat:</strong> Lebar kolom sudah diatur otomatis untuk kemudahan baca
                                            </div>
                                            <div style="margin-bottom: 6px;">
                                                <strong>üé® Siap Edit:</strong> Bisa langsung diedit, ditambah formula, atau diformat ulang
                                            </div>
                                            <div style="background: #A7F3D0; padding: 8px; border-radius: 6px; margin-top: 8px;">
                                                <strong>üí° Tips:</strong> Jika download gagal, klik kanan tombol ‚Üí "Save Link As"
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Close Button -->
                            <div style="text-align: center;">
                                <button onclick="closeDownloadModal(this)" 
                                        style="background: #6B7280; color: white; border: none; padding: 12px 24px; 
                                               border-radius: 8px; cursor: pointer; font-size: 14px; font-weight: 500;
                                               transition: background-color 0.2s;"
                                        onmouseover="this.style.backgroundColor='#4B5563'"
                                        onmouseout="this.style.backgroundColor='#6B7280'">
                                    ‚úï Tutup
                                </button>
                            </div>
                        </div>
                    </div>
                `;
                
                // Define close modal function globally
                window.closeDownloadModal = function(button) {
                    const modal = button.closest('div[style*="position: fixed"]');
                    if (modal && modal.parentNode) {
                        modal.parentNode.removeChild(modal);
                        // Clean up the blob URL to free memory
                        URL.revokeObjectURL(dataUrl);
                    }
                };
                
                document.body.appendChild(downloadModal);
                
                // Auto-remove after 5 minutes and clean up blob URL
                setTimeout(() => {
                    if (downloadModal.parentNode) {
                        downloadModal.parentNode.removeChild(downloadModal);
                        URL.revokeObjectURL(dataUrl);
                    }
                }, 300000);
                
                console.log('‚úÖ Excel download modal displayed');
                showNotification('File Excel siap didownload! Klik tombol download di modal.', 'success');
                
            } catch (error) {
                console.error('üí• Critical error in exportJurnalToExcel:', error);
                console.error('Error stack:', error.stack);
                showNotification('Gagal mengekspor data jurnal: ' + error.message, 'error');
            }
        }

        async function exportPresensiToExcel() {
            console.log('üöÄ Starting presensi export process...');
            
            try {
                // Get current filter settings
                const filterPeriode = document.getElementById('filterPeriode').value;
                const filterKelas = document.getElementById('filterKelas').value;
                const dateFrom = document.getElementById('dateFrom').value;
                const dateTo = document.getElementById('dateTo').value;
                
                let dateRange = getDateRange(filterPeriode, dateFrom, dateTo);
                console.log('üìÖ Filter settings - Periode:', filterPeriode, 'Kelas:', filterKelas, 'Date range:', dateRange.length);
                
                // Load data
                console.log('üìä Loading presensi data...');
                let absensiData = getLocalStorageData('absensi');
                console.log('üíæ LocalStorage data count:', absensiData.length);
                
                try {
                    const spreadsheetData = await loadDashboardDataFromSpreadsheet();
                    if (spreadsheetData.absensiData) {
                        absensiData = [...absensiData, ...spreadsheetData.absensiData];
                        console.log('‚òÅÔ∏è Combined with Google Sheets data, total:', absensiData.length);
                    }
                } catch (error) {
                    console.warn('‚ö†Ô∏è Using localStorage data only for export:', error.message);
                }
                
                // Apply ALL filters (user, date range, class)
                const filteredData = absensiData.filter(item => {
                    // Filter by current user
                    const guruName = item['Nama Guru'] || item.namaGuru || '';
                    const normalizedGuruName = guruName.toString().trim().toLowerCase().replace(/[^a-z\s]/g, '');
                    const normalizedCurrentUser = currentUser['Nama Guru'].toString().trim().toLowerCase().replace(/[^a-z\s]/g, '');
                    
                    if (normalizedGuruName !== normalizedCurrentUser) return false;
                    
                    // Filter by class if specified
                    if (filterKelas) {
                        const itemKelas = item.kelas || item.Kelas || '';
                        if (itemKelas !== filterKelas) return false;
                    }
                    
                    // Filter by date range if specified
                    if (dateRange.length > 0) {
                        const timestamp = item.timestamp || item.Timestamp || item['Tanggal'] || item.tanggal;
                        if (!timestamp) return false;
                        
                        const parsedTime = parseTimestamp(timestamp);
                        if (!parsedTime || !dateRange.includes(parsedTime.dateString)) return false;
                    }
                    
                    return true;
                });
                
                console.log('üîç Filtered data after applying all filters:', filteredData.length);
                
                if (filteredData.length === 0) {
                    showNotification('Tidak ada data presensi untuk diekspor', 'error');
                    return;
                }
                
                // Group data by student and organize by dates
                console.log('üìã Organizing data by student and dates...');
                
                const studentAttendance = {};
                const allDates = new Set();
                const kelasInfo = {};
                
                // Process each attendance record
                filteredData.forEach(item => {
                    const namaSiswa = item.namaSiswa || item['Nama Siswa'] || '';
                    const kelas = item.kelas || item.Kelas || '';
                    const keterangan = item.keterangan || item.Keterangan || '';
                    const timestamp = item.timestamp || item.Timestamp || '';
                    const jamPelajaran = item.jamPelajaran || item['Jam Pelajaran'] || '';
                    
                    if (!namaSiswa || !timestamp) return;
                    
                    // Parse date from timestamp
                    let dateKey;
                    try {
                        const timestampStr = timestamp.toString();
                        if (timestampStr.includes('/')) {
                            const parts = timestampStr.split(' ')[0].split('/');
                            if (parts.length === 3) {
                                const day = parts[0].padStart(2, '0');
                                const month = parts[1].padStart(2, '0');
                                const year = parts[2];
                                dateKey = `${day}/${month}/${year}`;
                            }
                        } else if (timestampStr.includes('-')) {
                            const parts = timestampStr.split(' ')[0].split('-');
                            if (parts.length === 3) {
                                if (parts[0].length === 4) {
                                    // YYYY-MM-DD format
                                    const day = parts[2].padStart(2, '0');
                                    const month = parts[1].padStart(2, '0');
                                    const year = parts[0];
                                    dateKey = `${day}/${month}/${year}`;
                                } else {
                                    // DD-MM-YYYY format
                                    const day = parts[0].padStart(2, '0');
                                    const month = parts[1].padStart(2, '0');
                                    const year = parts[2];
                                    dateKey = `${day}/${month}/${year}`;
                                }
                            }
                        }
                        
                        if (!dateKey) {
                            // Fallback: try to parse as date
                            const date = new Date(timestampStr);
                            if (!isNaN(date.getTime())) {
                                dateKey = date.toLocaleDateString('id-ID');
                            }
                        }
                    } catch (e) {
                        console.warn('Could not parse timestamp:', timestamp);
                        dateKey = timestamp.toString().split(' ')[0]; // Use as-is
                    }
                    
                    if (!dateKey) return;
                    
                    // Add to collections
                    allDates.add(dateKey);
                    kelasInfo[namaSiswa] = kelas;
                    
                    // Initialize student record if not exists
                    if (!studentAttendance[namaSiswa]) {
                        studentAttendance[namaSiswa] = {};
                    }
                    
                    // Store attendance for this date (with JP info)
                    const attendanceValue = jamPelajaran ? `${keterangan} (${jamPelajaran}JP)` : keterangan;
                    studentAttendance[namaSiswa][dateKey] = attendanceValue;
                });
                
                // Sort dates chronologically
                const sortedDates = Array.from(allDates).sort((a, b) => {
                    try {
                        const parseDate = (dateStr) => {
                            const parts = dateStr.split('/');
                            if (parts.length === 3) {
                                return new Date(parts[2], parts[1] - 1, parts[0]); // DD/MM/YYYY
                            }
                            return new Date(dateStr);
                        };
                        
                        const dateA = parseDate(a);
                        const dateB = parseDate(b);
                        return dateA - dateB;
                    } catch (e) {
                        return a.localeCompare(b);
                    }
                });
                
                console.log('üìÖ Found dates:', sortedDates.length, sortedDates);
                console.log('üë• Found students:', Object.keys(studentAttendance).length);
                
                // Create Excel data structure with proper column order
                const excelData = [];
                
                // Sort students by class first, then by name
                const sortedStudents = Object.keys(studentAttendance).sort((a, b) => {
                    const kelasA = studentAttendance[a].kelas;
                    const kelasB = studentAttendance[b].kelas;
                    
                    // First sort by class
                    if (kelasA !== kelasB) {
                        return kelasA.localeCompare(kelasB);
                    }
                    
                    // Then sort by name within the same class
                    return a.localeCompare(b);
                });
                
                sortedStudents.forEach(namaSiswa => {
                    // Calculate summary statistics first
                    const attendanceValues = Object.values(studentAttendance[namaSiswa]);
                    const hadir = attendanceValues.filter(val => val && val.toLowerCase().includes('hadir')).length;
                    const sakit = attendanceValues.filter(val => val && val.toLowerCase().includes('sakit')).length;
                    const ijin = attendanceValues.filter(val => val && val.toLowerCase().includes('ijin')).length;
                    const alpha = attendanceValues.filter(val => val && val.toLowerCase().includes('alpha')).length;
                    const bolos = attendanceValues.filter(val => val && val.toLowerCase().includes('bolos')).length;
                    const total = attendanceValues.length;
                    
                    // Create row with proper column order
                    const row = {};
                    
                    // Basic info columns
                    row['Nama Siswa'] = namaSiswa;
                    row['Kelas'] = kelasInfo[namaSiswa] || '';
                    
                    // Date columns (attendance data)
                    sortedDates.forEach(date => {
                        row[date] = studentAttendance[namaSiswa][date] || '-';
                    });
                    
                    // Summary columns
                    row['Total Hadir'] = hadir;
                    row['Total Sakit'] = sakit;
                    row['Total Ijin'] = ijin;
                    row['Total Alpha'] = alpha;
                    row['Total Bolos'] = bolos;
                    row['Total Pertemuan'] = total;
                    row['Persentase Kehadiran'] = total > 0 ? `${Math.round((hadir / total) * 100)}%` : '0%';
                    
                    excelData.push(row);
                });
                
                console.log('üìã Excel data prepared, rows:', excelData.length);
                
                // Generate filename with filter info
                const today = new Date().toLocaleDateString('id-ID').replace(/\//g, '-');
                let filterInfo = '';
                if (filterKelas) filterInfo += `_${filterKelas}`;
                if (filterPeriode !== 'today') filterInfo += `_${filterPeriode}`;
                
                const filename = `Presensi_${currentUser['Nama Guru'].replace(/\s+/g, '_')}${filterInfo}_${today}.xlsx`;
                console.log('üìÅ Generated filename:', filename);
                
                // Create Excel workbook using SheetJS
                console.log('üìù Creating Excel workbook...');
                
                // Create a new workbook
                const wb = XLSX.utils.book_new();
                
                // Convert data to worksheet
                const ws = XLSX.utils.json_to_sheet(excelData);
                
                // Set column widths for better readability
                const baseColWidths = [
                    { wch: 25 }, // Nama Siswa
                    { wch: 10 }  // Kelas
                ];
                
                // Date columns (narrower)
                const dateColWidths = sortedDates.map(() => ({ wch: 12 }));
                
                // Summary columns
                const summaryColWidths = [
                    { wch: 12 }, // Total Hadir
                    { wch: 12 }, // Total Sakit
                    { wch: 12 }, // Total Ijin
                    { wch: 12 }, // Total Alpha
                    { wch: 12 }, // Total Bolos
                    { wch: 15 }, // Total Pertemuan
                    { wch: 18 }  // Persentase Kehadiran
                ];
                
                ws['!cols'] = [...baseColWidths, ...dateColWidths, ...summaryColWidths];
                
                // Add worksheet to workbook
                XLSX.utils.book_append_sheet(wb, ws, 'Data Presensi');
                
                // Generate Excel file as array buffer
                const excelBuffer = XLSX.write(wb, { bookType: 'xlsx', type: 'array' });
                
                // Create blob and data URL
                const blob = new Blob([excelBuffer], { type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' });
                const dataUrl = URL.createObjectURL(blob);
                
                console.log('‚úÖ Excel file created successfully');
                
                // Show enhanced download modal with XLSX option
                const downloadModal = document.createElement('div');
                downloadModal.innerHTML = `
                    <div style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
                                background: rgba(0,0,0,0.7); z-index: 10000; display: flex; 
                                align-items: center; justify-content: center; backdrop-filter: blur(2px);">
                        <div style="background: white; padding: 30px; border-radius: 16px; 
                                    box-shadow: 0 25px 50px rgba(0,0,0,0.4); max-width: 600px; width: 90%;
                                    max-height: 90vh; overflow-y: auto;">
                            
                            <!-- Header -->
                            <div style="text-align: center; margin-bottom: 25px;">
                                <div style="font-size: 64px; margin-bottom: 15px;">üë•</div>
                                <h2 style="margin: 0 0 10px 0; color: #1F2937; font-size: 24px; font-weight: 700;">
                                    Export Data Presensi
                                </h2>
                                <p style="margin: 0; color: #6B7280; font-size: 16px;">
                                    Data siap untuk didownload dalam format Excel (.xlsx)
                                </p>
                            </div>
                            
                            <!-- File Info -->
                            <div style="background: linear-gradient(135deg, #ECFDF5 0%, #F0FDF4 100%); 
                                        padding: 20px; border-radius: 12px; margin-bottom: 25px; 
                                        border: 1px solid #BBF7D0;">
                                <div style="display: flex; align-items: center; margin-bottom: 15px;">
                                    <div style="font-size: 24px; margin-right: 10px;">üìã</div>
                                    <div style="font-weight: 600; color: #166534; font-size: 18px;">Detail File & Filter</div>
                                </div>
                                
                                <!-- Filter Info -->
                                <div style="background: #F8FAFC; padding: 12px; border-radius: 8px; margin-bottom: 15px; border: 1px solid #E2E8F0;">
                                    <div style="color: #475569; font-weight: 500; margin-bottom: 8px; font-size: 14px;">üîç Filter yang Diterapkan:</div>
                                    <div style="display: flex; flex-wrap: gap: 8px; font-size: 12px;">
                                        <span style="background: #10B981; color: white; padding: 4px 8px; border-radius: 4px;">
                                            üìÖ ${filterPeriode === 'today' ? 'Hari Ini' : 
                                                filterPeriode === 'week' ? 'Minggu Ini' : 
                                                filterPeriode === 'month' ? 'Bulan Ini' : 
                                                filterPeriode === 'lastmonth' ? 'Bulan Lalu' : 'Custom'}
                                        </span>
                                        ${filterKelas ? `<span style="background: #3B82F6; color: white; padding: 4px 8px; border-radius: 4px;">üè´ Kelas ${filterKelas}</span>` : ''}
                                        ${dateRange.length > 0 ? `<span style="background: #F59E0B; color: white; padding: 4px 8px; border-radius: 4px;">üìä ${dateRange.length} hari</span>` : ''}
                                    </div>
                                </div>
                                
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; font-size: 14px;">
                                    <div style="background: white; padding: 12px; border-radius: 8px; border: 1px solid #E5E7EB;">
                                        <div style="color: #6B7280; margin-bottom: 4px;">üìÅ Nama File:</div>
                                        <div style="color: #374151; font-weight: 500; word-break: break-all;">${filename}</div>
                                    </div>
                                    <div style="background: white; padding: 12px; border-radius: 8px; border: 1px solid #E5E7EB;">
                                        <div style="color: #6B7280; margin-bottom: 4px;">üë• Jumlah Siswa:</div>
                                        <div style="color: #374151; font-weight: 500;">${excelData.length} siswa</div>
                                    </div>
                                    <div style="background: white; padding: 12px; border-radius: 8px; border: 1px solid #E5E7EB;">
                                        <div style="color: #6B7280; margin-bottom: 4px;">üìè Ukuran File:</div>
                                        <div style="color: #374151; font-weight: 500;">${Math.round(blob.size / 1024)} KB</div>
                                    </div>
                                    <div style="background: white; padding: 12px; border-radius: 8px; border: 1px solid #E5E7EB;">
                                        <div style="color: #6B7280; margin-bottom: 4px;">üìÖ Format:</div>
                                        <div style="color: #374151; font-weight: 500;">Excel (.xlsx)</div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Download Options -->
                            <div style="margin-bottom: 25px;">
                                <h3 style="margin: 0 0 15px 0; color: #374151; font-size: 18px; font-weight: 600;">
                                    Download File Excel:
                                </h3>
                                
                                <!-- Primary Download Button -->
                                <div style="margin-bottom: 15px;">
                                    <a href="${dataUrl}" download="${filename}" 
                                       style="display: block; background: linear-gradient(135deg, #059669 0%, #047857 100%); 
                                              color: white; padding: 18px 24px; text-decoration: none; 
                                              border-radius: 12px; font-weight: 600; font-size: 16px;
                                              text-align: center; transition: all 0.3s ease;
                                              box-shadow: 0 4px 12px rgba(5, 150, 105, 0.3);"
                                       onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 8px 20px rgba(5, 150, 105, 0.4)'"
                                       onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 12px rgba(5, 150, 105, 0.3)'">
                                        <div style="display: flex; align-items: center; justify-content: center;">
                                            <span style="font-size: 20px; margin-right: 8px;">üì•</span>
                                            Download File Excel (.xlsx)
                                        </div>
                                        <div style="font-size: 12px; opacity: 0.9; margin-top: 4px;">
                                            Klik untuk download file Excel asli
                                        </div>
                                    </a>
                                </div>
                            </div>
                            
                            <!-- Instructions -->
                            <div style="background: #ECFDF5; border: 1px solid #10B981; border-radius: 12px; 
                                        padding: 20px; margin-bottom: 20px;">
                                <div style="display: flex; align-items: flex-start;">
                                    <div style="font-size: 24px; margin-right: 12px; margin-top: 2px;">üí°</div>
                                    <div>
                                        <div style="font-weight: 600; color: #047857; margin-bottom: 8px; font-size: 16px;">
                                            Format Data Presensi Excel:
                                        </div>
                                        <div style="color: #047857; font-size: 14px; line-height: 1.5;">
                                            <div style="margin-bottom: 6px;">
                                                <strong>üìä Kolom Terstruktur:</strong> Nama siswa, kelas, tanggal kehadiran, dan ringkasan
                                            </div>
                                            <div style="margin-bottom: 6px;">
                                                <strong>üìà Statistik Lengkap:</strong> Total hadir, sakit, ijin, alpha, bolos, dan persentase
                                            </div>
                                            <div style="margin-bottom: 6px;">
                                                <strong>üé® Siap Analisis:</strong> Format Excel memudahkan pembuatan grafik dan laporan
                                            </div>
                                            <div style="background: #A7F3D0; padding: 8px; border-radius: 6px; margin-top: 8px;">
                                                <strong>üí° Tips:</strong> Jika download gagal, klik kanan tombol ‚Üí "Save Link As"
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Close Button -->
                            <div style="text-align: center;">
                                <button onclick="closeDownloadModal(this)" 
                                        style="background: #6B7280; color: white; border: none; padding: 12px 24px; 
                                               border-radius: 8px; cursor: pointer; font-size: 14px; font-weight: 500;
                                               transition: background-color 0.2s;"
                                        onmouseover="this.style.backgroundColor='#4B5563'"
                                        onmouseout="this.style.backgroundColor='#6B7280'">
                                    ‚úï Tutup
                                </button>
                            </div>
                        </div>
                    </div>
                `;
                
                document.body.appendChild(downloadModal);
                
                // Auto-remove after 5 minutes and clean up blob URL
                setTimeout(() => {
                    if (downloadModal.parentNode) {
                        downloadModal.parentNode.removeChild(downloadModal);
                        URL.revokeObjectURL(dataUrl);
                    }
                }, 300000);
                
                console.log('‚úÖ Excel presensi download modal displayed');
                showNotification('File Excel presensi siap didownload! Klik tombol download di modal.', 'success');
                
            } catch (error) {
                console.error('üí• Critical error in exportPresensiToExcel:', error);
                console.error('Error stack:', error.stack);
                showNotification('Gagal mengekspor data presensi: ' + error.message, 'error');
            }
        }

        function addActivity(type, details) {
            const today = new Date().toLocaleDateString('id-ID');
            const activities = JSON.parse(localStorage.getItem('recentActivities_' + today) || '[]');
            
            const activity = {
                icon: type === 'jurnal' ? 'üìö' : 'üë•',
                title: type === 'jurnal' ? `Jurnal ${details.kelas} - ${details.materi.substring(0, 30)}...` : `Absensi ${details.kelas} - ${details.count} siswa`,
                time: new Date().toLocaleTimeString('id-ID', { hour: '2-digit', minute: '2-digit' })
            };
            
            activities.push(activity);
            localStorage.setItem('recentActivities_' + today, JSON.stringify(activities));
            
            // Update counters
            if (type === 'jurnal') {
                const jurnalCount = parseInt(localStorage.getItem('jurnalCount_' + today) || '0') + 1;
                localStorage.setItem('jurnalCount_' + today, jurnalCount.toString());
                
                // Update durasi count
                const durasiCount = parseInt(localStorage.getItem('durasiCount_' + today) || '0') + parseInt(details.jamPelajaran);
                localStorage.setItem('durasiCount_' + today, durasiCount.toString());
                
                // Update kelas data
                const kelasData = JSON.parse(localStorage.getItem('kelasData_' + today) || '[]');
                if (!kelasData.includes(details.kelas)) {
                    kelasData.push(details.kelas);
                    localStorage.setItem('kelasData_' + today, JSON.stringify(kelasData));
                }
            } else {
                const presensiCount = parseInt(localStorage.getItem('presensiCount_' + today) || '0') + details.count;
                localStorage.setItem('presensiCount_' + today, presensiCount.toString());
                
                // Update kelas data for presensi too
                const kelasData = JSON.parse(localStorage.getItem('kelasData_' + today) || '[]');
                if (!kelasData.includes(details.kelas)) {
                    kelasData.push(details.kelas);
                    localStorage.setItem('kelasData_' + today, JSON.stringify(kelasData));
                }
            }
        }

        function showDetailJurnal() {
            // Hide all tab contents
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.add('hidden');
            });
            
            // Show detail jurnal
            document.getElementById('contentDetailJurnal').classList.remove('hidden');
            
            // Load jurnal data
            loadDetailJurnal();
        }

        function showDetailPresensi() {
            // Hide all tab contents
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.add('hidden');
            });
            
            // Show detail presensi
            document.getElementById('contentDetailPresensi').classList.remove('hidden');
            
            // Load presensi data
            loadDetailPresensi();
        }

        function showDetailPresensiSiswa(kelas, tanggal, jam) {
            // Hide all tab contents
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.add('hidden');
            });
            
            // Show detail presensi siswa
            document.getElementById('contentDetailPresensiSiswa').classList.remove('hidden');
            document.getElementById('detailPresensiSiswaTitle').textContent = `Detail Presensi ${kelas} - ${tanggal}`;
            
            // Load presensi siswa data
            loadDetailPresensiSiswa(kelas, tanggal, jam);
        }

        function backToDashboard() {
            showTab('dashboard');
        }

        async function loadDetailJurnal() {
            const filterPeriode = document.getElementById('filterPeriode').value;
            const filterKelas = document.getElementById('filterKelas').value;
            const dateFrom = document.getElementById('dateFrom').value;
            const dateTo = document.getElementById('dateTo').value;
            
            let dateRange = getDateRange(filterPeriode, dateFrom, dateTo);
            
            const container = document.getElementById('detailJurnalContent');
            container.innerHTML = '<div class="text-center py-4"><div class="loading mx-auto"></div><p class="mt-2 text-gray-500">Memuat data jurnal...</p></div>';
            
            try {
                // Load data from localStorage first (recent data)
                let jurnalData = getLocalStorageData('jurnal');
                
                // Try to load from Google Sheets and combine
                try {
                    const spreadsheetData = await loadDashboardDataFromSpreadsheet();
                    if (spreadsheetData.jurnalData && spreadsheetData.jurnalData.length > 0) {
                        jurnalData = [...jurnalData, ...spreadsheetData.jurnalData];
                    }
                } catch (error) {
                    console.warn('Could not load from Google Sheets, using localStorage only:', error);
                }
                
                console.log('Total jurnal data loaded:', jurnalData.length);
                console.log('Filter kelas:', filterKelas);
                
                // Filter by current user, date range, and class
                const filteredJurnal = jurnalData.filter(item => {
                    // Check guru name (handle different column names)
                    const guruName = item['Nama Guru'] || item.namaGuru || item['Guru'] || item.namaGuru;
                    if (!guruName) return false;
                    
                    // Normalize names for comparison
                    const normalizedGuruName = guruName.toString().trim().toLowerCase().replace(/[^a-z\s]/g, '');
                    const normalizedCurrentUser = currentUser['Nama Guru'].toString().trim().toLowerCase().replace(/[^a-z\s]/g, '');
                    
                    if (normalizedGuruName !== normalizedCurrentUser) return false;
                    
                    // Check class filter
                    if (filterKelas) {
                        const itemKelas = item.kelas || item.Kelas || '';
                        if (itemKelas !== filterKelas) {
                            return false;
                        }
                    }
                    
                    // Check date range if specified
                    if (dateRange.length === 0) return true; // Show all if no date filter
                    
                    const timestamp = item.timestamp || item.Timestamp || item['Tanggal'] || item.tanggal;
                    if (!timestamp) return false;
                    
                    try {
                        let itemDate;
                        const timestampStr = timestamp.toString();
                        
                        if (timestampStr.includes('/')) {
                            const parts = timestampStr.split(' ')[0].split('/');
                            if (parts.length === 3) {
                                const day = parseInt(parts[0]);
                                const month = parseInt(parts[1]);
                                const year = parseInt(parts[2]);
                                
                                if (day <= 31 && month <= 12) {
                                    itemDate = new Date(year, month - 1, day).toLocaleDateString('id-ID');
                                }
                            }
                        } else if (timestampStr.includes('-')) {
                            const parts = timestampStr.split(' ')[0].split('-');
                            if (parts.length === 3) {
                                if (parts[0].length === 4) {
                                    itemDate = new Date(parts[0], parts[1] - 1, parts[2]).toLocaleDateString('id-ID');
                                } else {
                                    itemDate = new Date(parts[2], parts[1] - 1, parts[0]).toLocaleDateString('id-ID');
                                }
                            }
                        } else {
                            itemDate = new Date(timestampStr).toLocaleDateString('id-ID');
                        }
                        
                        return dateRange.includes(itemDate);
                    } catch (e) {
                        console.error('Error parsing jurnal timestamp:', timestamp, e);
                        return false;
                    }
                });
                
                console.log('Filtered jurnal data:', filteredJurnal.length);
                
                if (filteredJurnal.length > 0) {
                    // Sort by timestamp (newest first)
                    filteredJurnal.sort((a, b) => {
                        const timestampA = a.timestamp || a.Timestamp || a['Tanggal'] || a.tanggal;
                        const timestampB = b.timestamp || b.Timestamp || b['Tanggal'] || b.tanggal;
                        try {
                            const dateA = new Date(timestampA);
                            const dateB = new Date(timestampB);
                            return dateB - dateA;
                        } catch (e) {
                            return 0;
                        }
                    });
                    
                    container.innerHTML = filteredJurnal.map(jurnal => {
                        const kelas = jurnal.kelas || jurnal.Kelas || '';
                        const mataPelajaran = jurnal.mataPelajaran || jurnal['Mata Pelajaran'] || currentUser.Mapel;
                        const materi = jurnal.materi || jurnal.Materi || '';
                        const catatan = jurnal.catatan || jurnal.Catatan || '';
                        const jamPelajaran = jurnal.jamPelajaran || jurnal['Jam Pelajaran'] || '';
                        const timestamp = jurnal.timestamp || jurnal.Timestamp || jurnal['Tanggal'] || jurnal.tanggal;
                        
                        let displayTime = timestamp;
                        try {
                            const parsedTime = parseTimestamp(timestamp);
                            if (parsedTime && parsedTime.date && !isNaN(parsedTime.date.getTime())) {
                                // Format: DD/MM/YYYY HH:MM
                                const timeStr = timestamp.toString().includes(' ') ? 
                                    timestamp.toString().split(' ')[1] || '' : '';
                                displayTime = parsedTime.date.toLocaleDateString('id-ID') + 
                                    (timeStr ? ' ' + timeStr : '');
                            } else {
                                // Fallback: keep original timestamp
                                displayTime = timestamp.toString();
                            }
                        } catch (e) {
                            displayTime = timestamp.toString();
                        }
                        
                        return `
                            <div class="border border-gray-200 rounded-lg p-4 mb-4 bg-white shadow-sm">
                                <div class="flex justify-between items-start mb-3">
                                    <div class="flex items-center">
                                        <span class="text-2xl mr-3">üìö</span>
                                        <div>
                                            <h4 class="font-semibold text-gray-900">${kelas}</h4>
                                            <p class="text-sm text-gray-600">${mataPelajaran}</p>
                                        </div>
                                    </div>
                                    <span class="text-xs text-gray-500 bg-gray-100 px-2 py-1 rounded">${displayTime}</span>
                                </div>
                                <div class="ml-11">
                                    <p class="text-gray-700 mb-2"><strong>Materi:</strong> ${materi}</p>
                                    <p class="text-gray-600 mb-2"><strong>Durasi:</strong> ${jamPelajaran} JP</p>
                                    ${catatan ? `<p class="text-gray-600"><strong>Catatan:</strong> ${catatan}</p>` : ''}
                                </div>
                            </div>
                        `;
                    }).join('');
                } else {
                    container.innerHTML = '<div class="text-center py-12"><div class="text-6xl mb-4">üìö</div><p class="text-gray-500 text-lg">Belum ada jurnal pembelajaran</p><p class="text-gray-400 text-sm">Jurnal yang Anda buat akan muncul di sini</p></div>';
                }
            } catch (error) {
                console.error('Error loading detail jurnal:', error);
                container.innerHTML = '<div class="text-center py-12"><div class="text-6xl mb-4">‚ùå</div><p class="text-red-500 text-lg">Gagal memuat data jurnal</p><p class="text-gray-400 text-sm">Silakan coba lagi nanti</p></div>';
            }
        }

        async function loadDetailPresensi() {
            const filterPeriode = document.getElementById('filterPeriode').value;
            const filterKelas = document.getElementById('filterKelas').value;
            const dateFrom = document.getElementById('dateFrom').value;
            const dateTo = document.getElementById('dateTo').value;
            
            let dateRange = getDateRange(filterPeriode, dateFrom, dateTo);
            
            const container = document.getElementById('detailPresensiContent');
            container.innerHTML = '<div class="text-center py-4"><div class="loading mx-auto"></div><p class="mt-2 text-gray-500">Memuat data presensi...</p></div>';
            
            try {
                // Load data from localStorage first (recent data)
                let absensiData = getLocalStorageData('absensi');
                
                // Try to load from Google Sheets and combine
                try {
                    const spreadsheetData = await loadDashboardDataFromSpreadsheet();
                    if (spreadsheetData.absensiData && spreadsheetData.absensiData.length > 0) {
                        absensiData = [...absensiData, ...spreadsheetData.absensiData];
                    }
                } catch (error) {
                    console.warn('Could not load from Google Sheets, using localStorage only:', error);
                }
                
                console.log('Total absensi data loaded:', absensiData.length);
                console.log('Filter kelas:', filterKelas);
                
                // Filter by current user, date range, and class
                const filteredAbsensi = absensiData.filter(item => {
                    // Check guru name (handle different column names)
                    const guruName = item['Nama Guru'] || item.namaGuru || item['Guru'] || item.namaGuru;
                    if (!guruName) return false;
                    
                    // Normalize names for comparison
                    const normalizedGuruName = guruName.toString().trim().toLowerCase().replace(/[^a-z\s]/g, '');
                    const normalizedCurrentUser = currentUser['Nama Guru'].toString().trim().toLowerCase().replace(/[^a-z\s]/g, '');
                    
                    if (normalizedGuruName !== normalizedCurrentUser) return false;
                    
                    // Check class filter
                    if (filterKelas) {
                        const itemKelas = item.kelas || item.Kelas || '';
                        if (itemKelas !== filterKelas) {
                            return false;
                        }
                    }
                    
                    // Check date range if specified
                    if (dateRange.length === 0) return true; // Show all if no date filter
                    
                    const timestamp = item.timestamp || item.Timestamp || item['Tanggal'] || item.tanggal;
                    if (!timestamp) return false;
                    
                    try {
                        let itemDate;
                        const timestampStr = timestamp.toString();
                        
                        if (timestampStr.includes('/')) {
                            const parts = timestampStr.split(' ')[0].split('/');
                            if (parts.length === 3) {
                                const day = parseInt(parts[0]);
                                const month = parseInt(parts[1]);
                                const year = parseInt(parts[2]);
                                
                                if (day <= 31 && month <= 12) {
                                    itemDate = new Date(year, month - 1, day).toLocaleDateString('id-ID');
                                }
                            }
                        } else if (timestampStr.includes('-')) {
                            const parts = timestampStr.split(' ')[0].split('-');
                            if (parts.length === 3) {
                                if (parts[0].length === 4) {
                                    itemDate = new Date(parts[0], parts[1] - 1, parts[2]).toLocaleDateString('id-ID');
                                } else {
                                    itemDate = new Date(parts[2], parts[1] - 1, parts[0]).toLocaleDateString('id-ID');
                                }
                            }
                        } else {
                            itemDate = new Date(timestampStr).toLocaleDateString('id-ID');
                        }
                        
                        return dateRange.includes(itemDate);
                    } catch (e) {
                        console.error('Error parsing absensi timestamp:', timestamp, e);
                        return false;
                    }
                });
                
                console.log('Filtered absensi data:', filteredAbsensi.length);
                
                if (filteredAbsensi.length > 0) {
                    // Group by kelas, tanggal, and jam pelajaran
                    const grouped = {};
                    filteredAbsensi.forEach(presensi => {
                        const kelas = presensi.kelas || presensi.Kelas || '';
                        const jamPelajaran = presensi.jamPelajaran || presensi['Jam Pelajaran'] || '';
                        const timestamp = presensi.timestamp || presensi.Timestamp || presensi['Tanggal'] || presensi.tanggal;
                        
                        let tanggal;
                        try {
                            const timestampStr = timestamp.toString();
                            if (timestampStr.includes('/')) {
                                const parts = timestampStr.split(' ')[0].split('/');
                                if (parts.length === 3) {
                                    const day = parseInt(parts[0]);
                                    const month = parseInt(parts[1]);
                                    const year = parseInt(parts[2]);
                                    
                                    if (day <= 31 && month <= 12) {
                                        tanggal = new Date(year, month - 1, day).toLocaleDateString('id-ID');
                                    }
                                }
                            } else if (timestampStr.includes('-')) {
                                const parts = timestampStr.split(' ')[0].split('-');
                                if (parts.length === 3) {
                                    if (parts[0].length === 4) {
                                        tanggal = new Date(parts[0], parts[1] - 1, parts[2]).toLocaleDateString('id-ID');
                                    } else {
                                        tanggal = new Date(parts[2], parts[1] - 1, parts[0]).toLocaleDateString('id-ID');
                                    }
                                }
                            } else {
                                tanggal = new Date(timestampStr).toLocaleDateString('id-ID');
                            }
                        } catch (e) {
                            tanggal = timestamp;
                        }
                        
                        const key = `${kelas}_${tanggal}_${jamPelajaran}`;
                        if (!grouped[key]) {
                            grouped[key] = {
                                kelas: kelas,
                                tanggal: tanggal,
                                jamPelajaran: jamPelajaran,
                                siswa: [],
                                timestamp: timestamp
                            };
                        }
                        grouped[key].siswa.push(presensi);
                    });
                    
                    // Sort groups by timestamp (newest first)
                    const sortedGroups = Object.values(grouped).sort((a, b) => {
                        try {
                            const dateA = new Date(a.timestamp);
                            const dateB = new Date(b.timestamp);
                            return dateB - dateA;
                        } catch (e) {
                            return 0;
                        }
                    });
                    
                    container.innerHTML = sortedGroups.map(group => {
                        // Calculate attendance summary
                        const statusCount = {
                            hadir: 0,
                            sakit: 0,
                            ijin: 0,
                            alpha: 0,
                            bolos: 0
                        };
                        
                        group.siswa.forEach(siswa => {
                            const status = (siswa.keterangan || siswa.Keterangan || '').toLowerCase();
                            if (status === 'hadir') statusCount.hadir++;
                            else if (status === 'sakit') statusCount.sakit++;
                            else if (status === 'ijin') statusCount.ijin++;
                            else if (status === 'alpha') statusCount.alpha++;
                            else if (status === 'bolos') {     // Misal kolom jam pelajaran pada data absensi disebut 'jamPelajaran' atau 'Jam Pelajaran'     
                                const jp = Number(siswa.jamPelajaran || siswa['Jam Pelajaran'] || 1);     
                                statusCount.bolos += jp;
                        });
                        
                        return `
                            <div onclick="showDetailPresensiSiswa('${group.kelas}', '${group.tanggal}', '${group.jamPelajaran}')" 
                                 class="border border-gray-200 rounded-lg p-4 mb-4 cursor-pointer hover:bg-gray-50 transition-colors bg-white shadow-sm">
                                <div class="flex justify-between items-start">
                                    <div class="flex items-center flex-1">
                                        <span class="text-2xl mr-3">üë•</span>
                                        <div class="flex-1">
                                            <div class="flex items-center justify-between mb-2">
                                                <h4 class="font-semibold text-gray-900">${group.kelas}</h4>
                                                <span class="text-xs text-gray-500 bg-gray-100 px-2 py-1 rounded">${group.tanggal}</span>
                                            </div>
                                            <p class="text-sm text-gray-600 mb-2">${group.jamPelajaran} JP ‚Ä¢ ${group.siswa.length} siswa</p>
                                            <div class="flex flex-wrap gap-1">
                                                ${statusCount.hadir > 0 ? `<span class="bg-green-100 text-green-800 px-2 py-1 rounded text-xs">‚úì ${statusCount.hadir}</span>` : ''}
                                                ${statusCount.sakit > 0 ? `<span class="bg-yellow-100 text-yellow-800 px-2 py-1 rounded text-xs">ü§í ${statusCount.sakit}</span>` : ''}
                                                ${statusCount.ijin > 0 ? `<span class="bg-blue-100 text-blue-800 px-2 py-1 rounded text-xs">üìù ${statusCount.ijin}</span>` : ''}
                                                ${statusCount.alpha > 0 ? `<span class="bg-red-100 text-red-800 px-2 py-1 rounded text-xs">‚ùå ${statusCount.alpha}</span>` : ''}
                                                ${statusCount.bolos > 0 ? `<span class="bg-purple-100 text-purple-800 px-2 py-1 rounded text-xs">üö´ ${statusCount.bolos}</span>` : ''}
                                            </div>
                                        </div>
                                    </div>
                                    <div class="text-gray-400 ml-2">
                                        <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                                            <path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd"></path>
                                        </svg>
                                    </div>
                                </div>
                            </div>
                        `;
                    }).join('');
                } else {
                    container.innerHTML = '<div class="text-center py-12"><div class="text-6xl mb-4">üë•</div><p class="text-gray-500 text-lg">Belum ada data presensi</p><p class="text-gray-400 text-sm">Presensi yang Anda buat akan muncul di sini</p></div>';
                }
            } catch (error) {
                console.error('Error loading detail presensi:', error);
                container.innerHTML = '<div class="text-center py-12"><div class="text-6xl mb-4">‚ùå</div><p class="text-red-500 text-lg">Gagal memuat data presensi</p><p class="text-gray-400 text-sm">Silakan coba lagi nanti</p></div>';
            }
        }

        async function loadDetailPresensiSiswa(kelas, tanggal, jam) {
            const container = document.getElementById('detailPresensiSiswaContent');
            container.innerHTML = '<div class="text-center py-4"><div class="loading mx-auto"></div><p class="mt-2 text-gray-500">Memuat detail presensi siswa...</p></div>';
            
            try {
                // Load data from localStorage first (recent data)
                let absensiData = getLocalStorageData('absensi');
                
                // Try to load from Google Sheets and combine
                try {
                    const spreadsheetData = await loadDashboardDataFromSpreadsheet();
                    if (spreadsheetData.absensiData && spreadsheetData.absensiData.length > 0) {
                        absensiData = [...absensiData, ...spreadsheetData.absensiData];
                    }
                } catch (error) {
                    console.warn('Could not load from Google Sheets, using localStorage only:', error);
                }
                
                // Filter by kelas, tanggal, jam, and guru
                const filteredData = absensiData.filter(item => {
                    const guruName = item['Nama Guru'] || item.namaGuru || item['Guru'] || item.namaGuru;
                    const itemKelas = item.kelas || item.Kelas || '';
                    const itemJam = item.jamPelajaran || item['Jam Pelajaran'] || '';
                    const timestamp = item.timestamp || item.Timestamp || item['Tanggal'] || item.tanggal;
                    
                    // Check guru name
                    if (!guruName) return false;
                    
                    // Normalize names for comparison
                    const normalizedGuruName = guruName.toString().trim().toLowerCase().replace(/[^a-z\s]/g, '');
                    const normalizedCurrentUser = currentUser['Nama Guru'].toString().trim().toLowerCase().replace(/[^a-z\s]/g, '');
                    
                    if (normalizedGuruName !== normalizedCurrentUser) return false;
                    
                    // Check kelas and jam
                    if (itemKelas !== kelas || itemJam !== jam) return false;
                    
                    // Check tanggal
                    try {
                        let itemDate;
                        const timestampStr = timestamp.toString();
                        
                        if (timestampStr.includes('/')) {
                            const parts = timestampStr.split(' ')[0].split('/');
                            if (parts.length === 3) {
                                const day = parseInt(parts[0]);
                                const month = parseInt(parts[1]);
                                const year = parseInt(parts[2]);
                                
                                if (day <= 31 && month <= 12) {
                                    itemDate = new Date(year, month - 1, day).toLocaleDateString('id-ID');
                                }
                            }
                        } else if (timestampStr.includes('-')) {
                            const parts = timestampStr.split(' ')[0].split('-');
                            if (parts.length === 3) {
                                if (parts[0].length === 4) {
                                    itemDate = new Date(parts[0], parts[1] - 1, parts[2]).toLocaleDateString('id-ID');
                                } else {
                                    itemDate = new Date(parts[2], parts[1] - 1, parts[0]).toLocaleDateString('id-ID');
                                }
                            }
                        } else {
                            itemDate = new Date(timestampStr).toLocaleDateString('id-ID');
                        }
                        
                        return itemDate === tanggal;
                    } catch (e) {
                        console.error('Error parsing timestamp:', timestamp, e);
                        return false;
                    }
                });
                
                if (filteredData.length > 0) {
                    // Sort by student name
                    filteredData.sort((a, b) => {
                        const nameA = (a.namaSiswa || a['Nama Siswa'] || '').toString();
                        const nameB = (b.namaSiswa || b['Nama Siswa'] || '').toString();
                        return nameA.localeCompare(nameB);
                    });
                    
                    // Calculate summary
                    const statusCount = {
                        hadir: 0,
                        sakit: 0,
                        ijin: 0,
                        alpha: 0,
                        bolos: 0
                    };
                    
                    filteredData.forEach(siswa => {
                        const status = (siswa.keterangan || siswa.Keterangan || '').toLowerCase();
                        if (status === 'hadir') statusCount.hadir++;
                        else if (status === 'sakit') statusCount.sakit++;
                        else if (status === 'ijin') statusCount.ijin++;
                        else if (status === 'alpha') statusCount.alpha++;
                        else if (status === 'bolos') {     // Misal kolom jam pelajaran pada data absensi disebut 'jamPelajaran' atau 'Jam Pelajaran'     
                            const jp = Number(siswa.jamPelajaran || siswa['Jam Pelajaran'] || 1);     
                            statusCount.bolos += jp;
                    });
                    
                    container.innerHTML = `
                        <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-6">
                            <h4 class="font-semibold text-blue-900 mb-2">Ringkasan Kehadiran</h4>
                            <div class="flex flex-wrap gap-2">
                                <span class="bg-green-100 text-green-800 px-3 py-1 rounded-full text-sm">‚úì Hadir: ${statusCount.hadir}</span>
                                <span class="bg-yellow-100 text-yellow-800 px-3 py-1 rounded-full text-sm">ü§í Sakit: ${statusCount.sakit}</span>
                                <span class="bg-blue-100 text-blue-800 px-3 py-1 rounded-full text-sm">üìù Ijin: ${statusCount.ijin}</span>
                                <span class="bg-red-100 text-red-800 px-3 py-1 rounded-full text-sm">‚ùå Alpha: ${statusCount.alpha}</span>
                                <span class="bg-purple-100 text-purple-800 px-3 py-1 rounded-full text-sm">üö´ Bolos: ${statusCount.bolos}</span>
                            </div>
                        </div>
                        
                        <div class="space-y-3">
                            ${filteredData.map(siswa => {
                                const nama = siswa.namaSiswa || siswa['Nama Siswa'] || '';
                                const status = siswa.keterangan || siswa.Keterangan || '';
                                
                                let statusClass = 'bg-gray-100 text-gray-800';
                                let statusIcon = '‚ùì';
                                
                                switch(status.toLowerCase()) {
                                    case 'hadir':
                                        statusClass = 'bg-green-100 text-green-800';
                                        statusIcon = '‚úì';
                                        break;
                                    case 'sakit':
                                        statusClass = 'bg-yellow-100 text-yellow-800';
                                        statusIcon = 'ü§í';
                                        break;
                                    case 'ijin':
                                        statusClass = 'bg-blue-100 text-blue-800';
                                        statusIcon = 'üìù';
                                        break;
                                    case 'alpha':
                                        statusClass = 'bg-red-100 text-red-800';
                                        statusIcon = '‚ùå';
                                        break;
                                    case 'bolos':
                                        statusClass = 'bg-purple-100 text-purple-800';
                                        statusIcon = 'üö´';
                                        break;
                                }
                                
                                return `
                                    <div class="flex items-center justify-between p-3 bg-white border border-gray-200 rounded-lg">
                                        <span class="font-medium text-gray-900">${nama}</span>
                                        <span class="${statusClass} px-3 py-1 rounded-full text-sm font-medium">
                                            ${statusIcon} ${status}
                                        </span>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    `;
                } else {
                    container.innerHTML = '<div class="text-center py-12"><div class="text-6xl mb-4">üë•</div><p class="text-gray-500 text-lg">Tidak ada data presensi siswa</p><p class="text-gray-400 text-sm">Data presensi untuk sesi ini tidak ditemukan</p></div>';
                }
            } catch (error) {
                console.error('Error loading detail presensi siswa:', error);
                container.innerHTML = '<div class="text-center py-12"><div class="text-6xl mb-4">‚ùå</div><p class="text-red-500 text-lg">Gagal memuat detail presensi siswa</p><p class="text-gray-400 text-sm">Silakan coba lagi nanti</p></div>';
            }
        }

        // ===== WALI KELAS FUNCTIONS =====
        
        function setupWaliKelasInterface(user) {
            const waliKelas = user['Wali Kelas'] || '';
            const isOperator = waliKelas.toLowerCase() === 'operator';
            
            // Set title and subtitle
            if (isOperator) {
                document.getElementById('dashboardWaliTitle').textContent = 'Dashboard Operator';
                document.getElementById('dashboardWaliSubtitle').textContent = 'Akses ke semua kelas';
                document.getElementById('operatorFilter').classList.remove('hidden');
                
                // Populate all classes for operator
                populateWaliKelasOptions();
            } else {
                document.getElementById('dashboardWaliTitle').textContent = 'Dashboard Wali Kelas';
                document.getElementById('dashboardWaliSubtitle').textContent = `Wali Kelas ${waliKelas}`;
                document.getElementById('operatorFilter').classList.add('hidden');
            }
            
            // Set profile info
            document.getElementById('welcomeMessageWali').textContent = user['Nama Guru'];
            document.getElementById('roleInfoWali').textContent = isOperator ? 'Operator Sistem' : `Wali Kelas ${waliKelas}`;
            document.getElementById('profilePhotoWali').src = user.Foto || 'https://via.placeholder.com/40x40/4F46E5/FFFFFF?text=' + user['Nama Guru'].charAt(0);
        }
        
        function populateWaliKelasOptions() {
            const kelasSet = new Set();
            classData.forEach(row => {
                if (row.Kelas) {
                    kelasSet.add(row.Kelas);
                }
            });
            
            const kelasOptions = Array.from(kelasSet).sort();
            const filterKelasWali = document.getElementById('filterKelasWali');
            
            // Clear existing options except "Semua Kelas"
            filterKelasWali.innerHTML = '<option value="">Semua Kelas</option>';
            
            kelasOptions.forEach(kelas => {
                const option = new Option(kelas, kelas);
                filterKelasWali.appendChild(option);
            });
        }
        
        function showWaliTab(tabName) {
            // Hide all wali tab contents
            document.querySelectorAll('.wali-tab-content').forEach(content => {
                content.classList.add('hidden');
            });
            
            // Remove active class from all wali tabs
            document.querySelectorAll('.wali-tab-button').forEach(button => {
                button.classList.remove('border-blue-500', 'text-blue-600');
                button.classList.add('border-transparent', 'text-gray-500');
            });
            
            // Show selected tab content
            document.getElementById('contentWali' + tabName.charAt(0).toUpperCase() + tabName.slice(1)).classList.remove('hidden');
            
            // Add active class to selected tab
            const activeTab = document.getElementById('tabWali' + tabName.charAt(0).toUpperCase() + tabName.slice(1));
            activeTab.classList.remove('border-transparent', 'text-gray-500');
            activeTab.classList.add('border-blue-500', 'text-blue-600');
            
            // Load content based on tab
            if (tabName === 'overview') {
                updateWaliDashboardStats();
            } else if (tabName === 'kehadiran') {
                loadRekapKehadiran();
            } else if (tabName === 'pembelajaran') {
                loadRekapPembelajaran();
            } else if (tabName === 'siswaBermasalah') {
                loadSiswaBermasalah();
            }
        }
        
        function updateWaliFilter() {
            const filterPeriodeWali = document.getElementById('filterPeriodeWali').value;
            const customDateWali = document.getElementById('customDateWali');
            
            if (filterPeriodeWali === 'custom') {
                customDateWali.classList.remove('hidden');
                
                // Set default dates if not set
                if (!document.getElementById('dateFromWali').value) {
                    const today = new Date();
                    document.getElementById('dateFromWali').value = today.toISOString().split('T')[0];
                }
                if (!document.getElementById('dateToWali').value) {
                    const today = new Date();
                    document.getElementById('dateToWali').value = today.toISOString().split('T')[0];
                }
            } else {
                customDateWali.classList.add('hidden');
            }
            
            // Update dashboard stats
            updateWaliDashboardStats();
        }
        
        function resetWaliFilter() {
            document.getElementById('filterKelasWali').value = '';
            document.getElementById('filterPeriodeWali').value = 'week';
            document.getElementById('dateFromWali').value = '';
            document.getElementById('dateToWali').value = '';
            document.getElementById('customDateWali').classList.add('hidden');
            
            updateWaliDashboardStats();
        }
        
        async function updateWaliDashboardStats() {
            const waliKelas = currentUser['Wali Kelas'] || '';
            const isOperator = waliKelas.toLowerCase() === 'operator';
            
            // Get filter values with null checks
            const filterKelasWaliEl = document.getElementById('filterKelasWali');
            const filterPeriodeWaliEl = document.getElementById('filterPeriodeWali');
            const dateFromWaliEl = document.getElementById('dateFromWali');
            const dateToWaliEl = document.getElementById('dateToWali');
            
            const filterKelasWali = filterKelasWaliEl?.value || '';
            const filterPeriodeWali = filterPeriodeWaliEl?.value || 'week';
            const dateFromWali = dateFromWaliEl?.value || '';
            const dateToWali = dateToWaliEl?.value || '';
            
            // Determine which classes to show
            let targetClasses = [];
            if (isOperator) {
                if (filterKelasWali) {
                    targetClasses = [filterKelasWali];
                } else {
                    // Show all classes
                    const kelasSet = new Set();
                    classData.forEach(row => {
                        if (row.Kelas) kelasSet.add(row.Kelas);
                    });
                    targetClasses = Array.from(kelasSet);
                }
            } else {
                // Regular wali kelas - only show their class
                targetClasses = [waliKelas];
            }
            
            console.log('Target classes for wali kelas:', targetClasses);
            
            // Get date range
            let dateRange = getWaliDateRange(filterPeriodeWali, dateFromWali, dateToWali);
            
            // Show loading state
            showWaliDashboardLoading();
            
            try {
                // Load data
                let jurnalData = getLocalStorageData('jurnal');
                let absensiData = getLocalStorageData('absensi');
                
                // Try to load from Google Sheets
                try {
                    const spreadsheetData = await loadDashboardDataFromSpreadsheet();
                    if (spreadsheetData.jurnalData) {
                        jurnalData = [...jurnalData, ...spreadsheetData.jurnalData];
                    }
                    if (spreadsheetData.absensiData) {
                        absensiData = [...absensiData, ...spreadsheetData.absensiData];
                    }
                } catch (error) {
                    console.warn('Using localStorage data only for wali kelas:', error);
                }
                
                // Filter data by target classes and date range
                const filteredJurnal = jurnalData.filter(item => {
                    const itemKelas = item.kelas || item.Kelas || '';
                    if (!targetClasses.includes(itemKelas)) return false;
                    
                    if (dateRange.length > 0) {
                        const timestamp = item.timestamp || item.Timestamp || item['Tanggal'] || item.tanggal;
                        if (!timestamp) return false;
                        
                        const parsedTime = parseTimestamp(timestamp);
                        if (!parsedTime || !dateRange.includes(parsedTime.dateString)) return false;
                    }
                    
                    return true;
                });
                
                const filteredAbsensi = absensiData.filter(item => {
                    const itemKelas = item.kelas || item.Kelas || '';
                    if (!targetClasses.includes(itemKelas)) return false;
                    
                    if (dateRange.length > 0) {
                        const timestamp = item.timestamp || item.Timestamp || item['Tanggal'] || item.tanggal;
                        if (!timestamp) return false;
                        
                        const parsedTime = parseTimestamp(timestamp);
                        if (!parsedTime || !dateRange.includes(parsedTime.dateString)) return false;
                    }
                    
                    return true;
                });
                
                console.log('Filtered data for wali - Jurnal:', filteredJurnal.length, 'Absensi:', filteredAbsensi.length);
                
                // Calculate statistics
                const totalSiswa = classData.filter(row => targetClasses.includes(row.Kelas)).length;
                const totalPembelajaran = filteredJurnal.length;
                const totalJam = filteredJurnal.reduce((sum, item) => {
                    const jamPelajaran = item['Jam Pelajaran'] || item.jamPelajaran || '0';
                    return sum + parseInt(jamPelajaran.toString());
                }, 0);
                
                // Calculate attendance percentage
                let totalHadir = 0;
                let totalKehadiran = 0;
                
                filteredAbsensi.forEach(item => {
                    const status = (item.keterangan || item.Keterangan || '').toLowerCase();
                    totalKehadiran++;
                    if (status === 'hadir') {
                        totalHadir++;
                    }
                });
                
                const persentaseKehadiran = totalKehadiran > 0 ? Math.round((totalHadir / totalKehadiran) * 100) : 0;
                
                // Update labels based on period
                let periodLabel = '';
                switch(filterPeriodeWali) {
                    case 'week': periodLabel = 'Minggu Ini'; break;
                    case 'month': periodLabel = 'Bulan Ini'; break;
                    case 'semester1': periodLabel = 'Semester 1'; break;
                    case 'semester2': periodLabel = 'Semester 2'; break;
                    case 'tahun': periodLabel = 'Tahun Ajaran'; break;
                    case 'custom': periodLabel = 'Custom'; break;
                    default: periodLabel = 'Minggu Ini';
                }
                
                // Update labels with null checks
                const totalPembelajaranLabelEl = document.getElementById('totalPembelajaranLabel');
                const persentaseKehadiranLabelEl = document.getElementById('persentaseKehadiranLabel');
                const siswaBermasalahLabelEl = document.getElementById('siswaBermasalahLabel');
                
                if (totalPembelajaranLabelEl) {
                    totalPembelajaranLabelEl.textContent = `Pembelajaran ${periodLabel}`;
                }
                if (persentaseKehadiranLabelEl) {
                    persentaseKehadiranLabelEl.textContent = `Kehadiran ${periodLabel}`;
                }
                if (siswaBermasalahLabelEl) {
                    siswaBermasalahLabelEl.textContent = `Siswa Bermasalah ${periodLabel}`;
                }
                
                // Calculate problematic students
                const siswaBermasalah = await calculateSiswaBermasalah(targetClasses, dateRange, filteredAbsensi);
                
                // Update values with null checks
                const totalSiswaWaliEl = document.getElementById('totalSiswaWali');
                const totalPembelajaranWaliEl = document.getElementById('totalPembelajaranWali');
                const persentaseKehadiranWaliEl = document.getElementById('persentaseKehadiranWali');
                const totalSiswaBermasalahEl = document.getElementById('totalSiswaBermasalah');
                
                if (totalSiswaWaliEl) {
                    totalSiswaWaliEl.textContent = totalSiswa;
                }
                if (totalPembelajaranWaliEl) {
                    totalPembelajaranWaliEl.textContent = totalPembelajaran;
                }
                if (persentaseKehadiranWaliEl) {
                    persentaseKehadiranWaliEl.textContent = persentaseKehadiran + '%';
                }
                if (totalSiswaBermasalahEl) {
                    totalSiswaBermasalahEl.textContent = siswaBermasalah.length;
                }
                
                // Update summary
                updateRingkasanKehadiran(filteredAbsensi, targetClasses);
                
            } catch (error) {
                console.error('Error updating wali dashboard stats:', error);
                showNotification('Gagal memuat statistik dashboard', 'error');
            }
        }
        
        function getWaliDateRange(filterPeriode, dateFrom, dateTo) {
            let dateRange = [];
            const today = new Date();
            const currentYear = today.getFullYear();
            const currentMonth = today.getMonth(); // 0-11
            
            if (filterPeriode === 'week') {
                const startOfWeek = new Date(today.setDate(today.getDate() - today.getDay()));
                for (let i = 0; i < 7; i++) {
                    const date = new Date(startOfWeek);
                    date.setDate(startOfWeek.getDate() + i);
                    dateRange.push(date.toLocaleDateString('id-ID'));
                }
            } else if (filterPeriode === 'month') {
                const year = today.getFullYear();
                const month = today.getMonth();
                const daysInMonth = new Date(year, month + 1, 0).getDate();
                for (let i = 1; i <= daysInMonth; i++) {
                    const date = new Date(year, month, i);
                    dateRange.push(date.toLocaleDateString('id-ID'));
                }
            } else if (filterPeriode === 'semester1') {
                // Semester 1: Juli - Desember
                let startYear = currentYear;
                if (currentMonth < 6) { // Jika sekarang Jan-Jun, ambil semester 1 tahun lalu
                    startYear = currentYear - 1;
                }
                
                // Juli - Desember
                for (let month = 6; month <= 11; month++) {
                    const daysInMonth = new Date(startYear, month + 1, 0).getDate();
                    for (let day = 1; day <= daysInMonth; day++) {
                        const date = new Date(startYear, month, day);
                        dateRange.push(date.toLocaleDateString('id-ID'));
                    }
                }
            } else if (filterPeriode === 'semester2') {
                // Semester 2: Januari - Juni
                let startYear = currentYear;
                if (currentMonth >= 6) { // Jika sekarang Jul-Des, ambil semester 2 tahun depan
                    startYear = currentYear + 1;
                }
                
                // Januari - Juni
                for (let month = 0; month <= 5; month++) {
                    const daysInMonth = new Date(startYear, month + 1, 0).getDate();
                    for (let day = 1; day <= daysInMonth; day++) {
                        const date = new Date(startYear, month, day);
                        dateRange.push(date.toLocaleDateString('id-ID'));
                    }
                }
            } else if (filterPeriode === 'tahun') {
                // Tahun Ajaran: Juli tahun ini - Juni tahun depan (atau Juli tahun lalu - Juni tahun ini)
                let startYear = currentYear;
                if (currentMonth < 6) { // Jika sekarang Jan-Jun, tahun ajaran dimulai Juli tahun lalu
                    startYear = currentYear - 1;
                }
                
                // Juli - Desember (tahun pertama)
                for (let month = 6; month <= 11; month++) {
                    const daysInMonth = new Date(startYear, month + 1, 0).getDate();
                    for (let day = 1; day <= daysInMonth; day++) {
                        const date = new Date(startYear, month, day);
                        dateRange.push(date.toLocaleDateString('id-ID'));
                    }
                }
                
                // Januari - Juni (tahun kedua)
                for (let month = 0; month <= 5; month++) {
                    const daysInMonth = new Date(startYear + 1, month + 1, 0).getDate();
                    for (let day = 1; day <= daysInMonth; day++) {
                        const date = new Date(startYear + 1, month, day);
                        dateRange.push(date.toLocaleDateString('id-ID'));
                    }
                }
            } else if (filterPeriode === 'custom' && dateFrom && dateTo) {
                const start = new Date(dateFrom);
                const end = new Date(dateTo);
                for (let d = new Date(start); d <= end; d.setDate(d.getDate() + 1)) {
                    dateRange.push(new Date(d).toLocaleDateString('id-ID'));
                }
            }
            
            return dateRange;
        }
        
        function showWaliDashboardLoading() {
            // Show loading state with null checks
            const totalSiswaWaliEl = document.getElementById('totalSiswaWali');
            const totalPembelajaranWaliEl = document.getElementById('totalPembelajaranWali');
            const persentaseKehadiranWaliEl = document.getElementById('persentaseKehadiranWali');
            const totalSiswaBermasalahEl = document.getElementById('totalSiswaBermasalah');
            const ringkasanKehadiranEl = document.getElementById('ringkasanKehadiran');
            
            if (totalSiswaWaliEl) {
                totalSiswaWaliEl.innerHTML = '<div class="loading"></div>';
            }
            if (totalPembelajaranWaliEl) {
                totalPembelajaranWaliEl.innerHTML = '<div class="loading"></div>';
            }
            if (persentaseKehadiranWaliEl) {
                persentaseKehadiranWaliEl.innerHTML = '<div class="loading"></div>';
            }
            if (totalSiswaBermasalahEl) {
                totalSiswaBermasalahEl.innerHTML = '<div class="loading"></div>';
            }
            if (ringkasanKehadiranEl) {
                ringkasanKehadiranEl.innerHTML = '<div class="text-center py-4"><div class="loading mx-auto"></div><p class="mt-2 text-gray-500">Memuat ringkasan...</p></div>';
            }
        }
        
        async function calculateSiswaBermasalah(targetClasses, dateRange, absensiData) {
            // Get all students in target classes
            const allStudents = classData.filter(row => targetClasses.includes(row.Kelas));
            const siswaBermasalah = [];
            
            // Calculate attendance for each student
            allStudents.forEach(student => {
                const nama = student['Nama Siswa'];
                const kelas = student.Kelas;
                
                // Filter attendance data for this student
                const studentData = absensiData.filter(item => {
                    const itemNama = item.namaSiswa || item['Nama Siswa'] || '';
                    return itemNama === nama;
                });
                
                if (studentData.length === 0) return; // Skip if no attendance data
                
                // Calculate summary
                const summary = {
                    hadir: 0,
                    sakit: 0,
                    ijin: 0,
                    alpha: 0,
                    bolos: 0,
                    totalJP: 0,
                    bolosJP: 0
                };
                
                studentData.forEach(item => {
                    const status = (item.keterangan || item.Keterangan || '').toLowerCase();
                    const jamPelajaran = parseInt(item.jamPelajaran || item['Jam Pelajaran'] || '1');
                    
                    summary.totalJP += jamPelajaran;
                    
                    if (status === 'hadir') summary.hadir++;
                    else if (status === 'sakit') summary.sakit++;
                    else if (status === 'ijin') summary.ijin++;
                    else if (status === 'alpha') summary.alpha++;
                    else if (status === 'bolos') {
                        summary.bolos++;
                        summary.bolosJP += jamPelajaran;
                    }
                });
                
                // Apply bolos conversion: 9 JP bolos = 1 alpha
                const convertedAlpha = Math.floor(summary.bolosJP / 9);
                const remainingBolosJP = summary.bolosJP % 9;
                const finalAlpha = summary.alpha + convertedAlpha;
                
                const totalSessions = summary.hadir + summary.sakit + summary.ijin + finalAlpha + Math.ceil(remainingBolosJP / 9);
                const attendanceRate = totalSessions > 0 ? (summary.hadir / totalSessions) * 100 : 100;
                
                // Check if problematic: attendance < 75% OR has alpha (including converted)
                if (attendanceRate < 75 || finalAlpha > 0) {
                    siswaBermasalah.push({
                        nama: nama,
                        kelas: kelas,
                        attendanceRate: attendanceRate,
                        finalAlpha: finalAlpha,
                        remainingBolosJP: remainingBolosJP,
                        summary: summary
                    });
                }
            });
            
            return siswaBermasalah;
        }
        
        function showSiswaBermasalah() {
            showWaliTab('siswaBermasalah');
        }
        
        async function loadSiswaBermasalah() {
            const container = document.getElementById('siswaBermasalahContent');
            container.innerHTML = '<div class="text-center py-4"><div class="loading mx-auto"></div><p class="mt-2 text-gray-500">Memuat data siswa bermasalah...</p></div>';
            
            try {
                const waliKelas = currentUser['Wali Kelas'] || '';
                const isOperator = waliKelas.toLowerCase() === 'operator';
                
                // Get filter values
                const filterKelasWali = document.getElementById('filterKelasWali')?.value || '';
                const filterPeriodeWali = document.getElementById('filterPeriodeWali')?.value || 'week';
                const dateFromWali = document.getElementById('dateFromWali')?.value || '';
                const dateToWali = document.getElementById('dateToWali')?.value || '';
                
                // Determine which classes to show
                let targetClasses = [];
                if (isOperator) {
                    if (filterKelasWali) {
                        targetClasses = [filterKelasWali];
                    } else {
                        const kelasSet = new Set();
                        classData.forEach(row => {
                            if (row.Kelas) kelasSet.add(row.Kelas);
                        });
                        targetClasses = Array.from(kelasSet);
                    }
                } else {
                    targetClasses = [waliKelas];
                }
                
                // Get date range
                let dateRange = getWaliDateRange(filterPeriodeWali, dateFromWali, dateToWali);
                
                // Load data
                let absensiData = getLocalStorageData('absensi');
                
                try {
                    const spreadsheetData = await loadDashboardDataFromSpreadsheet();
                    if (spreadsheetData.absensiData) {
                        absensiData = [...absensiData, ...spreadsheetData.absensiData];
                    }
                } catch (error) {
                    console.warn('Using localStorage data only for siswa bermasalah:', error);
                }
                
                // Filter data by target classes and date range
                const filteredAbsensi = absensiData.filter(item => {
                    const itemKelas = item.kelas || item.Kelas || '';
                    if (!targetClasses.includes(itemKelas)) return false;
                    
                    if (dateRange.length > 0) {
                        const timestamp = item.timestamp || item.Timestamp || item['Tanggal'] || item.tanggal;
                        if (!timestamp) return false;
                        
                        const parsedTime = parseTimestamp(timestamp);
                        if (!parsedTime || !dateRange.includes(parsedTime.dateString)) return false;
                    }
                    
                    return true;
                });
                
                // Calculate problematic students
                const siswaBermasalah = await calculateSiswaBermasalah(targetClasses, dateRange, filteredAbsensi);
                
                if (siswaBermasalah.length === 0) {
                    container.innerHTML = '<div class="text-center py-12"><div class="text-6xl mb-4">üòä</div><p class="text-gray-500 text-lg">Tidak ada siswa bermasalah</p><p class="text-gray-400 text-sm">Semua siswa memiliki kehadiran yang baik</p></div>';
                    return;
                }
                
                // Sort by attendance rate (worst first)
                siswaBermasalah.sort((a, b) => {
                    if (a.finalAlpha !== b.finalAlpha) {
                        return b.finalAlpha - a.finalAlpha; // More alpha first
                    }
                    return a.attendanceRate - b.attendanceRate; // Lower attendance first
                });
                
                const studentsHtml = siswaBermasalah.map(student => {
                    const attendanceRate = student.attendanceRate.toFixed(1);
                    
                    // Determine severity
                    let severityClass = 'bg-red-100 border-red-300';
                    let severityIcon = 'üò∞';
                    let severityText = 'Sangat Bermasalah';
                    
                    if (student.finalAlpha === 0 && student.attendanceRate >= 70) {
                        severityClass = 'bg-orange-100 border-orange-300';
                        severityIcon = 'üòü';
                        severityText = 'Bermasalah';
                    }
                    
                    return `
                        <div class="border rounded-lg p-4 ${severityClass}">
                            <div class="flex justify-between items-start mb-3">
                                <div>
                                    <h5 class="font-semibold text-gray-900 text-lg">${student.nama}</h5>
                                    <p class="text-sm text-gray-600">Kelas ${student.kelas}</p>
                                </div>
                                <div class="text-right">
                                    <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium ${severityClass.replace('bg-', 'bg-').replace('-100', '-200')}">
                                        ${severityIcon} ${severityText}
                                    </span>
                                </div>
                            </div>
                            
                            <div class="grid grid-cols-2 md:grid-cols-4 gap-3 text-sm">
                                <div class="bg-white p-2 rounded border">
                                    <div class="text-xs text-gray-500">Kehadiran</div>
                                    <div class="font-semibold ${parseFloat(attendanceRate) >= 75 ? 'text-green-600' : 'text-red-600'}">${attendanceRate}%</div>
                                </div>
                                <div class="bg-white p-2 rounded border">
                                    <div class="text-xs text-gray-500">Alpha</div>
                                    <div class="font-semibold ${student.finalAlpha > 0 ? 'text-red-600' : 'text-green-600'}">${student.finalAlpha}</div>
                                </div>
                                <div class="bg-white p-2 rounded border">
                                    <div class="text-xs text-gray-500">Bolos (JP)</div>
                                    <div class="font-semibold ${student.remainingBolosJP > 4 ? 'text-orange-600' : 'text-gray-600'}">${student.remainingBolosJP}</div>
                                </div>
                                <div class="bg-white p-2 rounded border">
                                    <div class="text-xs text-gray-500">Total Hadir</div>
                                    <div class="font-semibold text-green-600">${student.summary.hadir}</div>
                                </div>
                            </div>
                            
                            <div class="mt-3 flex flex-wrap gap-1 text-xs">
                                <span class="bg-green-100 text-green-800 px-2 py-1 rounded">‚úì Hadir: ${student.summary.hadir}</span>
                                <span class="bg-yellow-100 text-yellow-800 px-2 py-1 rounded">ü§í Sakit: ${student.summary.sakit}</span>
                                <span class="bg-blue-100 text-blue-800 px-2 py-1 rounded">üìù Ijin: ${student.summary.ijin}</span>
                                <span class="bg-red-100 text-red-800 px-2 py-1 rounded">‚ùå Alpha: ${student.finalAlpha}</span>
                                <span class="bg-purple-100 text-purple-800 px-2 py-1 rounded">üö´ Bolos: ${Math.ceil(student.remainingBolosJP / 9)}</span>
                            </div>
                        </div>
                    `;
                }).join('');
                
                container.innerHTML = `
                    <div class="mb-6">
                        <div class="bg-red-50 border border-red-200 rounded-lg p-4 mb-4">
                            <h5 class="font-semibold text-red-800 mb-2">üìä Kriteria Siswa Bermasalah:</h5>
                            <div class="text-sm text-red-700">
                                <div class="mb-1">‚Ä¢ <strong>Kehadiran kurang dari 75%</strong> dari total pembelajaran</div>
                                <div>‚Ä¢ <strong>Memiliki Alpha</strong> (termasuk hasil konversi dari 9 JP Bolos = 1 Alpha)</div>
                            </div>
                        </div>
                        
                        <h4 class="text-lg font-semibold text-gray-900 mb-4">
                            Daftar Siswa Bermasalah (${siswaBermasalah.length} siswa)
                        </h4>
                        
                        <div class="space-y-4">
                            ${studentsHtml}
                        </div>
                    </div>
                `;
                
            } catch (error) {
                console.error('Error loading siswa bermasalah:', error);
                container.innerHTML = '<div class="text-center py-12"><div class="text-6xl mb-4">‚ùå</div><p class="text-red-500 text-lg">Gagal memuat data siswa bermasalah</p><p class="text-gray-400 text-sm">Silakan coba lagi nanti</p></div>';
            }
        }
        
        function updateRingkasanKehadiran(absensiData, targetClasses) {
            const container = document.getElementById('ringkasanKehadiran');
            
            if (!container) {
                console.warn('ringkasanKehadiran element not found');
                return;
            }
            
            if (absensiData.length === 0) {
                container.innerHTML = '<p class="text-gray-500 text-center py-4">Belum ada data kehadiran</p>';
                return;
            }
            
            // Group by class
            const classSummary = {};
            
            targetClasses.forEach(kelas => {
                classSummary[kelas] = {
                    hadir: 0,
                    sakit: 0,
                    ijin: 0,
                    alpha: 0,
                    bolos: 0,
                    total: 0
                };
            });
            
            absensiData.forEach(item => {
                const kelas = item.kelas || item.Kelas || '';
                const status = (item.keterangan || item.Keterangan || '').toLowerCase();
                
                if (classSummary[kelas]) {
                    classSummary[kelas].total++;
                    if (status === 'hadir') classSummary[kelas].hadir++;
                    else if (status === 'sakit') classSummary[kelas].sakit++;
                    else if (status === 'ijin') classSummary[kelas].ijin++;
                    else if (status === 'alpha') classSummary[kelas].alpha++;
                    else if (status === 'bolos') classSummary[kelas].bolos++;
                }
            });
            
            const summaryHtml = Object.entries(classSummary)
                .filter(([kelas, data]) => data.total > 0)
                .map(([kelas, data]) => {
                    const persentase = Math.round((data.hadir / data.total) * 100);
                    return `
                        <div class="border border-gray-200 rounded-lg p-4">
                            <div class="flex items-center justify-between mb-3">
                                <h4 class="font-semibold text-gray-900">Kelas ${kelas}</h4>
                                <span class="text-sm font-medium ${persentase >= 80 ? 'text-green-600' : persentase >= 60 ? 'text-yellow-600' : 'text-red-600'}">
                                    ${persentase}% Hadir
                                </span>
                            </div>
                            <div class="flex flex-wrap gap-2 text-xs">
                                <span class="bg-green-100 text-green-800 px-2 py-1 rounded">‚úì ${data.hadir}</span>
                                <span class="bg-yellow-100 text-yellow-800 px-2 py-1 rounded">ü§í ${data.sakit}</span>
                                <span class="bg-blue-100 text-blue-800 px-2 py-1 rounded">üìù ${data.ijin}</span>
                                <span class="bg-red-100 text-red-800 px-2 py-1 rounded">‚ùå ${data.alpha}</span>
                                <span class="bg-purple-100 text-purple-800 px-2 py-1 rounded">üö´ ${data.bolos}</span>
                            </div>
                        </div>
                    `;
                }).join('');
            
            container.innerHTML = summaryHtml || '<p class="text-gray-500 text-center py-4">Belum ada data kehadiran</p>';
        }
        
        async function loadRekapKehadiran() {
            const container = document.getElementById('rekapKehadiranContent');
            container.innerHTML = '<div class="text-center py-4"><div class="loading mx-auto"></div><p class="mt-2 text-gray-500">Memuat rekap kehadiran...</p></div>';
            
            try {
                const waliKelas = currentUser['Wali Kelas'] || '';
                const isOperator = waliKelas.toLowerCase() === 'operator';
                
                // Get filter values
                const filterKelasWali = document.getElementById('filterKelasWali')?.value || '';
                const filterPeriodeWali = document.getElementById('filterPeriodeWali')?.value || 'week';
                const dateFromWali = document.getElementById('dateFromWali')?.value || '';
                const dateToWali = document.getElementById('dateToWali')?.value || '';
                
                // Determine which classes to show
                let targetClasses = [];
                if (isOperator) {
                    if (filterKelasWali) {
                        targetClasses = [filterKelasWali];
                    } else {
                        const kelasSet = new Set();
                        classData.forEach(row => {
                            if (row.Kelas) kelasSet.add(row.Kelas);
                        });
                        targetClasses = Array.from(kelasSet);
                    }
                } else {
                    targetClasses = [waliKelas];
                }
                
                // Get date range
                let dateRange = getWaliDateRange(filterPeriodeWali, dateFromWali, dateToWali);
                
                // Load data
                let absensiData = getLocalStorageData('absensi');
                
                try {
                    const spreadsheetData = await loadDashboardDataFromSpreadsheet();
                    if (spreadsheetData.absensiData) {
                        absensiData = [...absensiData, ...spreadsheetData.absensiData];
                    }
                } catch (error) {
                    console.warn('Using localStorage data only for rekap kehadiran:', error);
                }
                
                // Filter data by target classes and date range
                const filteredAbsensi = absensiData.filter(item => {
                    const itemKelas = item.kelas || item.Kelas || '';
                    if (!targetClasses.includes(itemKelas)) return false;
                    
                    if (dateRange.length > 0) {
                        const timestamp = item.timestamp || item.Timestamp || item['Tanggal'] || item.tanggal;
                        if (!timestamp) return false;
                        
                        const parsedTime = parseTimestamp(timestamp);
                        if (!parsedTime || !dateRange.includes(parsedTime.dateString)) return false;
                    }
                    
                    return true;
                });
                
                if (filteredAbsensi.length === 0) {
                    container.innerHTML = '<div class="text-center py-12"><div class="text-6xl mb-4">üìÖ</div><p class="text-gray-500 text-lg">Belum ada data kehadiran</p><p class="text-gray-400 text-sm">Data kehadiran akan muncul di sini</p></div>';
                    return;
                }
                
                // Get all students in target classes
                const allStudents = classData.filter(row => targetClasses.includes(row.Kelas));
                
                // Get all unique dates from filtered data
                const allDates = new Set();
                filteredAbsensi.forEach(item => {
                    const timestamp = item.timestamp || item.Timestamp || item['Tanggal'] || item.tanggal;
                    const parsedTime = parseTimestamp(timestamp);
                    if (parsedTime) {
                        allDates.add(parsedTime.dateString);
                    }
                });
                
                // Sort dates chronologically (oldest first for table display)
                const sortedDates = Array.from(allDates).sort((a, b) => {
                    try {
                        const parseDate = (dateStr) => {
                            const parts = dateStr.split('/');
                            if (parts.length === 3) {
                                return new Date(parts[2], parts[1] - 1, parts[0]); // DD/MM/YYYY
                            }
                            return new Date(dateStr);
                        };
                        
                        const dateA = parseDate(a);
                        const dateB = parseDate(b);
                        return dateA - dateB;
                    } catch (e) {
                        return a.localeCompare(b);
                    }
                });
                
                // Build student attendance data
                const studentAttendance = {};
                
                // Initialize all students
                allStudents.forEach(student => {
                    const nama = student['Nama Siswa'];
                    const kelas = student.Kelas;
                    studentAttendance[nama] = {
                        kelas: kelas,
                        dailyAttendance: {},
                        summary: {
                            hadir: 0,
                            sakit: 0,
                            ijin: 0,
                            alpha: 0,
                            bolos: 0,
                            totalJP: 0,
                            bolosJP: 0
                        }
                    };
                    
                    // Initialize daily attendance
                    sortedDates.forEach(date => {
                        studentAttendance[nama].dailyAttendance[date] = {
                            sessions: [],
                            dailyStatus: '-',
                            totalJP: 0,
                            hadirJP: 0
                        };
                    });
                });
                
                // Process attendance data
                filteredAbsensi.forEach(item => {
                    const nama = item.namaSiswa || item['Nama Siswa'] || '';
                    const status = (item.keterangan || item.Keterangan || '').toLowerCase();
                    const jamPelajaran = parseInt(item.jamPelajaran || item['Jam Pelajaran'] || '1');
                    const timestamp = item.timestamp || item.Timestamp || item['Tanggal'] || item.tanggal;
                    const parsedTime = parseTimestamp(timestamp);
                    
                    if (studentAttendance[nama] && parsedTime) {
                        const dateKey = parsedTime.dateString;
                        
                        // Add to daily sessions
                        if (studentAttendance[nama].dailyAttendance[dateKey]) {
                            studentAttendance[nama].dailyAttendance[dateKey].sessions.push({
                                status: status,
                                jamPelajaran: jamPelajaran
                            });
                            studentAttendance[nama].dailyAttendance[dateKey].totalJP += jamPelajaran;
                            
                            if (status === 'hadir') {
                                studentAttendance[nama].dailyAttendance[dateKey].hadirJP += jamPelajaran;
                            }
                        }
                        
                        // Add to summary
                        studentAttendance[nama].summary.totalJP += jamPelajaran;
                        
                        if (status === 'hadir') studentAttendance[nama].summary.hadir++;
                        else if (status === 'sakit') studentAttendance[nama].summary.sakit++;
                        else if (status === 'ijin') studentAttendance[nama].summary.ijin++;
                        else if (status === 'alpha') studentAttendance[nama].summary.alpha++;
                        else if (status === 'bolos') {
                            studentAttendance[nama].summary.bolos++;
                            studentAttendance[nama].summary.bolosJP += jamPelajaran;
                        }
                    }
                });
                
                // Calculate daily status for each student (based on >55% attendance rule)
                Object.values(studentAttendance).forEach(student => {
                    sortedDates.forEach(date => {
                        const dayData = student.dailyAttendance[date];
                        if (dayData.sessions.length > 0) {
                            const attendanceRate = dayData.totalJP > 0 ? (dayData.hadirJP / dayData.totalJP) * 100 : 0;
                            
                            if (attendanceRate > 55) {
                                dayData.dailyStatus = 'H'; // Hadir
                            } else {
                                // Find majority status among non-hadir
                                const statusCount = { sakit: 0, ijin: 0, alpha: 0, bolos: 0 };
                                dayData.sessions.forEach(session => {
                                    if (session.status !== 'hadir') {
                                        statusCount[session.status] = (statusCount[session.status] || 0) + 1;
                                    }
                                });
                                
                                // Find majority status
                                let majorityStatus = 'alpha';
                                let maxCount = 0;
                                Object.entries(statusCount).forEach(([status, count]) => {
                                    if (count > maxCount) {
                                        maxCount = count;
                                        majorityStatus = status;
                                    }
                                });
                                
                                // Map to single letter
                                const statusMap = { sakit: 'S', ijin: 'I', alpha: 'A', bolos: 'B' };
                                dayData.dailyStatus = statusMap[majorityStatus] || 'A';
                            }
                        }
                    });
                });
                
                // Sort students by class first, then by name
                const sortedStudents = Object.keys(studentAttendance).sort((a, b) => {
                    const kelasA = studentAttendance[a].kelas;
                    const kelasB = studentAttendance[b].kelas;
                    
                    // First sort by class
                    if (kelasA !== kelasB) {
                        return kelasA.localeCompare(kelasB);
                    }
                    
                    // Then sort by name within the same class
                    return a.localeCompare(b);
                });
                
                // Generate table HTML
                const tableHtml = `
                    <div class="overflow-x-auto">
                        <table class="min-w-full bg-white border border-gray-300">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider border-r border-gray-300 sticky left-0 bg-gray-50 z-10">
                                        Nama Siswa
                                    </th>
                                    <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider border-r border-gray-300 sticky left-0 bg-gray-50 z-10" style="left: 200px;">
                                        Kelas
                                    </th>
                                    ${sortedDates.map(date => `
                                        <th onclick="showDetailKehadiranHarian('${date}')" 
                                            class="px-2 py-2 text-center text-xs font-medium text-gray-500 uppercase tracking-wider border-r border-gray-300 cursor-pointer hover:bg-blue-50 transition-colors min-w-[60px]">
                                            ${date.split('/').slice(0, 2).join('/')}
                                        </th>
                                    `).join('')}
                                    <th class="px-3 py-2 text-center text-xs font-medium text-gray-500 uppercase tracking-wider border-r border-gray-300 bg-green-50">H</th>
                                    <th class="px-3 py-2 text-center text-xs font-medium text-gray-500 uppercase tracking-wider border-r border-gray-300 bg-yellow-50">S</th>
                                    <th class="px-3 py-2 text-center text-xs font-medium text-gray-500 uppercase tracking-wider border-r border-gray-300 bg-blue-50">I</th>
                                    <th class="px-3 py-2 text-center text-xs font-medium text-gray-500 uppercase tracking-wider border-r border-gray-300 bg-red-50">A</th>
                                    <th class="px-3 py-2 text-center text-xs font-medium text-gray-500 uppercase tracking-wider border-r border-gray-300 bg-purple-50">B</th>
                                    <th class="px-3 py-2 text-center text-xs font-medium text-gray-500 uppercase tracking-wider bg-gray-100">%</th>
                                </tr>
                            </thead>
                            <tbody class="bg-white divide-y divide-gray-200">
                                ${sortedStudents.map(nama => {
                                    const student = studentAttendance[nama];
                                    
                                    // Apply bolos conversion: 9 JP bolos = 1 alpha
                                    const convertedAlpha = Math.floor(student.summary.bolosJP / 9);
                                    const remainingBolosJP = student.summary.bolosJP % 9;
                                    const finalAlpha = student.summary.alpha + convertedAlpha;
                                    const finalBolos = Math.ceil(remainingBolosJP / 9); // Convert remaining JP to sessions
                                    
                                    const totalSessions = student.summary.hadir + student.summary.sakit + student.summary.ijin + finalAlpha + finalBolos;
                                    const attendanceRate = totalSessions > 0 ? ((student.summary.hadir / totalSessions) * 100).toFixed(1) : '0.0';
                                    
                                    // Determine row color based on attendance
                                    let rowClass = '';
                                    if (parseFloat(attendanceRate) < 75 || finalAlpha > 0) {
                                        rowClass = 'bg-red-50'; // Bermasalah
                                    } else if (parseFloat(attendanceRate) < 85 || remainingBolosJP > 4) {
                                        rowClass = 'bg-yellow-50'; // Perhatian
                                    }
                                    
                                    return `
                                        <tr class="${rowClass} hover:bg-gray-50">
                                            <td class="px-3 py-2 text-sm font-medium text-gray-900 border-r border-gray-300 sticky left-0 bg-white z-10 ${rowClass}">
                                                ${nama}
                                            </td>
                                            <td class="px-3 py-2 text-sm text-gray-500 border-r border-gray-300 sticky left-0 bg-white z-10 ${rowClass}" style="left: 200px;">
                                                ${student.kelas}
                                            </td>
                                            ${sortedDates.map(date => {
                                                const dayData = student.dailyAttendance[date];
                                                const status = dayData.dailyStatus;
                                                
                                                let cellClass = 'text-gray-400';
                                                let cellBg = '';
                                                
                                                if (status === 'H') {
                                                    cellClass = 'text-green-700 font-bold';
                                                    cellBg = 'bg-green-100';
                                                } else if (status === 'S') {
                                                    cellClass = 'text-yellow-700 font-bold';
                                                    cellBg = 'bg-yellow-100';
                                                } else if (status === 'I') {
                                                    cellClass = 'text-blue-700 font-bold';
                                                    cellBg = 'bg-blue-100';
                                                } else if (status === 'A') {
                                                    cellClass = 'text-red-700 font-bold';
                                                    cellBg = 'bg-red-100';
                                                } else if (status === 'B') {
                                                    cellClass = 'text-purple-700 font-bold';
                                                    cellBg = 'bg-purple-100';
                                                }
                                                
                                                return `
                                                    <td class="px-2 py-2 text-center text-sm border-r border-gray-300 ${cellClass} ${cellBg}">
                                                        ${status}
                                                    </td>
                                                `;
                                            }).join('')}
                                            <td class="px-3 py-2 text-center text-sm font-medium text-green-700 border-r border-gray-300 bg-green-50">
                                                ${student.summary.hadir}
                                            </td>
                                            <td class="px-3 py-2 text-center text-sm font-medium text-yellow-700 border-r border-gray-300 bg-yellow-50">
                                                ${student.summary.sakit}
                                            </td>
                                            <td class="px-3 py-2 text-center text-sm font-medium text-blue-700 border-r border-gray-300 bg-blue-50">
                                                ${student.summary.ijin}
                                            </td>
                                            <td class="px-3 py-2 text-center text-sm font-medium text-red-700 border-r border-gray-300 bg-red-50">
                                                ${finalAlpha}
                                            </td>
                                            <td class="px-3 py-2 text-center text-sm font-medium text-purple-700 border-r border-gray-300 bg-purple-50">
                                                ${finalBolos}
                                            </td>
                                            <td class="px-3 py-2 text-center text-sm font-bold border-gray-300 ${parseFloat(attendanceRate) >= 85 ? 'text-green-700 bg-green-100' : parseFloat(attendanceRate) >= 75 ? 'text-yellow-700 bg-yellow-100' : 'text-red-700 bg-red-100'}">
                                                ${attendanceRate}%
                                            </td>
                                        </tr>
                                    `;
                                }).join('')}
                            </tbody>
                        </table>
                    </div>
                `;
                
                container.innerHTML = `
                    <div class="mb-6">
                        <h4 class="text-lg font-semibold text-gray-900 mb-4">Rekap Kehadiran Siswa</h4>
                        
                        <!-- Legend -->
                        <div class="bg-gray-50 border border-gray-200 rounded-lg p-4 mb-4">
                            <h5 class="font-semibold text-gray-700 mb-2">Keterangan:</h5>
                            <div class="grid grid-cols-2 md:grid-cols-3 gap-2 text-xs">
                                <div class="flex items-center">
                                    <span class="w-6 h-6 bg-green-100 text-green-700 font-bold rounded text-center mr-2">H</span>
                                    <span>Hadir (>55% JP hari itu)</span>
                                </div>
                                <div class="flex items-center">
                                    <span class="w-6 h-6 bg-yellow-100 text-yellow-700 font-bold rounded text-center mr-2">S</span>
                                    <span>Sakit (mayoritas status)</span>
                                </div>
                                <div class="flex items-center">
                                    <span class="w-6 h-6 bg-blue-100 text-blue-700 font-bold rounded text-center mr-2">I</span>
                                    <span>Ijin (mayoritas status)</span>
                                </div>
                                <div class="flex items-center">
                                    <span class="w-6 h-6 bg-red-100 text-red-700 font-bold rounded text-center mr-2">A</span>
                                    <span>Alpha (mayoritas status)</span>
                                </div>
                                <div class="flex items-center">
                                    <span class="w-6 h-6 bg-purple-100 text-purple-700 font-bold rounded text-center mr-2">B</span>
                                    <span>Bolos (mayoritas status)</span>
                                </div>
                                <div class="flex items-center">
                                    <span class="w-6 h-6 bg-gray-100 text-gray-400 font-bold rounded text-center mr-2">-</span>
                                    <span>Tidak ada data</span>
                                </div>
                            </div>
                            <div class="mt-2 text-xs text-blue-700 bg-blue-100 p-2 rounded">
                                <strong>üìù Konversi:</strong> 9 JP Bolos = 1 Alpha | Klik header tanggal untuk detail pembelajaran hari itu
                            </div>
                        </div>
                        
                        ${tableHtml}
                    </div>
                `;
                
            } catch (error) {
                console.error('Error loading rekap kehadiran:', error);
                container.innerHTML = '<div class="text-center py-12"><div class="text-6xl mb-4">‚ùå</div><p class="text-red-500 text-lg">Gagal memuat rekap kehadiran</p><p class="text-gray-400 text-sm">Silakan coba lagi nanti</p></div>';
            }
        }
        
        async function showDetailKehadiranHarian(date) {
            const container = document.getElementById('rekapKehadiranContent');
            container.innerHTML = '<div class="text-center py-4"><div class="loading mx-auto"></div><p class="mt-2 text-gray-500">Memuat detail kehadiran...</p></div>';
            
            try {
                const waliKelas = currentUser['Wali Kelas'] || '';
                const isOperator = waliKelas.toLowerCase() === 'operator';
                
                // Get filter values
                const filterKelasWali = document.getElementById('filterKelasWali')?.value || '';
                
                // Determine which classes to show
                let targetClasses = [];
                if (isOperator) {
                    if (filterKelasWali) {
                        targetClasses = [filterKelasWali];
                    } else {
                        const kelasSet = new Set();
                        classData.forEach(row => {
                            if (row.Kelas) kelasSet.add(row.Kelas);
                        });
                        targetClasses = Array.from(kelasSet);
                    }
                } else {
                    targetClasses = [waliKelas];
                }
                
                // Load jurnal and absensi data
                let jurnalData = getLocalStorageData('jurnal');
                let absensiData = getLocalStorageData('absensi');
                
                try {
                    const spreadsheetData = await loadDashboardDataFromSpreadsheet();
                    if (spreadsheetData.jurnalData) {
                        jurnalData = [...jurnalData, ...spreadsheetData.jurnalData];
                    }
                    if (spreadsheetData.absensiData) {
                        absensiData = [...absensiData, ...spreadsheetData.absensiData];
                    }
                } catch (error) {
                    console.warn('Using localStorage data only for detail kehadiran:', error);
                }
                
                // Filter jurnal data for specific date and classes
                const dayJurnalData = jurnalData.filter(item => {
                    const itemKelas = item.kelas || item.Kelas || '';
                    if (!targetClasses.includes(itemKelas)) return false;
                    
                    const timestamp = item.timestamp || item.Timestamp || item['Tanggal'] || item.tanggal;
                    const parsedTime = parseTimestamp(timestamp);
                    
                    return parsedTime && parsedTime.dateString === date;
                });
                
                // Filter absensi data for specific date and classes
                const dayAbsensiData = absensiData.filter(item => {
                    const itemKelas = item.kelas || item.Kelas || '';
                    if (!targetClasses.includes(itemKelas)) return false;
                    
                    const timestamp = item.timestamp || item.Timestamp || item['Tanggal'] || item.tanggal;
                    const parsedTime = parseTimestamp(timestamp);
                    
                    return parsedTime && parsedTime.dateString === date;
                });
                
                if (dayJurnalData.length === 0 && dayAbsensiData.length === 0) {
                    container.innerHTML = `
                        <div class="mb-4">
                            <button onclick="loadRekapKehadiran()" class="bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded-lg text-sm transition duration-200">
                                ‚Üê Kembali ke Rekap Harian
                            </button>
                        </div>
                        <div class="text-center py-12">
                            <div class="text-6xl mb-4">üìÖ</div>
                            <p class="text-gray-500 text-lg">Tidak ada data pembelajaran untuk ${date}</p>
                        </div>
                    `;
                    return;
                }
                
                // Combine jurnal and absensi data by matching kelas, guru, and jam pelajaran
                const combinedActivities = {};
                
                // Process jurnal data first
                dayJurnalData.forEach(item => {
                    const kelas = item.kelas || item.Kelas || '';
                    const namaGuru = item.namaGuru || item['Nama Guru'] || '';
                    const mataPelajaran = item.mataPelajaran || item['Mata Pelajaran'] || '';
                    const jamPelajaran = item.jamPelajaran || item['Jam Pelajaran'] || '';
                    const materi = item.materi || item.Materi || '';
                    const catatan = item.catatan || item.Catatan || '';
                    
                    const activityKey = `${kelas}_${namaGuru}_${jamPelajaran}`;
                    if (!combinedActivities[activityKey]) {
                        combinedActivities[activityKey] = {
                            kelas: kelas,
                            namaGuru: namaGuru,
                            mataPelajaran: mataPelajaran,
                            jamPelajaran: jamPelajaran,
                            jurnal: null,
                            absensi: null
                        };
                    }
                    combinedActivities[activityKey].jurnal = {
                        materi: materi,
                        catatan: catatan
                    };
                });
                
                // Group absensi data by session
                const absensiSessions = {};
                dayAbsensiData.forEach(item => {
                    const kelas = item.kelas || item.Kelas || '';
                    const namaGuru = item['Nama Guru'] || item.namaGuru || '';
                    const jamPelajaran = item.jamPelajaran || item['Jam Pelajaran'] || '';
                    
                    const sessionKey = `${kelas}_${namaGuru}_${jamPelajaran}`;
                    if (!absensiSessions[sessionKey]) {
                        absensiSessions[sessionKey] = [];
                    }
                    absensiSessions[sessionKey].push(item);
                });
                
                // Match absensi with jurnal activities
                Object.entries(absensiSessions).forEach(([sessionKey, students]) => {
                    if (combinedActivities[sessionKey]) {
                        // Count attendance status
                        const statusCount = {
                            hadir: 0,
                            sakit: 0,
                            ijin: 0,
                            alpha: 0,
                            bolos: 0
                        };
                        
                        students.forEach(siswa => {
                            const status = (siswa.keterangan || siswa.Keterangan || '').toLowerCase();
                            if (status === 'hadir') statusCount.hadir++;
                            else if (status === 'sakit') statusCount.sakit++;
                            else if (status === 'ijin') statusCount.ijin++;
                            else if (status === 'alpha') statusCount.alpha++;
                            else if (status === 'bolos') {     // Misal kolom jam pelajaran pada data absensi disebut 'jamPelajaran' atau 'Jam Pelajaran'     
                                const jp = Number(siswa.jamPelajaran || siswa['Jam Pelajaran'] || 1);     
                                statusCount.bolos += jp;
                        });
                        
                        combinedActivities[sessionKey].absensi = {
                            total: students.length,
                            statusCount: statusCount,
                            students: students
                        };
                    }
                });
                
                // Only include activities that have jurnal (pembelajaran yang benar-benar terjadi)
                const activities = Object.values(combinedActivities).filter(activity => {
                    return activity.jurnal && activity.jurnal.materi && activity.jurnal.materi.trim() !== '';
                });
                
                // Sort by kelas and mata pelajaran
                activities.sort((a, b) => {
                    if (a.kelas !== b.kelas) {
                        return a.kelas.localeCompare(b.kelas);
                    }
                    return a.mataPelajaran.localeCompare(b.mataPelajaran);
                });
                
                if (activities.length === 0) {
                    container.innerHTML = `
                        <div class="mb-4">
                            <button onclick="loadRekapKehadiran()" class="bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded-lg text-sm transition duration-200">
                                ‚Üê Kembali ke Rekap Harian
                            </button>
                        </div>
                        <div class="text-center py-12">
                            <div class="text-6xl mb-4">üìö</div>
                            <p class="text-gray-500 text-lg">Tidak ada pembelajaran dengan materi untuk ${date}</p>
                        </div>
                    `;
                    return;
                }
                
                const activitiesHtml = activities.map(activity => {
                    let content = `
                        <div onclick="showDetailPresensiMapel('${activity.kelas}', '${activity.namaGuru}', '${activity.jamPelajaran}', '${date}')" 
                             class="border border-gray-200 rounded-lg p-4 mb-4 cursor-pointer hover:bg-gray-50 transition-colors bg-white shadow-sm">
                            <div class="flex items-start justify-between mb-3">
                                <div class="flex items-center">
                                    <span class="text-2xl mr-3">üìö</span>
                                    <div>
                                        <h4 class="font-semibold text-gray-900">${activity.kelas} - ${activity.mataPelajaran}</h4>
                                        <p class="text-sm text-gray-600">Guru: ${activity.namaGuru} ‚Ä¢ ${activity.jamPelajaran} JP</p>
                                    </div>
                                </div>
                                <div class="text-gray-400">
                                    <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                                        <path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd"></path>
                                    </svg>
                                </div>
                            </div>
                    `;
                    
                    if (activity.jurnal) {
                        content += `
                            <div class="mb-3">
                                <div class="flex items-center text-xs text-blue-600 mb-1">
                                    <span class="mr-1">üìñ</span>
                                    <span class="font-medium">Materi Pembelajaran</span>
                                </div>
                                <p class="text-sm text-gray-700 ml-4 bg-blue-50 p-2 rounded border-l-2 border-blue-200">${activity.jurnal.materi}</p>
                                ${activity.jurnal.catatan ? `<p class="text-xs text-gray-600 ml-4 mt-1 italic">Catatan: ${activity.jurnal.catatan}</p>` : ''}
                            </div>
                        `;
                    }
                    
                    if (activity.absensi) {
                        const status = activity.absensi.statusCount;
                        content += `
                            <div>
                                <div class="flex items-center text-xs text-green-600 mb-1">
                                    <span class="mr-1">üë•</span>
                                    <span class="font-medium">Kehadiran (${activity.absensi.total} siswa)</span>
                                </div>
                                <div class="flex flex-wrap gap-1 ml-4 text-xs">
                                    ${status.hadir > 0 ? `<span class="bg-green-100 text-green-800 px-2 py-1 rounded">‚úì ${status.hadir}</span>` : ''}
                                    ${status.sakit > 0 ? `<span class="bg-yellow-100 text-yellow-800 px-2 py-1 rounded">ü§í ${status.sakit}</span>` : ''}
                                    ${status.ijin > 0 ? `<span class="bg-blue-100 text-blue-800 px-2 py-1 rounded">üìù ${status.ijin}</span>` : ''}
                                    ${status.alpha > 0 ? `<span class="bg-red-100 text-red-800 px-2 py-1 rounded">‚ùå ${status.alpha}</span>` : ''}
                                    ${status.bolos > 0 ? `<span class="bg-purple-100 text-purple-800 px-2 py-1 rounded">üö´ ${status.bolos}</span>` : ''}
                                </div>
                            </div>
                        `;
                    } else {
                        content += `
                            <div class="ml-4">
                                <p class="text-xs text-gray-500 italic">Data kehadiran tidak tersedia</p>
                            </div>
                        `;
                    }
                    
                    content += `
                            <div class="mt-2 text-right">
                                <span class="text-xs text-gray-400">Klik untuk detail presensi ‚Üí</span>
                            </div>
                        </div>
                    `;
                    
                    return content;
                }).join('');
                
                container.innerHTML = `
                    <div class="mb-6">
                        <div class="flex items-center justify-between mb-4">
                            <h4 class="text-lg font-semibold text-gray-900">Pembelajaran & Kehadiran - ${date}</h4>
                            <button onclick="loadRekapKehadiran()" class="bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded-lg text-sm transition duration-200">
                                ‚Üê Kembali ke Rekap Harian
                            </button>
                        </div>
                        
                        <div class="space-y-3">
                            ${activitiesHtml}
                        </div>
                    </div>
                `;
                
            } catch (error) {
                console.error('Error loading detail kehadiran harian:', error);
                container.innerHTML = `
                    <div class="mb-4">
                        <button onclick="loadRekapKehadiran()" class="bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded-lg text-sm transition duration-200">
                            ‚Üê Kembali ke Rekap Harian
                        </button>
                    </div>
                    <div class="text-center py-12">
                        <div class="text-6xl mb-4">‚ùå</div>
                        <p class="text-red-500 text-lg">Gagal memuat detail kehadiran</p>
                        <p class="text-gray-400 text-sm">Silakan coba lagi nanti</p>
                    </div>
                `;
            }
        }

        async function loadRekapPembelajaran() {
            const container = document.getElementById('rekapPembelajaranContent');
            container.innerHTML = '<div class="text-center py-4"><div class="loading mx-auto"></div><p class="mt-2 text-gray-500">Memuat rekap pembelajaran...</p></div>';
            
            try {
                const waliKelas = currentUser['Wali Kelas'] || '';
                const isOperator = waliKelas.toLowerCase() === 'operator';
                
                // Get filter values
                const filterKelasWali = document.getElementById('filterKelasWali')?.value || '';
                const filterPeriodeWali = document.getElementById('filterPeriodeWali')?.value || 'week';
                const dateFromWali = document.getElementById('dateFromWali')?.value || '';
                const dateToWali = document.getElementById('dateToWali')?.value || '';
                
                // Determine which classes to show
                let targetClasses = [];
                if (isOperator) {
                    if (filterKelasWali) {
                        targetClasses = [filterKelasWali];
                    } else {
                        const kelasSet = new Set();
                        classData.forEach(row => {
                            if (row.Kelas) kelasSet.add(row.Kelas);
                        });
                        targetClasses = Array.from(kelasSet);
                    }
                } else {
                    targetClasses = [waliKelas];
                }
                
                // Get date range
                let dateRange = getWaliDateRange(filterPeriodeWali, dateFromWali, dateToWali);
                
                // Load data
                let jurnalData = getLocalStorageData('jurnal');
                
                try {
                    const spreadsheetData = await loadDashboardDataFromSpreadsheet();
                    if (spreadsheetData.jurnalData) {
                        jurnalData = [...jurnalData, ...spreadsheetData.jurnalData];
                    }
                } catch (error) {
                    console.warn('Using localStorage data only for rekap pembelajaran:', error);
                }
                
                // Filter data by target classes and date range
                const filteredJurnal = jurnalData.filter(item => {
                    const itemKelas = item.kelas || item.Kelas || '';
                    if (!targetClasses.includes(itemKelas)) return false;
                    
                    if (dateRange.length > 0) {
                        const timestamp = item.timestamp || item.Timestamp || item['Tanggal'] || item.tanggal;
                        if (!timestamp) return false;
                        
                        const parsedTime = parseTimestamp(timestamp);
                        if (!parsedTime || !dateRange.includes(parsedTime.dateString)) return false;
                    }
                    
                    return true;
                });
                
                if (filteredJurnal.length === 0) {
                    container.innerHTML = '<div class="text-center py-12"><div class="text-6xl mb-4">üìö</div><p class="text-gray-500 text-lg">Belum ada data pembelajaran</p><p class="text-gray-400 text-sm">Data pembelajaran akan muncul di sini</p></div>';
                    return;
                }
                
                // Group by class and subject
                const classSubjects = {};
                filteredJurnal.forEach(item => {
                    const kelas = item.kelas || item.Kelas || '';
                    const mapel = item.mataPelajaran || item['Mata Pelajaran'] || '';
                    const guru = item.namaGuru || item['Nama Guru'] || '';
                    
                    const key = `${kelas}_${mapel}_${guru}`;
                    if (!classSubjects[key]) {
                        classSubjects[key] = {
                            kelas: kelas,
                            mapel: mapel,
                            guru: guru,
                            sessions: []
                        };
                    }
                    classSubjects[key].sessions.push(item);
                });
                
                // Sort by class then subject
                const sortedSubjects = Object.values(classSubjects).sort((a, b) => {
                    if (a.kelas !== b.kelas) {
                        return a.kelas.localeCompare(b.kelas);
                    }
                    return a.mapel.localeCompare(b.mapel);
                });
                
                const subjectsHtml = sortedSubjects.map(subject => {
                    // Sort sessions by date (newest first)
                    subject.sessions.sort((a, b) => {
                        const timestampA = a.timestamp || a.Timestamp || a['Tanggal'] || a.tanggal;
                        const timestampB = b.timestamp || b.Timestamp || b['Tanggal'] || b.tanggal;
                        try {
                            const dateA = new Date(timestampA);
                            const dateB = new Date(timestampB);
                            return dateB - dateA;
                        } catch (e) {
                            return 0;
                        }
                    });
                    
                    const totalJP = subject.sessions.reduce((sum, session) => {
                        const jp = parseInt(session.jamPelajaran || session['Jam Pelajaran'] || '1');
                        return sum + jp;
                    }, 0);
                    
                    const sessionsHtml = subject.sessions.map(session => {
                        const materi = session.materi || session.Materi || '';
                        const catatan = session.catatan || session.Catatan || '';
                        const jamPelajaran = session.jamPelajaran || session['Jam Pelajaran'] || '';
                        const timestamp = session.timestamp || session.Timestamp || session['Tanggal'] || session.tanggal;
                        
                        let displayTime = timestamp;
                        try {
                            const parsedTime = parseTimestamp(timestamp);
                            if (parsedTime && parsedTime.date && !isNaN(parsedTime.date.getTime())) {
                                displayTime = parsedTime.date.toLocaleDateString('id-ID');
                            }
                        } catch (e) {
                            displayTime = timestamp.toString();
                        }
                        
                        return `
                            <div class="border-l-4 border-blue-200 pl-4 py-2">
                                <div class="flex justify-between items-start mb-1">
                                    <span class="text-sm font-medium text-gray-900">${displayTime}</span>
                                    <span class="text-xs bg-blue-100 text-blue-800 px-2 py-1 rounded">${jamPelajaran} JP</span>
                                </div>
                                <p class="text-sm text-gray-700 mb-1"><strong>Materi:</strong> ${materi}</p>
                                ${catatan ? `<p class="text-xs text-gray-600"><strong>Catatan:</strong> ${catatan}</p>` : ''}
                            </div>
                        `;
                    }).join('');
                    
                    return `
                        <div class="bg-white border border-gray-200 rounded-lg p-4 mb-4">
                            <div class="flex justify-between items-start mb-4">
                                <div>
                                    <h5 class="font-semibold text-gray-900">Kelas ${subject.kelas} - ${subject.mapel}</h5>
                                    <p class="text-sm text-gray-600">Guru: ${subject.guru}</p>
                                </div>
                                <div class="text-right">
                                    <span class="text-sm font-medium text-blue-600">${subject.sessions.length} Pertemuan</span>
                                    <p class="text-xs text-gray-500">${totalJP} Total JP</p>
                                </div>
                            </div>
                            <div class="space-y-3">
                                ${sessionsHtml}
                            </div>
                        </div>
                    `;
                }).join('');
                
                container.innerHTML = `
                    <div class="mb-6">
                        <h4 class="text-lg font-semibold text-gray-900 mb-4">Rekap Pembelajaran per Mata Pelajaran</h4>
                        ${subjectsHtml}
                    </div>
                `;
                
            } catch (error) {
                console.error('Error loading rekap pembelajaran:', error);
                container.innerHTML = '<div class="text-center py-12"><div class="text-6xl mb-4">‚ùå</div><p class="text-red-500 text-lg">Gagal memuat rekap pembelajaran</p><p class="text-gray-400 text-sm">Silakan coba lagi nanti</p></div>';
            }
        }
        
        async function exportKehadiranToExcel() {
            console.log('üöÄ Starting kehadiran export process...');
            
            try {
                const waliKelas = currentUser['Wali Kelas'] || '';
                const isOperator = waliKelas.toLowerCase() === 'operator';
                
                // Get export period
                const exportPeriode = document.getElementById('exportPeriodeKehadiran').value;
                
                // Get filter values
                const filterKelasWali = document.getElementById('filterKelasWali')?.value || '';
                
                // Determine which classes to show
                let targetClasses = [];
                if (isOperator) {
                    if (filterKelasWali) {
                        targetClasses = [filterKelasWali];
                    } else {
                        const kelasSet = new Set();
                        classData.forEach(row => {
                            if (row.Kelas) kelasSet.add(row.Kelas);
                        });
                        targetClasses = Array.from(kelasSet);
                    }
                } else {
                    targetClasses = [waliKelas];
                }
                
                // Get date range based on export period
                let dateRange = getWaliDateRange(exportPeriode, '', '');
                
                console.log('üìÖ Export settings - Periode:', exportPeriode, 'Classes:', targetClasses.length);
                
                // Load data
                console.log('üìä Loading kehadiran data...');
                let absensiData = getLocalStorageData('absensi');
                console.log('üíæ LocalStorage data count:', absensiData.length);
                
                try {
                    const spreadsheetData = await loadDashboardDataFromSpreadsheet();
                    if (spreadsheetData.absensiData) {
                        absensiData = [...absensiData, ...spreadsheetData.absensiData];
                        console.log('‚òÅÔ∏è Combined with Google Sheets data, total:', absensiData.length);
                    }
                } catch (error) {
                    console.warn('‚ö†Ô∏è Using localStorage data only for export:', error.message);
                }
                
                // Filter data by target classes and date range
                const filteredAbsensi = absensiData.filter(item => {
                    const itemKelas = item.kelas || item.Kelas || '';
                    if (!targetClasses.includes(itemKelas)) return false;
                    
                    if (dateRange.length > 0) {
                        const timestamp = item.timestamp || item.Timestamp || item['Tanggal'] || item.tanggal;
                        if (!timestamp) return false;
                        
                        const parsedTime = parseTimestamp(timestamp);
                        if (!parsedTime || !dateRange.includes(parsedTime.dateString)) return false;
                    }
                    
                    return true;
                });
                
                console.log('üîç Filtered data after applying all filters:', filteredAbsensi.length);
                
                if (filteredAbsensi.length === 0) {
                    showNotification('Tidak ada data kehadiran untuk diekspor', 'error');
                    return;
                }
                
                // Get all students in target classes
                const allStudents = classData.filter(row => targetClasses.includes(row.Kelas));
                
                // Get all unique dates from filtered data
                const allDates = new Set();
                filteredAbsensi.forEach(item => {
                    const timestamp = item.timestamp || item.Timestamp || item['Tanggal'] || item.tanggal;
                    const parsedTime = parseTimestamp(timestamp);
                    if (parsedTime) {
                        allDates.add(parsedTime.dateString);
                    }
                });
                
                // Sort dates chronologically
                const sortedDates = Array.from(allDates).sort((a, b) => {
                    try {
                        const parseDate = (dateStr) => {
                            const parts = dateStr.split('/');
                            if (parts.length === 3) {
                                return new Date(parts[2], parts[1] - 1, parts[0]); // DD/MM/YYYY
                            }
                            return new Date(dateStr);
                        };
                        
                        const dateA = parseDate(a);
                        const dateB = parseDate(b);
                        return dateA - dateB;
                    } catch (e) {
                        return a.localeCompare(b);
                    }
                });
                
                console.log('üìÖ Found dates:', sortedDates.length, sortedDates);
                console.log('üë• Found students:', allStudents.length);
                
                // Build student attendance data
                const studentAttendance = {};
                
                // Initialize all students
                allStudents.forEach(student => {
                    const nama = student['Nama Siswa'];
                    const kelas = student.Kelas;
                    studentAttendance[nama] = {
                        kelas: kelas,
                        dailyAttendance: {},
                        summary: {
                            hadir: 0,
                            sakit: 0,
                            ijin: 0,
                            alpha: 0,
                            bolos: 0,
                            totalJP: 0,
                            bolosJP: 0
                        }
                    };
                    
                    // Initialize daily attendance
                    sortedDates.forEach(date => {
                        studentAttendance[nama].dailyAttendance[date] = {
                            sessions: [],
                            dailyStatus: '-',
                            totalJP: 0,
                            hadirJP: 0
                        };
                    });
                });
                
                // Process attendance data
                filteredAbsensi.forEach(item => {
                    const nama = item.namaSiswa || item['Nama Siswa'] || '';
                    const status = (item.keterangan || item.Keterangan || '').toLowerCase();
                    const jamPelajaran = parseInt(item.jamPelajaran || item['Jam Pelajaran'] || '1');
                    const timestamp = item.timestamp || item.Timestamp || item['Tanggal'] || item.tanggal;
                    const parsedTime = parseTimestamp(timestamp);
                    
                    if (studentAttendance[nama] && parsedTime) {
                        const dateKey = parsedTime.dateString;
                        
                        // Add to daily sessions
                        if (studentAttendance[nama].dailyAttendance[dateKey]) {
                            studentAttendance[nama].dailyAttendance[dateKey].sessions.push({
                                status: status,
                                jamPelajaran: jamPelajaran
                            });
                            studentAttendance[nama].dailyAttendance[dateKey].totalJP += jamPelajaran;
                            
                            if (status === 'hadir') {
                                studentAttendance[nama].dailyAttendance[dateKey].hadirJP += jamPelajaran;
                            }
                        }
                        
                        // Add to summary
                        studentAttendance[nama].summary.totalJP += jamPelajaran;
                        
                        if (status === 'hadir') studentAttendance[nama].summary.hadir++;
                        else if (status === 'sakit') studentAttendance[nama].summary.sakit++;
                        else if (status === 'ijin') studentAttendance[nama].summary.ijin++;
                        else if (status === 'alpha') studentAttendance[nama].summary.alpha++;
                        else if (status === 'bolos') {
                            studentAttendance[nama].summary.bolos++;
                            studentAttendance[nama].summary.bolosJP += jamPelajaran;
                        }
                    }
                });
                
                // Calculate daily status for each student (based on >55% attendance rule)
                Object.values(studentAttendance).forEach(student => {
                    sortedDates.forEach(date => {
                        const dayData = student.dailyAttendance[date];
                        if (dayData.sessions.length > 0) {
                            const attendanceRate = dayData.totalJP > 0 ? (dayData.hadirJP / dayData.totalJP) * 100 : 0;
                            
                            if (attendanceRate > 55) {
                                dayData.dailyStatus = 'H'; // Hadir
                            } else {
                                // Find majority status among non-hadir
                                const statusCount = { sakit: 0, ijin: 0, alpha: 0, bolos: 0 };
                                dayData.sessions.forEach(session => {
                                    if (session.status !== 'hadir') {
                                        statusCount[session.status] = (statusCount[session.status] || 0) + 1;
                                    }
                                });
                                
                                // Find majority status
                                let majorityStatus = 'alpha';
                                let maxCount = 0;
                                Object.entries(statusCount).forEach(([status, count]) => {
                                    if (count > maxCount) {
                                        maxCount = count;
                                        majorityStatus = status;
                                    }
                                });
                                
                                // Map to single letter
                                const statusMap = { sakit: 'S', ijin: 'I', alpha: 'A', bolos: 'B' };
                                dayData.dailyStatus = statusMap[majorityStatus] || 'A';
                            }
                        }
                    });
                });
                
                // Sort students by class first, then by name
                const sortedStudents = Object.keys(studentAttendance).sort((a, b) => {
                    const kelasA = studentAttendance[a].kelas;
                    const kelasB = studentAttendance[b].kelas;
                    
                    // First sort by class
                    if (kelasA !== kelasB) {
                        return kelasA.localeCompare(kelasB);
                    }
                    
                    // Then sort by name within the same class
                    return a.localeCompare(b);
                });
                
                // Create Excel data structure with proper column order
                const excelData = [];
                
                sortedStudents.forEach(namaSiswa => {
                    const student = studentAttendance[namaSiswa];
                    
                    // Apply bolos conversion: 9 JP bolos = 1 alpha
                    const convertedAlpha = Math.floor(student.summary.bolosJP / 9);
                    const remainingBolosJP = student.summary.bolosJP % 9;
                    const finalAlpha = student.summary.alpha + convertedAlpha;
                    const finalBolos = Math.ceil(remainingBolosJP / 9);
                    
                    const totalSessions = student.summary.hadir + student.summary.sakit + student.summary.ijin + finalAlpha + finalBolos;
                    const attendanceRate = totalSessions > 0 ? ((student.summary.hadir / totalSessions) * 100).toFixed(1) : '0.0';
                    
                    // Create row with proper column order
                    const row = {};
                    
                    // Basic info columns
                    row['Nama Siswa'] = namaSiswa;
                    row['Kelas'] = student.kelas;
                    
                    // Date columns (attendance data)
                    sortedDates.forEach(date => {
                        const dayData = student.dailyAttendance[date];
                        row[date] = dayData.dailyStatus;
                    });
                    
                    // Summary columns
                    row['Total Hadir'] = student.summary.hadir;
                    row['Total Sakit'] = student.summary.sakit;
                    row['Total Ijin'] = student.summary.ijin;
                    row['Total Alpha'] = finalAlpha;
                    row['Total Bolos'] = finalBolos;
                    row['Total Pertemuan'] = totalSessions;
                    row['Persentase Kehadiran'] = attendanceRate + '%';
                    
                    excelData.push(row);
                });
                
                console.log('üìã Excel data prepared, rows:', excelData.length);
                
                // Generate filename with filter info
                const today = new Date().toLocaleDateString('id-ID').replace(/\//g, '-');
                let filterInfo = '';
                if (targetClasses.length === 1) {
                    filterInfo += `_${targetClasses[0]}`;
                } else if (isOperator && !filterKelasWali) {
                    filterInfo += '_Semua_Kelas';
                }
                
                const periodMap = {
                    'week': 'Minggu_Ini',
                    'month': 'Bulan_Ini',
                    'semester1': 'Semester_1',
                    'semester2': 'Semester_2',
                    'tahun': 'Tahun_Ajaran'
                };
                
                const periodLabel = periodMap[exportPeriode] || exportPeriode;
                const filename = `Rekap_Kehadiran${filterInfo}_${periodLabel}_${today}.xlsx`;
                console.log('üìÅ Generated filename:', filename);
                
                // Create Excel workbook using SheetJS
                console.log('üìù Creating Excel workbook...');
                
                // Create a new workbook
                const wb = XLSX.utils.book_new();
                
                // Convert data to worksheet
                const ws = XLSX.utils.json_to_sheet(excelData);
                
                // Set column widths for better readability
                const baseColWidths = [
                    { wch: 25 }, // Nama Siswa
                    { wch: 10 }  // Kelas
                ];
                
                // Date columns (narrower)
                const dateColWidths = sortedDates.map(() => ({ wch: 8 }));
                
                // Summary columns
                const summaryColWidths = [
                    { wch: 12 }, // Total Hadir
                    { wch: 12 }, // Total Sakit
                    { wch: 12 }, // Total Ijin
                    { wch: 12 }, // Total Alpha
                    { wch: 12 }, // Total Bolos
                    { wch: 15 }, // Total Pertemuan
                    { wch: 18 }  // Persentase Kehadiran
                ];
                
                ws['!cols'] = [...baseColWidths, ...dateColWidths, ...summaryColWidths];
                
                // Add worksheet to workbook
                XLSX.utils.book_append_sheet(wb, ws, 'Rekap Kehadiran');
                
                // Generate Excel file as array buffer
                const excelBuffer = XLSX.write(wb, { bookType: 'xlsx', type: 'array' });
                
                // Create blob and data URL
                const blob = new Blob([excelBuffer], { type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' });
                const dataUrl = URL.createObjectURL(blob);
                
                console.log('‚úÖ Excel file created successfully');
                
                // Show enhanced download modal
                const downloadModal = document.createElement('div');
                downloadModal.innerHTML = `
                    <div style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
                                background: rgba(0,0,0,0.7); z-index: 10000; display: flex; 
                                align-items: center; justify-content: center; backdrop-filter: blur(2px);">
                        <div style="background: white; padding: 30px; border-radius: 16px; 
                                    box-shadow: 0 25px 50px rgba(0,0,0,0.4); max-width: 600px; width: 90%;
                                    max-height: 90vh; overflow-y: auto;">
                            
                            <!-- Header -->
                            <div style="text-align: center; margin-bottom: 25px;">
                                <div style="font-size: 64px; margin-bottom: 15px;">üìä</div>
                                <h2 style="margin: 0 0 10px 0; color: #1F2937; font-size: 24px; font-weight: 700;">
                                    Export Rekap Kehadiran
                                </h2>
                                <p style="margin: 0; color: #6B7280; font-size: 16px;">
                                    Data siap untuk didownload dalam format Excel (.xlsx)
                                </p>
                            </div>
                            
                            <!-- File Info -->
                            <div style="background: linear-gradient(135deg, #ECFDF5 0%, #F0FDF4 100%); 
                                        padding: 20px; border-radius: 12px; margin-bottom: 25px; 
                                        border: 1px solid #BBF7D0;">
                                <div style="display: flex; align-items: center; margin-bottom: 15px;">
                                    <div style="font-size: 24px; margin-right: 10px;">üìã</div>
                                    <div style="font-weight: 600; color: #166534; font-size: 18px;">Detail File & Filter</div>
                                </div>
                                
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; font-size: 14px;">
                                    <div style="background: white; padding: 12px; border-radius: 8px; border: 1px solid #E5E7EB;">
                                        <div style="color: #6B7280; margin-bottom: 4px;">üìÅ Nama File:</div>
                                        <div style="color: #374151; font-weight: 500; word-break: break-all;">${filename}</div>
                                    </div>
                                    <div style="background: white; padding: 12px; border-radius: 8px; border: 1px solid #E5E7EB;">
                                        <div style="color: #6B7280; margin-bottom: 4px;">üë• Jumlah Siswa:</div>
                                        <div style="color: #374151; font-weight: 500;">${excelData.length} siswa</div>
                                    </div>
                                    <div style="background: white; padding: 12px; border-radius: 8px; border: 1px solid #E5E7EB;">
                                        <div style="color: #6B7280; margin-bottom: 4px;">üìÖ Periode:</div>
                                        <div style="color: #374151; font-weight: 500;">${periodLabel.replace(/_/g, ' ')}</div>
                                    </div>
                                    <div style="background: white; padding: 12px; border-radius: 8px; border: 1px solid #E5E7EB;">
                                        <div style="color: #6B7280; margin-bottom: 4px;">üìè Ukuran File:</div>
                                        <div style="color: #374151; font-weight: 500;">${Math.round(blob.size / 1024)} KB</div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Download Button -->
                            <div style="margin-bottom: 25px;">
                                <a href="${dataUrl}" download="${filename}" 
                                   style="display: block; background: linear-gradient(135deg, #059669 0%, #047857 100%); 
                                          color: white; padding: 18px 24px; text-decoration: none; 
                                          border-radius: 12px; font-weight: 600; font-size: 16px;
                                          text-align: center; transition: all 0.3s ease;
                                          box-shadow: 0 4px 12px rgba(5, 150, 105, 0.3);"
                                   onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 8px 20px rgba(5, 150, 105, 0.4)'"
                                   onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 12px rgba(5, 150, 105, 0.3)'">
                                    <div style="display: flex; align-items: center; justify-content: center;">
                                        <span style="font-size: 20px; margin-right: 8px;">üì•</span>
                                        Download Rekap Kehadiran Excel
                                    </div>
                                    <div style="font-size: 12px; opacity: 0.9; margin-top: 4px;">
                                        Format: Excel (.xlsx) dengan ${sortedDates.length} hari data
                                    </div>
                                </a>
                            </div>
                            
                            <!-- Instructions -->
                            <div style="background: #ECFDF5; border: 1px solid #10B981; border-radius: 12px; 
                                        padding: 20px; margin-bottom: 20px;">
                                <div style="display: flex; align-items: flex-start;">
                                    <div style="font-size: 24px; margin-right: 12px; margin-top: 2px;">üí°</div>
                                    <div>
                                        <div style="font-weight: 600; color: #047857; margin-bottom: 8px; font-size: 16px;">
                                            Format Rekap Kehadiran:
                                        </div>
                                        <div style="color: #047857; font-size: 14px; line-height: 1.5;">
                                            <div style="margin-bottom: 6px;">
                                                <strong>üìä Kolom Harian:</strong> H=Hadir (>55% JP), S=Sakit, I=Ijin, A=Alpha, B=Bolos
                                            </div>
                                            <div style="margin-bottom: 6px;">
                                                <strong>üìà Statistik Lengkap:</strong> Total per kategori dan persentase kehadiran
                                            </div>
                                            <div style="margin-bottom: 6px;">
                                                <strong>üîÑ Konversi Otomatis:</strong> 9 JP Bolos = 1 Alpha (sudah dihitung)
                                            </div>
                                            <div style="background: #A7F3D0; padding: 8px; border-radius: 6px; margin-top: 8px;">
                                                <strong>üìã Urutan:</strong> Siswa diurutkan berdasarkan kelas, lalu nama
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Close Button -->
                            <div style="text-align: center;">
                                <button onclick="closeDownloadModal(this)" 
                                        style="background: #6B7280; color: white; border: none; padding: 12px 24px; 
                                               border-radius: 8px; cursor: pointer; font-size: 14px; font-weight: 500;
                                               transition: background-color 0.2s;"
                                        onmouseover="this.style.backgroundColor='#4B5563'"
                                        onmouseout="this.style.backgroundColor='#6B7280'">
                                    ‚úï Tutup
                                </button>
                            </div>
                        </div>
                    </div>
                `;
                
                document.body.appendChild(downloadModal);
                
                // Auto-remove after 5 minutes and clean up blob URL
                setTimeout(() => {
                    if (downloadModal.parentNode) {
                        downloadModal.parentNode.removeChild(downloadModal);
                        URL.revokeObjectURL(dataUrl);
                    }
                }, 300000);
                
                console.log('‚úÖ Excel kehadiran download modal displayed');
                showNotification('File Excel rekap kehadiran siap didownload!', 'success');
                
            } catch (error) {
                console.error('üí• Critical error in exportKehadiranToExcel:', error);
                console.error('Error stack:', error.stack);
                showNotification('Gagal mengekspor rekap kehadiran: ' + error.message, 'error');
            }
        }
        
        async function exportPembelajaranToExcel() {
            showNotification('Fitur export pembelajaran akan segera tersedia', 'success');
        }
        
        async function showDetailPresensiMapel(kelas, namaGuru, jamPelajaran, date) {
            const container = document.getElementById('rekapKehadiranContent');
            container.innerHTML = '<div class="text-center py-4"><div class="loading mx-auto"></div><p class="mt-2 text-gray-500">Memuat detail presensi...</p></div>';
            
            try {
                // Load absensi data
                let absensiData = getLocalStorageData('absensi');
                
                try {
                    const spreadsheetData = await loadDashboardDataFromSpreadsheet();
                    if (spreadsheetData.absensiData) {
                        absensiData = [...absensiData, ...spreadsheetData.absensiData];
                    }
                } catch (error) {
                    console.warn('Using localStorage data only for detail presensi mapel:', error);
                }
                
                // Filter data for specific session
                const sessionData = absensiData.filter(item => {
                    const itemKelas = item.kelas || item.Kelas || '';
                    const itemGuru = item['Nama Guru'] || item.namaGuru || '';
                    const itemJam = item.jamPelajaran || item['Jam Pelajaran'] || '';
                    const timestamp = item.timestamp || item.Timestamp || item['Tanggal'] || item.tanggal;
                    
                    const parsedTime = parseTimestamp(timestamp);
                    
                    return itemKelas === kelas && 
                           itemGuru === namaGuru && 
                           itemJam === jamPelajaran && 
                           parsedTime && parsedTime.dateString === date;
                });
                
                if (sessionData.length === 0) {
                    container.innerHTML = `
                        <div class="mb-4">
                            <button onclick="showDetailKehadiranHarian('${date}')" class="bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded-lg text-sm transition duration-200">
                                ‚Üê Kembali ke Pembelajaran Harian
                            </button>
                        </div>
                        <div class="text-center py-12">
                            <div class="text-6xl mb-4">üë•</div>
                            <p class="text-gray-500 text-lg">Tidak ada data presensi untuk sesi ini</p>
                        </div>
                    `;
                    return;
                }
                
                // Calculate student attendance summary for the period (for categorization)
                const waliKelas = currentUser['Wali Kelas'] || '';
                const isOperator = waliKelas.toLowerCase() === 'operator';
                const filterKelasWali = document.getElementById('filterKelasWali')?.value || '';
                
                let targetClasses = [];
                if (isOperator) {
                    if (filterKelasWali) {
                        targetClasses = [filterKelasWali];
                    } else {
                        const kelasSet = new Set();
                        classData.forEach(row => {
                            if (row.Kelas) kelasSet.add(row.Kelas);
                        });
                        targetClasses = Array.from(kelasSet);
                    }
                } else {
                    targetClasses = [waliKelas];
                }
                
                const studentSummary = {};
                
                // Get all students in target classes
                const allStudents = classData.filter(row => targetClasses.includes(row.Kelas));
                allStudents.forEach(student => {
                    const nama = student['Nama Siswa'];
                    const kelasStudent = student.Kelas;
                    if (!studentSummary[nama]) {
                        studentSummary[nama] = {
                            kelas: kelasStudent,
                            hadir: 0,
                            sakit: 0,
                            ijin: 0,
                            alpha: 0,
                            bolos: 0,
                            totalJP: 0,
                            bolosJP: 0
                        };
                    }
                });
                
                // Get all attendance data for the period to calculate student status
                const filterPeriodeWali = document.getElementById('filterPeriodeWali')?.value || 'week';
                const dateFromWali = document.getElementById('dateFromWali')?.value || '';
                const dateToWali = document.getElementById('dateToWali')?.value || '';
                let dateRange = getWaliDateRange(filterPeriodeWali, dateFromWali, dateToWali);
                
                const periodData = absensiData.filter(item => {
                    const itemKelas = item.kelas || item.Kelas || '';
                    if (!targetClasses.includes(itemKelas)) return false;
                    
                    if (dateRange.length > 0) {
                        const timestamp = item.timestamp || item.Timestamp || item['Tanggal'] || item.tanggal;
                        const parsedTime = parseTimestamp(timestamp);
                        if (!parsedTime || !dateRange.includes(parsedTime.dateString)) return false;
                    }
                    
                    return true;
                });
                
                // Calculate period summary for each student
                periodData.forEach(item => {
                    const nama = item.namaSiswa || item['Nama Siswa'] || '';
                    const status = (item.keterangan || item.Keterangan || '').toLowerCase();
                    const jamPelajaranItem = parseInt(item.jamPelajaran || item['Jam Pelajaran'] || '1');
                    
                    if (studentSummary[nama]) {
                        studentSummary[nama].totalJP += jamPelajaranItem;
                        
                        if (status === 'hadir') studentSummary[nama].hadir++;
                        else if (status === 'sakit') studentSummary[nama].sakit++;
                        else if (status === 'ijin') studentSummary[nama].ijin++;
                        else if (status === 'alpha') studentSummary[nama].alpha++;
                        else if (status === 'bolos') {
                            studentSummary[nama].bolos++;
                            studentSummary[nama].bolosJP += jamPelajaranItem;
                        }
                    }
                });
                
                // Sort students by name
                sessionData.sort((a, b) => {
                    const nameA = (a.namaSiswa || a['Nama Siswa'] || '').toString();
                    const nameB = (b.namaSiswa || b['Nama Siswa'] || '').toString();
                    return nameA.localeCompare(nameB);
                });
                
                // Calculate summary
                const statusCount = {
                    hadir: 0,
                    sakit: 0,
                    ijin: 0,
                    alpha: 0,
                    bolos: 0
                };
                
                sessionData.forEach(siswa => {
                    const status = (siswa.keterangan || siswa.Keterangan || '').toLowerCase();
                    if (status === 'hadir') statusCount.hadir++;
                    else if (status === 'sakit') statusCount.sakit++;
                    else if (status === 'ijin') statusCount.ijin++;
                    else if (status === 'alpha') statusCount.alpha++;
                    else if (status === 'bolos') {     // Misal kolom jam pelajaran pada data absensi disebut 'jamPelajaran' atau 'Jam Pelajaran'     
                        const jp = Number(siswa.jamPelajaran || siswa['Jam Pelajaran'] || 1);     
                        statusCount.bolos += jp;
                });
                
                const studentsHtml = sessionData.map(student => {
                    const nama = student.namaSiswa || student['Nama Siswa'] || '';
                    const status = student.keterangan || student.Keterangan || '';
                    const summary = studentSummary[nama];
                    
                    // Determine student category
                    let category = 'Baik';
                    let categoryClass = 'bg-green-100 text-green-800';
                    let categoryIcon = 'üòä';
                    
                    if (summary) {
                        // Convert bolos to alpha: 9 JP bolos = 1 alpha
                        const convertedAlpha = Math.floor(summary.bolosJP / 9);
                        const remainingBolosJP = summary.bolosJP % 9;
                        const totalAlpha = summary.alpha + convertedAlpha;
                        
                        const totalSessions = summary.hadir + summary.sakit + summary.ijin + totalAlpha + Math.ceil(remainingBolosJP / 9);
                        const attendanceRate = totalSessions > 0 ? (summary.hadir / totalSessions) * 100 : 100;
                        
                        // Check if problematic: attendance < 75% OR total alpha (including converted) > 0
                        if (attendanceRate < 75 || totalAlpha > 0) {
                            category = 'Bermasalah';
                            categoryClass = 'bg-red-100 text-red-800';
                            categoryIcon = 'üò∞';
                        } else if (attendanceRate < 85 || remainingBolosJP > 4) {
                            category = 'Perhatian';
                            categoryClass = 'bg-yellow-100 text-yellow-800';
                            categoryIcon = 'üòê';
                        }
                        
                        // Add attendance summary info
                        const attendanceInfo = `Kehadiran: ${attendanceRate.toFixed(1)}% | Alpha: ${totalAlpha} | Bolos: ${remainingBolosJP} JP`;
                        category += ` (${attendanceInfo})`;
                    }
                    
                    let statusClass = 'bg-gray-100 text-gray-800';
                    let statusIcon = '‚ùì';
                    
                    switch(status.toLowerCase()) {
                        case 'hadir':
                            statusClass = 'bg-green-100 text-green-800';
                            statusIcon = '‚úì';
                            break;
                        case 'sakit':
                            statusClass = 'bg-yellow-100 text-yellow-800';
                            statusIcon = 'ü§í';
                            break;
                        case 'ijin':
                            statusClass = 'bg-blue-100 text-blue-800';
                            statusIcon = 'üìù';
                            break;
                        case 'alpha':
                            statusClass = 'bg-red-100 text-red-800';
                            statusIcon = '‚ùå';
                            break;
                        case 'bolos':
                            statusClass = 'bg-purple-100 text-purple-800';
                            statusIcon = 'üö´';
                            break;
                    }
                    
                    return `
                        <div class="border border-gray-200 rounded-lg p-4 mb-3">
                            <div class="flex items-center justify-between mb-2">
                                <span class="font-medium text-gray-900 text-lg">${nama}</span>
                                <span class="${statusClass} px-3 py-1 rounded-full text-sm font-medium">
                                    ${statusIcon} ${status}
                                </span>
                            </div>
                            <div class="text-xs ${categoryClass.replace('bg-', 'text-').replace('-100', '-700')} bg-gray-50 p-2 rounded">
                                <strong>${categoryIcon} Status:</strong> ${category}
                            </div>
                        </div>
                    `;
                }).join('');
                
                container.innerHTML = `
                    <div class="mb-6">
                        <div class="flex items-center justify-between mb-4">
                            <div>
                                <h4 class="text-lg font-semibold text-gray-900">Detail Presensi - ${kelas}</h4>
                                <p class="text-sm text-gray-600">${namaGuru} ‚Ä¢ ${jamPelajaran} JP ‚Ä¢ ${date}</p>
                            </div>
                            <button onclick="showDetailKehadiranHarian('${date}')" class="bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded-lg text-sm transition duration-200">
                                ‚Üê Kembali ke Pembelajaran Harian
                            </button>
                        </div>
                        
                        <!-- Summary -->
                        <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-6">
                            <h5 class="font-semibold text-blue-900 mb-2">Ringkasan Kehadiran Sesi Ini:</h5>
                            <div class="flex flex-wrap gap-2">
                                <span class="bg-green-100 text-green-800 px-3 py-1 rounded-full text-sm">‚úì Hadir: ${statusCount.hadir}</span>
                                <span class="bg-yellow-100 text-yellow-800 px-3 py-1 rounded-full text-sm">ü§í Sakit: ${statusCount.sakit}</span>
                                <span class="bg-blue-100 text-blue-800 px-3 py-1 rounded-full text-sm">üìù Ijin: ${statusCount.ijin}</span>
                                <span class="bg-red-100 text-red-800 px-3 py-1 rounded-full text-sm">‚ùå Alpha: ${statusCount.alpha}</span>
                                <span class="bg-purple-100 text-purple-800 px-3 py-1 rounded-full text-sm">üö´ Bolos: ${statusCount.bolos}</span>
                            </div>
                        </div>
                        

                        
                        <!-- Student List -->
                        <div class="space-y-3">
                            ${studentsHtml}
                        </div>
                    </div>
                `;
                
            } catch (error) {
                console.error('Error loading detail presensi mapel:', error);
                container.innerHTML = `
                    <div class="mb-4">
                        <button onclick="showDetailKehadiranHarian('${date}')" class="bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded-lg text-sm transition duration-200">
                            ‚Üê Kembali ke Pembelajaran Harian
                        </button>
                    </div>
                    <div class="text-center py-12">
                        <div class="text-6xl mb-4">‚ùå</div>
                        <p class="text-red-500 text-lg">Gagal memuat detail presensi</p>
                        <p class="text-gray-400 text-sm">Silakan coba lagi nanti</p>
                    </div>
                `;
            }
        }
    </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'98d4cc7840a10a32',t:'MTc2MDI1MzI0OS4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
