<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Administrasi Kelas - Jurnal & Presensi</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            box-sizing: border-box;
        }
        .fade-in {
            animation: fadeIn 0.3s ease-in;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .success-animation {
            animation: successPulse 0.6s ease-out;
        }
        @keyframes successPulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }
    </style>
</head>
<body class="bg-gradient-to-br from-blue-50 to-indigo-100 min-h-full">
    <div class="container mx-auto px-4 py-6 max-w-6xl">
        <!-- Header -->
        <div class="bg-white rounded-xl shadow-lg p-6 mb-6">
            <h1 class="text-3xl font-bold text-gray-800 text-center mb-2">üìö Administrasi Kelas</h1>
            <p class="text-gray-600 text-center">Jurnal Pembelajaran & Presensi Siswa</p>
        </div>

        <!-- Navigation Tabs -->
        <div class="bg-white rounded-xl shadow-lg mb-6">
            <div class="flex border-b">
                <button id="tab-input" class="flex-1 py-4 px-6 text-center font-semibold text-blue-600 border-b-2 border-blue-600 bg-blue-50">
                    üìù Input Jurnal & Presensi
                </button>
                <button id="tab-riwayat" class="flex-1 py-4 px-6 text-center font-semibold text-gray-500 hover:text-blue-600 transition-colors">
                    üìä Riwayat Data
                </button>
            </div>
        </div>

        <!-- Input Jurnal & Presensi Tab -->
        <div id="content-input" class="fade-in">
            <div class="bg-white rounded-xl shadow-lg p-6">
                <h2 class="text-2xl font-bold text-gray-800 mb-6">üìù Input Jurnal Pembelajaran & Presensi</h2>
                
                <form id="form-gabungan" class="space-y-6">
                    <!-- Bagian Jurnal -->
                    <div class="bg-blue-50 p-6 rounded-lg">
                        <h3 class="text-lg font-semibold text-gray-800 mb-4">üìñ Data Jurnal Pembelajaran</h3>
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-2">Nama Guru</label>
                                <input type="text" id="nama-guru" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="Masukkan nama guru" required>
                            </div>
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-2">Kelas</label>
                                <select id="kelas" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" required>
                                    <option value="">Pilih Kelas</option>
                                    <!-- Kelas akan dimuat dari CSV -->
                                </select>
                            </div>
                        </div>

                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-2">Mata Pelajaran</label>
                                <input type="text" id="mata-pelajaran" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="Contoh: Matematika" required>
                            </div>
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-2">Durasi Pembelajaran</label>
                                <select id="durasi-pelajaran" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" required>
                                    <option value="">Pilih Durasi</option>
                                    <option value="1">1 Jam Pelajaran</option>
                                    <option value="2">2 Jam Pelajaran</option>
                                    <option value="3">3 Jam Pelajaran</option>
                                    <option value="4">4 Jam Pelajaran</option>
                                </select>
                            </div>
                        </div>

                        <div class="mb-4">
                            <label class="block text-sm font-semibold text-gray-700 mb-2">Materi Pembelajaran</label>
                            <textarea id="materi" rows="3" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="Jelaskan materi yang diajarkan..." required></textarea>
                        </div>

                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">Catatan Tambahan</label>
                            <textarea id="catatan" rows="2" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="Catatan khusus (opsional)"></textarea>
                        </div>
                    </div>

                    <!-- Bagian Presensi -->
                    <div class="bg-green-50 p-6 rounded-lg">
                        <h3 class="text-lg font-semibold text-gray-800 mb-4">‚úÖ Presensi Siswa</h3>
                        


                        <div id="daftar-presensi" class="space-y-3 mb-4">
                            <div class="text-center text-gray-500 py-8 border-2 border-dashed border-gray-300 rounded-lg">
                                Pilih kelas untuk memuat daftar siswa secara otomatis
                            </div>
                        </div>
                    </div>

                    <button type="submit" class="w-full bg-gradient-to-r from-blue-600 to-green-600 hover:from-blue-700 hover:to-green-700 text-white font-semibold py-4 px-6 rounded-lg transition-all transform hover:scale-105">
                        üíæ Simpan Jurnal & Presensi
                    </button>
                </form>
            </div>
        </div>

        <!-- Riwayat Data Tab -->
        <div id="content-riwayat" class="hidden">
            <div class="bg-white rounded-xl shadow-lg p-6">
                <h2 class="text-2xl font-bold text-gray-800 mb-6">üìä Riwayat Data</h2>
                
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <!-- Riwayat Jurnal -->
                    <div>
                        <h3 class="text-lg font-semibold text-gray-700 mb-4">üìñ Jurnal Pembelajaran</h3>
                        <div id="riwayat-jurnal" class="space-y-3 max-h-96 overflow-y-auto">
                            <div class="text-center text-gray-500 py-8">
                                Belum ada data jurnal
                            </div>
                        </div>
                    </div>

                    <!-- Riwayat Presensi -->
                    <div>
                        <h3 class="text-lg font-semibold text-gray-700 mb-4">‚úÖ Data Presensi</h3>
                        <div id="riwayat-presensi" class="space-y-3 max-h-96 overflow-y-auto">
                            <div class="text-center text-gray-500 py-8">
                                Belum ada data presensi
                            </div>
                        </div>
                    </div>
                </div>

                <div class="mt-6 p-4 bg-yellow-50 rounded-lg">
                    <h4 class="font-semibold text-yellow-800 mb-2">üìã Kode Google Apps Script</h4>
                    <p class="text-sm text-yellow-700 mb-3">Salin kode berikut ke Google Apps Script untuk integrasi dengan Google Sheets:</p>
                    <button id="show-script" class="bg-yellow-600 hover:bg-yellow-700 text-white px-4 py-2 rounded-lg text-sm font-semibold">
                        üìÑ Tampilkan Kode Script
                    </button>
                </div>
            </div>
        </div>

        <!-- Modal Script -->
        <div id="modal-script" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
            <div class="bg-white rounded-xl p-6 max-w-4xl max-h-full overflow-y-auto m-4">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-xl font-bold text-gray-800">üìÑ Google Apps Script Code</h3>
                    <button id="close-modal" class="text-gray-500 hover:text-gray-700 text-2xl">&times;</button>
                </div>
                <div class="bg-gray-900 text-green-400 p-4 rounded-lg text-sm font-mono overflow-x-auto">
                    <pre id="script-code">// Google Apps Script untuk Administrasi Kelas
// SPREADSHEET ID: 15JuTyfVZBjLt6PIEwFewloNjcrBj4StgYkeUN0CZIvs

// Fungsi utama untuk menerima data dari aplikasi web
function doPost(e) {
  try {
    // Gunakan spreadsheet dengan ID yang sudah ditentukan
    const ss = SpreadsheetApp.openById('15JuTyfVZBjLt6PIEwFewloNjcrBj4StgYkeUN0CZIvs');
    
    // Handle data dari parameter form
    let data;
    if (e.parameter) {
      // Jika data dikirim sebagai field terpisah
      if (e.parameter.idJurnal) {
        data = {
          idJurnal: e.parameter.idJurnal,
          namaGuru: e.parameter.namaGuru,
          kelas: e.parameter.kelas,
          mataPelajaran: e.parameter.mataPelajaran,
          materi: e.parameter.materi,
          catatan: e.parameter.catatan || '',
          durasiPelajaran: e.parameter.durasiPelajaran,
          timestamp: e.parameter.timestamp,
          presensi: JSON.parse(e.parameter.presensi || '[]')
        };
      } else if (e.parameter.data) {
        // Jika data dikirim sebagai JSON string
        data = JSON.parse(e.parameter.data);
      }
    } else if (e.postData && e.postData.contents) {
      data = JSON.parse(e.postData.contents);
    }
    
    if (!data) {
      throw new Error('No data received');
    }
    
    // Buat atau ambil sheet Jurnal
    let jurnalSheet = ss.getSheetByName('Jurnal');
    if (!jurnalSheet) {
      jurnalSheet = ss.insertSheet('Jurnal');
      // Tambahkan header
      jurnalSheet.getRange(1, 1, 1, 8).setValues([
        ['ID Jurnal', 'Timestamp', 'Nama Guru', 'Kelas', 'Mata Pelajaran', 'Materi', 'Catatan', 'Durasi Pelajaran']
      ]);
      // Format header
      const headerRange = jurnalSheet.getRange(1, 1, 1, 8);
      headerRange.setBackground('#4285f4');
      headerRange.setFontColor('white');
      headerRange.setFontWeight('bold');
      headerRange.setHorizontalAlignment('center');
    }
    
    // Buat atau ambil sheet Presensi
    let presensiSheet = ss.getSheetByName('Presensi');
    if (!presensiSheet) {
      presensiSheet = ss.insertSheet('Presensi');
      // Tambahkan header
      presensiSheet.getRange(1, 1, 1, 7).setValues([
        ['ID Jurnal', 'Timestamp', 'Nama Guru', 'Kelas', 'Nama Siswa', 'Keterangan', 'Durasi Pelajaran']
      ]);
      // Format header
      const headerRange = presensiSheet.getRange(1, 1, 1, 7);
      headerRange.setBackground('#34a853');
      headerRange.setFontColor('white');
      headerRange.setFontWeight('bold');
      headerRange.setHorizontalAlignment('center');
    }
    
    // Simpan data jurnal
    jurnalSheet.appendRow([
      data.idJurnal,
      new Date(data.timestamp),
      data.namaGuru,
      data.kelas,
      data.mataPelajaran,
      data.materi,
      data.catatan || '',
      getDurasiText(data.durasiPelajaran)
    ]);
    
    // Simpan data presensi
    data.presensi.forEach(siswa => {
      presensiSheet.appendRow([
        data.idJurnal,
        new Date(data.timestamp),
        data.namaGuru,
        data.kelas,
        siswa.nama,
        siswa.keterangan,
        getDurasiText(data.durasiPelajaran)
      ]);
    });
    
    // Auto-resize kolom untuk tampilan yang rapi
    jurnalSheet.autoResizeColumns(1, 8);
    presensiSheet.autoResizeColumns(1, 7);
    
    // Format tanggal untuk kolom timestamp
    const jurnalLastRow = jurnalSheet.getLastRow();
    const presensiLastRow = presensiSheet.getLastRow();
    
    if (jurnalLastRow > 1) {
      jurnalSheet.getRange(jurnalLastRow, 2).setNumberFormat('dd/mm/yyyy hh:mm:ss');
    }
    
    if (presensiLastRow > 1) {
      presensiSheet.getRange(presensiLastRow - data.presensi.length + 1, 2, data.presensi.length, 1)
        .setNumberFormat('dd/mm/yyyy hh:mm:ss');
    }
    
    return ContentService
      .createTextOutput(JSON.stringify({
        success: true, 
        message: 'Data berhasil disimpan ke Google Sheets',
        idJurnal: data.idJurnal,
        totalSiswa: data.presensi.length,
        spreadsheetUrl: ss.getUrl()
      }))
      .setMimeType(ContentService.MimeType.JSON);
      
  } catch (error) {
    Logger.log('Error in doPost: ' + error.toString());
    return ContentService
      .createTextOutput(JSON.stringify({
        success: false, 
        error: error.toString()
      }))
      .setMimeType(ContentService.MimeType.JSON);
  }
}

// Fungsi untuk mengambil data dari spreadsheet
function doGet() {
  try {
    const ss = SpreadsheetApp.openById('15JuTyfVZBjLt6PIEwFewloNjcrBj4StgYkeUN0CZIvs');
    const jurnalSheet = ss.getSheetByName('Jurnal');
    const presensiSheet = ss.getSheetByName('Presensi');
    
    let jurnalData = [];
    let presensiData = [];
    
    if (jurnalSheet && jurnalSheet.getLastRow() > 1) {
      const jurnalValues = jurnalSheet.getRange(2, 1, jurnalSheet.getLastRow() - 1, 8).getValues();
      jurnalData = jurnalValues.map(row => ({
        idJurnal: row[0],
        timestamp: row[1],
        namaGuru: row[2],
        kelas: row[3],
        mataPelajaran: row[4],
        materi: row[5],
        catatan: row[6],
        durasiPelajaran: row[7]
      }));
    }
    
    if (presensiSheet && presensiSheet.getLastRow() > 1) {
      const presensiValues = presensiSheet.getRange(2, 1, presensiSheet.getLastRow() - 1, 7).getValues();
      presensiData = presensiValues.map(row => ({
        idJurnal: row[0],
        timestamp: row[1],
        namaGuru: row[2],
        kelas: row[3],
        namaSiswa: row[4],
        keterangan: row[5],
        durasiPelajaran: row[6]
      }));
    }
    
    return ContentService
      .createTextOutput(JSON.stringify({
        success: true,
        jurnal: jurnalData,
        presensi: presensiData,
        spreadsheetUrl: ss.getUrl()
      }))
      .setMimeType(ContentService.MimeType.JSON);
      
  } catch (error) {
    Logger.log('Error in doGet: ' + error.toString());
    return ContentService
      .createTextOutput(JSON.stringify({
        success: false,
        error: error.toString()
      }))
      .setMimeType(ContentService.MimeType.JSON);
  }
}

// Fungsi helper untuk format durasi
function getDurasiText(durasi) {
  const durasiOptions = {
    '1': '1 Jam Pelajaran',
    '2': '2 Jam Pelajaran',
    '3': '3 Jam Pelajaran',
    '4': '4 Jam Pelajaran'
  };
  return durasiOptions[durasi] || durasi + ' Jam Pelajaran';
}

// Fungsi untuk membuat laporan harian otomatis
function buatLaporanHarian() {
  try {
    const ss = SpreadsheetApp.openById('15JuTyfVZBjLt6PIEwFewloNjcrBj4StgYkeUN0CZIvs');
    const today = new Date();
    const todayString = Utilities.formatDate(today, Session.getScriptTimeZone(), 'yyyy-MM-dd');
    
    const jurnalSheet = ss.getSheetByName('Jurnal');
    const presensiSheet = ss.getSheetByName('Presensi');
    
    if (!jurnalSheet || !presensiSheet) {
      Logger.log('Sheet Jurnal atau Presensi tidak ditemukan');
      return;
    }
    
    // Buat sheet laporan jika belum ada
    let laporanSheet = ss.getSheetByName('Laporan_' + todayString);
    if (!laporanSheet) {
      laporanSheet = ss.insertSheet('Laporan_' + todayString);
    }
    
    // Bersihkan sheet
    laporanSheet.clear();
    
    // Header laporan
    laporanSheet.getRange(1, 1).setValue('LAPORAN HARIAN ADMINISTRASI KELAS');
    laporanSheet.getRange(2, 1).setValue('Tanggal: ' + todayString);
    laporanSheet.getRange(1, 1, 2, 1).setFontSize(14).setFontWeight('bold');
    
    // Ringkasan data hari ini
    const jurnalData = jurnalSheet.getDataRange().getValues();
    const presensiData = presensiSheet.getDataRange().getValues();
    
    // Filter data hari ini (implementasi bisa disesuaikan)
    let jurnalHariIni = 0;
    let totalSiswaHadir = 0;
    
    // Hitung statistik sederhana
    for (let i = 1; i < jurnalData.length; i++) {
      const tanggalJurnal = new Date(jurnalData[i][1]);
      if (tanggalJurnal.toDateString() === today.toDateString()) {
        jurnalHariIni++;
      }
    }
    
    for (let i = 1; i < presensiData.length; i++) {
      const tanggalPresensi = new Date(presensiData[i][1]);
      if (tanggalPresensi.toDateString() === today.toDateString() && presensiData[i][5] === 'Hadir') {
        totalSiswaHadir++;
      }
    }
    
    laporanSheet.getRange(4, 1).setValue('Total Jurnal Hari Ini: ' + jurnalHariIni);
    laporanSheet.getRange(5, 1).setValue('Total Siswa Hadir: ' + totalSiswaHadir);
    
    Logger.log('Laporan harian berhasil dibuat untuk tanggal: ' + todayString);
    
  } catch (error) {
    Logger.log('Error membuat laporan harian: ' + error.toString());
  }
}

// Fungsi untuk testing koneksi
function testConnection() {
  try {
    const ss = SpreadsheetApp.openById('15JuTyfVZBjLt6PIEwFewloNjcrBj4StgYkeUN0CZIvs');
    Logger.log('Koneksi berhasil ke spreadsheet: ' + ss.getName());
    Logger.log('URL Spreadsheet: ' + ss.getUrl());
    return true;
  } catch (error) {
    Logger.log('Error koneksi: ' + error.toString());
    return false;
  }
}</pre>
                </div>
                <div class="mt-4 p-4 bg-blue-50 rounded-lg">
                    <p class="text-sm text-blue-700">
                        <strong>üìã Cara Setup Google Apps Script:</strong><br><br>
                        <strong>1. Buka Google Apps Script</strong><br>
                        ‚Üí Kunjungi <a href="https://script.google.com" target="_blank" class="underline">script.google.com</a><br><br>
                        
                        <strong>2. Buat Project Baru</strong><br>
                        ‚Üí Klik "New Project"<br>
                        ‚Üí Hapus kode default dan paste kode di atas<br>
                        ‚Üí Save dengan nama "Administrasi Kelas"<br><br>
                        
                        <strong>3. Deploy sebagai Web App</strong><br>
                        ‚Üí Klik "Deploy" ‚Üí "New deployment"<br>
                        ‚Üí Type: "Web app"<br>
                        ‚Üí Execute as: "Me"<br>
                        ‚Üí Who has access: "Anyone"<br>
                        ‚Üí Klik "Deploy"<br><br>
                        
                        <strong>4. Salin URL Deployment</strong><br>
                        ‚Üí Salin URL yang diberikan<br>
                        ‚Üí Ganti "YOUR_SCRIPT_ID" di aplikasi dengan URL tersebut<br><br>
                        
                        <strong>‚úÖ Spreadsheet Target:</strong><br>
                        ID: <code class="bg-white px-2 py-1 rounded">15JuTyfVZBjLt6PIEwFewloNjcrBj4StgYkeUN0CZIvs</code><br>
                        Data akan otomatis tersimpan ke sheet "Jurnal" dan "Presensi"
                    </p>
                </div>
            </div>
        </div>

        <!-- Success Message -->
        <div id="success-message" class="fixed top-4 right-4 bg-green-500 text-white px-6 py-3 rounded-lg shadow-lg hidden">
            ‚úÖ Data berhasil disimpan!
        </div>
    </div>

    <script>
        // State management
        let currentJurnal = null;
        let jurnalData = [];
        let presensiData = [];
        let kelasData = {};
        
        // URL CSV untuk data kelas
        const csvUrl = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vS8PjE1NIfkkBcTl1djKRGgZuwXSsSwAphbxzV_qlJ4qNThWW_ZQh1AJ647vIjBeoexz4sw-8WRLg-d/pub?gid=209740916&single=true&output=csv';
        
        // Fungsi untuk memuat data CSV
        async function loadKelasData() {
            try {
                const response = await fetch(csvUrl);
                const csvText = await response.text();
                const lines = csvText.split('\n');
                
                // Skip header (baris pertama)
                for (let i = 1; i < lines.length; i++) {
                    const line = lines[i].trim();
                    if (line) {
                        const columns = line.split(',');
                        if (columns.length >= 2) {
                            const kelas = columns[0].trim().replace(/"/g, '');
                            const nama = columns[1].trim().replace(/"/g, '');
                            
                            if (kelas && nama) {
                                if (!kelasData[kelas]) {
                                    kelasData[kelas] = [];
                                }
                                kelasData[kelas].push(nama);
                            }
                        }
                    }
                }
                
                // Populate dropdown kelas
                const kelasSelect = document.getElementById('kelas');
                const sortedKelas = Object.keys(kelasData).sort();
                
                sortedKelas.forEach(kelas => {
                    const option = document.createElement('option');
                    option.value = kelas;
                    option.textContent = kelas;
                    kelasSelect.appendChild(option);
                });
                
                console.log('Data kelas berhasil dimuat:', Object.keys(kelasData).length, 'kelas');
                
            } catch (error) {
                console.error('Error loading CSV data:', error);
                // Fallback ke data default jika gagal load CSV
                kelasData = {
                    'X-A': ['Ahmad Rizki', 'Siti Nurhaliza', 'Budi Santoso', 'Dewi Sartika', 'Eko Prasetyo'],
                    'X-B': ['Fitri Handayani', 'Gilang Ramadhan', 'Hana Pertiwi', 'Indra Gunawan', 'Joko Widodo'],
                    'XI-A': ['Kartika Sari', 'Lukman Hakim', 'Maya Sari', 'Nanda Pratama', 'Oki Setiana'],
                    'XI-B': ['Putri Ayu', 'Qori Sumantri', 'Rina Marlina', 'Sandi Permana', 'Tari Wulandari'],
                    'XII-A': ['Umar Bakri', 'Vina Panduwinata', 'Wahyu Hidayat', 'Xenia Gratia', 'Yudi Latif'],
                    'XII-B': ['Zahra Aulia', 'Andi Lala', 'Bella Saphira', 'Citra Kirana', 'Dimas Anggara']
                };
                
                const kelasSelect = document.getElementById('kelas');
                Object.keys(kelasData).forEach(kelas => {
                    const option = document.createElement('option');
                    option.value = kelas;
                    option.textContent = kelas;
                    kelasSelect.appendChild(option);
                });
            }
        }

        // Tab navigation
        document.getElementById('tab-input').addEventListener('click', () => showTab('input'));
        document.getElementById('tab-riwayat').addEventListener('click', () => showTab('riwayat'));

        function showTab(tab) {
            // Hide all content
            document.getElementById('content-input').classList.add('hidden');
            document.getElementById('content-riwayat').classList.add('hidden');
            
            // Reset tab styles
            document.querySelectorAll('[id^="tab-"]').forEach(t => {
                t.className = 'flex-1 py-4 px-6 text-center font-semibold text-gray-500 hover:text-blue-600 transition-colors';
            });
            
            // Show selected content and highlight tab
            document.getElementById(`content-${tab}`).classList.remove('hidden');
            document.getElementById(`tab-${tab}`).className = 'flex-1 py-4 px-6 text-center font-semibold text-blue-600 border-b-2 border-blue-600 bg-blue-50';
            
            if (tab === 'riwayat') {
                loadRiwayatData();
            }
        }

        // URL Google Apps Script (sudah terhubung ke deployment Anda)
        const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbyMlCPy-tUdbW09dmFTn_-dbg2T2EQV_G-5bGlrGLdLZ-PJiIolUiXsyMaCierGL2Fq/exec';
        
        // Form gabungan submission
        document.getElementById('form-gabungan').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const submitButton = document.querySelector('button[type="submit"]');
            const originalText = submitButton.innerHTML;
            submitButton.innerHTML = '‚è≥ Menyimpan...';
            submitButton.disabled = true;
            
            const idJurnal = 'JRN' + Date.now();
            const namaGuru = document.getElementById('nama-guru').value;
            const kelas = document.getElementById('kelas').value;
            const mataPelajaran = document.getElementById('mata-pelajaran').value;
            const materi = document.getElementById('materi').value;
            const catatan = document.getElementById('catatan').value;
            const durasiPelajaran = document.getElementById('durasi-pelajaran').value;
            
            // Validasi presensi
            const daftarPresensi = document.getElementById('daftar-presensi');
            const siswaElements = daftarPresensi.children;
            
            if (siswaElements.length === 0 || (siswaElements.length === 1 && siswaElements[0].classList.contains('text-center'))) {
                alert('Silakan tambahkan minimal satu siswa untuk presensi!');
                submitButton.innerHTML = originalText;
                submitButton.disabled = false;
                return;
            }
            
            // Kumpulkan data presensi
            const presensiList = [];
            for (let element of siswaElements) {
                if (!element.classList.contains('text-center')) {
                    const nama = element.querySelector('.siswa-nama').textContent;
                    const keterangan = element.querySelector('input[type="radio"]:checked').value;
                    presensiList.push({ nama, keterangan });
                }
            }
            
            // Data untuk dikirim ke Google Sheets
            const dataToSend = {
                idJurnal,
                namaGuru,
                kelas,
                mataPelajaran,
                materi,
                catatan,
                durasiPelajaran,
                presensi: presensiList,
                timestamp: new Date().toISOString()
            };
            
            console.log('üì§ Mengirim data ke Google Sheets:', dataToSend);
            
            try {
                // Metode yang lebih sederhana: langsung submit form ke iframe
                console.log('üöÄ Menggunakan metode iframe form submission...');
                
                const iframe = document.createElement('iframe');
                iframe.style.display = 'none';
                iframe.name = 'submit_iframe_' + Date.now();
                document.body.appendChild(iframe);
                
                const form = document.createElement('form');
                form.method = 'POST';
                form.action = SCRIPT_URL;
                form.target = iframe.name;
                form.style.display = 'none';
                
                // Tambahkan semua field sebagai input terpisah
                const fields = [
                    { name: 'idJurnal', value: dataToSend.idJurnal },
                    { name: 'namaGuru', value: dataToSend.namaGuru },
                    { name: 'kelas', value: dataToSend.kelas },
                    { name: 'mataPelajaran', value: dataToSend.mataPelajaran },
                    { name: 'materi', value: dataToSend.materi },
                    { name: 'catatan', value: dataToSend.catatan },
                    { name: 'durasiPelajaran', value: dataToSend.durasiPelajaran },
                    { name: 'timestamp', value: dataToSend.timestamp },
                    { name: 'presensi', value: JSON.stringify(dataToSend.presensi) }
                ];
                
                fields.forEach(field => {
                    const input = document.createElement('input');
                    input.type = 'hidden';
                    input.name = field.name;
                    input.value = field.value;
                    form.appendChild(input);
                });
                
                document.body.appendChild(form);
                
                // Submit form
                form.submit();
                console.log('‚úÖ Form berhasil disubmit ke Google Apps Script');
                
                // Cleanup setelah 10 detik
                setTimeout(() => {
                    if (document.body.contains(form)) document.body.removeChild(form);
                    if (document.body.contains(iframe)) document.body.removeChild(iframe);
                }, 10000);
                
                // Simpan ke localStorage sebagai backup
                const jurnalEntry = {
                    idJurnal,
                    namaGuru,
                    kelas,
                    mataPelajaran,
                    materi,
                    catatan,
                    durasiPelajaran,
                    timestamp: new Date()
                };
                
                jurnalData.push(jurnalEntry);
                localStorage.setItem('jurnalData', JSON.stringify(jurnalData));
                
                const presensiEntry = {
                    idJurnal,
                    namaGuru,
                    kelas,
                    durasiPelajaran,
                    timestamp: new Date(),
                    presensi: presensiList
                };
                
                presensiData.push(presensiEntry);
                localStorage.setItem('presensiData', JSON.stringify(presensiData));
                
                showSuccessMessage('‚úÖ Data dikirim ke Google Sheets! Cek spreadsheet dalam 10-15 detik.');
                
                // Reset form
                document.getElementById('form-gabungan').reset();
                document.getElementById('daftar-presensi').innerHTML = `
                    <div class="text-center text-gray-500 py-8 border-2 border-dashed border-gray-300 rounded-lg">
                        Pilih kelas untuk memuat daftar siswa secara otomatis
                    </div>
                `;
                
            } catch (error) {
                console.error('‚ùå Error mengirim data:', error);
                
                // Simpan ke localStorage sebagai fallback
                const jurnalEntry = {
                    idJurnal,
                    namaGuru,
                    kelas,
                    mataPelajaran,
                    materi,
                    catatan,
                    durasiPelajaran,
                    timestamp: new Date()
                };
                
                jurnalData.push(jurnalEntry);
                localStorage.setItem('jurnalData', JSON.stringify(jurnalData));
                
                const presensiEntry = {
                    idJurnal,
                    namaGuru,
                    kelas,
                    durasiPelajaran,
                    timestamp: new Date(),
                    presensi: presensiList
                };
                
                presensiData.push(presensiEntry);
                localStorage.setItem('presensiData', JSON.stringify(presensiData));
                
                showSuccessMessage('‚ö†Ô∏è Gagal kirim ke Google Sheets. Data tersimpan lokal.', 'warning');
            } finally {
                submitButton.innerHTML = originalText;
                submitButton.disabled = false;
            }
        });

        function getDurasiText(durasi) {
            const durasiOptions = {
                '1': '1 Jam Pelajaran',
                '2': '2 Jam Pelajaran',
                '3': '3 Jam Pelajaran',
                '4': '4 Jam Pelajaran'
            };
            return durasiOptions[durasi] || `${durasi} Jam Pelajaran`;
        }

        function addSiswaToPresensi(nama) {
            const daftarPresensi = document.getElementById('daftar-presensi');
            
            // Hapus pesan placeholder jika ada
            const placeholder = daftarPresensi.querySelector('.text-center');
            if (placeholder) {
                placeholder.remove();
            }
            
            const siswaDiv = document.createElement('div');
            siswaDiv.className = 'bg-white p-4 rounded-lg flex items-center justify-between border border-gray-200';
            siswaDiv.innerHTML = `
                <div class="siswa-nama font-semibold text-gray-800">${nama}</div>
                <div class="flex gap-2">
                    <label class="flex items-center">
                        <input type="radio" name="presensi-${nama.replace(/\s+/g, '')}" value="Hadir" class="mr-2" checked>
                        <span class="text-green-600 font-semibold">‚úÖ Hadir</span>
                    </label>
                    <label class="flex items-center">
                        <input type="radio" name="presensi-${nama.replace(/\s+/g, '')}" value="Sakit" class="mr-2">
                        <span class="text-yellow-600 font-semibold">ü§í Sakit</span>
                    </label>
                    <label class="flex items-center">
                        <input type="radio" name="presensi-${nama.replace(/\s+/g, '')}" value="Izin" class="mr-2">
                        <span class="text-blue-600 font-semibold">üìù Izin</span>
                    </label>
                    <label class="flex items-center">
                        <input type="radio" name="presensi-${nama.replace(/\s+/g, '')}" value="Alpha" class="mr-2">
                        <span class="text-red-600 font-semibold">‚ùå Alpha</span>
                    </label>

                </div>
            `;
            daftarPresensi.appendChild(siswaDiv);
        }





        // Auto load default saat kelas berubah
        document.getElementById('kelas').addEventListener('change', function() {
            const kelas = this.value;
            if (kelas && kelasData[kelas]) {
                // Clear existing list
                document.getElementById('daftar-presensi').innerHTML = '';
                
                // Load default siswa
                const siswaList = kelasData[kelas];
                siswaList.forEach(nama => {
                    addSiswaToPresensi(nama);
                });
            }
        });



        function loadRiwayatData() {
            // Load dari localStorage
            jurnalData = JSON.parse(localStorage.getItem('jurnalData') || '[]');
            presensiData = JSON.parse(localStorage.getItem('presensiData') || '[]');
            
            // Display jurnal
            const riwayatJurnal = document.getElementById('riwayat-jurnal');
            if (jurnalData.length === 0) {
                riwayatJurnal.innerHTML = '<div class="text-center text-gray-500 py-8">Belum ada data jurnal</div>';
            } else {
                riwayatJurnal.innerHTML = jurnalData.map(jurnal => `
                    <div class="bg-gray-50 p-4 rounded-lg">
                        <div class="flex justify-between items-start mb-2">
                            <div class="font-semibold text-gray-800">${jurnal.mataPelajaran}</div>
                            <div class="text-xs text-gray-500">${new Date(jurnal.timestamp).toLocaleString('id-ID')}</div>
                        </div>
                        <div class="text-sm text-gray-600 space-y-1">
                            <div><strong>Guru:</strong> ${jurnal.namaGuru}</div>
                            <div><strong>Kelas:</strong> ${jurnal.kelas} - ${getDurasiText(jurnal.durasiPelajaran)}</div>
                            <div><strong>Materi:</strong> ${jurnal.materi}</div>
                            ${jurnal.catatan ? `<div><strong>Catatan:</strong> ${jurnal.catatan}</div>` : ''}
                        </div>
                    </div>
                `).join('');
            }
            
            // Display presensi
            const riwayatPresensi = document.getElementById('riwayat-presensi');
            if (presensiData.length === 0) {
                riwayatPresensi.innerHTML = '<div class="text-center text-gray-500 py-8">Belum ada data presensi</div>';
            } else {
                riwayatPresensi.innerHTML = presensiData.map(presensi => `
                    <div class="bg-gray-50 p-4 rounded-lg">
                        <div class="flex justify-between items-start mb-2">
                            <div class="font-semibold text-gray-800">${presensi.kelas} - ${getDurasiText(presensi.durasiPelajaran)}</div>
                            <div class="text-xs text-gray-500">${new Date(presensi.timestamp).toLocaleString('id-ID')}</div>
                        </div>
                        <div class="text-sm text-gray-600 mb-2">
                            <strong>Guru:</strong> ${presensi.namaGuru}
                        </div>
                        <div class="grid grid-cols-2 gap-2 text-xs">
                            ${presensi.presensi.map(siswa => `
                                <div class="flex justify-between">
                                    <span>${siswa.nama}</span>
                                    <span class="font-semibold ${getKeteranganColor(siswa.keterangan)}">${siswa.keterangan}</span>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `).join('');
            }
        }

        function getKeteranganColor(keterangan) {
            const colors = {
                'Hadir': 'text-green-600',
                'Sakit': 'text-yellow-600',
                'Izin': 'text-blue-600',
                'Alpha': 'text-red-600'
            };
            return colors[keterangan] || 'text-gray-600';
        }

        // Modal script
        document.getElementById('show-script').addEventListener('click', function() {
            document.getElementById('modal-script').classList.remove('hidden');
            document.getElementById('modal-script').classList.add('flex');
        });

        document.getElementById('close-modal').addEventListener('click', function() {
            document.getElementById('modal-script').classList.add('hidden');
            document.getElementById('modal-script').classList.remove('flex');
        });

        function showSuccessMessage(text = '‚úÖ Data berhasil disimpan!', type = 'success') {
            const message = document.getElementById('success-message');
            message.textContent = text;
            
            if (type === 'error') {
                message.className = 'fixed top-4 right-4 bg-red-500 text-white px-6 py-3 rounded-lg shadow-lg';
            } else if (type === 'warning') {
                message.className = 'fixed top-4 right-4 bg-yellow-500 text-white px-6 py-3 rounded-lg shadow-lg';
            } else {
                message.className = 'fixed top-4 right-4 bg-green-500 text-white px-6 py-3 rounded-lg shadow-lg';
            }
            
            message.classList.remove('hidden');
            message.classList.add('success-animation');
            setTimeout(() => {
                message.classList.add('hidden');
                message.classList.remove('success-animation');
            }, 4000);
        }

        // Load data saat halaman dimuat
        window.addEventListener('load', function() {
            jurnalData = JSON.parse(localStorage.getItem('jurnalData') || '[]');
            presensiData = JSON.parse(localStorage.getItem('presensiData') || '[]');
            loadKelasData(); // Muat data kelas dari CSV
        });
    </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'98dd20a19388fdc5',t:'MTc2MDM0MDU4Mi4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
